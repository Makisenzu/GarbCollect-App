import{j as e,r as c,i as Qe,g as be,a as V}from"./app-BXaeCBOp.js";import{a as F}from"./mapbox-gl-Gp_LbRkJ.js";import{h as Ye,i as ye,j as Ke,g as et}from"./index-ugUzdbGz.js";import"./iconBase-DHFaiy5H.js";const tt=({isLoading:b=!1,size:w="medium",message:k="Collecting garbage..."})=>{if(!b)return null;const R={small:"w-16 h-16",medium:"w-24 h-24",large:"w-32 h-32",xlarge:"w-48 h-48"},i={small:"text-xs",medium:"text-sm",large:"text-base",xlarge:"text-lg"};return e.jsxs("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:[e.jsxs("div",{className:"bg-white rounded-2xl p-8 shadow-2xl flex flex-col items-center",children:[e.jsxs("div",{className:`relative ${R[w]} mb-4`,children:[e.jsx("div",{className:"absolute bottom-0 left-0 right-0 h-2 bg-gray-600 rounded-full"}),e.jsx("div",{className:"absolute bottom-3 left-4 w-3 h-4 bg-gray-400 rounded-sm",children:e.jsx("div",{className:"absolute -top-1 left-0.5 w-2 h-1 bg-gray-500 rounded-sm"})}),e.jsx("div",{className:"absolute bottom-3 left-8 w-3 h-5 bg-gray-400 rounded-sm",children:e.jsx("div",{className:"absolute -top-1 left-0.5 w-2 h-1 bg-gray-500 rounded-sm"})}),e.jsx("div",{className:"absolute bottom-3 left-12 w-3 h-4 bg-gray-400 rounded-sm",children:e.jsx("div",{className:"absolute -top-1 left-0.5 w-2 h-1 bg-gray-500 rounded-sm"})}),e.jsx("div",{className:"absolute bottom-2 left-0 animate-collect-garbage",children:e.jsxs("div",{className:"relative",children:[e.jsxs("div",{className:"w-6 h-4 bg-green-600 rounded-t-sm",children:[e.jsx("div",{className:"absolute top-0.5 left-1 w-3 h-1.5 bg-blue-300 rounded-sm"}),e.jsx("div",{className:"absolute bottom-0 left-1 w-1 h-0.5 bg-yellow-300 rounded-full"})]}),e.jsx("div",{className:"absolute left-6 top-1 w-8 h-3 bg-green-700 rounded-sm",children:e.jsx("div",{className:"absolute top-0.5 left-1 w-6 h-2 bg-gray-800 rounded",children:e.jsx("div",{className:"absolute -top-1 left-0 right-0 h-1 bg-gray-700 rounded-t animate-garbage-fill"})})}),e.jsx("div",{className:"absolute -bottom-1 left-1 w-2 h-2 bg-black rounded-full",children:e.jsx("div",{className:"absolute inset-0.5 w-1 h-1 bg-gray-600 rounded-full"})}),e.jsx("div",{className:"absolute -bottom-1 left-5 w-2 h-2 bg-black rounded-full",children:e.jsx("div",{className:"absolute inset-0.5 w-1 h-1 bg-gray-600 rounded-full"})}),e.jsx("div",{className:"absolute -bottom-1 left-11 w-2 h-2 bg-black rounded-full",children:e.jsx("div",{className:"absolute inset-0.5 w-1 h-1 bg-gray-600 rounded-full"})})]})}),e.jsx("div",{className:"absolute bottom-3 left-16 w-4 h-1 bg-gray-400 rounded-full animate-dust-cloud opacity-0"})]}),e.jsx("div",{className:`text-center ${i[w]} text-gray-700 font-semibold`,children:k}),e.jsxs("div",{className:"flex space-x-1 mt-2",children:[e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-bounce",style:{animationDelay:"0ms"}}),e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-bounce",style:{animationDelay:"150ms"}}),e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-bounce",style:{animationDelay:"300ms"}})]})]}),e.jsx("style",{jsx:!0,children:`
        @keyframes collect-garbage {
          0% {
            transform: translateX(-20px);
          }
          20% {
            transform: translateX(40px);
          }
          40% {
            transform: translateX(80px);
          }
          60% {
            transform: translateX(120px);
          }
          80% {
            transform: translateX(160px);
          }
          100% {
            transform: translateX(200px);
          }
        }
        
        @keyframes garbage-fill {
          0%, 20% {
            height: 0px;
            opacity: 0;
          }
          25% {
            height: 1px;
            opacity: 1;
          }
          40% {
            height: 2px;
            opacity: 1;
          }
          60% {
            height: 3px;
            opacity: 1;
          }
          80% {
            height: 4px;
            opacity: 1;
          }
          100% {
            height: 4px;
            opacity: 0;
          }
        }
        
        @keyframes dust-cloud {
          0%, 60% {
            opacity: 0;
            transform: scale(0.5);
          }
          70% {
            opacity: 0.8;
            transform: scale(1);
          }
          80% {
            opacity: 0.6;
            transform: scale(1.2);
          }
          90% {
            opacity: 0.4;
            transform: scale(1.4);
          }
          100% {
            opacity: 0;
            transform: scale(1.6);
          }
        }
        
        .animate-collect-garbage {
          animation: collect-garbage 4s ease-in-out infinite;
        }
        
        .animate-garbage-fill {
          animation: garbage-fill 4s ease-in-out infinite;
        }
        
        .animate-dust-cloud {
          animation: dust-cloud 4s ease-in-out infinite;
        }
      `})]})},X={Alegria:"#FF5733","Barangay 1":"#33FF57","Barangay 2":"#3357FF","Barangay 3":"#F033FF","Barangay 4":"#FF33F0","Barangay 5":"#33FFF0","Bayugan 2":"#8A2BE2","Bitan-agan":"#A52A2A",Borbon:"#DEB887",Buenasuerte:"#5F9EA0",Caimpugan:"#7FFF00","Das-agan":"#D2691E",Ebro:"#FF7F50",Hubang:"#6495ED",Karaus:"#DC143C",Ladgadan:"#00FFFF",Lapinigan:"#00008B",Lucac:"#008B8B",Mate:"#B8860B","New Visayas":"#006400",Ormaca:"#8B008B",Pasta:"#556B2F","Pisa-an":"#FF8C00",Rizal:"#9932CC","San Isidro":"#8FBC8F","Santa Ana":"#483D8B",Tagapua:"#2F4F4F","San Francisco":"#FFE659",_default:"#4F262A"},dt=({mapboxKey:b,barangayId:w,scheduleId:k})=>{const R=c.useRef(null),i=c.useRef(null),[B,D]=c.useState(!1),[p,C]=c.useState(!1),[T,ae]=c.useState(null),[h,we]=c.useState(null),[se,je]=c.useState(null),[x,oe]=c.useState([]),[Z,Se]=c.useState([]),[rt,at]=c.useState(!0),[st,ne]=c.useState(!0),[P,G]=c.useState("connecting"),[ie,U]=c.useState(null),[_,Ne]=c.useState(!1),[$e,le]=c.useState(!1),[Fe,ke]=c.useState("Loading map data..."),H=(t="Loading map data...")=>{ke(t),le(!0)},M=()=>{le(!1)},[j,I]=c.useState([]),[d,A]=c.useState(null),[z,Me]=c.useState([]),[N,Le]=c.useState(null),[y,Re]=c.useState(null),[o,Te]=c.useState(!1),[J,ce]=c.useState(!0),[Q,de]=c.useState(!1),[ue,Y]=c.useState(null),[v,Ee]=c.useState(!0),E=c.useRef(null),K=c.useRef(null),[Ce,ze]=c.useState(Date.now()),Be=()=>Date.now()-Ce<3e4,[me,De]=c.useState({width:typeof window<"u"?window.innerWidth:1200,height:typeof window<"u"?window.innerHeight:800});c.useEffect(()=>{if(!i.current)return;const t=["mousedown","touchstart","wheel","movestart","dragstart"],a=()=>{ze(Date.now())};return t.forEach(r=>{i.current.on(r,a)}),()=>{t.forEach(r=>{i.current&&i.current.off(r,a)})}},[i.current]),c.useEffect(()=>{const t=()=>{const a=window.innerWidth<768;Te(a),De({width:window.innerWidth,height:window.innerHeight}),a&&ce(!1)};return t(),window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)},[]),c.useEffect(()=>{b&&(console.log("Setting Mapbox access token"),F.accessToken=b)},[b]),c.useEffect(()=>{const t=()=>{R.current?(console.log("Map container is ready in DOM"),Ne(!0)):(console.log("Waiting for map container..."),setTimeout(t,100))};t()},[]),c.useEffect(()=>{if((()=>{const u=document.querySelector('link[href*="mapbox-gl.css"]');return u&&u.sheet?(console.log("Mapbox CSS already loaded"),D(!0),!0):!1})())return;const a=document.createElement("link");a.href="https://api.mapbox.com/mapbox-gl-js/v3.0.0/mapbox-gl.css",a.rel="stylesheet",a.type="text/css";let r;const n=()=>{clearTimeout(r),console.log("Mapbox CSS loaded successfully"),D(!0)},s=()=>{clearTimeout(r),console.warn("Mapbox CSS failed to load, continuing anyway"),D(!0)};a.onload=n,a.onerror=s,document.head.appendChild(a),r=setTimeout(()=>{console.warn("Mapbox CSS load timeout, continuing anyway"),D(!0)},5e3)},[]);const ee=t=>{if(t<60)return`${t} min`;{const a=Math.floor(t/60),r=t%60;return r===0?`${a}h`:`${a}h ${r}min`}},W=(t,a,r,n)=>{const u=(r-t)*Math.PI/180,g=(n-a)*Math.PI/180,f=Math.sin(u/2)*Math.sin(u/2)+Math.cos(t*Math.PI/180)*Math.cos(r*Math.PI/180)*Math.sin(g/2)*Math.sin(g/2);return 6371*(2*Math.atan2(Math.sqrt(f),Math.sqrt(1-f)))},Pe=(t,a)=>{if(!t||a.length===0)return a;const r=[...a],n=[],s=r.map(m=>{const l=W(parseFloat(t.latitude),parseFloat(t.longitude),parseFloat(m.latitude),parseFloat(m.longitude));return{...m,distance:l,coordinates:[parseFloat(m.longitude),parseFloat(m.latitude)]}});s.sort((m,l)=>m.distance-l.distance);const u=s[0];n.push(u);const g=s.slice(1);let f=u;for(;g.length>0;){let m=-1,l=1/0;for(let S=0;S<g.length;S++){const L=W(parseFloat(f.latitude),parseFloat(f.longitude),parseFloat(g[S].latitude),parseFloat(g[S].longitude));L<l&&(l=L,m=S)}m!==-1&&(f=g[m],n.push(f),g.splice(m,1))}return n},ge=async(t,a)=>{if(!b||!t||!a)return console.log("Missing data for driver route calculation"),null;try{const r=`${t[0]},${t[1]};${parseFloat(a.longitude).toFixed(6)},${parseFloat(a.latitude).toFixed(6)}`;console.log("Calculating driver route to site:",r);const n=await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${r}?access_token=${b}&geometries=geojson&overview=full&steps=true&alternatives=false`);if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const s=await n.json();if(s.routes&&s.routes.length>0){const u=s.routes[0];if(u.geometry&&u.geometry.coordinates){const g=Math.round(u.duration/60),f=(u.distance/1e3).toFixed(1);return console.log(`Driver route calculated: ${g}min, ${f}km`),{coordinates:u.geometry.coordinates,duration:g,distance:f,targetSite:a.site_name,isRealTime:!0}}}}catch(r){console.error("Error calculating driver route:",r)}return null},fe=async(t,a,r=!1)=>{if(!(!b||t.length<1)){de(!0),H("Calculating optimal route..."),Y(null);try{const n=t.filter(l=>l.latitude&&l.longitude&&!isNaN(parseFloat(l.latitude))&&!isNaN(parseFloat(l.longitude)));if(n.length<1){console.warn("No valid sites with coordinates found"),Y("No valid sites with coordinates found");return}const s=a?Pe(a,n.filter(l=>l.type!=="station")):n;if(Me(s),s.length>0&&Le(s[0]),r&&h&&s.length>0){const l=await ge(h,s[0]);if(l){I(l.coordinates),A({duration:l.duration,formattedDuration:ee(l.duration),distance:l.distance,targetSite:l.targetSite,isRealTime:!0,totalStops:s.length}),console.log("Using real-time driver route"),i.current&&p&&$();return}}let u=[];a?u=[`${parseFloat(a.longitude).toFixed(6)},${parseFloat(a.latitude).toFixed(6)}`,...s.map(l=>`${parseFloat(l.longitude).toFixed(6)},${parseFloat(l.latitude).toFixed(6)}`)]:u=s.map(l=>`${parseFloat(l.longitude).toFixed(6)},${parseFloat(l.latitude).toFixed(6)}`);const g=u.length>2,f=await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${u.join(";")}?access_token=${b}&geometries=geojson&overview=full&steps=true&alternatives=false&continue_straight=false`+(g?"&roundabout_exits=true":""));if(!f.ok)throw new Error(`HTTP error! status: ${f.status}`);const m=await f.json();if(m.routes&&m.routes.length>0){const l=m.routes[0];if(l.geometry&&l.geometry.coordinates){const S=Math.round(l.duration/60),L=(l.distance/1e3).toFixed(1);I(l.geometry.coordinates),A({duration:S,formattedDuration:ee(S),distance:L,rawData:l,totalStops:s.length,isRealTime:!1}),console.log(`Station route calculated: ${S}min, ${L}km`),i.current&&p&&$()}else throw new Error("Invalid route geometry received")}else throw new Error(m.message||"No routes found")}catch(n){console.error("Error calculating route:",n),Y(`Route calculation failed: ${n.message}`);const s=t.filter(u=>u.latitude&&u.longitude&&!isNaN(parseFloat(u.latitude))&&!isNaN(parseFloat(u.longitude)));if(s.length>0){const u=s.map(g=>[parseFloat(g.longitude),parseFloat(g.latitude)]);I(u),A({duration:Math.round(pe(u)*2),formattedDuration:"Estimated",distance:pe(u).toFixed(1),isFallback:!0,totalStops:s.length,isRealTime:!1}),i.current&&p&&$()}}finally{de(!1),M()}}},pe=t=>{let a=0;for(let r=1;r<t.length;r++){const[n,s]=t[r-1],[u,g]=t[r];a+=W(s,n,g,u)}return a},te=async()=>{if(!(!v||!h||!z.length)){if(K.current){const[t,a]=K.current,[r,n]=h;if(W(a,t,n,r)*1e3<50)return}K.current=h,console.log("Updating real-time route from driver location");try{const t=await ge(h,z[0]);t&&(I(t.coordinates),A(a=>({...a,duration:t.duration,formattedDuration:ee(t.duration),distance:t.distance,targetSite:t.targetSite,isRealTime:!0,lastUpdated:new Date().toLocaleTimeString()})),i.current&&p&&$())}catch(t){console.error("Error updating real-time route:",t)}}},he=()=>{E.current&&clearInterval(E.current),E.current=setInterval(()=>{v&&h&&z.length>0&&te()},2e3),console.log("Started real-time route updates")},xe=()=>{E.current&&(clearInterval(E.current),E.current=null),console.log("Stopped real-time route updates")},Ue=()=>{const t=!v;Ee(t),t?he():xe()},$=()=>{if(!(!i.current||j.length===0)){if(!i.current.isStyleLoaded()){i.current.once("styledata",()=>{setTimeout($,100)});return}["route","route-glow","route-direction","route-start","route-end","route-waypoints","driver-route","driver-route-glow"].forEach(t=>{i.current.getLayer(t)&&i.current.removeLayer(t)}),i.current.getSource("route")&&i.current.removeSource("route"),i.current.getSource("driver-route")&&i.current.removeSource("driver-route"),["route-start-marker","route-end-marker","route-waypoints-marker"].forEach(t=>{i.current.getSource(t)&&i.current.removeSource(t)});try{const t=d!=null&&d.isRealTime?"driver-route":"route",a=d!=null&&d.isRealTime?"driver-route":"route",r=d!=null&&d.isRealTime?"driver-route-glow":"route-glow";i.current.addSource(t,{type:"geojson",data:{type:"Feature",properties:{},geometry:{type:"LineString",coordinates:j}}});const n=(T==null?void 0:T.barangay_name)||"San Francisco",s=d!=null&&d.isRealTime?"#10B981":X[n]||X._default,u=o?6:5,g=o?14:12;i.current.addLayer({id:r,type:"line",source:t,layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":s,"line-width":g,"line-opacity":d!=null&&d.isRealTime?.4:.3,"line-blur":10}}),i.current.addLayer({id:a,type:"line",source:t,layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":s,"line-width":u,"line-opacity":.9,"line-dasharray":d!=null&&d.isRealTime?[2,1]:[1,0]}}),i.current.addLayer({id:"route-direction",type:"symbol",source:t,layout:{"symbol-placement":"line","text-field":"‚ñ∂","text-size":o?14:12,"symbol-spacing":100},paint:{"text-color":s}});const f=[];y&&y.latitude&&y.longitude&&!(d!=null&&d.isRealTime)&&f.push({coordinates:[parseFloat(y.longitude),parseFloat(y.latitude)],type:"station",sequence:0}),z.forEach((m,l)=>{m.latitude&&m.longitude&&f.push({coordinates:[parseFloat(m.longitude),parseFloat(m.latitude)],type:"site",sequence:l+1,isTarget:(d==null?void 0:d.isRealTime)&&l===0})}),f.length>0&&(i.current.addSource("route-waypoints-marker",{type:"geojson",data:{type:"FeatureCollection",features:f.map((m,l)=>({type:"Feature",geometry:{type:"Point",coordinates:m.coordinates},properties:{description:m.type==="station"?"Station":m.isTarget?`Target: ${m.sequence}`:`Site ${m.sequence}`,type:m.type,sequence:m.sequence,isTarget:m.isTarget}}))}}),i.current.addLayer({id:"route-waypoints",type:"circle",source:"route-waypoints-marker",paint:{"circle-radius":["case",["==",["get","type"],"station"],o?10:8,["==",["get","isTarget"],!0],o?12:10,o?8:6],"circle-color":["case",["==",["get","type"],"station"],"#dc2626",["==",["get","isTarget"],!0],"#10B981","#3b82f6"],"circle-stroke-width":2,"circle-stroke-color":"#ffffff"}})),!(d!=null&&d.isRealTime)&&j.length>=2&&(i.current.addSource("route-start-marker",{type:"geojson",data:{type:"Feature",geometry:{type:"Point",coordinates:j[0]},properties:{description:"Start"}}}),i.current.addSource("route-end-marker",{type:"geojson",data:{type:"Feature",geometry:{type:"Point",coordinates:j[j.length-1]},properties:{description:"End"}}}),i.current.addLayer({id:"route-start",type:"circle",source:"route-start-marker",paint:{"circle-radius":o?8:6,"circle-color":"#22c55e","circle-stroke-width":2,"circle-stroke-color":"#ffffff"}}),i.current.addLayer({id:"route-end",type:"circle",source:"route-end-marker",paint:{"circle-radius":o?8:6,"circle-color":"#ef4444","circle-stroke-width":2,"circle-stroke-color":"#ffffff"}})),setTimeout(()=>{ve()},200)}catch(t){console.error("Error adding route layer:",t),setTimeout(()=>{$()},500)}}},ve=()=>{if(!i.current||j.length===0||x.length===0)return;const t=new F.LngLatBounds;j.forEach(r=>{t.extend(r)}),y&&t.extend([parseFloat(y.longitude),parseFloat(y.latitude)]),x.forEach(r=>{r.longitude&&r.latitude&&t.extend([parseFloat(r.longitude),parseFloat(r.latitude)])}),h&&t.extend(h);const a=o?40:80;try{i.current.fitBounds(t,{padding:a,duration:1500,essential:!0,maxZoom:o?16:15,offset:[0,o?-50:0]})}catch(r){console.error("Error fitting map to bounds:",r)}},_e=t=>t.find(a=>a.type==="station")||null;c.useEffect(()=>(B&&b&&_&&(()=>{if(R.current&&!i.current){if(!b){U("Mapbox key is missing.");return}console.log("Starting map initialization..."),H("Initializing map...");try{F.accessToken=b,i.current=new F.Map({container:R.current,style:"mapbox://styles/makisenpai/cm9mo7odu006c01qsc3931nj7",center:[125.94849837776422,8.483022468128098],zoom:o?11:10.5,attributionControl:!1,interactive:!0,scrollZoom:!0,dragPan:!0,dragRotate:!1,keyboard:!1,doubleClickZoom:!o,touchZoomRotate:!0,touchPitch:!1,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!0});const a=()=>{console.log("Map loaded successfully!"),C(!0),U(null),x.length>0&&O(x),h&&q(h,{}),j.length>0&&setTimeout(()=>{$()},500),v&&he(),M()},r=s=>{var u;console.error("Map error:",s),U(`Map error: ${((u=s.error)==null?void 0:u.message)||"Unknown error"}`),C(!0),M()};i.current.once("load",a),i.current.on("error",r);const n=setTimeout(()=>{p||(console.warn("Map load timeout - continuing anyway"),C(!0),M())},1e4);return()=>clearTimeout(n)}catch(a){console.error("Error creating map:",a),U(`Failed to create map: ${a.message}`),C(!0),M()}}})(),()=>{xe(),i.current&&(console.log("Cleaning up map"),i.current.remove(),i.current=null,C(!1))}),[B,b,_,o]),c.useEffect(()=>{x.length>0&&y&&b&&p&&(console.log("All data available, calculating optimal route..."),fe(x,y,v))},[x,y,b,p]),c.useEffect(()=>{if(v&&h&&z.length>0){const t=setTimeout(()=>{te()},1e3);return()=>clearTimeout(t)}},[h,v]),c.useEffect(()=>{i.current&&j.length>0&&p&&$()},[j,p]),c.useEffect(()=>{p&&x.length>0&&(console.log("Force updating site markers due to state change"),O(x))},[p,x,o,v,N]),c.useEffect(()=>{p&&h&&(console.log("Force updating driver marker"),q(h,{}))},[p,h,o]),c.useEffect(()=>{if(!w)return;const t=async()=>{try{console.log("Initializing Reverb connection for real-time location updates..."),Qe();const n=be();if(!n)throw new Error("Echo not initialized");n.channel(`driver-locations.${w}`).listen("DriverLocationUpdated",s=>{console.log("Real-time driver location update received:",s),G("connected"),re(s)}),n.channel(`schedule-updates.${w}`).listen("ScheduleStatusUpdated",s=>{console.log("Schedule update received:",s),Ie(s.schedule)}),n.channel(`site-completion.${w}`).listen("SiteCompletionUpdated",s=>{console.log("Site completion update received:",s),Ae(s)}),G("connected"),await He(),a()}catch(n){console.error("Realtime connection failed:",n),G("disconnected"),a()}},a=()=>{const n=setInterval(()=>{r()},1e4);return()=>clearInterval(n)},r=async()=>{try{if(k){const n=await V.get(`/schedule/${k}/driver-location`);n.data.success&&n.data.data&&re(n.data.data)}}catch(n){console.error("Error polling driver location:",n)}};return t(),()=>{const n=be();n&&(n.leave(`driver-locations.${w}`),n.leave(`schedule-updates.${w}`),n.leave(`site-completion.${w}`))}},[w,k]);const He=async()=>{try{ne(!0),H("Loading collection sites...");const t=await V.get(`/barangay/${w}/current-schedule`);if(t.data.success){const a=t.data.data;if(ae(a),a.id){const r=await V.get(`/schedule/${a.id}/sites`);if(r.data.success){const n=r.data.data;oe(n);const s=_e(n);s&&(Re(s),console.log("Station found:",s.site_name))}}if(k){const r=await V.get(`/schedule/${k}/driver-location`);r.data.success&&r.data.data&&re(r.data.data)}}M()}catch(t){console.error("Error loading initial data:",t),M()}finally{ne(!1)}},re=t=>{if(!t.longitude||!t.latitude){console.warn("Invalid location data received:",t);return}const a=[parseFloat(t.longitude),parseFloat(t.latitude)];console.log("Updating driver location on map:",a),we(a),p&&i.current&&(q(a,t),Be()||i.current.flyTo({center:a,zoom:o?16:15,duration:2e3,essential:!0,offset:[0,o?-100:0]}),v&&te())},q=(t,a)=>{if(!i.current||!p)return;se&&se.remove();const r=o?"w-12 h-12":"w-10 h-10",n=o?"w-6 h-6":"w-5 h-5",s=document.createElement("div");s.className="driver-location-marker";const g=(a.timestamp?(new Date-new Date(a.timestamp))/1e3:0)<30;s.innerHTML=`
      <div class="relative">
        <div class="${r} bg-blue-600 border-3 border-white rounded-full shadow-lg flex items-center justify-center relative z-10">
          <svg class="${n} text-white" viewBox="0 0 24 24" fill="currentColor">
            <path d="M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z"/>
            <path d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0"/>
          </svg>
          ${g?"":`
            <div class="absolute -top-1 -right-1 w-3 h-3 bg-yellow-500 rounded-full border border-white"></div>
          `}
        </div>
        <div class="absolute inset-0 bg-blue-400 rounded-full animate-ping opacity-30"></div>
        ${a.accuracy?`
          <div class="absolute inset-0 border-2 border-blue-300 rounded-full opacity-50" 
               style="transform: scale(${Math.min(a.accuracy/10,3)})"></div>
        `:""}
      </div>
    `;try{const f=new F.Marker({element:s,draggable:!1}).setLngLat(t).addTo(i.current),m=new F.Popup({offset:25,closeButton:!1,className:`custom-popup ${o?"max-w-xs":"max-w-sm"}`}).setHTML(`
        <div class="text-sm ${o?"p-2":"p-3"}">
          <div class="font-semibold text-gray-900 ${o?"text-base":""}">üöó Driver Location</div>
          <div class="text-xs text-gray-500 mt-1">
            ${a.timestamp?`Updated: ${new Date(a.timestamp).toLocaleTimeString()}`:"Live"}
          </div>
          ${a.accuracy?`
            <div class="text-xs text-gray-500 mt-1">
              Accuracy: ¬±${Math.round(a.accuracy)} meters
            </div>
          `:""}
          ${g?"":`
            <div class="text-xs text-yellow-600 mt-1 font-medium">
              ‚ö†Ô∏è Location data may be delayed
            </div>
          `}
        </div>
      `);f.setPopup(m),je(f)}catch(f){console.error("Error creating driver marker:",f)}},Ie=t=>{ae(t)},Ae=t=>{console.log("Updating site completion status:",t),oe(a=>a.map(r=>r.id===t.site_id?{...r,status:t.status,completed_at:t.completed_at}:r)),p&&setTimeout(()=>{O(x)},100)},O=t=>{if(!i.current||!p)return;Z.forEach(r=>{r&&r.remove&&r.remove()});const a=t.map((r,n)=>{if(!r.longitude||!r.latitude)return null;try{const s=document.createElement("div");s.className="site-marker";const u=r.status==="finished"||r.status==="completed",g=r.status==="in_progress",f=r.type==="station",m=r.purok_name||r.site_name||"Site",l=v&&N&&N.id===r.id,S=()=>f?"#DC2626":u||l?"#10B981":"#6B7280",L=()=>f?`
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
              </svg>
            `:u?`
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
              </svg>
            `:`
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M3 6h18"/>
                <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
              </svg>
            `,Xe=o?"w-12 h-12":"w-10 h-10",Ze=o?"w-6 h-6":"w-5 h-5";s.innerHTML=`
          <div class="relative ${g||l?"animate-pulse":""}">
            <div class="${Xe} rounded-full border-3 border-white flex items-center justify-center shadow-lg" 
                  style="background-color: ${S()}; ${u?"opacity: 0.7;":""}">
              <div class="${Ze} text-white">
                ${L()}
              </div>
            </div>
            ${g?'<div class="absolute inset-0 rounded-full border-3 border-yellow-500 animate-ping"></div>':""}
            ${l&&!g?'<div class="absolute inset-0 rounded-full border-3 border-green-500 animate-ping"></div>':""}
          </div>
        `;const Ge=[parseFloat(r.longitude),parseFloat(r.latitude)],Je=new F.Popup({offset:25,closeButton:!1,className:`custom-popup ${o?"max-w-xs":"max-w-sm"}`}).setHTML(`
          <div class="text-sm ${o?"p-2":"p-3"}">
            <div class="font-semibold text-gray-900 ${o?"text-base":""}">${m}</div>
            <div class="text-xs text-gray-500 mt-1">
              ${f?"Collection Station":u?"Completed":g?"In Progress":"Pending"}
            </div>
            ${l&&v&&'<div class="text-xs text-green-600 mt-1 font-medium">üéØ Current Target</div>'}
            ${N&&N.id===r.id&&!l&&'<div class="text-xs text-green-600 mt-1 font-medium">üìç Nearest Site</div>'}
          </div>
        `);return new F.Marker({element:s,draggable:!1}).setLngLat(Ge).setPopup(Je).addTo(i.current)}catch(s){return console.error("Error creating marker:",s),null}}).filter(r=>r!==null);Se(a)},We=async()=>{x.length>0&&y&&(H("Refreshing route..."),await fe(x,y,v))},qe=()=>{console.log("Manually refreshing icons"),x.length>0&&O(x),h&&q(h,{})},Oe=()=>{ce(!J)},Ve=()=>me.width<640?"400px":me.width<768?"500px":"600px";return c.useEffect(()=>{console.log("Current state:",{cssLoaded:B,mapInitialized:p,containerReady:_,siteLocationsCount:x.length,siteMarkersCount:Z.length,driverLocation:!!h})},[B,p,_,x,Z,h]),ie?e.jsx("div",{className:"w-full h-96 bg-gray-50 rounded-lg border border-gray-200 flex items-center justify-center",children:e.jsxs("div",{className:"text-center p-6",children:[e.jsx(Ye,{className:"w-12 h-12 text-red-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-base font-semibold text-gray-900 mb-2",children:"Map Loading Error"}),e.jsx("p",{className:"text-sm text-gray-600 mb-4",children:ie}),e.jsx("p",{className:"text-xs text-gray-500",children:"The interface will continue with limited functionality"})]})}):e.jsxs("div",{className:"w-full bg-white rounded-lg border border-gray-200 overflow-hidden",children:[e.jsx(tt,{isLoading:$e,message:Fe,size:o?"medium":"large",variant:"default"}),e.jsxs("div",{className:"relative w-full",style:{height:Ve()},children:[e.jsx("div",{ref:R,className:"w-full h-full absolute inset-0"}),p&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:`absolute ${o?"bottom-2 left-2":"bottom-4 left-4"} bg-white rounded-lg shadow-lg border border-gray-200 ${o?"p-2":"p-3"} z-10 ${o?"min-w-40":"min-w-48"}`,children:[e.jsx("div",{className:`font-semibold ${o?"text-xs":"text-sm"} text-gray-900 ${o?"mb-2":"mb-3"}`,children:"Legend"}),e.jsxs("div",{className:`space-y-1 ${o?"text-xs":"text-sm"}`,children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 bg-blue-600 rounded-full flex items-center justify-center flex-shrink-0 relative",children:e.jsx("div",{className:"absolute inset-0 bg-blue-400 rounded-full animate-ping opacity-30"})}),e.jsx("span",{className:"text-gray-700",children:"Driver"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 bg-red-600 rounded-full flex-shrink-0"}),e.jsx("span",{className:"text-gray-700",children:"Station"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 bg-gray-500 rounded-full flex-shrink-0"}),e.jsx("span",{className:"text-gray-700",children:"Pending"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 bg-green-600 rounded-full flex-shrink-0"}),e.jsx("span",{className:"text-gray-700",children:"Completed"})]}),v&&N&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 bg-green-500 rounded-full flex-shrink-0 relative",children:e.jsx("div",{className:"absolute inset-0 rounded-full border-2 border-white animate-ping"})}),e.jsx("span",{className:"text-gray-700",children:"Target Site"})]}),d&&e.jsxs("div",{className:"flex items-center gap-2 pt-1 border-t border-gray-200",children:[e.jsx("div",{className:"w-4 h-1 rounded-full flex-shrink-0",style:{backgroundColor:d.isRealTime?"#10B981":X[T==null?void 0:T.barangay_name]||X._default}}),e.jsx("span",{className:"text-gray-700",children:d.isRealTime?"Live Route":"Planned Route"})]})]})]}),e.jsxs("div",{className:`absolute ${o?"top-2 right-2":"top-4 right-4"} flex flex-col gap-2 z-10`,children:[e.jsx("button",{onClick:qe,className:`bg-white rounded-lg shadow-lg border border-gray-200 hover:bg-gray-50 transition-colors flex items-center justify-center ${o?"p-2":"p-3"}`,title:"Refresh icons",children:e.jsx(ye,{className:`text-gray-700 ${o?"w-4 h-4":"w-5 h-5"}`})}),e.jsx("button",{onClick:Ue,className:`rounded-lg shadow-lg border transition-colors flex items-center justify-center ${o?"p-2":"p-3"} ${v?"bg-green-500 border-green-600 hover:bg-green-600 text-white":"bg-white border-gray-200 hover:bg-gray-50 text-gray-700"}`,title:v?"Disable real-time routing":"Enable real-time routing",children:e.jsx("div",{className:`${o?"w-4 h-4":"w-5 h-5"} ${v?"animate-pulse":""}`})}),e.jsx("button",{onClick:We,disabled:Q,className:`bg-white rounded-lg shadow-lg border border-gray-200 hover:bg-gray-50 transition-colors flex items-center justify-center ${o?"p-2":"p-3"} ${Q?"opacity-50 cursor-not-allowed":""}`,title:"Refresh route",children:Q?e.jsx("div",{className:`animate-spin rounded-full border-b-2 border-gray-700 ${o?"w-4 h-4":"w-5 h-5"}`}):e.jsx(ye,{className:`text-gray-700 ${o?"w-4 h-4":"w-5 h-5"}`})}),e.jsx("button",{onClick:Oe,className:`bg-white rounded-lg shadow-lg border border-gray-200 hover:bg-gray-50 transition-colors flex items-center justify-center ${o?"p-2":"p-3"}`,title:J?"Hide route info":"Show route info",children:e.jsx(Ke,{className:`text-gray-700 ${o?"w-4 h-4":"w-5 h-5"}`})}),e.jsx("button",{onClick:ve,className:`bg-white rounded-lg shadow-lg border border-gray-200 hover:bg-gray-50 transition-colors flex items-center justify-center ${o?"p-2":"p-3"}`,title:"Fit to route",children:e.jsx(et,{className:`text-gray-700 ${o?"w-4 h-4":"w-5 h-5"}`})})]}),e.jsx("div",{className:`absolute ${o?"top-2 left-2":"top-4 left-4"} bg-white rounded-lg shadow-lg border border-gray-200 ${o?"px-2 py-1":"px-3 py-2"} z-10`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${P==="connected"?"bg-green-500":P==="connecting"?"bg-yellow-500":"bg-red-500"} ${P==="connected"?"animate-pulse":""}`}),e.jsx("span",{className:`font-medium text-gray-700 capitalize ${o?"text-xs":"text-sm"}`,children:P})]})}),d&&J&&e.jsxs("div",{className:`absolute ${o?"top-12 left-2 right-2":"top-16 left-4"} bg-white rounded-lg shadow-lg border border-gray-200 ${o?"p-3":"p-4"} z-10 ${o?"":"min-w-64"}`,children:[e.jsxs("div",{className:`font-semibold text-gray-900 ${o?"text-sm mb-2":"text-base mb-3"} flex items-center justify-between`,children:[e.jsx("span",{children:d.isRealTime?"Live Route":"Planned Route"}),e.jsxs("div",{className:"flex gap-1",children:[d.isRealTime&&e.jsxs("span",{className:"text-xs bg-green-100 text-green-800 px-2 py-1 rounded flex items-center gap-1",children:[e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-pulse"}),"Live"]}),d.isFallback&&e.jsx("span",{className:"text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded",children:"Estimated"})]})]}),e.jsxs("div",{className:`space-y-2 ${o?"text-xs":"text-sm"} text-gray-600`,children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{children:"Estimated Time:"}),e.jsx("span",{className:"font-semibold text-blue-600",children:d.formattedDuration})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{children:"Distance:"}),e.jsxs("span",{className:"font-semibold",children:[d.distance," km"]})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{children:"Total Stops:"}),e.jsxs("span",{className:"font-semibold",children:[d.totalStops," sites"]})]}),d.targetSite&&e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{children:"Target Site:"}),e.jsx("span",{className:"font-semibold text-green-600",children:d.targetSite})]}),N&&!d.targetSite&&e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{children:"Nearest Site:"}),e.jsx("span",{className:"font-semibold text-green-600",children:N.site_name})]}),d.lastUpdated&&e.jsxs("div",{className:"flex justify-between items-center text-xs text-gray-500",children:[e.jsx("span",{children:"Last Updated:"}),e.jsx("span",{children:d.lastUpdated})]})]}),ue&&e.jsx("div",{className:`mt-2 p-2 bg-red-50 border border-red-200 rounded ${o?"text-xs":"text-sm"} text-red-600`,children:ue})]})]})]})]})};export{dt as default};
