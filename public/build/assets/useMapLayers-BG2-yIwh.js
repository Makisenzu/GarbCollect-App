import{r as L,c as ae,j as le}from"./app-B4pHSuQz.js";import{a as E}from"./mapbox-gl-C-Rq1YNl.js";import{G as se}from"./index-DA9DQ_Po.js";import{c as ue}from"./can-3MqaZyCZ.js";import"./iconBase-MZ461PLe.js";const me=({map:e,isMobile:a,activeSchedule:y,completedSites:k,optimizedSiteOrder:b,currentSiteIndex:Q,nearestSiteToStation:_,routeCoordinates:d,routeInfo:g,currentLocation:v,isTaskActive:X,siteLocations:j,stationLocation:f})=>{const x=L.useRef([]),F=L.useRef(null),T=L.useRef(null),A=L.useRef(null),p=L.useRef(null),w={Alegria:"#FF5733","Barangay 1":"#33FF57","Barangay 2":"#3357FF","Barangay 3":"#F033FF","Barangay 4":"#FF33F0","Barangay 5":"#33FFF0","Bayugan 2":"#8A2BE2","Bitan-agan":"#A52A2A",Borbon:"#DEB887",Buenasuerte:"#5F9EA0",Caimpugan:"#7FFF00","Das-agan":"#D2691E",Ebro:"#FF7F50",Hubang:"#6495ED",Karaus:"#DC143C",Ladgadan:"#00FFFF",Lapinigan:"#00008B",Lucac:"#008B8B",Mate:"#B8860B","New Visayas":"#006400",Ormaca:"#8B008B",Pasta:"#556B2F","Pisa-an":"#FF8C00",Rizal:"#9932CC","San Isidro":"#8FBC8F","Santa Ana":"#483D8B",Tagapua:"#2F4F4F","San Francisco":"#FFE659",_default:"#4F262A"},Y=(r,n)=>{if(!e.current)return;const t=[n,r];N(n,r),F.current&&F.current.setLngLat(t),X&&e.current&&!e.current.hasUserInteracted()&&e.current.flyTo({center:t,zoom:a?16:15,speed:.8,curve:1,essential:!0,duration:1e3})},N=(r,n)=>{if(!e.current)return;const t={type:"FeatureCollection",features:[{type:"Feature",geometry:{type:"Point",coordinates:[r,n]},properties:{description:"Driver current location"}}]};if(!e.current.getSource("driver-location"))e.current.addSource("driver-location",{type:"geojson",data:t}),e.current.addLayer({id:"driver-location-layer",type:"circle",source:"driver-location",paint:{"circle-radius":8,"circle-color":"#2563eb","circle-stroke-width":2,"circle-stroke-color":"#ffffff","circle-opacity":.9}}),e.current.addLayer({id:"driver-location-pulse",type:"circle",source:"driver-location",paint:{"circle-radius":{base:8,stops:[[0,8],[20,25]]},"circle-color":"#2563eb","circle-opacity":{base:.4,stops:[[0,.4],[1,0]]},"circle-stroke-width":1,"circle-stroke-color":"#2563eb"}}),T.current=e.current.getSource("driver-location"),A.current="driver-location-layer";else{const o=e.current.getSource("driver-location");o&&o.setData(t)}P()},P=()=>{if(!e.current||!e.current.getLayer("driver-location-pulse"))return;p.current&&cancelAnimationFrame(p.current);const r=Date.now(),n=2e3,t=()=>{const l=(Date.now()-r)%n/n,c=8+l*17;e.current.setPaintProperty("driver-location-pulse","circle-radius",c),e.current.setPaintProperty("driver-location-pulse","circle-opacity",.4*(1-l)),p.current=requestAnimationFrame(t)};p.current=requestAnimationFrame(t)},q=(r,n)=>{if(!e.current||d.length===0)return;const t=new E.LngLatBounds;d.forEach(c=>{t.extend(c)}),v&&t.extend(v);const o=r();if(o!==-1&&n[o]){const c=n[o];t.extend([parseFloat(c.longitude),parseFloat(c.latitude)])}const l=a?40:80;try{e.current.fitBounds(t,{padding:l,duration:1e3,essential:!0,maxZoom:a?16:15})}catch(c){console.error("Error fitting map to bounds:",c)}},D=()=>{if(!e.current||d.length===0||j.length===0)return;const r=new E.LngLatBounds;f&&r.extend([parseFloat(f.longitude),parseFloat(f.latitude)]),j.forEach(t=>{t.longitude&&t.latitude&&r.extend([parseFloat(t.longitude),parseFloat(t.latitude)])}),d.forEach(t=>{r.extend(t)}),v&&r.extend(v);const n=a?20:50;try{e.current.fitBounds(r,{padding:n,duration:1e3,essential:!0,maxZoom:a?16:15})}catch(t){console.error("Error fitting map to bounds:",t)}},O=()=>{if(!e.current)return;["driver-location-layer","driver-location-pulse"].forEach(t=>{e.current.getLayer(t)&&e.current.removeLayer(t)}),["route","route-glow","route-direction","route-recalculated","route-completed","route-completed-glow"].forEach(t=>{e.current.getLayer(t)&&e.current.removeLayer(t)}),e.current.getStyle().layers.forEach(t=>{t.id.startsWith("route-to-site-")&&e.current.getLayer(t.id)&&e.current.removeLayer(t.id)}),e.current.getSource("driver-location")&&e.current.removeSource("driver-location"),e.current.getSource("route")&&e.current.removeSource("route"),e.current.getSource("route-completed")&&e.current.removeSource("route-completed"),Object.keys(e.current.getStyle().sources).forEach(t=>{t.startsWith("route-to-site-")&&e.current.getSource(t)&&e.current.removeSource(t)}),T.current=null,A.current=null,p.current&&(cancelAnimationFrame(p.current),p.current=null)},ee=r=>{if(!e.current)return;F.current&&F.current.remove();const n=document.createElement("div");n.className="current-location-marker";const t=a?"w-8 h-8":"w-6 h-6";n.innerHTML=`
      <div class="relative">
        <div class="${t} bg-blue-600 border-2 border-white rounded-full shadow-lg z-50"></div>
        <div class="absolute inset-0 bg-blue-400 rounded-full animate-ping"></div>
      </div>
    `,F.current=new E.Marker({element:n,draggable:!1}).setLngLat(r).addTo(e.current)},C=()=>{if(!e.current||d.length===0){console.log("Cannot add route layer - missing map or route coordinates");return}if(!e.current.isStyleLoaded()){console.log("Map style not loaded yet, waiting..."),e.current.once("styledata",()=>{setTimeout(C,100)});return}["route","route-glow","route-direction","route-recalculated","route-completed","route-completed-glow"].forEach(r=>{e.current.getLayer(r)&&e.current.removeLayer(r)}),e.current.getSource("route")&&e.current.removeSource("route"),e.current.getSource("route-completed")&&e.current.removeSource("route-completed");try{console.log("Adding route layer to map with coordinates:",d.length);const r=(y==null?void 0:y.barangay_name)||"San Francisco",n=w[r]||w._default,t=g!=null&&g.recalculated?"#FF6B35":n,o=a?6:5,l=a?14:12;let c=[],i=d;if(b.length>0&&k.size>0){let s=-1;for(let u=b.length-1;u>=0;u--)if(k.has(b[u].id)){s=u;break}if(s>=0){const u=b.length,h=(s+1)/u,m=Math.floor(d.length*h);c=d.slice(0,m),i=d.slice(m),console.log(`Route split: ${c.length} completed, ${i.length} remaining`)}}c.length>1&&(e.current.addSource("route-completed",{type:"geojson",data:{type:"Feature",properties:{completed:!0},geometry:{type:"LineString",coordinates:c}}}),e.current.addLayer({id:"route-completed-glow",type:"line",source:"route-completed",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#10B981","line-width":l,"line-opacity":.3,"line-blur":8}}),e.current.addLayer({id:"route-completed",type:"line",source:"route-completed",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#10B981","line-width":o,"line-opacity":.7,"line-dasharray":[2,2]}})),i.length>1&&(e.current.addSource("route",{type:"geojson",data:{type:"Feature",properties:{recalculated:(g==null?void 0:g.recalculated)||!1,remaining:!0},geometry:{type:"LineString",coordinates:i}}}),e.current.addLayer({id:"route-glow",type:"line",source:"route",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":t,"line-width":l,"line-opacity":.4,"line-blur":8}}),e.current.addLayer({id:"route",type:"line",source:"route",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":t,"line-width":o,"line-opacity":.9}}),e.current.addLayer({id:"route-direction",type:"symbol",source:"route",layout:{"symbol-placement":"line","text-field":"‚ñ∂","text-size":a?14:12,"symbol-spacing":100},paint:{"text-color":t}}),g!=null&&g.recalculated&&e.current.addLayer({id:"route-recalculated",type:"line",source:"route",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#FF6B35","line-width":o-1,"line-dasharray":[2,2],"line-opacity":.7}})),console.log("Route layer added successfully"),setTimeout(()=>{q()},200)}catch(r){console.error("Error adding route layer:",r),setTimeout(()=>{C()},500)}},W=r=>{if(!e.current||!r||r.length===0){console.log("Cannot add all site routes - missing map or routes");return}if(!e.current.isStyleLoaded()){console.log("Map style not loaded yet, waiting..."),e.current.once("styledata",()=>{setTimeout(()=>W(r),100)});return}try{console.log(`Adding ${r.length} individual route layers to map`),r.forEach((o,l)=>{const c=`route-to-site-${o.siteId}`,i=`route-to-site-${o.siteId}-glow`,s=`route-to-site-${o.siteId}-direction`;[c,i,s].forEach(u=>{e.current.getLayer(u)&&e.current.removeLayer(u)}),e.current.getSource(c)&&e.current.removeSource(c)});const n=(y==null?void 0:y.barangay_name)||"San Francisco",t=w[n]||w._default;r.forEach((o,l)=>{const c=`route-to-site-${o.siteId}`,i=`route-to-site-${o.siteId}`,s=`route-to-site-${o.siteId}-glow`,u=`route-to-site-${o.siteId}-direction`;e.current.addSource(c,{type:"geojson",data:{type:"Feature",properties:{siteId:o.siteId,siteName:o.siteName,sequence:o.sequence,distance:o.distance,duration:o.duration},geometry:{type:"LineString",coordinates:o.coordinates}}});const h=.3+l/r.length*.4,m=a?4:3,$=a?10:8;e.current.addLayer({id:s,type:"line",source:c,layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":t,"line-width":$,"line-opacity":h*.3,"line-blur":6}}),e.current.addLayer({id:i,type:"line",source:c,layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":t,"line-width":m,"line-opacity":h,"line-dasharray":o.isFallback?[2,2]:[1]}}),e.current.addLayer({id:u,type:"symbol",source:c,layout:{"symbol-placement":"line","text-field":"‚ñ∂","text-size":a?10:8,"symbol-spacing":120},paint:{"text-color":t,"text-opacity":h*.8}})}),console.log(`Successfully added ${r.length} route layers`),setTimeout(()=>{H(r)},200)}catch(n){console.error("Error adding all site route layers:",n)}},H=r=>{if(!e.current||!r||r.length===0)return;const n=new E.LngLatBounds;r.forEach(o=>{o.coordinates.forEach(l=>{n.extend(l)})}),v&&n.extend(v);const t=a?40:80;try{e.current.fitBounds(n,{padding:t,duration:1e3,essential:!0,maxZoom:a?15:14})}catch(o){console.error("Error fitting map to all routes:",o)}},I=(r,n)=>{var G,K,V,J;const t=(K=(G=r==null?void 0:r.purok)==null?void 0:G.baranggay)==null?void 0:K.baranggay_name,o=w[t]||w._default,l=_&&_.id===r.id,c=r.type==="station",i=k.has(r.id),s=((V=b[Q])==null?void 0:V.id)===r.id,u=a?"w-12 h-12":"w-10 h-10",h=a?"w-10 h-10":"w-8 h-8",m=document.createElement("div");m.className="custom-image-marker";let $="";if(y){const ie=a?"w-8 h-8 text-sm":"w-7 h-7 text-xs";let S="bg-blue-500",B=n;i?(S="bg-green-600",B='<span class="text-lg">‚úì</span>'):s?(S="bg-yellow-500 animate-pulse",B=n):c&&(S="bg-red-500",B="üè†"),$=`
        <div class="absolute -top-2 -right-2 ${S} text-white rounded-full ${ie} flex items-center justify-center font-bold shadow-lg border-2 border-white z-20">
          ${B}
        </div>
      `}const re=i?"opacity-60":"opacity-100",Z=i?"grayscale brightness-110":"",te=i?"border-green-600":"",ne=s&&!i?"ring-4 ring-yellow-500 ring-opacity-70":"",oe=l&&!i&&!s?"ring-4 ring-green-500 ring-opacity-70":"",ce=i?`
      <div class="absolute inset-0 rounded-full bg-green-500 bg-opacity-20 animate-ping pointer-events-none z-0"></div>
    `:"";return m.innerHTML=`
      <div class="relative ${re}">
        ${$}
        ${ce}
        <div class="${u} rounded-full border-3 flex items-center justify-center overflow-hidden shadow-lg bg-white relative ${ne} ${oe} ${Z} ${te}" 
             style="border-color: ${i?"#16A34A":o}; border-width: ${i?"3px":"2px"};">
          ${s&&!i?`
            <div class="absolute -inset-3 rounded-full border-4 border-yellow-500 border-opacity-70 animate-pulse pointer-events-none z-10"></div>
          `:""}
          ${l&&!i&&!s?`
            <div class="absolute -inset-3 rounded-full border-4 border-green-500 border-opacity-70 animate-pulse pointer-events-none z-10"></div>
          `:""}
          ${i?`
            <div class="absolute inset-0 bg-green-600 bg-opacity-30 rounded-full z-5 flex items-center justify-center">
              <span class="text-2xl text-green-700">‚úì</span>
            </div>
          `:""}
          <img src="${ue}" 
               alt="${r.site_name}" 
               class="${h} object-cover rounded-full z-0 ${Z}"
               onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\\'${h} rounded-full flex items-center justify-center text-white text-xs font-bold bg-white\\' style=\\'border: 2px solid ${o}; color: ${o}\\'>${((J=r.site_name)==null?void 0:J.charAt(0))||"S"}</div>'">
        </div>
      </div>
    `,m},M=r=>{const n=document.createElement("div");n.className="custom-marker relative";const t=a?44:36,o=a?"w-14 h-14":"w-12 h-12";let l="";y&&(l=`
        <div class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full ${a?"w-7 h-7 text-xs":"w-6 h-6 text-xs"} flex items-center justify-center font-bold shadow-lg border-2 border-white z-20">
          üè†
        </div>
      `),n.innerHTML=`
      <div class="relative">
        ${l}
        <div class="${o} rounded-full bg-white shadow-2xl border-4 border-red-600 flex items-center justify-center">
          <div id="station-icon-container" class="flex items-center justify-center"></div>
        </div>
      </div>
    `;const c=ae.createRoot(n.querySelector("#station-icon-container"));return c.render(le.jsx(se,{size:t,color:"#DC2626"})),{element:n,root:c}},R=(r,n="manual",t="",o=null,l=0)=>{let c,i=null;if(n==="manual")c=document.createElement("div"),c.className="custom-marker";else if((o==null?void 0:o.type)==="station"){const u=M();c=u.element,i=u.root}else c=I(o,l);const s=new E.Marker({element:c,draggable:!1}).setLngLat(r).addTo(e.current);return i&&(s._root=i),s},U=()=>{if(z(),f){const n=R([parseFloat(f.longitude),parseFloat(f.latitude)],"station",f.site_name,f,0);x.current.push(n)}(b.length>0?b:j).forEach((n,t)=>{if(n.longitude&&n.latitude){const o=R([parseFloat(n.longitude),parseFloat(n.latitude)],"site",n.site_name,n,t+1);x.current.push(o)}})},z=()=>{x.current.forEach(r=>{r._root&&setTimeout(()=>r._root.unmount(),0),r.remove()}),x.current=[]};return{siteMarkersRef:x,currentLocationMarkerRef:F,userLocationSourceRef:T,userLocationLayerRef:A,animationFrameRef:p,smoothUpdateUserLocation:Y,updateUserLocationSource:N,animatePulse:P,fitMapToRouteAndDriver:q,fitMapToRoute:D,clearUserLocationLayers:O,updateCurrentLocationMarker:ee,addRouteLayer:C,addSiteMarkers:U,clearSiteMarkers:z,updateSiteMarkers:()=>{z(),U()},addMarker:R,createImageMarker:I,createStationIcon:M,addAllSiteRoutesLayers:W,fitMapToAllRoutes:H}};export{me as useMapLayers};
