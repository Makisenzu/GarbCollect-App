import{r as g,a as f}from"./app-BaJPuWjO.js";const K=({scheduleId:c,onTaskComplete:y,onTaskCancel:G,calculateDistance:F,showCompletionNotification:R,updateSiteMarkers:E,recalculateRouteFromCurrentPosition:I,currentLocation:O})=>{const[m,h]=g.useState([]),[P,z]=g.useState(null),[p,b]=g.useState(null),[H,k]=g.useState(null),[S,C]=g.useState([]),[q,_]=g.useState(new Set),[U,w]=g.useState(0),[B,$]=g.useState(!1),[W,A]=g.useState(!1),v=(t,o)=>{if(!t||o.length===0)return null;let s=null,n=1/0;return o.forEach(e=>{if(e.longitude&&e.latitude){const a=F(parseFloat(t.latitude),parseFloat(t.longitude),parseFloat(e.latitude),parseFloat(e.longitude));a<n&&(n=a,s=e)}}),s},Q=(t,o)=>{if(!t||o.length===0)return!1;const[s,n]=t,e=.05;let a=!1;return o.forEach((i,u)=>{if(q.has(i.id))return;const l=parseFloat(i.longitude),r=parseFloat(i.latitude),d=F(n,s,r,l);d<.1&&console.log(`ðŸ“ Proximity check: ${i.site_name} - Distance: ${(d*1e3).toFixed(0)}m (threshold: ${(e*1e3).toFixed(0)}m)`),d<e&&(console.log(`ðŸŽ¯ SITE REACHED! ${i.site_name} - Distance: ${(d*1e3).toFixed(0)}m`),D(i),a=!0)}),a},L=async()=>{var t;try{if(!m.length){console.log("No sites available to initialize collection queue");return}const o=m.map(n=>n.id);console.log("Initializing collection queue with sites:",o);const s=await f.post("/initialize",{schedule_id:c,site_id:o});s.data.success?console.log("Collection queue initialized with",s.data.total_sites,"sites"):console.error("Failed to initialize collection queue:",s.data.message)}catch(o){console.error("Error initializing collection queue:",o),console.error("Error details:",(t=o.response)==null?void 0:t.data)}},D=async(t,o)=>{var s;console.log(`Site reached: ${t.site_name}`);try{const n=await f.post("/mark-completed",{schedule_id:c,site_id:t.id});if(n.data.success){if(console.log("Site marked as completed in database:",t.site_name),_(e=>{const a=new Set(e);return a.add(t.id),console.log("Updated completed sites:",Array.from(a)),a}),h(e=>e.map(a=>a.id===t.id?{...a,collectionStatus:"finished",status:"finished",completed_at:new Date().toISOString()}:a)),n.data.all_completed?(console.log("ðŸŽ‰ All sites completed! Show completion report modal."),y&&y(t,!0)):console.log(`Progress: ${n.data.completed_sites}/${n.data.total_sites} sites completed`),S.length>0){const e=S.findIndex(a=>a.id===t.id);if(e!==-1&&e<S.length-1){const a=e+1;w(a);const i=S[a];console.log(`Moving to next site: ${i.site_name}`),O&&(console.log("Immediately recalculating route from current location to next site"),I(O))}else e===S.length-1&&(console.log("ðŸ Last site reached!"),w(e))}E(),R(t.site_name)}}catch(n){console.error("Error marking site as completed:",n),console.error("Error details:",(s=n.response)==null?void 0:s.data)}},X=async()=>{if(!c){console.error("Cannot start task: missing schedule ID");return}try{const t=(p==null?void 0:p.barangay_id)||"unknown",o=await f.post("/schedule/start",{schedule_id:c,barangay_id:t});o.data.success&&(console.log("Task started and broadcasted to residents"),$(!0),m.length>0&&await L(),o.data.data&&b(s=>({...s,...o.data.data,status:"in_progress"})))}catch(t){console.error("Failed to start task:",t)}},Y=async()=>{if(!c){console.error("Cannot complete task: missing schedule ID");return}try{(await f.post("/schedule/complete",{schedule_id:c})).data.success&&(console.log("Task completed and broadcasted to residents"),$(!1),y&&y())}catch(t){console.error("Failed to complete task:",t)}},j=()=>{_(new Set),w(0),E()},T=async()=>{if(!c){console.warn("No schedule ID provided");return}A(!0);try{let t=null;try{const o=await f.get(`/schedules/${c}`);o.data.success&&o.data.data?(t=o.data.data,b(t),console.log("Schedule data loaded:",t)):console.warn("No schedule data received from API")}catch(o){console.warn("Could not fetch schedule details:",o),t={id:c,barangay_id:"unknown",status:"pending"},b(t)}if(t!=null&&t.barangay_id&&t.barangay_id!=="unknown")try{const o=await f.get(`/barangay/${t.barangay_id}/sites?status=active`);if(o.data.success){const s=o.data.data;console.log("Sites loaded:",s.length);try{const n=await f.get(`/progress/${c}`);if(n.data.success){const e=n.data.progress,a=new Set(e.filter(r=>r.status==="finished").map(r=>r.site_id));console.log("Collection queue loaded, completed sites:",a.size),_(a);const i=s.map(r=>{var d;return{...r,collectionStatus:((d=e.find(x=>x.site_id===r.id))==null?void 0:d.status)||"unfinished"}}),u=i.find(r=>r.type==="station"),l=i.filter(r=>r.type!=="station");if(u&&(z({...u,coordinates:[parseFloat(u.longitude),parseFloat(u.latitude)]}),l.length>0)){const r=v(u,l);k(r),console.log("Nearest site to station found:",r==null?void 0:r.site_name);const d=N(u,l);C(d),w(0)}h(l)}}catch{console.warn("Could not fetch collection queue progress, using default statuses");const e=s.find(i=>i.type==="station"),a=s.filter(i=>i.type!=="station");if(e&&(z({...e,coordinates:[parseFloat(e.longitude),parseFloat(e.latitude)]}),a.length>0)){const i=v(e,a);k(i),console.log("Nearest site to station found:",i==null?void 0:i.site_name);const u=N(e,a);C(u),w(0)}h(a)}}}catch(o){console.error("Error fetching sites:",o)}else console.warn("No valid barangay_id available to fetch sites")}catch(t){console.error("Error in schedule and sites setup: ",t)}finally{A(!1)}},N=(t,o)=>{if(!t||o.length===0)return o;const s=[...o],n=[],e=s.map(l=>{const r=F(parseFloat(t.latitude),parseFloat(t.longitude),parseFloat(l.latitude),parseFloat(l.longitude));return{...l,distance:r,coordinates:[parseFloat(l.longitude),parseFloat(l.latitude)]}});e.sort((l,r)=>l.distance-r.distance);const a=e[0];n.push(a);const i=e.slice(1);let u=a;for(;i.length>0;){let l=-1,r=1/0;for(let d=0;d<i.length;d++){const x=F(parseFloat(u.latitude),parseFloat(u.longitude),parseFloat(i[d].latitude),parseFloat(i[d].longitude));x<r&&(r=x,l=d)}l!==-1&&(u=i[l],n.push(u),i.splice(l,1))}return n};return g.useEffect(()=>{T()},[c]),g.useEffect(()=>{m.length>0&&c&&(console.log("Sites loaded, initializing collection queue..."),L())},[m,c]),g.useEffect(()=>{if(!(p!=null&&p.barangay_id)||!c)return;console.log("Setting up site completion listener for barangay:",p.barangay_id);const t=`site-completion.${p.barangay_id}`,o=`site-completion-schedule.${c}`;return window.Echo.channel(t).listen("SiteCompletionUpdated",s=>{console.log("Site completion update received:",s),s.schedule_id===c&&(_(n=>{const e=new Set(n);return e.add(s.site_id),console.log("Site completion broadcast received, updated completed sites:",Array.from(e)),e}),h(n=>n.map(e=>e.id===s.site_id?{...e,collectionStatus:"finished",status:"finished",completed_at:s.completed_at}:e)),E())}),window.Echo.channel(o).listen("SiteCompletionUpdated",s=>{console.log("Schedule-specific site completion update:",s),_(n=>{const e=new Set(n);return e.add(s.site_id),e}),h(n=>n.map(e=>e.id===s.site_id?{...e,collectionStatus:"finished",status:"finished",completed_at:s.completed_at}:e)),E()}),()=>{window.Echo&&(window.Echo.leave(t),window.Echo.leave(o),console.log("Left site completion channels"))}},[p==null?void 0:p.barangay_id,c]),{siteLocations:m,stationLocation:P,activeSchedule:p,nearestSiteToStation:H,optimizedSiteOrder:S,completedSites:q,currentSiteIndex:U,isTaskActive:B,loading:W,setSiteLocations:h,setStationLocation:z,setActiveSchedule:b,setNearestSiteToStation:k,setOptimizedSiteOrder:C,setCompletedSites:_,setCurrentSiteIndex:w,setIsTaskActive:$,setLoading:A,findNearestSiteToStation:v,checkSiteProximity:Q,markSiteAsCompleted:D,startTaskAndBroadcast:X,completeTaskAndBroadcast:Y,resetCompletedSites:j,fetchScheduleAndSites:T,optimizeSiteOrderFromStation:N}};export{K as useSiteManagement};
