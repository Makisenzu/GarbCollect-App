import{r as l,a as u,S as U}from"./app-B7J0SWTz.js";const Y=({scheduleId:i,onTaskComplete:h,onTaskCancel:V,calculateDistance:y,showCompletionNotification:R,updateSiteMarkers:E,recalculateRouteFromCurrentPosition:I,currentLocation:b})=>{const[g,z]=l.useState([]),[B,v]=l.useState(null),[_,k]=l.useState(null),[D,A]=l.useState(null),[p,C]=l.useState([]),[T,F]=l.useState(new Set),[G,S]=l.useState(0),[M,w]=l.useState(!1),[Q,x]=l.useState(!1),$=(e,t)=>{if(!e||t.length===0)return null;let a=null,o=1/0;return t.forEach(s=>{if(s.longitude&&s.latitude){const n=y(parseFloat(e.latitude),parseFloat(e.longitude),parseFloat(s.latitude),parseFloat(s.longitude));n<o&&(o=n,a=s)}}),a},W=(e,t)=>{if(!e||t.length===0)return!1;const[a,o]=e;let s=!1;return t.forEach((n,c)=>{if(T.has(n.id))return;const f=parseFloat(n.longitude),r=parseFloat(n.latitude);y(o,a,r,f)<.05&&(N(n),s=!0)}),s},j=async()=>{try{console.log("Generating access token for schedule:",i);const e=await u.post("/generate-report-token",{schedule_id:i});e.data.success&&e.data.access_token?(console.log("Access token generated, redirecting to report form"),U.visit(`/driver/report/${i}?token=${e.data.access_token}`)):(console.error("Failed to generate access token:",e.data.message),alert("Failed to generate report access. Please contact support."))}catch(e){console.error("Error generating access token:",e),alert("Error generating report access. Please try again.")}},L=async()=>{var e;try{if(!g.length){console.log("No sites available to initialize collection queue");return}const t=g.map(o=>o.id);console.log("Initializing collection queue with sites:",t);const a=await u.post("/initialize",{schedule_id:i,site_id:t});a.data.success?console.log("Collection queue initialized with",a.data.total_sites,"sites"):console.error("Failed to initialize collection queue:",a.data.message)}catch(t){console.error("Error initializing collection queue:",t),console.error("Error details:",(e=t.response)==null?void 0:e.data)}},N=async(e,t)=>{console.log(`Site reached: ${e.site_name}`);try{const a=await u.post("/mark-completed",{schedule_id:i,site_id:e.id});if(a.data.success){if(F(o=>{const s=new Set(o).add(e.id);return a.data.all_completed?(console.log("ðŸŽ‰ All sites completed! Task finished."),j(),h&&h(e)):console.log(`Progress: ${a.data.completed_sites}/${a.data.total_sites} sites completed`),s}),p.length>0){const o=p.findIndex(s=>s.id===e.id);if(o!==-1&&o<p.length-1){const s=o+1;S(s);const n=p[s];console.log(`Moving to next site: ${n.site_name}`),b&&(console.log("Immediately recalculating route from current location to next site"),I(b))}else o===p.length-1&&(console.log("ðŸ Last site reached!"),S(o))}E(),R(e.site_name)}}catch(a){console.error("Error marking site as completed:",a)}},H=async()=>{if(!i){console.error("Cannot start task: missing schedule ID");return}try{const e=(_==null?void 0:_.barangay_id)||"unknown",t=await u.post("/schedule/start",{schedule_id:i,barangay_id:e});t.data.success&&(console.log("Task started and broadcasted to residents"),w(!0),g.length>0&&await L(),t.data.data&&k(a=>({...a,...t.data.data,status:"in_progress"})))}catch(e){console.error("Failed to start task:",e)}},J=async()=>{if(!i){console.error("Cannot complete task: missing schedule ID");return}try{(await u.post("/schedule/complete",{schedule_id:i})).data.success&&(console.log("Task completed and broadcasted to residents"),w(!1),h&&h())}catch(e){console.error("Failed to complete task:",e)}},K=()=>{F(new Set),S(0),E()},q=async()=>{if(!i){console.warn("No schedule ID provided");return}x(!0);try{let e=null;try{const t=await u.get(`/schedules/${i}`);t.data.success&&t.data.data?(e=t.data.data,k(e),console.log("Schedule data loaded:",e)):console.warn("No schedule data received from API")}catch(t){console.warn("Could not fetch schedule details:",t),e={id:i,barangay_id:"unknown",status:"pending"},k(e)}if(e!=null&&e.barangay_id&&e.barangay_id!=="unknown")try{const t=await u.get(`/barangay/${e.barangay_id}/sites?status=active`);if(t.data.success){const a=t.data.data;console.log("Sites loaded:",a.length);const o=a.find(n=>n.type==="station"),s=a.filter(n=>n.type!=="station");if(o&&(v({...o,coordinates:[parseFloat(o.longitude),parseFloat(o.latitude)]}),s.length>0)){const n=$(o,s);A(n),console.log("Nearest site to station found:",n==null?void 0:n.site_name);const c=O(o,s);C(c),S(0)}z(s)}}catch(t){console.error("Error fetching sites:",t)}else console.warn("No valid barangay_id available to fetch sites")}catch(e){console.error("Error in schedule and sites setup: ",e)}finally{x(!1)}},O=(e,t)=>{if(!e||t.length===0)return t;const a=[...t],o=[],s=a.map(r=>{const d=y(parseFloat(e.latitude),parseFloat(e.longitude),parseFloat(r.latitude),parseFloat(r.longitude));return{...r,distance:d,coordinates:[parseFloat(r.longitude),parseFloat(r.latitude)]}});s.sort((r,d)=>r.distance-d.distance);const n=s[0];o.push(n);const c=s.slice(1);let f=n;for(;c.length>0;){let r=-1,d=1/0;for(let m=0;m<c.length;m++){const P=y(parseFloat(f.latitude),parseFloat(f.longitude),parseFloat(c[m].latitude),parseFloat(c[m].longitude));P<d&&(d=P,r=m)}r!==-1&&(f=c[r],o.push(f),c.splice(r,1))}return o};return l.useEffect(()=>{q()},[i]),l.useEffect(()=>{g.length>0&&i&&(console.log("Sites loaded, initializing collection queue..."),L())},[g,i]),{siteLocations:g,stationLocation:B,activeSchedule:_,nearestSiteToStation:D,optimizedSiteOrder:p,completedSites:T,currentSiteIndex:G,isTaskActive:M,loading:Q,setSiteLocations:z,setStationLocation:v,setActiveSchedule:k,setNearestSiteToStation:A,setOptimizedSiteOrder:C,setCompletedSites:F,setCurrentSiteIndex:S,setIsTaskActive:w,setLoading:x,findNearestSiteToStation:$,checkSiteProximity:W,markSiteAsCompleted:N,startTaskAndBroadcast:H,completeTaskAndBroadcast:J,resetCompletedSites:K,fetchScheduleAndSites:q,optimizeSiteOrderFromStation:O}};export{Y as useSiteManagement};
