import{j as t,r as u,a as P,i as rt,g as Le}from"./app-BvmHgrQj.js";import{a as C}from"./mapbox-gl-BBpX-Y9l.js";import{h as at,i as ot,j as nt,g as it}from"./index-B2D8sayp.js";import"./iconBase-DR3plGC3.js";const lt=({isLoading:w=!1,size:y="medium",message:T="Collecting garbage..."})=>{if(!w)return null;const x={small:"w-16 h-16",medium:"w-24 h-24",large:"w-32 h-32",xlarge:"w-48 h-48"},F={small:"text-xs",medium:"text-sm",large:"text-base",xlarge:"text-lg"};return t.jsxs("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:[t.jsxs("div",{className:"bg-white rounded-2xl p-8 shadow-2xl flex flex-col items-center",children:[t.jsxs("div",{className:`relative ${x[y]} mb-4`,children:[t.jsx("div",{className:"absolute bottom-0 left-0 right-0 h-2 bg-gray-600 rounded-full"}),t.jsx("div",{className:"absolute bottom-3 left-4 w-3 h-4 bg-gray-400 rounded-sm",children:t.jsx("div",{className:"absolute -top-1 left-0.5 w-2 h-1 bg-gray-500 rounded-sm"})}),t.jsx("div",{className:"absolute bottom-3 left-8 w-3 h-5 bg-gray-400 rounded-sm",children:t.jsx("div",{className:"absolute -top-1 left-0.5 w-2 h-1 bg-gray-500 rounded-sm"})}),t.jsx("div",{className:"absolute bottom-3 left-12 w-3 h-4 bg-gray-400 rounded-sm",children:t.jsx("div",{className:"absolute -top-1 left-0.5 w-2 h-1 bg-gray-500 rounded-sm"})}),t.jsx("div",{className:"absolute bottom-2 left-0 animate-collect-garbage",children:t.jsxs("div",{className:"relative",children:[t.jsxs("div",{className:"w-6 h-4 bg-green-600 rounded-t-sm",children:[t.jsx("div",{className:"absolute top-0.5 left-1 w-3 h-1.5 bg-blue-300 rounded-sm"}),t.jsx("div",{className:"absolute bottom-0 left-1 w-1 h-0.5 bg-yellow-300 rounded-full"})]}),t.jsx("div",{className:"absolute left-6 top-1 w-8 h-3 bg-green-700 rounded-sm",children:t.jsx("div",{className:"absolute top-0.5 left-1 w-6 h-2 bg-gray-800 rounded",children:t.jsx("div",{className:"absolute -top-1 left-0 right-0 h-1 bg-gray-700 rounded-t animate-garbage-fill"})})}),t.jsx("div",{className:"absolute -bottom-1 left-1 w-2 h-2 bg-black rounded-full",children:t.jsx("div",{className:"absolute inset-0.5 w-1 h-1 bg-gray-600 rounded-full"})}),t.jsx("div",{className:"absolute -bottom-1 left-5 w-2 h-2 bg-black rounded-full",children:t.jsx("div",{className:"absolute inset-0.5 w-1 h-1 bg-gray-600 rounded-full"})}),t.jsx("div",{className:"absolute -bottom-1 left-11 w-2 h-2 bg-black rounded-full",children:t.jsx("div",{className:"absolute inset-0.5 w-1 h-1 bg-gray-600 rounded-full"})})]})}),t.jsx("div",{className:"absolute bottom-3 left-16 w-4 h-1 bg-gray-400 rounded-full animate-dust-cloud opacity-0"})]}),t.jsx("div",{className:`text-center ${F[y]} text-gray-700 font-semibold`,children:T}),t.jsxs("div",{className:"flex space-x-1 mt-2",children:[t.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-bounce",style:{animationDelay:"0ms"}}),t.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-bounce",style:{animationDelay:"150ms"}}),t.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-bounce",style:{animationDelay:"300ms"}})]})]}),t.jsx("style",{jsx:!0,children:`
        @keyframes collect-garbage {
          0% {
            transform: translateX(-20px);
          }
          20% {
            transform: translateX(40px);
          }
          40% {
            transform: translateX(80px);
          }
          60% {
            transform: translateX(120px);
          }
          80% {
            transform: translateX(160px);
          }
          100% {
            transform: translateX(200px);
          }
        }
        
        @keyframes garbage-fill {
          0%, 20% {
            height: 0px;
            opacity: 0;
          }
          25% {
            height: 1px;
            opacity: 1;
          }
          40% {
            height: 2px;
            opacity: 1;
          }
          60% {
            height: 3px;
            opacity: 1;
          }
          80% {
            height: 4px;
            opacity: 1;
          }
          100% {
            height: 4px;
            opacity: 0;
          }
        }
        
        @keyframes dust-cloud {
          0%, 60% {
            opacity: 0;
            transform: scale(0.5);
          }
          70% {
            opacity: 0.8;
            transform: scale(1);
          }
          80% {
            opacity: 0.6;
            transform: scale(1.2);
          }
          90% {
            opacity: 0.4;
            transform: scale(1.4);
          }
          100% {
            opacity: 0;
            transform: scale(1.6);
          }
        }
        
        .animate-collect-garbage {
          animation: collect-garbage 4s ease-in-out infinite;
        }
        
        .animate-garbage-fill {
          animation: garbage-fill 4s ease-in-out infinite;
        }
        
        .animate-dust-cloud {
          animation: dust-cloud 4s ease-in-out infinite;
        }
      `})]})},xt=({mapboxKey:w,barangayId:y,scheduleId:T,isFullscreen:x=!1})=>{const F=u.useRef(null),d=u.useRef(null),[O,B]=u.useState(!1),[g,_]=u.useState(!1),[j,de]=u.useState(null),[h,Me]=u.useState(null),[ue,Re]=u.useState(null),[p,q]=u.useState([]),[K,Te]=u.useState([]),[me,ee]=u.useState(navigator.onLine),[ct,fe]=u.useState(!0),[H,z]=u.useState("connecting"),[dt,I]=u.useState(null),[A,Ee]=u.useState(!1),[W,X]=u.useState(!1),[Ce,ge]=u.useState(!1),[Fe,_e]=u.useState("Loading map data..."),[he,pe]=u.useState(!0),V=(e="Loading map data...")=>{he&&(_e(e),ge(!0))},E=()=>{he&&ge(!1)},[$,G]=u.useState([]),[m,Z]=u.useState(null),[k,ze]=u.useState([]),[M,Ie]=u.useState(null),[S,De]=u.useState(null),[c,Pe]=u.useState(!1),[U,xe]=u.useState(!0),[te,ve]=u.useState(!1),[be,se]=u.useState(null),[b,ut]=u.useState(!0),D=u.useRef(null),re=u.useRef(null),[Ue,Oe]=u.useState(Date.now()),Be=()=>Date.now()-Ue<3e4,[we,qe]=u.useState({width:typeof window<"u"?window.innerWidth:1200,height:typeof window<"u"?window.innerHeight:800});u.useEffect(()=>{if(!d.current)return;const e=["mousedown","touchstart","wheel","movestart","dragstart"],s=()=>{Oe(Date.now())};return e.forEach(r=>{d.current.on(r,s)}),()=>{e.forEach(r=>{d.current&&d.current.off(r,s)})}},[d.current]),u.useEffect(()=>{const e=()=>{const s=window.innerWidth<768;Pe(s),qe({width:window.innerWidth,height:window.innerHeight}),s&&xe(!1)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),u.useEffect(()=>{const e=()=>{console.log("‚úÖ Internet connection restored"),ee(!0),X(!1),z("online")},s=()=>{console.log("‚ö†Ô∏è Internet connection lost - switching to offline mode"),ee(!1),X(!0),z("offline"),I(null)};return ee(navigator.onLine),X(!navigator.onLine),z(navigator.onLine?"online":"offline"),window.addEventListener("online",e),window.addEventListener("offline",s),()=>{window.removeEventListener("online",e),window.removeEventListener("offline",s)}},[]),u.useEffect(()=>{const e=()=>{F.current?(console.log("Map container is ready in DOM"),Ee(!0)):(console.log("Waiting for map container..."),setTimeout(e,100))};e()},[]),u.useEffect(()=>{if((()=>{const i=document.querySelector('link[href*="mapbox-gl.css"]');return i&&i.sheet?(console.log("Mapbox CSS already loaded"),B(!0),!0):!1})())return;const s=document.createElement("link");s.href="https://api.mapbox.com/mapbox-gl-js/v3.0.0/mapbox-gl.css",s.rel="stylesheet",s.type="text/css";let r;const a=()=>{clearTimeout(r),console.log("Mapbox CSS loaded successfully"),B(!0)},o=()=>{clearTimeout(r),console.warn("Mapbox CSS failed to load, continuing anyway"),B(!0)};s.onload=a,s.onerror=o,document.head.appendChild(s),r=setTimeout(()=>{console.warn("Mapbox CSS load timeout, continuing anyway"),B(!0)},5e3)},[]);const ae=e=>{if(e<60)return`${e} min`;{const s=Math.floor(e/60),r=e%60;return r===0?`${s}h`:`${s}h ${r}min`}},J=(e,s,r,a)=>{const i=(r-e)*Math.PI/180,n=(a-s)*Math.PI/180,l=Math.sin(i/2)*Math.sin(i/2)+Math.cos(e*Math.PI/180)*Math.cos(r*Math.PI/180)*Math.sin(n/2)*Math.sin(n/2);return 6371*(2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l)))},He=(e,s)=>{if(!e||s.length===0)return s;const r=[...s],a=[],o=r.map(f=>{const v=J(parseFloat(e.latitude),parseFloat(e.longitude),parseFloat(f.latitude),parseFloat(f.longitude));return{...f,distance:v,coordinates:[parseFloat(f.longitude),parseFloat(f.latitude)]}});o.sort((f,v)=>f.distance-v.distance);const i=o[0];a.push(i);const n=o.slice(1);let l=i;for(;n.length>0;){let f=-1,v=1/0;for(let N=0;N<n.length;N++){const L=J(parseFloat(l.latitude),parseFloat(l.longitude),parseFloat(n[N].latitude),parseFloat(n[N].longitude));L<v&&(v=L,f=N)}f!==-1&&(l=n[f],a.push(l),n.splice(f,1))}return a},Q=async(e,s,r=!1,a=!1)=>{if(!w||e.length<1)return;if(e.filter(i=>i.type!=="station"&&i.status!=="finished"&&i.status!=="completed").length===0){console.log("‚ö†Ô∏è All sites finished - showing original planned route"),s&&await ye(e,s,a);return}a||(ve(!0),V("Calculating optimal route...")),se(null);try{const i=e.filter(l=>l.latitude&&l.longitude&&!isNaN(parseFloat(l.latitude))&&!isNaN(parseFloat(l.longitude))&&l.type!=="station"&&l.status!=="finished"&&l.status!=="completed");if(i.length<1){console.warn("No valid unfinished sites with coordinates found"),se("No valid sites with coordinates found");return}const n=s?He(s,i):i;if(ze(n),n.length>0&&Ie(n[0]),r&&h&&n.length>0){console.log("üìç Drawing route from driver location through remaining sites");const l=[`${h[0].toFixed(6)},${h[1].toFixed(6)}`,...n.map(f=>`${parseFloat(f.longitude).toFixed(6)},${parseFloat(f.latitude).toFixed(6)}`)];try{const f=await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${l.join(";")}?access_token=${w}&geometries=geojson&overview=full&steps=true&alternatives=false&continue_straight=false&roundabout_exits=true`);if(f.ok){const v=await f.json();if(v.routes&&v.routes.length>0){const N=v.routes[0],L=Math.round(N.duration/60),Y=(N.distance/1e3).toFixed(1);G(N.geometry.coordinates),Z({duration:L,formattedDuration:ae(L),distance:Y,targetSite:n[0].site_name,isRealTime:!0,totalStops:n.length}),console.log(`‚úÖ Dynamic route: Driver ‚Üí ${n.length} remaining sites (${L}min)`),d.current&&g&&R();return}}}catch(f){console.error("Error calculating driver route:",f)}}await ye(n,s,a)}catch(i){console.error("Error calculating route:",i),se(`Route calculation failed: ${i.message}`);const n=e.filter(l=>l.latitude&&l.longitude&&!isNaN(parseFloat(l.latitude))&&!isNaN(parseFloat(l.longitude))&&l.type!=="station"&&l.status!=="finished"&&l.status!=="completed");if(n.length>0){const l=n.map(f=>[parseFloat(f.longitude),parseFloat(f.latitude)]);G(l),Z({duration:Math.round(Se(l)*2),formattedDuration:"Estimated",distance:Se(l).toFixed(1),isFallback:!0,totalStops:n.length,isRealTime:!1}),d.current&&g&&R()}}finally{a||(ve(!1),E())}},ye=async(e,s,r=!1)=>{if(!(!w||e.length<1))try{const a=[];if(s&&s.longitude&&s.latitude&&a.push(`${parseFloat(s.longitude).toFixed(6)},${parseFloat(s.latitude).toFixed(6)}`),e.forEach(n=>{n.type!=="station"&&a.push(`${parseFloat(n.longitude).toFixed(6)},${parseFloat(n.latitude).toFixed(6)}`)}),a.length<2){console.warn("Not enough coordinates for station route");return}const o=await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${a.join(";")}?access_token=${w}&geometries=geojson&overview=full&steps=true&alternatives=false&continue_straight=false`+(a.length>2?"&roundabout_exits=true":""));if(!o.ok)throw new Error(`HTTP error! status: ${o.status}`);const i=await o.json();if(i.routes&&i.routes.length>0){const n=i.routes[0],l=Math.round(n.duration/60),f=(n.distance/1e3).toFixed(1);G(n.geometry.coordinates),Z({duration:l,formattedDuration:ae(l),distance:f,totalStops:e.filter(v=>v.type!=="station").length,isRealTime:!1}),console.log(`üìã Original planned route: Station ‚Üí ${e.length} sites (${l}min)`),d.current&&g&&R()}}catch(a){console.error("Error calculating station route:",a)}},Se=e=>{let s=0;for(let r=1;r<e.length;r++){const[a,o]=e[r-1],[i,n]=e[r];s+=J(o,a,n,i)}return s},oe=async()=>{if(!(!b||!h||!k.length)){if(re.current){const[e,s]=re.current,[r,a]=h;if(J(s,e,a,r)*1e3<50)return}re.current=h,console.log("Updating complete sequential route from driver location through all sites");try{const e=[`${h[0].toFixed(6)},${h[1].toFixed(6)}`,...k.map(r=>`${parseFloat(r.longitude).toFixed(6)},${parseFloat(r.latitude).toFixed(6)}`)],s=await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${e.join(";")}?access_token=${w}&geometries=geojson&overview=full&steps=true&alternatives=false&continue_straight=false&roundabout_exits=true`);if(s.ok){const r=await s.json();if(r.routes&&r.routes.length>0){const a=r.routes[0],o=Math.round(a.duration/60),i=(a.distance/1e3).toFixed(1);G(a.geometry.coordinates),Z(n=>({...n,duration:o,formattedDuration:ae(o),distance:i,targetSite:k[0].site_name,isRealTime:!0,totalStops:k.length,lastUpdated:new Date().toLocaleTimeString()})),console.log(`Sequential route updated: Driver through ${k.length} sites (${i}km, ${o}min)`),d.current&&g&&R()}}}catch(e){console.error("Error updating real-time route:",e)}}},Ae=()=>{D.current&&clearInterval(D.current),D.current=setInterval(()=>{b&&h&&k.length>0&&oe()},2e3),console.log("Started real-time route updates")},We=()=>{D.current&&(clearInterval(D.current),D.current=null),console.log("Stopped real-time route updates")},R=()=>{if(!(!d.current||$.length===0)){if(!d.current.isStyleLoaded()){d.current.once("styledata",()=>{setTimeout(R,100)});return}["route","route-glow","route-direction","route-start","route-end","route-waypoints","driver-route","driver-route-glow"].forEach(e=>{d.current.getLayer(e)&&d.current.removeLayer(e)}),d.current.getSource("route")&&d.current.removeSource("route"),d.current.getSource("driver-route")&&d.current.removeSource("driver-route"),["route-start-marker","route-end-marker","route-waypoints-marker"].forEach(e=>{d.current.getSource(e)&&d.current.removeSource(e)});try{const e=m!=null&&m.isRealTime?"driver-route":"route",s=m!=null&&m.isRealTime?"driver-route":"route",r=m!=null&&m.isRealTime?"driver-route-glow":"route-glow";d.current.addSource(e,{type:"geojson",data:{type:"Feature",properties:{},geometry:{type:"LineString",coordinates:$}}});const a=m!=null&&m.isRealTime?"#000000":"#6B7280",o=c?6:5,i=c?14:12;d.current.addLayer({id:r,type:"line",source:e,layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":a,"line-width":i,"line-opacity":m!=null&&m.isRealTime?.4:.3,"line-blur":10}}),d.current.addLayer({id:s,type:"line",source:e,layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":a,"line-width":o,"line-opacity":.9,"line-dasharray":m!=null&&m.isRealTime?[2,1]:[1,0]}}),d.current.addLayer({id:"route-direction",type:"symbol",source:e,layout:{"symbol-placement":"line","text-field":"‚ñ∂","text-size":c?14:12,"symbol-spacing":100},paint:{"text-color":a}});const n=[];S&&S.latitude&&S.longitude&&!(m!=null&&m.isRealTime)&&n.push({coordinates:[parseFloat(S.longitude),parseFloat(S.latitude)],type:"station",sequence:0}),k.forEach((l,f)=>{l.latitude&&l.longitude&&n.push({coordinates:[parseFloat(l.longitude),parseFloat(l.latitude)],type:"site",sequence:f+1,isTarget:(m==null?void 0:m.isRealTime)&&f===0})}),n.length>0&&(d.current.addSource("route-waypoints-marker",{type:"geojson",data:{type:"FeatureCollection",features:n.map((l,f)=>({type:"Feature",geometry:{type:"Point",coordinates:l.coordinates},properties:{description:l.type==="station"?"Station":l.isTarget?`Target: ${l.sequence}`:`Site ${l.sequence}`,type:l.type,sequence:l.sequence,isTarget:l.isTarget}}))}}),d.current.addLayer({id:"route-waypoints",type:"circle",source:"route-waypoints-marker",paint:{"circle-radius":["case",["==",["get","type"],"station"],c?10:8,["==",["get","isTarget"],!0],c?12:10,c?8:6],"circle-color":["case",["==",["get","type"],"station"],"#dc2626",["==",["get","isTarget"],!0],"#10B981","#3b82f6"],"circle-stroke-width":2,"circle-stroke-color":"#ffffff"}})),!(m!=null&&m.isRealTime)&&$.length>=2&&(d.current.addSource("route-start-marker",{type:"geojson",data:{type:"Feature",geometry:{type:"Point",coordinates:$[0]},properties:{description:"Start"}}}),d.current.addSource("route-end-marker",{type:"geojson",data:{type:"Feature",geometry:{type:"Point",coordinates:$[$.length-1]},properties:{description:"End"}}}),d.current.addLayer({id:"route-start",type:"circle",source:"route-start-marker",paint:{"circle-radius":c?8:6,"circle-color":"#22c55e","circle-stroke-width":2,"circle-stroke-color":"#ffffff"}}),d.current.addLayer({id:"route-end",type:"circle",source:"route-end-marker",paint:{"circle-radius":c?8:6,"circle-color":"#ef4444","circle-stroke-width":2,"circle-stroke-color":"#ffffff"}})),setTimeout(()=>{je()},200)}catch(e){console.error("Error adding route layer:",e),setTimeout(()=>{R()},500)}}},je=()=>{if(!d.current||$.length===0||p.length===0)return;const e=new C.LngLatBounds;$.forEach(r=>{e.extend(r)}),S&&e.extend([parseFloat(S.longitude),parseFloat(S.latitude)]),p.forEach(r=>{r.longitude&&r.latitude&&e.extend([parseFloat(r.longitude),parseFloat(r.latitude)])}),h&&e.extend(h);const s=c?40:80;try{d.current.fitBounds(e,{padding:s,duration:1500,essential:!0,maxZoom:c?16:15,offset:[0,c?-50:0]})}catch(r){console.error("Error fitting map to bounds:",r)}},ne=e=>e.find(s=>s.type==="station")||null;u.useEffect(()=>(O&&w&&A&&(()=>{if(F.current&&!d.current){if(!w){I("Mapbox key is missing.");return}console.log("Starting map initialization..."),V("Initializing map...");try{C.accessToken=w;const s={container:F.current,style:"mapbox://styles/mapbox/streets-v12",center:[125.94849837776422,8.483022468128098],zoom:c?11:10.5,attributionControl:!1,interactive:!0,scrollZoom:!0,dragPan:!0,dragRotate:!1,keyboard:!1,doubleClickZoom:!c,touchZoomRotate:!0,touchPitch:!1,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!0,maxTileCacheSize:50,refreshExpiredTiles:me,transformRequest:(i,n)=>!me&&n==="Tile"?{url:i,headers:{"Cache-Control":"max-age=86400"}}:{url:i}};d.current=new C.Map(s);const r=()=>{console.log("Map loaded successfully!"),_(!0),I(null),p.length>0&&Ne(p),h&&ce(h,{}),$.length>0&&setTimeout(()=>{R()},500),b&&Ae(),E()},a=i=>{var n;if(console.error("Map error:",i),!navigator.onLine||W){console.warn("Map error suppressed - continuing in offline mode"),X(!0),I(null),g||_(!0);return}I(`Map error: ${((n=i.error)==null?void 0:n.message)||"Unknown error"}`),_(!0),E()};d.current.once("load",r),d.current.on("error",a),d.current.on("dataloading",i=>{var n;(!navigator.onLine||W)&&((n=i.preventDefault)==null||n.call(i))}),d.current.on("sourcedataloading",i=>{var n;(!navigator.onLine||W)&&((n=i.preventDefault)==null||n.call(i))});const o=setTimeout(()=>{g||(console.warn("Map load timeout - continuing anyway"),_(!0),E())},1e4);return()=>clearTimeout(o)}catch(s){console.error("Error creating map:",s),I(`Failed to create map: ${s.message}`),_(!0),E()}}})(),()=>{We(),d.current&&(console.log("Cleaning up map"),d.current.remove(),d.current=null,_(!1))}),[O,w,A,c]),u.useEffect(()=>{if(p.length>0&&S&&w&&g){if(p.filter(s=>s.type!=="station"&&s.status!=="finished"&&s.status!=="completed").length===0){console.log("‚ö†Ô∏è All sites finished - skipping route calculation");return}console.log("All data available, calculating optimal route..."),Q(p,S,b,!0)}},[p,S,w,g]),u.useEffect(()=>{if(b&&h&&k.length>0){const e=setTimeout(()=>{oe()},1e3);return()=>clearTimeout(e)}},[h,b]),u.useEffect(()=>{d.current&&$.length>0&&g&&R()},[$,g]),u.useEffect(()=>{g&&p.length>0&&(console.log("üîÑ Force updating site markers due to state change"),console.log("üìä Sites to render:",p.map(e=>({id:e.id,name:e.site_name,status:e.status}))),Ne(p))},[g,p,c,b,M]),u.useEffect(()=>{if(!(j!=null&&j.id))return;console.log("‚è∞ Starting polling for site updates every 5 seconds");const e=setInterval(async()=>{try{const s=await P.get(`/schedule/${j.id}/sites`);if(s.data.success){const r=s.data.data;if(r.some((o,i)=>{const n=p.find(l=>l.id===o.id);return n&&n.status!==o.status}))if(console.log("üîÑ POLLING: Site status changed, updating silently"),q(r),r.filter(i=>i.type!=="station"&&i.status!=="finished"&&i.status!=="completed").length>0){const i=ne(r);i&&g&&setTimeout(()=>{Q(r,i,b&&h,!0)},200)}else console.log("‚ö†Ô∏è All sites finished - no route calculation needed")}}catch(s){console.error("Polling error:",s)}},5e3);return()=>{console.log("‚è∞ Stopping site polling"),clearInterval(e)}},[j==null?void 0:j.id,p]),u.useEffect(()=>{g&&h&&(console.log("Force updating driver marker"),ce(h,{}))},[g,h,c]),u.useEffect(()=>{if(!y)return;const e=async()=>{try{console.log("Initializing Reverb connection for real-time location updates..."),rt();const a=Le();if(!a)throw new Error("Echo not initialized");a.channel(`driver-locations.${y}`).listen("DriverLocationUpdated",o=>{console.log("Real-time driver location update received:",o),z("connected"),le(o)}),a.channel(`schedule-updates.${y}`).listen("ScheduleStatusUpdated",o=>{console.log("Schedule update received:",o),Ve(o.schedule)}),a.channel(`site-completion.${y}`).listen("SiteCompletionUpdated",o=>{console.log("üéØ REALTIME: Site completion event received:",{barangay_id:y,event_data:o,site_id:o.site_id||o.siteId,status:o.status,site_name:o.site_name||o.siteName,completed_sites:o.completed_sites,total_sites:o.total_sites}),$e(o),ie()}),z("connected"),await Xe(),s()}catch(a){console.error("Realtime connection failed:",a),z("disconnected"),s()}},s=()=>{const a=setInterval(()=>{r()},1e4);return()=>clearInterval(a)},r=async()=>{try{if(T){const a=await P.get(`/schedule/${T}/driver-location`);a.data.success&&a.data.data&&le(a.data.data)}}catch(a){console.error("Error polling driver location:",a)}};return e(),()=>{const a=Le();a&&(a.leave(`driver-locations.${y}`),a.leave(`schedule-updates.${y}`),a.leave(`site-completion.${y}`))}},[y,T]);const ie=async(e=!0)=>{try{if(e||console.log("üîÑ Refreshing sites from server..."),!j||!j.id){console.warn("No current schedule available to refresh sites");return}const s=await P.get(`/schedule/${j.id}/sites`);if(s.data.success){const r=s.data.data;if(e||console.log("‚úÖ Sites refreshed from server:",r.map(o=>({id:o.id,name:o.site_name,status:o.status}))),q(r),r.filter(o=>o.type!=="station"&&o.status!=="finished"&&o.status!=="completed").length>0){const o=ne(r);o&&g&&setTimeout(()=>{Q(r,o,b&&h,!0)},200)}else console.log("‚ö†Ô∏è All sites finished - no route calculation needed")}}catch(s){console.error("Error refreshing sites from server:",s)}};u.useEffect(()=>{window.testSiteCompletion=e=>{console.log("üß™ TEST: Manually triggering site completion for site ID:",e),$e({site_id:e,status:"finished",completed_at:new Date().toISOString(),site_name:"Test Site"})},window.refreshResidentMap=()=>{console.log("üß™ TEST: Manually refreshing resident map"),ie()}},[p,j]);const Xe=async()=>{try{fe(!0),V("Loading collection sites...");const e=await P.get(`/barangay/${y}/current-schedule`);if(e.data.success){const s=e.data.data;if(de(s),s.id){const r=await P.get(`/schedule/${s.id}/sites`);if(r.data.success){const a=r.data.data;q(a);const o=ne(a);o&&(De(o),console.log("Station found:",o.site_name))}}if(T){const r=await P.get(`/schedule/${T}/driver-location`);r.data.success&&r.data.data&&le(r.data.data)}}E(),pe(!1)}catch(e){console.error("Error loading initial data:",e),E(),pe(!1)}finally{fe(!1)}},le=e=>{if(!e.longitude||!e.latitude){console.warn("Invalid location data received:",e);return}const s=[parseFloat(e.longitude),parseFloat(e.latitude)];console.log("Updating driver location on map:",s),Me(s),g&&d.current&&(ce(s,e),Be()||d.current.flyTo({center:s,zoom:c?16:15,duration:2e3,essential:!0,offset:[0,c?-100:0]}),b&&oe())},$e=e=>{console.log("üéØ PROCESSING site completion:",{received_data:e,site_id_variants:{site_id:e.site_id,siteId:e.siteId},current_sites_count:p.length}),q(s=>{console.log("üìã Current sites before update:",s.map(a=>({id:a.id,name:a.site_name,status:a.status})));const r=s.map(a=>a.id===e.site_id||a.id===e.siteId?(console.log(`‚úÖ MARKING site ${a.site_name} (ID: ${a.id}) as FINISHED`),{...a,status:"finished",collectionStatus:"finished",completed_at:e.completed_at||new Date().toISOString()}):a);return console.log("üìã Sites after update:",r.map(a=>({id:a.id,name:a.site_name,status:a.status}))),r}),setTimeout(()=>{console.log("üîÑ Refreshing sites from server"),ie()},1e3)},ce=(e,s)=>{if(!d.current||!g)return;ue&&ue.remove();const r=c?"w-12 h-12":"w-10 h-10",a=c?"w-6 h-6":"w-5 h-5",o=document.createElement("div");o.className="driver-location-marker";const n=(s.timestamp?(new Date-new Date(s.timestamp))/1e3:0)<30;o.innerHTML=`
      <div class="relative">
        <div class="${r} bg-blue-600 border-3 border-white rounded-full shadow-lg flex items-center justify-center relative z-10">
          <svg class="${a} text-white" viewBox="0 0 24 24" fill="currentColor">
            <path d="M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z"/>
            <path d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0"/>
          </svg>
          ${n?"":`
            <div class="absolute -top-1 -right-1 w-3 h-3 bg-yellow-500 rounded-full border border-white"></div>
          `}
        </div>
        <div class="absolute inset-0 bg-blue-400 rounded-full animate-ping opacity-30"></div>
        ${s.accuracy?`
          <div class="absolute inset-0 border-2 border-blue-300 rounded-full opacity-50" 
               style="transform: scale(${Math.min(s.accuracy/10,3)})"></div>
        `:""}
      </div>
    `;try{const l=new C.Marker({element:o,draggable:!1}).setLngLat(e).addTo(d.current),f=new C.Popup({offset:25,closeButton:!1,className:`custom-popup ${c?"max-w-xs":"max-w-sm"}`}).setHTML(`
        <div class="text-sm ${c?"p-2":"p-3"}">
          <div class="font-semibold text-gray-900 ${c?"text-base":""}">üöó Driver Location</div>
          <div class="text-xs text-gray-500 mt-1">
            ${s.timestamp?`Updated: ${new Date(s.timestamp).toLocaleTimeString()}`:"Live"}
          </div>
          ${s.accuracy?`
            <div class="text-xs text-gray-500 mt-1">
              Accuracy: ¬±${Math.round(s.accuracy)} meters
            </div>
          `:""}
          ${n?"":`
            <div class="text-xs text-yellow-600 mt-1 font-medium">
              ‚ö†Ô∏è Location data may be delayed
            </div>
          `}
        </div>
      `);l.setPopup(f),Re(l)}catch(l){console.error("Error creating driver marker:",l)}},Ve=e=>{de(e)},Ne=e=>{if(!d.current||!g)return;K.forEach(r=>{r&&r.remove&&r.remove()});const s=e.map((r,a)=>{if(!r.longitude||!r.latitude||r.type==="station")return null;try{const o=document.createElement("div");o.className="site-marker";const i=r.status==="completed"||r.status==="finished"||r.collectionStatus==="finished",n=r.status==="in_progress",l=r.type==="station",f=r.purok_name||r.site_name||"Site",v=b&&M&&M.id===r.id&&!i;i&&console.log(`‚úì Rendering completed site: ${r.site_name} (ID: ${r.id})`);const N=()=>l?"#DC2626":i||v?"#10B981":"#6B7280",L=()=>l?`
              <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
              </svg>
            `:i?`
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
              </svg>
            `:`
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M3 6h18"/>
                <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
              </svg>
            `,Y=c?"w-14 h-14":"w-12 h-12",Qe=c?"w-7 h-7":"w-6 h-6",Ye=c?"w-8 h-8":"w-7 h-7",ke=k.findIndex(st=>st.id===r.id)+1,Ke=ke>0;o.innerHTML=`
          <div class="relative ${n||v?"animate-pulse":""}">
            ${Ke&&!l&&!i?`
              <div class="absolute -top-2 -right-2 bg-blue-500 text-white rounded-full ${c?"w-7 h-7 text-sm":"w-6 h-6 text-xs"} flex items-center justify-center font-bold shadow-lg border-2 border-white z-20">
                ${ke}
              </div>
            `:""}
            ${l?`
              <div class="${Y} rounded-full bg-white shadow-2xl border-4 border-red-600 flex items-center justify-center">
                <div class="${Ye} text-red-600">
                  ${L()}
                </div>
              </div>
            `:`
              <div class="${Y} rounded-full border-3 border-white flex items-center justify-center shadow-lg" 
                    style="background-color: ${N()}; ${i?"opacity: 0.7;":""}">
                <div class="${Qe} text-white">
                  ${L()}
                </div>
              </div>
            `}
            ${n?'<div class="absolute inset-0 rounded-full border-3 border-yellow-500 animate-ping"></div>':""}
            ${v&&!n?'<div class="absolute inset-0 rounded-full border-3 border-green-500 animate-ping"></div>':""}
          </div>
        `;const et=[parseFloat(r.longitude),parseFloat(r.latitude)],tt=new C.Popup({offset:25,closeButton:!1,className:`custom-popup ${c?"max-w-xs":"max-w-sm"}`}).setHTML(`
          <div class="text-sm ${c?"p-2":"p-3"}">
            <div class="font-semibold text-gray-900 ${c?"text-base":""}">${f}</div>
            <div class="text-xs text-gray-500 mt-1">
              ${l?"Collection Station":i?"Completed":n?"In Progress":"Pending"}
            </div>
            ${v&&b&&'<div class="text-xs text-green-600 mt-1 font-medium">üéØ Current Target</div>'}
            ${M&&M.id===r.id&&!v&&'<div class="text-xs text-green-600 mt-1 font-medium">üìç Nearest Site</div>'}
          </div>
        `);return new C.Marker({element:o,draggable:!1}).setLngLat(et).setPopup(tt).addTo(d.current)}catch(o){return console.error("Error creating marker:",o),null}}).filter(r=>r!==null);Te(s)},Ge=async()=>{p.length>0&&S&&(V("Refreshing route..."),await Q(p,S,b))},Ze=()=>{xe(!U)},Je=()=>x?"100%":we.width<640?"400px":we.width<768?"500px":"600px";return u.useEffect(()=>{console.log("Current state:",{cssLoaded:O,mapInitialized:g,containerReady:A,siteLocationsCount:p.length,siteMarkersCount:K.length,driverLocation:!!h})},[O,g,A,p,K,h]),t.jsxs("div",{className:`${x?"w-full h-full":"w-full"} bg-white ${x?"":"rounded-lg border border-gray-200"} overflow-hidden`,children:[t.jsx(lt,{isLoading:Ce,message:Fe,size:c?"medium":"large",variant:"default"}),W&&t.jsxs("div",{className:"absolute top-0 left-0 right-0 bg-yellow-500 text-black px-4 py-2 z-50 flex items-center justify-center gap-2 shadow-lg",children:[t.jsx(at,{className:"w-5 h-5"}),t.jsx("span",{className:"font-semibold text-sm",children:"Offline Mode - Using cached map data"})]}),t.jsxs("div",{className:`relative w-full ${x?"h-full":""}`,style:{height:x?"100%":Je()},children:[t.jsx("div",{ref:F,className:"w-full h-full absolute inset-0"}),g&&t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:`absolute ${c?"bottom-2 left-2":"bottom-4 left-4"} bg-white/95 backdrop-blur-sm rounded-lg shadow-lg border border-gray-200 ${c?"p-2":"p-3"} z-10 ${c?"min-w-40 max-w-48":x?"min-w-52":"min-w-48"}`,children:[t.jsxs("div",{className:`font-semibold ${c?"text-xs":"text-sm"} text-gray-900 ${c?"mb-2":"mb-3"} flex items-center justify-between`,children:[t.jsx("span",{children:"Legend"}),x&&!c&&t.jsx("span",{className:"text-xs font-normal text-gray-500",children:"Live Tracking"})]}),t.jsxs("div",{className:`space-y-1 ${c?"text-xs":"text-sm"}`,children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("div",{className:"w-4 h-4 bg-blue-600 rounded-full flex items-center justify-center flex-shrink-0 relative",children:t.jsx("div",{className:"absolute inset-0 bg-blue-400 rounded-full animate-ping opacity-30"})}),t.jsx("span",{className:"text-gray-700",children:"Driver"})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("div",{className:"w-4 h-4 bg-red-600 rounded-full flex-shrink-0"}),t.jsx("span",{className:"text-gray-700",children:"Station"})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("div",{className:"w-4 h-4 bg-gray-500 rounded-full flex-shrink-0"}),t.jsx("span",{className:"text-gray-700",children:"Pending"})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("div",{className:"w-4 h-4 bg-green-600 rounded-full flex-shrink-0"}),t.jsx("span",{className:"text-gray-700",children:"Completed"})]}),b&&M&&t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("div",{className:"w-4 h-4 bg-green-500 rounded-full flex-shrink-0 relative",children:t.jsx("div",{className:"absolute inset-0 rounded-full border-2 border-white animate-ping"})}),t.jsx("span",{className:"text-gray-700",children:"Target Site"})]}),m&&t.jsxs("div",{className:"flex items-center gap-2 pt-1 border-t border-gray-200",children:[t.jsx("div",{className:"w-4 h-1 rounded-full flex-shrink-0",style:{backgroundColor:m.isRealTime?"#000000":"#6B7280"}}),t.jsx("span",{className:"text-gray-700",children:m.isRealTime?"Live Route":"Planned Route"})]})]})]}),t.jsxs("div",{className:`absolute ${c?"top-2 right-2":"top-4 right-4"} flex ${x&&!c?"flex-row gap-2":"flex-col gap-2"} z-10`,children:[t.jsx("button",{onClick:Ge,disabled:te,className:`${x?"bg-white/95 backdrop-blur-sm":"bg-white"} rounded-lg shadow-lg border border-gray-200 hover:bg-gray-50 transition-colors flex items-center justify-center ${c?"p-2":"p-3"} ${te?"opacity-50 cursor-not-allowed":""}`,title:"Refresh route",children:te?t.jsx("div",{className:`animate-spin rounded-full border-b-2 border-gray-700 ${c?"w-4 h-4":"w-5 h-5"}`}):t.jsx(ot,{className:`text-gray-700 ${c?"w-4 h-4":"w-5 h-5"}`})}),t.jsx("button",{onClick:Ze,className:`${x?"bg-white/95 backdrop-blur-sm":"bg-white"} rounded-lg shadow-lg border ${U?"border-blue-500 bg-blue-50":"border-gray-200"} hover:bg-gray-50 transition-colors flex items-center justify-center ${c?"p-2":"p-3"}`,title:U?"Hide route info":"Show route info",children:t.jsx(nt,{className:`${U?"text-blue-600":"text-gray-700"} ${c?"w-4 h-4":"w-5 h-5"}`})}),t.jsx("button",{onClick:je,className:`${x?"bg-white/95 backdrop-blur-sm":"bg-white"} rounded-lg shadow-lg border border-gray-200 hover:bg-gray-50 transition-colors flex items-center justify-center ${c?"p-2":"p-3"}`,title:"Fit to route",children:t.jsx(it,{className:`text-gray-700 ${c?"w-4 h-4":"w-5 h-5"}`})})]}),t.jsx("div",{className:`absolute ${c?"top-2 left-2":"top-4 left-4"} bg-white/95 backdrop-blur-sm rounded-lg shadow-lg border border-gray-200 ${c?"px-2 py-1":"px-3 py-2"} z-10`,children:t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("div",{className:`w-2 h-2 rounded-full ${H==="connected"?"bg-green-500":H==="connecting"?"bg-yellow-500":"bg-red-500"} ${H==="connected"?"animate-pulse":""}`}),t.jsx("span",{className:`font-medium text-gray-700 capitalize ${c?"text-xs":"text-sm"}`,children:H})]})}),m&&U&&t.jsxs("div",{className:`absolute ${c?"top-12 left-2 right-2":x?"top-4 left-1/2 transform -translate-x-1/2":"top-16 left-4"} bg-white/95 backdrop-blur-sm rounded-lg shadow-lg border border-gray-200 ${c?"p-3":"p-4"} z-10 ${c?"":x?"min-w-80 max-w-md":"min-w-64"}`,children:[t.jsxs("div",{className:`font-semibold text-gray-900 ${c?"text-sm mb-2":"text-base mb-3"} flex items-center justify-between`,children:[t.jsx("span",{children:m.isRealTime?"Live Route":"Planned Route"}),t.jsxs("div",{className:"flex gap-1",children:[m.isRealTime&&t.jsxs("span",{className:"text-xs bg-green-100 text-green-800 px-2 py-1 rounded flex items-center gap-1",children:[t.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-pulse"}),"Live"]}),m.isFallback&&t.jsx("span",{className:"text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded",children:"Estimated"})]})]}),t.jsxs("div",{className:`space-y-2 ${c?"text-xs":"text-sm"} text-gray-600`,children:[t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsx("span",{children:"Estimated Time:"}),t.jsx("span",{className:"font-semibold text-blue-600",children:m.formattedDuration})]}),t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsx("span",{children:"Distance:"}),t.jsxs("span",{className:"font-semibold",children:[m.distance," km"]})]}),t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsx("span",{children:"Total Stops:"}),t.jsxs("span",{className:"font-semibold",children:[m.totalStops," sites"]})]}),m.targetSite&&t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsx("span",{children:"Target Site:"}),t.jsx("span",{className:"font-semibold text-green-600",children:m.targetSite})]}),M&&!m.targetSite&&t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsx("span",{children:"Nearest Site:"}),t.jsx("span",{className:"font-semibold text-green-600",children:M.site_name})]}),m.lastUpdated&&t.jsxs("div",{className:"flex justify-between items-center text-xs text-gray-500",children:[t.jsx("span",{children:"Last Updated:"}),t.jsx("span",{children:m.lastUpdated})]})]}),be&&t.jsx("div",{className:`mt-2 p-2 bg-red-50 border border-red-200 rounded ${c?"text-xs":"text-sm"} text-red-600`,children:be})]})]})]})]})};export{xt as default};
