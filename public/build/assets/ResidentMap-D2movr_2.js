import{j as e,r as d,a as P,i as Ye,g as Fe}from"./app-Cc2yil4n.js";import{a as C}from"./mapbox-gl-BDCb7C5Y.js";import{h as Ke,i as et,j as tt,g as st}from"./index-DWIXb_JG.js";import"./iconBase-Cb3GE4JV.js";const at=({isLoading:y=!1,size:j="medium",message:_="Collecting garbage..."})=>{if(!y)return null;const b={small:"w-16 h-16",medium:"w-24 h-24",large:"w-32 h-32",xlarge:"w-48 h-48"},B={small:"text-xs",medium:"text-sm",large:"text-base",xlarge:"text-lg"};return e.jsxs("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:[e.jsxs("div",{className:"bg-white rounded-2xl p-8 shadow-2xl flex flex-col items-center",children:[e.jsxs("div",{className:`relative ${b[j]} mb-4`,children:[e.jsx("div",{className:"absolute bottom-0 left-0 right-0 h-2 bg-gray-600 rounded-full"}),e.jsx("div",{className:"absolute bottom-3 left-4 w-3 h-4 bg-gray-400 rounded-sm",children:e.jsx("div",{className:"absolute -top-1 left-0.5 w-2 h-1 bg-gray-500 rounded-sm"})}),e.jsx("div",{className:"absolute bottom-3 left-8 w-3 h-5 bg-gray-400 rounded-sm",children:e.jsx("div",{className:"absolute -top-1 left-0.5 w-2 h-1 bg-gray-500 rounded-sm"})}),e.jsx("div",{className:"absolute bottom-3 left-12 w-3 h-4 bg-gray-400 rounded-sm",children:e.jsx("div",{className:"absolute -top-1 left-0.5 w-2 h-1 bg-gray-500 rounded-sm"})}),e.jsx("div",{className:"absolute bottom-2 left-0 animate-collect-garbage",children:e.jsxs("div",{className:"relative",children:[e.jsxs("div",{className:"w-6 h-4 bg-green-600 rounded-t-sm",children:[e.jsx("div",{className:"absolute top-0.5 left-1 w-3 h-1.5 bg-blue-300 rounded-sm"}),e.jsx("div",{className:"absolute bottom-0 left-1 w-1 h-0.5 bg-yellow-300 rounded-full"})]}),e.jsx("div",{className:"absolute left-6 top-1 w-8 h-3 bg-green-700 rounded-sm",children:e.jsx("div",{className:"absolute top-0.5 left-1 w-6 h-2 bg-gray-800 rounded",children:e.jsx("div",{className:"absolute -top-1 left-0 right-0 h-1 bg-gray-700 rounded-t animate-garbage-fill"})})}),e.jsx("div",{className:"absolute -bottom-1 left-1 w-2 h-2 bg-black rounded-full",children:e.jsx("div",{className:"absolute inset-0.5 w-1 h-1 bg-gray-600 rounded-full"})}),e.jsx("div",{className:"absolute -bottom-1 left-5 w-2 h-2 bg-black rounded-full",children:e.jsx("div",{className:"absolute inset-0.5 w-1 h-1 bg-gray-600 rounded-full"})}),e.jsx("div",{className:"absolute -bottom-1 left-11 w-2 h-2 bg-black rounded-full",children:e.jsx("div",{className:"absolute inset-0.5 w-1 h-1 bg-gray-600 rounded-full"})})]})}),e.jsx("div",{className:"absolute bottom-3 left-16 w-4 h-1 bg-gray-400 rounded-full animate-dust-cloud opacity-0"})]}),e.jsx("div",{className:`text-center ${B[j]} text-gray-700 font-semibold`,children:_}),e.jsxs("div",{className:"flex space-x-1 mt-2",children:[e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-bounce",style:{animationDelay:"0ms"}}),e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-bounce",style:{animationDelay:"150ms"}}),e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-bounce",style:{animationDelay:"300ms"}})]})]}),e.jsx("style",{jsx:!0,children:`
        @keyframes collect-garbage {
          0% {
            transform: translateX(-20px);
          }
          20% {
            transform: translateX(40px);
          }
          40% {
            transform: translateX(80px);
          }
          60% {
            transform: translateX(120px);
          }
          80% {
            transform: translateX(160px);
          }
          100% {
            transform: translateX(200px);
          }
        }
        
        @keyframes garbage-fill {
          0%, 20% {
            height: 0px;
            opacity: 0;
          }
          25% {
            height: 1px;
            opacity: 1;
          }
          40% {
            height: 2px;
            opacity: 1;
          }
          60% {
            height: 3px;
            opacity: 1;
          }
          80% {
            height: 4px;
            opacity: 1;
          }
          100% {
            height: 4px;
            opacity: 0;
          }
        }
        
        @keyframes dust-cloud {
          0%, 60% {
            opacity: 0;
            transform: scale(0.5);
          }
          70% {
            opacity: 0.8;
            transform: scale(1);
          }
          80% {
            opacity: 0.6;
            transform: scale(1.2);
          }
          90% {
            opacity: 0.4;
            transform: scale(1.4);
          }
          100% {
            opacity: 0;
            transform: scale(1.6);
          }
        }
        
        .animate-collect-garbage {
          animation: collect-garbage 4s ease-in-out infinite;
        }
        
        .animate-garbage-fill {
          animation: garbage-fill 4s ease-in-out infinite;
        }
        
        .animate-dust-cloud {
          animation: dust-cloud 4s ease-in-out infinite;
        }
      `})]})},ee={Alegria:"#FF5733","Barangay 1":"#33FF57","Barangay 2":"#3357FF","Barangay 3":"#F033FF","Barangay 4":"#FF33F0","Barangay 5":"#33FFF0","Bayugan 2":"#8A2BE2","Bitan-agan":"#A52A2A",Borbon:"#DEB887",Buenasuerte:"#5F9EA0",Caimpugan:"#7FFF00","Das-agan":"#D2691E",Ebro:"#FF7F50",Hubang:"#6495ED",Karaus:"#DC143C",Ladgadan:"#00FFFF",Lapinigan:"#00008B",Lucac:"#008B8B",Mate:"#B8860B","New Visayas":"#006400",Ormaca:"#8B008B",Pasta:"#556B2F","Pisa-an":"#FF8C00",Rizal:"#9932CC","San Isidro":"#8FBC8F","Santa Ana":"#483D8B",Tagapua:"#2F4F4F","San Francisco":"#FFE659",_default:"#4F262A"},gt=({mapboxKey:y,barangayId:j,scheduleId:_,isFullscreen:b=!1})=>{const B=d.useRef(null),i=d.useRef(null),[q,H]=d.useState(!1),[h,U]=d.useState(!1),[w,ge]=d.useState(null),[p,ke]=d.useState(null),[fe,Me]=d.useState(null),[x,O]=d.useState([]),[te,Le]=d.useState([]),[rt,ot]=d.useState(!0),[nt,pe]=d.useState(!0),[W,se]=d.useState("connecting"),[he,V]=d.useState(null),[X,Re]=d.useState(!1),[Ee,xe]=d.useState(!1),[Te,Ce]=d.useState("Loading map data..."),G=(t="Loading map data...")=>{Ce(t),xe(!0)},z=()=>{xe(!1)},[F,Z]=d.useState([]),[u,J]=d.useState(null),[L,_e]=d.useState([]),[R,ze]=d.useState(null),[$,Be]=d.useState(null),[n,De]=d.useState(!1),[A,be]=d.useState(!0),[ae,ve]=d.useState(!1),[we,re]=d.useState(null),[S,it]=d.useState(!0),D=d.useRef(null),oe=d.useRef(null),[Ie,Pe]=d.useState(Date.now()),Ue=()=>Date.now()-Ie<3e4,[ye,Ae]=d.useState({width:typeof window<"u"?window.innerWidth:1200,height:typeof window<"u"?window.innerHeight:800});d.useEffect(()=>{if(!i.current)return;const t=["mousedown","touchstart","wheel","movestart","dragstart"],a=()=>{Pe(Date.now())};return t.forEach(s=>{i.current.on(s,a)}),()=>{t.forEach(s=>{i.current&&i.current.off(s,a)})}},[i.current]),d.useEffect(()=>{const t=()=>{const a=window.innerWidth<768;De(a),Ae({width:window.innerWidth,height:window.innerHeight}),a&&be(!1)};return t(),window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)},[]),d.useEffect(()=>{y&&(console.log("Setting Mapbox access token"),C.accessToken=y)},[y]),d.useEffect(()=>{const t=()=>{B.current?(console.log("Map container is ready in DOM"),Re(!0)):(console.log("Waiting for map container..."),setTimeout(t,100))};t()},[]),d.useEffect(()=>{if((()=>{const c=document.querySelector('link[href*="mapbox-gl.css"]');return c&&c.sheet?(console.log("Mapbox CSS already loaded"),H(!0),!0):!1})())return;const a=document.createElement("link");a.href="https://api.mapbox.com/mapbox-gl-js/v3.0.0/mapbox-gl.css",a.rel="stylesheet",a.type="text/css";let s;const o=()=>{clearTimeout(s),console.log("Mapbox CSS loaded successfully"),H(!0)},r=()=>{clearTimeout(s),console.warn("Mapbox CSS failed to load, continuing anyway"),H(!0)};a.onload=o,a.onerror=r,document.head.appendChild(a),s=setTimeout(()=>{console.warn("Mapbox CSS load timeout, continuing anyway"),H(!0)},5e3)},[]);const ne=t=>{if(t<60)return`${t} min`;{const a=Math.floor(t/60),s=t%60;return s===0?`${a}h`:`${a}h ${s}min`}},Q=(t,a,s,o)=>{const c=(s-t)*Math.PI/180,g=(o-a)*Math.PI/180,l=Math.sin(c/2)*Math.sin(c/2)+Math.cos(t*Math.PI/180)*Math.cos(s*Math.PI/180)*Math.sin(g/2)*Math.sin(g/2);return 6371*(2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l)))},qe=(t,a)=>{if(!t||a.length===0)return a;const s=[...a],o=[],r=s.map(m=>{const v=Q(parseFloat(t.latitude),parseFloat(t.longitude),parseFloat(m.latitude),parseFloat(m.longitude));return{...m,distance:v,coordinates:[parseFloat(m.longitude),parseFloat(m.latitude)]}});r.sort((m,v)=>m.distance-v.distance);const c=r[0];o.push(c);const g=r.slice(1);let l=c;for(;g.length>0;){let m=-1,v=1/0;for(let k=0;k<g.length;k++){const M=Q(parseFloat(l.latitude),parseFloat(l.longitude),parseFloat(g[k].latitude),parseFloat(g[k].longitude));M<v&&(v=M,m=k)}m!==-1&&(l=g[m],o.push(l),g.splice(m,1))}return o},Y=async(t,a,s=!1,o=!1)=>{if(!y||t.length<1)return;if(t.filter(c=>c.type!=="station"&&c.status!=="finished"&&c.status!=="completed").length===0){console.log("‚ö†Ô∏è All sites finished - no route to calculate");return}o||(ve(!0),G("Calculating optimal route...")),re(null);try{const c=t.filter(f=>f.latitude&&f.longitude&&!isNaN(parseFloat(f.latitude))&&!isNaN(parseFloat(f.longitude)));if(c.length<1){console.warn("No valid sites with coordinates found"),re("No valid sites with coordinates found");return}const g=c.filter(f=>f.type==="station"||f.status!=="finished"&&f.status!=="completed"),l=a?qe(a,g.filter(f=>f.type!=="station")):g.filter(f=>f.type!=="station");if(_e(l),l.length>0&&ze(l[0]),s&&p&&l.length>0){const f=[`${p[0].toFixed(6)},${p[1].toFixed(6)}`,...l.map(N=>`${parseFloat(N.longitude).toFixed(6)},${parseFloat(N.latitude).toFixed(6)}`)];try{const N=await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${f.join(";")}?access_token=${y}&geometries=geojson&overview=full&steps=true&alternatives=false&continue_straight=false&roundabout_exits=true`);if(N.ok){const T=await N.json();if(T.routes&&T.routes.length>0){const I=T.routes[0],K=Math.round(I.duration/60),me=(I.distance/1e3).toFixed(1);Z(I.geometry.coordinates),J({duration:K,formattedDuration:ne(K),distance:me,targetSite:l[0].site_name,isRealTime:!0,totalStops:l.length}),console.log(`Complete sequential route calculated from driver through ${l.length} sites`),i.current&&h&&E();return}}}catch(N){console.error("Error calculating driver sequential route:",N)}}let m=[];a?m=[`${parseFloat(a.longitude).toFixed(6)},${parseFloat(a.latitude).toFixed(6)}`,...l.map(f=>`${parseFloat(f.longitude).toFixed(6)},${parseFloat(f.latitude).toFixed(6)}`)]:m=l.map(f=>`${parseFloat(f.longitude).toFixed(6)},${parseFloat(f.latitude).toFixed(6)}`);const v=m.length>2,k=await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${m.join(";")}?access_token=${y}&geometries=geojson&overview=full&steps=true&alternatives=false&continue_straight=false`+(v?"&roundabout_exits=true":""));if(!k.ok)throw new Error(`HTTP error! status: ${k.status}`);const M=await k.json();if(M.routes&&M.routes.length>0){const f=M.routes[0];if(f.geometry&&f.geometry.coordinates){const N=Math.round(f.duration/60),T=(f.distance/1e3).toFixed(1);Z(f.geometry.coordinates),J({duration:N,formattedDuration:ne(N),distance:T,rawData:f,totalStops:l.length,isRealTime:!1}),console.log(`Station route calculated: ${N}min, ${T}km`),i.current&&h&&E()}else throw new Error("Invalid route geometry received")}else throw new Error(M.message||"No routes found")}catch(c){console.error("Error calculating route:",c),re(`Route calculation failed: ${c.message}`);const g=t.filter(l=>l.latitude&&l.longitude&&!isNaN(parseFloat(l.latitude))&&!isNaN(parseFloat(l.longitude)));if(g.length>0){const l=g.map(m=>[parseFloat(m.longitude),parseFloat(m.latitude)]);Z(l),J({duration:Math.round(Se(l)*2),formattedDuration:"Estimated",distance:Se(l).toFixed(1),isFallback:!0,totalStops:g.length,isRealTime:!1}),i.current&&h&&E()}}finally{o||(ve(!1),z())}},Se=t=>{let a=0;for(let s=1;s<t.length;s++){const[o,r]=t[s-1],[c,g]=t[s];a+=Q(r,o,g,c)}return a},ie=async()=>{if(!(!S||!p||!L.length)){if(oe.current){const[t,a]=oe.current,[s,o]=p;if(Q(a,t,o,s)*1e3<50)return}oe.current=p,console.log("Updating complete sequential route from driver location through all sites");try{const t=[`${p[0].toFixed(6)},${p[1].toFixed(6)}`,...L.map(s=>`${parseFloat(s.longitude).toFixed(6)},${parseFloat(s.latitude).toFixed(6)}`)],a=await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${t.join(";")}?access_token=${y}&geometries=geojson&overview=full&steps=true&alternatives=false&continue_straight=false&roundabout_exits=true`);if(a.ok){const s=await a.json();if(s.routes&&s.routes.length>0){const o=s.routes[0],r=Math.round(o.duration/60),c=(o.distance/1e3).toFixed(1);Z(o.geometry.coordinates),J(g=>({...g,duration:r,formattedDuration:ne(r),distance:c,targetSite:L[0].site_name,isRealTime:!0,totalStops:L.length,lastUpdated:new Date().toLocaleTimeString()})),console.log(`Sequential route updated: Driver through ${L.length} sites (${c}km, ${r}min)`),i.current&&h&&E()}}}catch(t){console.error("Error updating real-time route:",t)}}},He=()=>{D.current&&clearInterval(D.current),D.current=setInterval(()=>{S&&p&&L.length>0&&ie()},2e3),console.log("Started real-time route updates")},Oe=()=>{D.current&&(clearInterval(D.current),D.current=null),console.log("Stopped real-time route updates")},E=()=>{if(!(!i.current||F.length===0)){if(!i.current.isStyleLoaded()){i.current.once("styledata",()=>{setTimeout(E,100)});return}["route","route-glow","route-direction","route-start","route-end","route-waypoints","driver-route","driver-route-glow"].forEach(t=>{i.current.getLayer(t)&&i.current.removeLayer(t)}),i.current.getSource("route")&&i.current.removeSource("route"),i.current.getSource("driver-route")&&i.current.removeSource("driver-route"),["route-start-marker","route-end-marker","route-waypoints-marker"].forEach(t=>{i.current.getSource(t)&&i.current.removeSource(t)});try{const t=u!=null&&u.isRealTime?"driver-route":"route",a=u!=null&&u.isRealTime?"driver-route":"route",s=u!=null&&u.isRealTime?"driver-route-glow":"route-glow";i.current.addSource(t,{type:"geojson",data:{type:"Feature",properties:{},geometry:{type:"LineString",coordinates:F}}});const o=(w==null?void 0:w.barangay_name)||"San Francisco",r=u!=null&&u.isRealTime?"#10B981":ee[o]||ee._default,c=n?6:5,g=n?14:12;i.current.addLayer({id:s,type:"line",source:t,layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":r,"line-width":g,"line-opacity":u!=null&&u.isRealTime?.4:.3,"line-blur":10}}),i.current.addLayer({id:a,type:"line",source:t,layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":r,"line-width":c,"line-opacity":.9,"line-dasharray":u!=null&&u.isRealTime?[2,1]:[1,0]}}),i.current.addLayer({id:"route-direction",type:"symbol",source:t,layout:{"symbol-placement":"line","text-field":"‚ñ∂","text-size":n?14:12,"symbol-spacing":100},paint:{"text-color":r}});const l=[];$&&$.latitude&&$.longitude&&!(u!=null&&u.isRealTime)&&l.push({coordinates:[parseFloat($.longitude),parseFloat($.latitude)],type:"station",sequence:0}),L.forEach((m,v)=>{m.latitude&&m.longitude&&l.push({coordinates:[parseFloat(m.longitude),parseFloat(m.latitude)],type:"site",sequence:v+1,isTarget:(u==null?void 0:u.isRealTime)&&v===0})}),l.length>0&&(i.current.addSource("route-waypoints-marker",{type:"geojson",data:{type:"FeatureCollection",features:l.map((m,v)=>({type:"Feature",geometry:{type:"Point",coordinates:m.coordinates},properties:{description:m.type==="station"?"Station":m.isTarget?`Target: ${m.sequence}`:`Site ${m.sequence}`,type:m.type,sequence:m.sequence,isTarget:m.isTarget}}))}}),i.current.addLayer({id:"route-waypoints",type:"circle",source:"route-waypoints-marker",paint:{"circle-radius":["case",["==",["get","type"],"station"],n?10:8,["==",["get","isTarget"],!0],n?12:10,n?8:6],"circle-color":["case",["==",["get","type"],"station"],"#dc2626",["==",["get","isTarget"],!0],"#10B981","#3b82f6"],"circle-stroke-width":2,"circle-stroke-color":"#ffffff"}})),!(u!=null&&u.isRealTime)&&F.length>=2&&(i.current.addSource("route-start-marker",{type:"geojson",data:{type:"Feature",geometry:{type:"Point",coordinates:F[0]},properties:{description:"Start"}}}),i.current.addSource("route-end-marker",{type:"geojson",data:{type:"Feature",geometry:{type:"Point",coordinates:F[F.length-1]},properties:{description:"End"}}}),i.current.addLayer({id:"route-start",type:"circle",source:"route-start-marker",paint:{"circle-radius":n?8:6,"circle-color":"#22c55e","circle-stroke-width":2,"circle-stroke-color":"#ffffff"}}),i.current.addLayer({id:"route-end",type:"circle",source:"route-end-marker",paint:{"circle-radius":n?8:6,"circle-color":"#ef4444","circle-stroke-width":2,"circle-stroke-color":"#ffffff"}})),setTimeout(()=>{je()},200)}catch(t){console.error("Error adding route layer:",t),setTimeout(()=>{E()},500)}}},je=()=>{if(!i.current||F.length===0||x.length===0)return;const t=new C.LngLatBounds;F.forEach(s=>{t.extend(s)}),$&&t.extend([parseFloat($.longitude),parseFloat($.latitude)]),x.forEach(s=>{s.longitude&&s.latitude&&t.extend([parseFloat(s.longitude),parseFloat(s.latitude)])}),p&&t.extend(p);const a=n?40:80;try{i.current.fitBounds(t,{padding:a,duration:1500,essential:!0,maxZoom:n?16:15,offset:[0,n?-50:0]})}catch(s){console.error("Error fitting map to bounds:",s)}},le=t=>t.find(a=>a.type==="station")||null;d.useEffect(()=>(q&&y&&X&&(()=>{if(B.current&&!i.current){if(!y){V("Mapbox key is missing.");return}console.log("Starting map initialization..."),G("Initializing map...");try{C.accessToken=y,i.current=new C.Map({container:B.current,style:"mapbox://styles/mapbox/streets-v12",center:[125.94849837776422,8.483022468128098],zoom:n?11:10.5,attributionControl:!1,interactive:!0,scrollZoom:!0,dragPan:!0,dragRotate:!1,keyboard:!1,doubleClickZoom:!n,touchZoomRotate:!0,touchPitch:!1,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!0});const a=()=>{console.log("Map loaded successfully!"),U(!0),V(null),x.length>0&&Ne(x),p&&ue(p,{}),F.length>0&&setTimeout(()=>{E()},500),S&&He(),z()},s=r=>{var c;console.error("Map error:",r),V(`Map error: ${((c=r.error)==null?void 0:c.message)||"Unknown error"}`),U(!0),z()};i.current.once("load",a),i.current.on("error",s);const o=setTimeout(()=>{h||(console.warn("Map load timeout - continuing anyway"),U(!0),z())},1e4);return()=>clearTimeout(o)}catch(a){console.error("Error creating map:",a),V(`Failed to create map: ${a.message}`),U(!0),z()}}})(),()=>{Oe(),i.current&&(console.log("Cleaning up map"),i.current.remove(),i.current=null,U(!1))}),[q,y,X,n]),d.useEffect(()=>{if(x.length>0&&$&&y&&h){if(x.filter(a=>a.type!=="station"&&a.status!=="finished"&&a.status!=="completed").length===0){console.log("‚ö†Ô∏è All sites finished - skipping route calculation");return}console.log("All data available, calculating optimal route..."),Y(x,$,S,!0)}},[x,$,y,h]),d.useEffect(()=>{if(S&&p&&L.length>0){const t=setTimeout(()=>{ie()},1e3);return()=>clearTimeout(t)}},[p,S]),d.useEffect(()=>{i.current&&F.length>0&&h&&E()},[F,h]),d.useEffect(()=>{h&&x.length>0&&(console.log("üîÑ Force updating site markers due to state change"),console.log("üìä Sites to render:",x.map(t=>({id:t.id,name:t.site_name,status:t.status}))),Ne(x))},[h,x,n,S,R]),d.useEffect(()=>{if(!(w!=null&&w.id))return;console.log("‚è∞ Starting polling for site updates every 5 seconds");const t=setInterval(async()=>{try{const a=await P.get(`/schedule/${w.id}/sites`);if(a.data.success){const s=a.data.data;if(s.some((r,c)=>{const g=x.find(l=>l.id===r.id);return g&&g.status!==r.status}))if(console.log("üîÑ POLLING: Site status changed, updating silently"),O(s),s.filter(c=>c.type!=="station"&&c.status!=="finished"&&c.status!=="completed").length>0){const c=le(s);c&&h&&setTimeout(()=>{Y(s,c,S&&p,!0)},200)}else console.log("‚ö†Ô∏è All sites finished - no route calculation needed")}}catch(a){console.error("Polling error:",a)}},5e3);return()=>{console.log("‚è∞ Stopping site polling"),clearInterval(t)}},[w==null?void 0:w.id,x]),d.useEffect(()=>{h&&p&&(console.log("Force updating driver marker"),ue(p,{}))},[h,p,n]),d.useEffect(()=>{if(!j)return;const t=async()=>{try{console.log("Initializing Reverb connection for real-time location updates..."),Ye();const o=Fe();if(!o)throw new Error("Echo not initialized");o.channel(`driver-locations.${j}`).listen("DriverLocationUpdated",r=>{console.log("Real-time driver location update received:",r),se("connected"),de(r)}),o.channel(`schedule-updates.${j}`).listen("ScheduleStatusUpdated",r=>{console.log("Schedule update received:",r),Ve(r.schedule)}),o.channel(`site-completion.${j}`).listen("SiteCompletionUpdated",r=>{console.log("üéØ REALTIME: Site completion event received:",{barangay_id:j,event_data:r,site_id:r.site_id||r.siteId,status:r.status,site_name:r.site_name||r.siteName,completed_sites:r.completed_sites,total_sites:r.total_sites}),$e(r),ce()}),se("connected"),await We(),a()}catch(o){console.error("Realtime connection failed:",o),se("disconnected"),a()}},a=()=>{const o=setInterval(()=>{s()},1e4);return()=>clearInterval(o)},s=async()=>{try{if(_){const o=await P.get(`/schedule/${_}/driver-location`);o.data.success&&o.data.data&&de(o.data.data)}}catch(o){console.error("Error polling driver location:",o)}};return t(),()=>{const o=Fe();o&&(o.leave(`driver-locations.${j}`),o.leave(`schedule-updates.${j}`),o.leave(`site-completion.${j}`))}},[j,_]);const ce=async(t=!0)=>{try{if(t||console.log("üîÑ Refreshing sites from server..."),!w||!w.id){console.warn("No current schedule available to refresh sites");return}const a=await P.get(`/schedule/${w.id}/sites`);if(a.data.success){const s=a.data.data;if(t||console.log("‚úÖ Sites refreshed from server:",s.map(r=>({id:r.id,name:r.site_name,status:r.status}))),O(s),s.filter(r=>r.type!=="station"&&r.status!=="finished"&&r.status!=="completed").length>0){const r=le(s);r&&h&&setTimeout(()=>{Y(s,r,S&&p,!0)},200)}else console.log("‚ö†Ô∏è All sites finished - no route calculation needed")}}catch(a){console.error("Error refreshing sites from server:",a)}};d.useEffect(()=>{window.testSiteCompletion=t=>{console.log("üß™ TEST: Manually triggering site completion for site ID:",t),$e({site_id:t,status:"finished",completed_at:new Date().toISOString(),site_name:"Test Site"})},window.refreshResidentMap=()=>{console.log("üß™ TEST: Manually refreshing resident map"),ce()}},[x,w]);const We=async()=>{try{pe(!0),G("Loading collection sites...");const t=await P.get(`/barangay/${j}/current-schedule`);if(t.data.success){const a=t.data.data;if(ge(a),a.id){const s=await P.get(`/schedule/${a.id}/sites`);if(s.data.success){const o=s.data.data;O(o);const r=le(o);r&&(Be(r),console.log("Station found:",r.site_name))}}if(_){const s=await P.get(`/schedule/${_}/driver-location`);s.data.success&&s.data.data&&de(s.data.data)}}z()}catch(t){console.error("Error loading initial data:",t),z()}finally{pe(!1)}},de=t=>{if(!t.longitude||!t.latitude){console.warn("Invalid location data received:",t);return}const a=[parseFloat(t.longitude),parseFloat(t.latitude)];console.log("Updating driver location on map:",a),ke(a),h&&i.current&&(ue(a,t),Ue()||i.current.flyTo({center:a,zoom:n?16:15,duration:2e3,essential:!0,offset:[0,n?-100:0]}),S&&ie())},$e=t=>{console.log("üéØ PROCESSING site completion:",{received_data:t,site_id_variants:{site_id:t.site_id,siteId:t.siteId},current_sites_count:x.length}),O(a=>{console.log("üìã Current sites before update:",a.map(o=>({id:o.id,name:o.site_name,status:o.status})));const s=a.map(o=>o.id===t.site_id||o.id===t.siteId?(console.log(`‚úÖ MARKING site ${o.site_name} (ID: ${o.id}) as FINISHED`),{...o,status:"finished",collectionStatus:"finished",completed_at:t.completed_at||new Date().toISOString()}):o);return console.log("üìã Sites after update:",s.map(o=>({id:o.id,name:o.site_name,status:o.status}))),s}),setTimeout(()=>{console.log("üîÑ Refreshing sites from server"),ce()},1e3)},ue=(t,a)=>{if(!i.current||!h)return;fe&&fe.remove();const s=n?"w-12 h-12":"w-10 h-10",o=n?"w-6 h-6":"w-5 h-5",r=document.createElement("div");r.className="driver-location-marker";const g=(a.timestamp?(new Date-new Date(a.timestamp))/1e3:0)<30;r.innerHTML=`
      <div class="relative">
        <div class="${s} bg-blue-600 border-3 border-white rounded-full shadow-lg flex items-center justify-center relative z-10">
          <svg class="${o} text-white" viewBox="0 0 24 24" fill="currentColor">
            <path d="M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z"/>
            <path d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0"/>
          </svg>
          ${g?"":`
            <div class="absolute -top-1 -right-1 w-3 h-3 bg-yellow-500 rounded-full border border-white"></div>
          `}
        </div>
        <div class="absolute inset-0 bg-blue-400 rounded-full animate-ping opacity-30"></div>
        ${a.accuracy?`
          <div class="absolute inset-0 border-2 border-blue-300 rounded-full opacity-50" 
               style="transform: scale(${Math.min(a.accuracy/10,3)})"></div>
        `:""}
      </div>
    `;try{const l=new C.Marker({element:r,draggable:!1}).setLngLat(t).addTo(i.current),m=new C.Popup({offset:25,closeButton:!1,className:`custom-popup ${n?"max-w-xs":"max-w-sm"}`}).setHTML(`
        <div class="text-sm ${n?"p-2":"p-3"}">
          <div class="font-semibold text-gray-900 ${n?"text-base":""}">üöó Driver Location</div>
          <div class="text-xs text-gray-500 mt-1">
            ${a.timestamp?`Updated: ${new Date(a.timestamp).toLocaleTimeString()}`:"Live"}
          </div>
          ${a.accuracy?`
            <div class="text-xs text-gray-500 mt-1">
              Accuracy: ¬±${Math.round(a.accuracy)} meters
            </div>
          `:""}
          ${g?"":`
            <div class="text-xs text-yellow-600 mt-1 font-medium">
              ‚ö†Ô∏è Location data may be delayed
            </div>
          `}
        </div>
      `);l.setPopup(m),Me(l)}catch(l){console.error("Error creating driver marker:",l)}},Ve=t=>{ge(t)},Ne=t=>{if(!i.current||!h)return;te.forEach(s=>{s&&s.remove&&s.remove()});const a=t.map((s,o)=>{if(!s.longitude||!s.latitude)return null;try{const r=document.createElement("div");r.className="site-marker";const c=s.status==="completed"||s.status==="finished"||s.collectionStatus==="finished",g=s.status==="in_progress",l=s.type==="station",m=s.purok_name||s.site_name||"Site",v=S&&R&&R.id===s.id&&!c;c&&console.log(`‚úì Rendering completed site: ${s.site_name} (ID: ${s.id})`);const k=()=>l?"#DC2626":c||v?"#10B981":"#6B7280",M=()=>l?`
              <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
              </svg>
            `:c?`
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
              </svg>
            `:`
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M3 6h18"/>
                <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
              </svg>
            `,f=n?"w-14 h-14":"w-12 h-12",N=n?"w-7 h-7":"w-6 h-6",T=n?"w-8 h-8":"w-7 h-7",I=L.findIndex(Qe=>Qe.id===s.id)+1,K=I>0;r.innerHTML=`
          <div class="relative ${g||v?"animate-pulse":""}">
            ${K&&!l&&!c?`
              <div class="absolute -top-2 -right-2 bg-blue-500 text-white rounded-full ${n?"w-7 h-7 text-sm":"w-6 h-6 text-xs"} flex items-center justify-center font-bold shadow-lg border-2 border-white z-20">
                ${I}
              </div>
            `:""}
            ${l?`
              <div class="${f} rounded-full bg-white shadow-2xl border-4 border-red-600 flex items-center justify-center">
                <div class="${T} text-red-600">
                  ${M()}
                </div>
              </div>
            `:`
              <div class="${f} rounded-full border-3 border-white flex items-center justify-center shadow-lg" 
                    style="background-color: ${k()}; ${c?"opacity: 0.7;":""}">
                <div class="${N} text-white">
                  ${M()}
                </div>
              </div>
            `}
            ${g?'<div class="absolute inset-0 rounded-full border-3 border-yellow-500 animate-ping"></div>':""}
            ${v&&!g?'<div class="absolute inset-0 rounded-full border-3 border-green-500 animate-ping"></div>':""}
          </div>
        `;const me=[parseFloat(s.longitude),parseFloat(s.latitude)],Je=new C.Popup({offset:25,closeButton:!1,className:`custom-popup ${n?"max-w-xs":"max-w-sm"}`}).setHTML(`
          <div class="text-sm ${n?"p-2":"p-3"}">
            <div class="font-semibold text-gray-900 ${n?"text-base":""}">${m}</div>
            <div class="text-xs text-gray-500 mt-1">
              ${l?"Collection Station":c?"Completed":g?"In Progress":"Pending"}
            </div>
            ${v&&S&&'<div class="text-xs text-green-600 mt-1 font-medium">üéØ Current Target</div>'}
            ${R&&R.id===s.id&&!v&&'<div class="text-xs text-green-600 mt-1 font-medium">üìç Nearest Site</div>'}
          </div>
        `);return new C.Marker({element:r,draggable:!1}).setLngLat(me).setPopup(Je).addTo(i.current)}catch(r){return console.error("Error creating marker:",r),null}}).filter(s=>s!==null);Le(a)},Xe=async()=>{x.length>0&&$&&(G("Refreshing route..."),await Y(x,$,S))},Ge=()=>{be(!A)},Ze=()=>b?"100%":ye.width<640?"400px":ye.width<768?"500px":"600px";return d.useEffect(()=>{console.log("Current state:",{cssLoaded:q,mapInitialized:h,containerReady:X,siteLocationsCount:x.length,siteMarkersCount:te.length,driverLocation:!!p})},[q,h,X,x,te,p]),he?e.jsx("div",{className:"w-full h-96 bg-gray-50 rounded-lg border border-gray-200 flex items-center justify-center",children:e.jsxs("div",{className:"text-center p-6",children:[e.jsx(Ke,{className:"w-12 h-12 text-red-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-base font-semibold text-gray-900 mb-2",children:"Map Loading Error"}),e.jsx("p",{className:"text-sm text-gray-600 mb-4",children:he}),e.jsx("p",{className:"text-xs text-gray-500",children:"The interface will continue with limited functionality"})]})}):e.jsxs("div",{className:`${b?"w-full h-full":"w-full"} bg-white ${b?"":"rounded-lg border border-gray-200"} overflow-hidden`,children:[e.jsx(at,{isLoading:Ee,message:Te,size:n?"medium":"large",variant:"default"}),e.jsxs("div",{className:`relative w-full ${b?"h-full":""}`,style:{height:b?"100%":Ze()},children:[e.jsx("div",{ref:B,className:"w-full h-full absolute inset-0"}),h&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:`absolute ${n?"bottom-2 left-2":"bottom-4 left-4"} bg-white/95 backdrop-blur-sm rounded-lg shadow-lg border border-gray-200 ${n?"p-2":"p-3"} z-10 ${n?"min-w-40 max-w-48":b?"min-w-52":"min-w-48"}`,children:[e.jsxs("div",{className:`font-semibold ${n?"text-xs":"text-sm"} text-gray-900 ${n?"mb-2":"mb-3"} flex items-center justify-between`,children:[e.jsx("span",{children:"Legend"}),b&&!n&&e.jsx("span",{className:"text-xs font-normal text-gray-500",children:"Live Tracking"})]}),e.jsxs("div",{className:`space-y-1 ${n?"text-xs":"text-sm"}`,children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 bg-blue-600 rounded-full flex items-center justify-center flex-shrink-0 relative",children:e.jsx("div",{className:"absolute inset-0 bg-blue-400 rounded-full animate-ping opacity-30"})}),e.jsx("span",{className:"text-gray-700",children:"Driver"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 bg-red-600 rounded-full flex-shrink-0"}),e.jsx("span",{className:"text-gray-700",children:"Station"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 bg-gray-500 rounded-full flex-shrink-0"}),e.jsx("span",{className:"text-gray-700",children:"Pending"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 bg-green-600 rounded-full flex-shrink-0"}),e.jsx("span",{className:"text-gray-700",children:"Completed"})]}),S&&R&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 bg-green-500 rounded-full flex-shrink-0 relative",children:e.jsx("div",{className:"absolute inset-0 rounded-full border-2 border-white animate-ping"})}),e.jsx("span",{className:"text-gray-700",children:"Target Site"})]}),u&&e.jsxs("div",{className:"flex items-center gap-2 pt-1 border-t border-gray-200",children:[e.jsx("div",{className:"w-4 h-1 rounded-full flex-shrink-0",style:{backgroundColor:u.isRealTime?"#10B981":ee[w==null?void 0:w.barangay_name]||ee._default}}),e.jsx("span",{className:"text-gray-700",children:u.isRealTime?"Live Route":"Planned Route"})]})]})]}),e.jsxs("div",{className:`absolute ${n?"top-2 right-2":"top-4 right-4"} flex ${b&&!n?"flex-row gap-2":"flex-col gap-2"} z-10`,children:[e.jsx("button",{onClick:Xe,disabled:ae,className:`${b?"bg-white/95 backdrop-blur-sm":"bg-white"} rounded-lg shadow-lg border border-gray-200 hover:bg-gray-50 transition-colors flex items-center justify-center ${n?"p-2":"p-3"} ${ae?"opacity-50 cursor-not-allowed":""}`,title:"Refresh route",children:ae?e.jsx("div",{className:`animate-spin rounded-full border-b-2 border-gray-700 ${n?"w-4 h-4":"w-5 h-5"}`}):e.jsx(et,{className:`text-gray-700 ${n?"w-4 h-4":"w-5 h-5"}`})}),e.jsx("button",{onClick:Ge,className:`${b?"bg-white/95 backdrop-blur-sm":"bg-white"} rounded-lg shadow-lg border ${A?"border-blue-500 bg-blue-50":"border-gray-200"} hover:bg-gray-50 transition-colors flex items-center justify-center ${n?"p-2":"p-3"}`,title:A?"Hide route info":"Show route info",children:e.jsx(tt,{className:`${A?"text-blue-600":"text-gray-700"} ${n?"w-4 h-4":"w-5 h-5"}`})}),e.jsx("button",{onClick:je,className:`${b?"bg-white/95 backdrop-blur-sm":"bg-white"} rounded-lg shadow-lg border border-gray-200 hover:bg-gray-50 transition-colors flex items-center justify-center ${n?"p-2":"p-3"}`,title:"Fit to route",children:e.jsx(st,{className:`text-gray-700 ${n?"w-4 h-4":"w-5 h-5"}`})})]}),e.jsx("div",{className:`absolute ${n?"top-2 left-2":"top-4 left-4"} bg-white/95 backdrop-blur-sm rounded-lg shadow-lg border border-gray-200 ${n?"px-2 py-1":"px-3 py-2"} z-10`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${W==="connected"?"bg-green-500":W==="connecting"?"bg-yellow-500":"bg-red-500"} ${W==="connected"?"animate-pulse":""}`}),e.jsx("span",{className:`font-medium text-gray-700 capitalize ${n?"text-xs":"text-sm"}`,children:W})]})}),u&&A&&e.jsxs("div",{className:`absolute ${n?"top-12 left-2 right-2":b?"top-4 left-1/2 transform -translate-x-1/2":"top-16 left-4"} bg-white/95 backdrop-blur-sm rounded-lg shadow-lg border border-gray-200 ${n?"p-3":"p-4"} z-10 ${n?"":b?"min-w-80 max-w-md":"min-w-64"}`,children:[e.jsxs("div",{className:`font-semibold text-gray-900 ${n?"text-sm mb-2":"text-base mb-3"} flex items-center justify-between`,children:[e.jsx("span",{children:u.isRealTime?"Live Route":"Planned Route"}),e.jsxs("div",{className:"flex gap-1",children:[u.isRealTime&&e.jsxs("span",{className:"text-xs bg-green-100 text-green-800 px-2 py-1 rounded flex items-center gap-1",children:[e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-pulse"}),"Live"]}),u.isFallback&&e.jsx("span",{className:"text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded",children:"Estimated"})]})]}),e.jsxs("div",{className:`space-y-2 ${n?"text-xs":"text-sm"} text-gray-600`,children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{children:"Estimated Time:"}),e.jsx("span",{className:"font-semibold text-blue-600",children:u.formattedDuration})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{children:"Distance:"}),e.jsxs("span",{className:"font-semibold",children:[u.distance," km"]})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{children:"Total Stops:"}),e.jsxs("span",{className:"font-semibold",children:[u.totalStops," sites"]})]}),u.targetSite&&e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{children:"Target Site:"}),e.jsx("span",{className:"font-semibold text-green-600",children:u.targetSite})]}),R&&!u.targetSite&&e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{children:"Nearest Site:"}),e.jsx("span",{className:"font-semibold text-green-600",children:R.site_name})]}),u.lastUpdated&&e.jsxs("div",{className:"flex justify-between items-center text-xs text-gray-500",children:[e.jsx("span",{children:"Last Updated:"}),e.jsx("span",{children:u.lastUpdated})]})]}),we&&e.jsx("div",{className:`mt-2 p-2 bg-red-50 border border-red-200 rounded ${n?"text-xs":"text-sm"} text-red-600`,children:we})]})]})]})]})};export{gt as default};
