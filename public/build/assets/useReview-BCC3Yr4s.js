import{r as s}from"./app-hBFkVOqz.js";import{S as R}from"./sweetalert2.esm.all-DGhwgajj.js";const ce=(I=[])=>{const[$,N]=s.useState(I),[C,j]=s.useState([]),[m,O]=s.useState([]),[H,E]=s.useState(!0),[M,B]=s.useState(!1),[q,p]=s.useState(null),[J,u]=s.useState(null),[i,f]=s.useState(1),[w,L]=s.useState(3),[r,h]=s.useState({rate:0,fullname:"",category_id:"",barangay:"",purok:"",review_content:"",additional_comments:""}),[c,y]=s.useState(1),[U,Y]=s.useState(0),[b,G]=s.useState("all"),[d,K]=s.useState("newest"),[V,F]=s.useState([]),X=async()=>{try{const e=await fetch("/categoryFetch");if(!e.ok)throw new Error("Failed to fetch categories");const t=await e.json();if(t.success)j(t.categories||[]);else throw new Error(t.message||"Failed to fetch categories")}catch(e){console.error("Error fetching categories:",e),p(t=>t||`Categories: ${e.message}`)}},z=async()=>{try{const e=await fetch("/barangayFetch");if(!e.ok)throw new Error("Failed to fetch barangay data");const t=await e.json();if(t.success){const v=t.barangays.map(o=>({id:o.id,name:o.baranggay_name,puroks:o.puroks?o.puroks.map(n=>({id:n.id,name:n.purok_name})):[]}));O(v)}else throw new Error(t.message||"Failed to fetch barangay data")}catch(e){console.error("Error fetching barangay data:",e),p(t=>t||`Barangays: ${e.message}`)}};s.useEffect(()=>{(async()=>{try{E(!0),p(null),await Promise.all([X(),z()])}catch(t){console.error("Error fetching data:",t),p(t.message)}finally{E(!1)}})()},[]),s.useEffect(()=>{if(r.barangay){const e=m.find(t=>t.name===r.barangay);F((e==null?void 0:e.puroks)||[]),h(t=>({...t,purok:""}))}else F([])},[r.barangay,m]);const A=[{number:1,title:"Rating",description:"How was your experience?"},{number:2,title:"Personal Info",description:"Tell us about yourself"},{number:3,title:"Service Details",description:"Service type and location"},{number:4,title:"Review Content",description:"Share your experience"}],Q=async e=>{var o;if(e.preventDefault(),r.rate===0||!r.review_content.trim()||!r.category_id){u({success:!1,message:"Please fill in all required fields: rating, service type, and review content."});return}const t=m.find(n=>n.name===r.barangay),v=t==null?void 0:t.puroks.find(n=>n.name===r.purok);if(!v){u({success:!1,message:"Please select a valid barangay and purok."});return}try{B(!0),u(null);const n={fullname:r.fullname||"Anonymous User",purok_id:v.id,category_id:parseInt(r.category_id),review_content:r.review_content,suggestion_content:r.additional_comments||"",rate:parseInt(r.rate)},g=await fetch("/reviews",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":((o=document.querySelector('meta[name="csrf-token"]'))==null?void 0:o.getAttribute("content"))||"",Accept:"application/json"},body:JSON.stringify(n)}),T=g.headers.get("content-type");if(!T||!T.includes("application/json")){const P=await g.text();throw console.error("Non-JSON response:",P.substring(0,200)),new Error("Server returned an invalid response. Please try again.")}const a=await g.json();if(!g.ok)throw new Error(a.message||`Server error: ${g.status}`);if(a.success){if(a.flagged){const l=a.field==="suggestion_content"?"Additional Suggestions":"Review Content";await R.fire({icon:"error",title:"Review Not Submitted",html:`
              <p class="text-gray-700 mb-4">Your <strong>${l}</strong> contains inappropriate content and cannot be submitted.</p>
              <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-left">
                <p class="text-sm font-semibold text-red-800 mb-2">Flagged Content:</p>
                <p class="text-sm text-red-700">${a.message||"Please review your content and remove any inappropriate language."}</p>
              </div>
              <p class="text-sm text-gray-600 mt-4">Please edit your ${l.toLowerCase()} and resubmit.</p>
            `,confirmButtonText:"Edit Review",confirmButtonColor:"#ef4444",customClass:{popup:"rounded-2xl",confirmButton:"px-6 py-3 rounded-xl"}});return}const P={id:a.review.id,fullname:a.review.fullname,category_id:a.review.category_id,review_content:a.review.review_content,additional_comments:a.review.suggestion_content,rate:a.review.rate,barangay:r.barangay,purok:r.purok,created_at:a.review.created_at,category:C.find(l=>l.id===a.review.category_id)||{id:a.review.category_id,category_name:"Unknown Category"},replies:null,status:a.review.status};a.status==="approved"&&N(l=>[P,...l]),h({rate:0,fullname:"",category_id:"",barangay:"",purok:"",review_content:"",additional_comments:""}),y(1),f(1),await R.fire({icon:"success",title:"Review Submitted!",html:`
            <p class="text-gray-700 mb-2">${a.message}</p>
            ${a.status==="pending"?'<p class="text-sm text-gray-600">Your review is pending admin approval.</p>':""}
          `,confirmButtonText:"Great!",confirmButtonColor:"#10b981",timer:3e3,customClass:{popup:"rounded-2xl",confirmButton:"px-6 py-3 rounded-xl"}})}else throw new Error(a.message||"Failed to submit review")}catch(n){console.error("Error submitting review:",n),await R.fire({icon:"error",title:"Submission Failed",html:`
          <p class="text-gray-700">${n.message||"An error occurred while submitting your review. Please try again."}</p>
        `,confirmButtonText:"Try Again",confirmButtonColor:"#ef4444",customClass:{popup:"rounded-2xl",confirmButton:"px-6 py-3 rounded-xl"}}),u({success:!1,message:n.message||"An error occurred while submitting your review. Please try again."})}finally{B(!1)}},W=()=>{c<A.length&&y(c+1)},Z=()=>{c>1&&y(c-1)},ee=e=>{console.log("Marked review as helpful:",e)},S=$.filter(e=>e.status&&e.status!=="approved"?!1:b==="all"?!0:e.rate===parseInt(b)).sort((e,t)=>d==="newest"?new Date(t.created_at)-new Date(e.created_at):d==="oldest"?new Date(e.created_at)-new Date(t.created_at):d==="highest"?t.rate-e.rate:d==="lowest"?e.rate-t.rate:0),x=S.length,_=Math.ceil(x/w),k=(i-1)*w,D=k+w,te=S.slice(k,D),re=e=>{e>=1&&e<=_&&f(e)},ae=()=>{i<_&&f(i+1)},se=()=>{i>1&&f(i-1)},ne=()=>{switch(c){case 1:return r.rate>0;case 2:return!0;case 3:return r.category_id&&r.barangay&&r.purok;case 4:return r.review_content.trim().length>0;default:return!1}};return{reviews:te,allReviews:S,categories:C,barangays:m,newReview:r,currentStep:c,hoverRating:U,activeFilter:b,sortBy:d,availablePuroks:V,loading:H,submitting:M,error:q,submitResult:J,pagination:{currentPage:i,totalPages:_,totalReviews:x,itemsPerPage:w,startIndex:k+1,endIndex:Math.min(D,x)},steps:A,setNewReview:h,setCurrentStep:y,setHoverRating:Y,setActiveFilter:G,setSortBy:K,handleSubmitReview:Q,nextStep:W,prevStep:Z,handleHelpful:ee,isStepValid:ne,goToPage:re,nextPage:ae,prevPage:se,setItemsPerPage:L,clearSubmitResult:()=>u(null)}};export{ce as useReview};
