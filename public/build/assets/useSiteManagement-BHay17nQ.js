import{r as g,a as m}from"./app-hBFkVOqz.js";const Y=r=>{var f;return r?r.display_name?r.display_name:(f=r.purok)!=null&&f.purok_name?r.purok.purok_name:r.site_name?r.site_name:"Site":"Site"},G=({scheduleId:r,onTaskComplete:f,onTaskCancel:J,calculateDistance:F,showCompletionNotification:R,updateSiteMarkers:E,recalculateRouteFromCurrentPosition:I,currentLocation:N})=>{const[S,h]=g.useState([]),[P,k]=g.useState(null),[p,b]=g.useState(null),[H,z]=g.useState(null),[_,$]=g.useState([]),[q,y]=g.useState(new Set),[U,w]=g.useState(0),[j,C]=g.useState(!1),[B,A]=g.useState(!1),O=(t,o)=>{if(!t||o.length===0)return null;let n=null,s=1/0;return o.forEach(e=>{if(e.longitude&&e.latitude){const a=F(parseFloat(t.latitude),parseFloat(t.longitude),parseFloat(e.latitude),parseFloat(e.longitude));a<s&&(s=a,n=e)}}),n},M=(t,o)=>{if(!t||o.length===0)return!1;const[n,s]=t,e=.05;let a=!1;return o.forEach((i,u)=>{if(q.has(i.id))return;const c=parseFloat(i.longitude),l=parseFloat(i.latitude),d=F(s,n,l,c);d<.1&&console.log(`ðŸ“ Proximity check: ${i.site_name} - Distance: ${(d*1e3).toFixed(0)}m (threshold: ${(e*1e3).toFixed(0)}m)`),d<e&&(console.log(`ðŸŽ¯ SITE REACHED! ${i.site_name} - Distance: ${(d*1e3).toFixed(0)}m`),L(i),a=!0)}),a},D=async()=>{var t;try{if(!S.length){console.log("No sites available to initialize collection queue");return}const o=S.map(s=>s.id);console.log("Initializing collection queue with sites:",o);const n=await m.post("/initialize",{schedule_id:r,site_id:o});n.data.success?console.log("Collection queue initialized with",n.data.total_sites,"sites"):console.error("Failed to initialize collection queue:",n.data.message)}catch(o){console.error("Error initializing collection queue:",o),console.error("Error details:",(t=o.response)==null?void 0:t.data)}},L=async(t,o)=>{var n;console.log(`Site reached: ${t.site_name}`);try{const s=await m.post("/mark-completed",{schedule_id:r,site_id:t.id});if(s.data.success){if(console.log("Site marked as completed in database:",t.site_name),y(e=>{const a=new Set(e);return a.add(t.id),console.log("Updated completed sites:",Array.from(a)),a}),h(e=>e.map(a=>a.id===t.id?{...a,collectionStatus:"finished",status:"finished",completed_at:new Date().toISOString()}:a)),s.data.all_completed?(console.log("ðŸŽ‰ All sites completed! Show completion report modal."),f&&f(t,!0)):console.log(`Progress: ${s.data.completed_sites}/${s.data.total_sites} sites completed`),_.length>0){const e=_.findIndex(a=>a.id===t.id);if(e!==-1&&e<_.length-1){const a=e+1;w(a);const i=_[a];console.log(`Moving to next site: ${i.site_name}`),N&&(console.log("Immediately recalculating route from current location to next site"),I(N))}else e===_.length-1&&(console.log("ðŸ Last site reached!"),w(e))}E(),R(Y(t))}}catch(s){console.error("Error marking site as completed:",s),console.error("Error details:",(n=s.response)==null?void 0:n.data)}},W=async()=>{if(!r){console.error("Cannot start task: missing schedule ID");return}try{const t=(p==null?void 0:p.barangay_id)||"unknown",o=await m.post("/schedule/start",{schedule_id:r,barangay_id:t});o.data.success&&(console.log("Task started and broadcasted to residents"),C(!0),S.length>0&&await D(),o.data.data&&b(n=>({...n,...o.data.data,status:"in_progress"})))}catch(t){console.error("Failed to start task:",t)}},Q=async()=>{if(!r){console.error("Cannot complete task: missing schedule ID");return}try{(await m.post("/schedule/complete",{schedule_id:r})).data.success&&(console.log("Task completed and broadcasted to residents"),C(!1),f&&f())}catch(t){console.error("Failed to complete task:",t)}},X=()=>{y(new Set),w(0),E()},T=async()=>{if(!r){console.warn("No schedule ID provided");return}A(!0);try{let t=null;try{const o=await m.get(`/schedules/${r}`);o.data.success&&o.data.data?(t=o.data.data,b(t),console.log("Schedule data loaded:",t)):console.warn("No schedule data received from API")}catch(o){console.warn("Could not fetch schedule details:",o),t={id:r,barangay_id:"unknown",status:"pending"},b(t)}if(t!=null&&t.barangay_id&&t.barangay_id!=="unknown")try{const o=await m.get(`/barangay/${t.barangay_id}/sites?status=active`);if(o.data.success){const n=o.data.data;console.log("Sites loaded:",n.length);try{const s=await m.get(`/progress/${r}`);if(s.data.success){const e=s.data.progress,a=new Set(e.filter(l=>l.status==="finished").map(l=>l.site_id));console.log("Collection queue loaded, completed sites:",a.size),y(a);const i=n.map(l=>{var d;return{...l,collectionStatus:((d=e.find(x=>x.site_id===l.id))==null?void 0:d.status)||"unfinished"}}),u=i.find(l=>l.type==="station"),c=i.filter(l=>l.type!=="station");if(u&&(k({...u,coordinates:[parseFloat(u.longitude),parseFloat(u.latitude)]}),c.length>0)){const l=O(u,c);z(l),console.log("Nearest site to station found:",l==null?void 0:l.site_name);const d=v(u,c);$(d),w(0)}h(c)}}catch{console.warn("Could not fetch collection queue progress, using default statuses");const e=n.find(i=>i.type==="station"),a=n.filter(i=>i.type!=="station");if(e&&(k({...e,coordinates:[parseFloat(e.longitude),parseFloat(e.latitude)]}),a.length>0)){const i=O(e,a);z(i),console.log("Nearest site to station found:",i==null?void 0:i.site_name);const u=v(e,a);$(u),w(0)}h(a)}}}catch(o){console.error("Error fetching sites:",o)}else console.warn("No valid barangay_id available to fetch sites")}catch(t){console.error("Error in schedule and sites setup: ",t)}finally{A(!1)}},v=(t,o)=>{if(!t||o.length===0)return o;const n=[...o],s=[],e=n.map(c=>{const l=F(parseFloat(t.latitude),parseFloat(t.longitude),parseFloat(c.latitude),parseFloat(c.longitude));return{...c,distance:l,coordinates:[parseFloat(c.longitude),parseFloat(c.latitude)]}});e.sort((c,l)=>c.distance-l.distance);const a=e[0];s.push(a);const i=e.slice(1);let u=a;for(;i.length>0;){let c=-1,l=1/0;for(let d=0;d<i.length;d++){const x=F(parseFloat(u.latitude),parseFloat(u.longitude),parseFloat(i[d].latitude),parseFloat(i[d].longitude));x<l&&(l=x,c=d)}c!==-1&&(u=i[c],s.push(u),i.splice(c,1))}return s};return g.useEffect(()=>{T()},[r]),g.useEffect(()=>{S.length>0&&r&&(console.log("Sites loaded, initializing collection queue..."),D())},[S,r]),g.useEffect(()=>{if(!(p!=null&&p.barangay_id)||!r)return;console.log("Setting up site completion listener for barangay:",p.barangay_id);const t=`site-completion.${p.barangay_id}`,o=`site-completion-schedule.${r}`;return window.Echo.channel(t).listen("SiteCompletionUpdated",n=>{console.log("Site completion update received:",n),n.schedule_id===r&&(y(s=>{const e=new Set(s);return e.add(n.site_id),console.log("Site completion broadcast received, updated completed sites:",Array.from(e)),e}),h(s=>s.map(e=>e.id===n.site_id?{...e,collectionStatus:"finished",status:"finished",completed_at:n.completed_at}:e)),E())}),window.Echo.channel(o).listen("SiteCompletionUpdated",n=>{console.log("Schedule-specific site completion update:",n),y(s=>{const e=new Set(s);return e.add(n.site_id),e}),h(s=>s.map(e=>e.id===n.site_id?{...e,collectionStatus:"finished",status:"finished",completed_at:n.completed_at}:e)),E()}),()=>{window.Echo&&(window.Echo.leave(t),window.Echo.leave(o),console.log("Left site completion channels"))}},[p==null?void 0:p.barangay_id,r]),{siteLocations:S,stationLocation:P,activeSchedule:p,nearestSiteToStation:H,optimizedSiteOrder:_,completedSites:q,currentSiteIndex:U,isTaskActive:j,loading:B,setSiteLocations:h,setStationLocation:k,setActiveSchedule:b,setNearestSiteToStation:z,setOptimizedSiteOrder:$,setCompletedSites:y,setCurrentSiteIndex:w,setIsTaskActive:C,setLoading:A,findNearestSiteToStation:O,checkSiteProximity:M,markSiteAsCompleted:L,startTaskAndBroadcast:W,completeTaskAndBroadcast:Q,resetCompletedSites:X,fetchScheduleAndSites:T,optimizeSiteOrderFromStation:v}},V=Object.freeze(Object.defineProperty({__proto__:null,useSiteManagement:G},Symbol.toStringTag,{value:"Module"}));export{V as a,Y as g,G as u};
