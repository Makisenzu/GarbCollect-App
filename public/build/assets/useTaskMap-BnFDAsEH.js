import{r as c}from"./app-Dp-W5Iv5.js";import{useLocationTracking as M}from"./useLocationTracking-BWcQ5-Tc.js";import{useMapboxSetup as E}from"./useMapboxSetup-cXO52C8o.js";import{useMapLayers as U}from"./useMapLayers-DQK5X4Sb.js";import{useRouteCalculations as F}from"./useRouteCalculations-DTAtalU0.js";import{useSiteManagement as D}from"./useSiteManagement-B4y5wiBy.js";import"./mapbox-gl-D4Caqtxm.js";import"./index-Ce4MgMr-.js";import"./iconBase-BjpKKBDg.js";import"./can-3MqaZyCZ.js";const Z=({mapboxKey:S,scheduleId:m,onTaskComplete:f,onTaskCancel:T})=>{const[d,R]=c.useState(!1),[k,g]=c.useState(!1),[b,y]=c.useState(!0),[h,v]=c.useState(navigator.onLine),[A,w]=c.useState(!1),n=E({mapboxKey:S,isMobile:d}),i=F({mapboxKey:S,isOnline:h,activeSchedule:null,optimizedSiteOrder:[],completedSites:new Set,siteLocations:[],currentLocation:null,routeCoordinates:[],routeInfo:null,map:n.map,isMobile:d,addRouteLayer:()=>{}}),t=D({scheduleId:m,onTaskComplete:(o,e=!1)=>{e&&w(!0),f&&f(o,e)},onTaskCancel:T,calculateDistance:i.calculateDistance,showCompletionNotification:o=>{if(console.log(`Site completed: ${o}`),d){const e=document.createElement("div");e.className="fixed top-20 left-4 right-4 bg-gradient-to-r from-green-500 to-emerald-600 text-white px-6 py-4 rounded-xl shadow-2xl z-50 text-center transform transition-all duration-500 animate-bounce",e.style.animation="slideInDown 0.5s ease-out, fadeOut 0.5s ease-in 2.5s",e.innerHTML=`
          <div class="flex items-center justify-center gap-3">
            <span class="text-3xl">âœ…</span>
            <div class="text-left">
              <div class="font-bold text-lg">${o} Completed!</div>
              <div class="text-sm opacity-90">Progress: ${t.completedSites.size+1}/${t.siteLocations.length} sites collected</div>
            </div>
          </div>
          <div class="mt-2 h-2 bg-white bg-opacity-30 rounded-full overflow-hidden">
            <div class="h-full bg-white rounded-full transition-all duration-1000" style="width: ${(t.completedSites.size+1)/t.siteLocations.length*100}%"></div>
          </div>
        `,document.body.appendChild(e);try{const r=new Audio("data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZSA0PVqzn77BdGAg+ltryxnMpBSuBzvLaiTUIGGe77OmfTgwOUKbk8LdjHQU2kdby0HwqBSp3x/DdkUELEl+06OyqVRUKRp7g8r5wIgU0h9H004IzBh1tv+/mnEkODlat6O+xXBkIP5Xa8sV0KgUrgc7y2YszCBdnvOzpnk4MDU+m5O+5ZBwGNpHX8s98Kgcrc8fv3ZJCCxFftOjuq1YUDD6f4fK/cCMGNYfR89OCMwYcbb/v5JxKDg5VrOjusVwZCj6U2vLGdSoGK4HO8tmLMwgXZ7vs6J5PDA1Ppubw...");r.volume=.3,r.play().catch(()=>{})}catch{}setTimeout(()=>{document.body.contains(e)&&(e.style.opacity="0",e.style.transform="translateY(-20px)",setTimeout(()=>{document.body.contains(e)&&document.body.removeChild(e)},500))},3e3)}else{const e=document.createElement("div");e.className="fixed top-4 right-4 bg-gradient-to-br from-green-500 to-emerald-600 text-white px-6 py-4 rounded-xl shadow-2xl z-50 min-w-[320px] transform transition-all duration-500",e.style.animation="slideInRight 0.5s ease-out",e.innerHTML=`
          <div class="flex items-start gap-3">
            <div class="text-4xl animate-bounce">ðŸŽ‰</div>
            <div class="flex-1">
              <div class="font-bold text-lg mb-1">âœ… ${o}</div>
              <div class="text-sm opacity-90 mb-2">Collection completed successfully!</div>
              <div class="flex items-center gap-2 text-xs">
                <span class="font-semibold">${t.completedSites.size+1}/${t.siteLocations.length} sites</span>
                <span class="opacity-75">â€¢</span>
                <span>${Math.round((t.completedSites.size+1)/t.siteLocations.length*100)}% complete</span>
              </div>
              <div class="mt-2 h-2 bg-white bg-opacity-30 rounded-full overflow-hidden">
                <div class="h-full bg-white rounded-full transition-all duration-1000" style="width: ${(t.completedSites.size+1)/t.siteLocations.length*100}%"></div>
              </div>
            </div>
          </div>
        `;const r=document.createElement("button");r.className="absolute top-2 right-2 text-white opacity-75 hover:opacity-100 transition-opacity",r.innerHTML="Ã—",r.style.fontSize="24px",r.onclick=()=>{document.body.contains(e)&&(e.style.opacity="0",e.style.transform="translateX(100%)",setTimeout(()=>{document.body.contains(e)&&document.body.removeChild(e)},300))},e.appendChild(r),document.body.appendChild(e),setTimeout(()=>{document.body.contains(e)&&(e.style.opacity="0",e.style.transform="translateX(100%)",setTimeout(()=>{document.body.contains(e)&&document.body.removeChild(e)},300))},4e3)}if(!document.getElementById("completion-animations")){const e=document.createElement("style");e.id="completion-animations",e.textContent=`
          @keyframes slideInRight {
            from {
              transform: translateX(100%);
              opacity: 0;
            }
            to {
              transform: translateX(0);
              opacity: 1;
            }
          }
          @keyframes slideInDown {
            from {
              transform: translateY(-100%);
              opacity: 0;
            }
            to {
              transform: translateY(0);
              opacity: 1;
            }
          }
          @keyframes fadeOut {
            from {
              opacity: 1;
            }
            to {
              opacity: 0;
            }
          }
        `,document.head.appendChild(e)}},updateSiteMarkers:()=>{},recalculateRouteFromCurrentPosition:i.recalculateRouteFromCurrentPosition,currentLocation:null}),s=U({map:n.map,isMobile:d,activeSchedule:t.activeSchedule,completedSites:t.completedSites,optimizedSiteOrder:t.optimizedSiteOrder,currentSiteIndex:t.currentSiteIndex,nearestSiteToStation:t.nearestSiteToStation,routeCoordinates:i.routeCoordinates,routeInfo:i.routeInfo,currentLocation:null,isTaskActive:t.isTaskActive,siteLocations:t.siteLocations,stationLocation:t.stationLocation}),a=M({scheduleId:m,activeSchedule:t.activeSchedule,siteLocations:t.siteLocations,completedSites:t.completedSites,optimizedSiteOrder:t.optimizedSiteOrder,currentSiteIndex:t.currentSiteIndex,isTaskActive:t.isTaskActive,onTaskComplete:f,map:n.map,isMobile:d,currentLocation:null,routeCoordinates:i.routeCoordinates,routeInfo:i.routeInfo,smoothUpdateUserLocation:s.smoothUpdateUserLocation,checkSiteProximity:t.checkSiteProximity,recalculateRouteFromCurrentPosition:i.recalculateRouteFromCurrentPosition,shouldRecalculateRoute:i.shouldRecalculateRoute,updateUserLocationSource:s.updateUserLocationSource,animatePulse:s.animatePulse,clearUserLocationLayers:s.clearUserLocationLayers,updateCurrentLocationMarker:s.updateCurrentLocationMarker,handleLocationError:o=>{let e="Location tracking error: ";switch(o.code){case o.PERMISSION_DENIED:e+="Location access denied. Please enable location permissions.";break;case o.POSITION_UNAVAILABLE:e+="Location unavailable. Using last known position.";break;case o.TIMEOUT:e+="Location request timeout. Retrying...",setTimeout(a.startRealtimeLocationTracking,5e3);break;default:e+="Unknown location error.";break}console.warn(e)},sendLocationToReverb:async(o,e,r=null)=>{var p;if(!m){console.error("No schedule ID available");return}try{const l=((p=t.activeSchedule)==null?void 0:p.barangay_id)||"unknown";(await axios.post("/driver/location/update",{latitude:o,longitude:e,accuracy:r,schedule_id:m,barangay_id:l,timestamp:new Date().toISOString()})).data.success&&console.log("Location successfully sent to backend")}catch(l){throw console.error("Failed to send location to backend:",l),l}}});c.useEffect(()=>{const o=()=>{const e=window.innerWidth<768;R(e),e&&(g(!1),y(!0))};return o(),window.addEventListener("resize",o),()=>window.removeEventListener("resize",o)},[]),c.useEffect(()=>{const o=()=>{v(!0),console.log("Connection restored")},e=()=>{v(!1),console.log("Connection lost - switching to offline mode")};return window.addEventListener("online",o),window.addEventListener("offline",e),()=>{window.removeEventListener("online",o),window.removeEventListener("offline",e)}},[]),c.useEffect(()=>{const o=n.initializeMap(()=>{a.startRealtimeLocationTracking()});return()=>{a.stopRealtimeLocationTracking(),a.stopFakeLocationTest(),s.clearUserLocationLayers(),o&&o()}},[n.cssLoaded]),c.useEffect(()=>{n.mapInitialized&&n.customStyleLoaded&&t.siteLocations.length>0&&(s.clearSiteMarkers(),s.addSiteMarkers(),i.routeCoordinates.length>0&&setTimeout(()=>{s.addRouteLayer()},300))},[n.mapInitialized,n.customStyleLoaded,t.siteLocations,i.routeCoordinates,t.optimizedSiteOrder,t.nearestSiteToStation,t.completedSites]),c.useEffect(()=>{a.currentLocation&&t.siteLocations.length>0&&n.mapInitialized&&(console.log("All data available, calculating sequential route through all sites"),(async()=>{const e=await i.analyzeAndOptimizeRouteFromCurrentLocation(a.currentLocation,t.siteLocations);e&&(i.setRouteCoordinates(e.route),i.setRouteInfo({duration:e.duration,distance:e.distance,formattedDuration:e.formattedDuration}),setTimeout(()=>{n.map.current&&e.route.length>0&&s.addRouteLayer()},300))})())},[a.currentLocation,t.siteLocations,n.mapInitialized]);const C=()=>{navigator.geolocation?(t.setLoading(!0),navigator.geolocation.getCurrentPosition(async o=>{var L;const{latitude:e,longitude:r,accuracy:p}=o.coords,l=[r,e];if(a.setCurrentLocation(l),a.setLocationAccuracy(p),a.setLastLocationUpdate(new Date),s.smoothUpdateUserLocation(e,r),t.siteLocations.length>0){const u=await i.analyzeAndOptimizeRouteFromCurrentLocation(l,t.siteLocations);u&&(i.setRouteCoordinates(u.route),i.setRouteInfo({duration:u.duration,distance:u.distance,formattedDuration:u.formattedDuration,toSite:(L=u.nearestSite)==null?void 0:L.site_name}),setTimeout(()=>{n.map.current&&u.route.length>0&&s.addRouteLayer()},500))}n.map.current&&n.map.current.flyTo({center:l,zoom:d?15:14,essential:!0,duration:1500}),t.setLoading(!1)},o=>{console.error("Error getting location:",o),t.setLoading(!1),a.handleLocationError(o)},{enableHighAccuracy:!0,timeout:3e4,maximumAge:0})):alert("Geolocation is not supported by your browser.")},x=()=>{if(!t.stationLocation){alert("No station found. Please check site configuration.");return}if(t.siteLocations.length===0){alert("No sites available for optimization.");return}i.analyzeAndOptimizeRouteFromStation(t.stationLocation,t.siteLocations)},z=(o,e)=>{const r=[e,o];a.setCurrentLocation(r),s.smoothUpdateUserLocation(o,e),t.nearestSiteToStation&&i.calculateRouteToNearestSiteFromStation(r,t.nearestSiteToStation)},I=()=>{s.fitMapToRouteAndDriver(i.getNextUncompletedSiteIndex,t.optimizedSiteOrder)},O=()=>{s.fitMapToRoute()};return{mapContainer:n.mapContainer,siteMarkersRef:s.siteMarkersRef,cssLoaded:n.cssLoaded,siteLocations:t.siteLocations,stationLocation:t.stationLocation,mapInitialized:n.mapInitialized,activeSchedule:t.activeSchedule,routeCoordinates:i.routeCoordinates,loading:t.loading,currentLocation:a.currentLocation,routeInfo:i.routeInfo,mapError:n.mapError,customStyleLoaded:n.customStyleLoaded,aiOptimizedRoute:i.aiOptimizedRoute,nearestSiteToStation:t.nearestSiteToStation,isMobile:d,showAIPanel:k,showControls:b,optimizedSiteOrder:t.optimizedSiteOrder,isOnline:h,locationAccuracy:a.locationAccuracy,lastLocationUpdate:a.lastLocationUpdate,completedSites:t.completedSites,currentSiteIndex:t.currentSiteIndex,isTaskActive:t.isTaskActive,isFakeLocationActive:a.isFakeLocationActive,allSiteRoutes:i.allSiteRoutes,showCompletionModal:A,setShowCompletionModal:w,formatDuration:i.formatDuration,getCurrentLocation:C,getAIOptimizedRoute:x,setShowAIPanel:g,setShowControls:y,startRealtimeLocationTracking:a.startRealtimeLocationTracking,stopRealtimeLocationTracking:a.stopRealtimeLocationTracking,updateLocationManually:z,resetCompletedSites:t.resetCompletedSites,markSiteAsCompleted:t.markSiteAsCompleted,startTaskAndBroadcast:t.startTaskAndBroadcast,completeTaskAndBroadcast:t.completeTaskAndBroadcast,sendLocationToReverb:a.sendLocationToReverb,startFakeLocationTest:a.startFakeLocationTest,stopFakeLocationTest:a.stopFakeLocationTest,sendTestLocation:a.sendTestLocation,simulateRouteFollowing:a.simulateRouteFollowing,fitMapToRouteAndDriver:I,fitMapToRoute:O,updateSiteMarkers:s.updateSiteMarkers,addRouteLayer:s.addRouteLayer,calculateRouteToNextSite:i.calculateRouteToNextSite,calculateOptimalRoute:i.calculateOptimalRoute,optimizeSiteOrder:i.optimizeSiteOrder,analyzeAndOptimizeRouteFromStation:i.analyzeAndOptimizeRouteFromStation}};export{Z as useTaskMap};
