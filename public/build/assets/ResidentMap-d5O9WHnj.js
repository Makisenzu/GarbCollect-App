import{j as t,r as u,a as B,i as st,g as Te}from"./app-B6op6jpD.js";import{a as z}from"./mapbox-gl-CRhpymhd.js";import{h as rt,i as at,j as ot,g as nt}from"./index-D9ajuYI7.js";import"./iconBase-f9qwwLH2.js";const it=({isLoading:$=!1,size:y="medium",message:F="Collecting garbage..."})=>{if(!$)return null;const v={small:"w-16 h-16",medium:"w-24 h-24",large:"w-32 h-32",xlarge:"w-48 h-48"},I={small:"text-xs",medium:"text-sm",large:"text-base",xlarge:"text-lg"};return t.jsxs("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:[t.jsxs("div",{className:"bg-white rounded-2xl p-8 shadow-2xl flex flex-col items-center",children:[t.jsxs("div",{className:`relative ${v[y]} mb-4`,children:[t.jsx("div",{className:"absolute bottom-0 left-0 right-0 h-2 bg-gray-600 rounded-full"}),t.jsx("div",{className:"absolute bottom-3 left-4 w-3 h-4 bg-gray-400 rounded-sm",children:t.jsx("div",{className:"absolute -top-1 left-0.5 w-2 h-1 bg-gray-500 rounded-sm"})}),t.jsx("div",{className:"absolute bottom-3 left-8 w-3 h-5 bg-gray-400 rounded-sm",children:t.jsx("div",{className:"absolute -top-1 left-0.5 w-2 h-1 bg-gray-500 rounded-sm"})}),t.jsx("div",{className:"absolute bottom-3 left-12 w-3 h-4 bg-gray-400 rounded-sm",children:t.jsx("div",{className:"absolute -top-1 left-0.5 w-2 h-1 bg-gray-500 rounded-sm"})}),t.jsx("div",{className:"absolute bottom-2 left-0 animate-collect-garbage",children:t.jsxs("div",{className:"relative",children:[t.jsxs("div",{className:"w-6 h-4 bg-green-600 rounded-t-sm",children:[t.jsx("div",{className:"absolute top-0.5 left-1 w-3 h-1.5 bg-blue-300 rounded-sm"}),t.jsx("div",{className:"absolute bottom-0 left-1 w-1 h-0.5 bg-yellow-300 rounded-full"})]}),t.jsx("div",{className:"absolute left-6 top-1 w-8 h-3 bg-green-700 rounded-sm",children:t.jsx("div",{className:"absolute top-0.5 left-1 w-6 h-2 bg-gray-800 rounded",children:t.jsx("div",{className:"absolute -top-1 left-0 right-0 h-1 bg-gray-700 rounded-t animate-garbage-fill"})})}),t.jsx("div",{className:"absolute -bottom-1 left-1 w-2 h-2 bg-black rounded-full",children:t.jsx("div",{className:"absolute inset-0.5 w-1 h-1 bg-gray-600 rounded-full"})}),t.jsx("div",{className:"absolute -bottom-1 left-5 w-2 h-2 bg-black rounded-full",children:t.jsx("div",{className:"absolute inset-0.5 w-1 h-1 bg-gray-600 rounded-full"})}),t.jsx("div",{className:"absolute -bottom-1 left-11 w-2 h-2 bg-black rounded-full",children:t.jsx("div",{className:"absolute inset-0.5 w-1 h-1 bg-gray-600 rounded-full"})})]})}),t.jsx("div",{className:"absolute bottom-3 left-16 w-4 h-1 bg-gray-400 rounded-full animate-dust-cloud opacity-0"})]}),t.jsx("div",{className:`text-center ${I[y]} text-gray-700 font-semibold`,children:F}),t.jsxs("div",{className:"flex space-x-1 mt-2",children:[t.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-bounce",style:{animationDelay:"0ms"}}),t.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-bounce",style:{animationDelay:"150ms"}}),t.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-bounce",style:{animationDelay:"300ms"}})]})]}),t.jsx("style",{jsx:!0,children:`
        @keyframes collect-garbage {
          0% {
            transform: translateX(-20px);
          }
          20% {
            transform: translateX(40px);
          }
          40% {
            transform: translateX(80px);
          }
          60% {
            transform: translateX(120px);
          }
          80% {
            transform: translateX(160px);
          }
          100% {
            transform: translateX(200px);
          }
        }
        
        @keyframes garbage-fill {
          0%, 20% {
            height: 0px;
            opacity: 0;
          }
          25% {
            height: 1px;
            opacity: 1;
          }
          40% {
            height: 2px;
            opacity: 1;
          }
          60% {
            height: 3px;
            opacity: 1;
          }
          80% {
            height: 4px;
            opacity: 1;
          }
          100% {
            height: 4px;
            opacity: 0;
          }
        }
        
        @keyframes dust-cloud {
          0%, 60% {
            opacity: 0;
            transform: scale(0.5);
          }
          70% {
            opacity: 0.8;
            transform: scale(1);
          }
          80% {
            opacity: 0.6;
            transform: scale(1.2);
          }
          90% {
            opacity: 0.4;
            transform: scale(1.4);
          }
          100% {
            opacity: 0;
            transform: scale(1.6);
          }
        }
        
        .animate-collect-garbage {
          animation: collect-garbage 4s ease-in-out infinite;
        }
        
        .animate-garbage-fill {
          animation: garbage-fill 4s ease-in-out infinite;
        }
        
        .animate-dust-cloud {
          animation: dust-cloud 4s ease-in-out infinite;
        }
      `})]})},ht=({mapboxKey:$,barangayId:y,scheduleId:F,isFullscreen:v=!1})=>{const I=u.useRef(null),c=u.useRef(null),[W,A]=u.useState(!1),[p,D]=u.useState(!1),[N,pe]=u.useState(null),[h,Ee]=u.useState(null),[he,Ce]=u.useState(null),[x,X]=u.useState([]),[re,Fe]=u.useState([]),[xe,ae]=u.useState(navigator.onLine),[lt,ve]=u.useState(!0),[V,P]=u.useState("connecting"),[ct,U]=u.useState(null),[G,_e]=u.useState(!1),[Z,J]=u.useState(!1),[ze,be]=u.useState(!1),[Ie,De]=u.useState("Loading map data..."),[we,ye]=u.useState(!0),Q=(e="Loading map data...")=>{we&&(De(e),be(!0))},_=()=>{we&&be(!1)},[k,Y]=u.useState([]),[m,K]=u.useState(null),[R,Pe]=u.useState([]),[T,Ue]=u.useState(null),[S,Oe]=u.useState(null),[n,qe]=u.useState(!1),[H,Se]=u.useState(!0),[oe,je]=u.useState(!1),[$e,ne]=u.useState(null),[b,dt]=u.useState(!0),O=u.useRef(null),ie=u.useRef(null),[Be,He]=u.useState(Date.now()),We=()=>Date.now()-Be<3e4,[Ne,Ae]=u.useState({width:typeof window<"u"?window.innerWidth:1200,height:typeof window<"u"?window.innerHeight:800});u.useEffect(()=>{if(!c.current)return;const e=["mousedown","touchstart","wheel","movestart","dragstart"],r=()=>{He(Date.now())};return e.forEach(s=>{c.current.on(s,r)}),()=>{e.forEach(s=>{c.current&&c.current.off(s,r)})}},[c.current]),u.useEffect(()=>{const e=()=>{const r=window.innerWidth<768;qe(r),Ae({width:window.innerWidth,height:window.innerHeight}),r&&Se(!1)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),u.useEffect(()=>{const e=()=>{console.log("‚úÖ Internet connection restored"),ae(!0),J(!1),P("online")},r=()=>{console.log("‚ö†Ô∏è Internet connection lost - switching to offline mode"),ae(!1),J(!0),P("offline"),U(null)};return ae(navigator.onLine),J(!navigator.onLine),P(navigator.onLine?"online":"offline"),window.addEventListener("online",e),window.addEventListener("offline",r),()=>{window.removeEventListener("online",e),window.removeEventListener("offline",r)}},[]),u.useEffect(()=>{const e=()=>{I.current?(console.log("Map container is ready in DOM"),_e(!0)):(console.log("Waiting for map container..."),setTimeout(e,100))};e()},[]),u.useEffect(()=>{if((()=>{const i=document.querySelector('link[href*="mapbox-gl.css"]');return i&&i.sheet?(console.log("Mapbox CSS already loaded"),A(!0),!0):!1})())return;const r=document.createElement("link");r.href="https://api.mapbox.com/mapbox-gl-js/v3.0.0/mapbox-gl.css",r.rel="stylesheet",r.type="text/css";let s;const a=()=>{clearTimeout(s),console.log("Mapbox CSS loaded successfully"),A(!0)},o=()=>{clearTimeout(s),console.warn("Mapbox CSS failed to load, continuing anyway"),A(!0)};r.onload=a,r.onerror=o,document.head.appendChild(r),s=setTimeout(()=>{console.warn("Mapbox CSS load timeout, continuing anyway"),A(!0)},5e3)},[]);const le=e=>{if(e<60)return`${e} min`;{const r=Math.floor(e/60),s=e%60;return s===0?`${r}h`:`${r}h ${s}min`}},ee=(e,r,s,a)=>{const i=(s-e)*Math.PI/180,d=(a-r)*Math.PI/180,l=Math.sin(i/2)*Math.sin(i/2)+Math.cos(e*Math.PI/180)*Math.cos(s*Math.PI/180)*Math.sin(d/2)*Math.sin(d/2);return 6371*(2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l)))},Xe=(e,r)=>{if(!e||r.length===0)return r;const s=[...r],a=[],o=s.map(g=>{const w=ee(parseFloat(e.latitude),parseFloat(e.longitude),parseFloat(g.latitude),parseFloat(g.longitude));return{...g,distance:w,coordinates:[parseFloat(g.longitude),parseFloat(g.latitude)]}});o.sort((g,w)=>g.distance-w.distance);const i=o[0];a.push(i);const d=o.slice(1);let l=i;for(;d.length>0;){let g=-1,w=1/0;for(let L=0;L<d.length;L++){const M=ee(parseFloat(l.latitude),parseFloat(l.longitude),parseFloat(d[L].latitude),parseFloat(d[L].longitude));M<w&&(w=M,g=L)}g!==-1&&(l=d[g],a.push(l),d.splice(g,1))}return a},te=async(e,r,s=!1,a=!1)=>{if(!$||e.length<1)return;if(e.filter(i=>i.type!=="station"&&i.status!=="finished"&&i.status!=="completed").length===0){console.log("‚ö†Ô∏è All sites finished - no route to calculate");return}a||(je(!0),Q("Calculating optimal route...")),ne(null);try{const i=e.filter(f=>f.latitude&&f.longitude&&!isNaN(parseFloat(f.latitude))&&!isNaN(parseFloat(f.longitude)));if(i.length<1){console.warn("No valid sites with coordinates found"),ne("No valid sites with coordinates found");return}const d=i.filter(f=>f.type==="station"||f.status!=="finished"&&f.status!=="completed"),l=r?Xe(r,d.filter(f=>f.type!=="station")):d.filter(f=>f.type!=="station");if(Pe(l),l.length>0&&Ue(l[0]),s&&h&&l.length>0){const f=[`${h[0].toFixed(6)},${h[1].toFixed(6)}`,...l.map(j=>`${parseFloat(j.longitude).toFixed(6)},${parseFloat(j.latitude).toFixed(6)}`)];try{const j=await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${f.join(";")}?access_token=${$}&geometries=geojson&overview=full&steps=true&alternatives=false&continue_straight=false&roundabout_exits=true`);if(j.ok){const C=await j.json();if(C.routes&&C.routes.length>0){const q=C.routes[0],se=Math.round(q.duration/60),ge=(q.distance/1e3).toFixed(1);Y(q.geometry.coordinates),K({duration:se,formattedDuration:le(se),distance:ge,targetSite:l[0].site_name,isRealTime:!0,totalStops:l.length}),console.log(`Complete sequential route calculated from driver through ${l.length} sites`),c.current&&p&&E();return}}}catch(j){console.error("Error calculating driver sequential route:",j)}}let g=[];r?g=[`${parseFloat(r.longitude).toFixed(6)},${parseFloat(r.latitude).toFixed(6)}`,...l.map(f=>`${parseFloat(f.longitude).toFixed(6)},${parseFloat(f.latitude).toFixed(6)}`)]:g=l.map(f=>`${parseFloat(f.longitude).toFixed(6)},${parseFloat(f.latitude).toFixed(6)}`);const w=g.length>2,L=await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${g.join(";")}?access_token=${$}&geometries=geojson&overview=full&steps=true&alternatives=false&continue_straight=false`+(w?"&roundabout_exits=true":""));if(!L.ok)throw new Error(`HTTP error! status: ${L.status}`);const M=await L.json();if(M.routes&&M.routes.length>0){const f=M.routes[0];if(f.geometry&&f.geometry.coordinates){const j=Math.round(f.duration/60),C=(f.distance/1e3).toFixed(1);Y(f.geometry.coordinates),K({duration:j,formattedDuration:le(j),distance:C,rawData:f,totalStops:l.length,isRealTime:!1}),console.log(`Station route calculated: ${j}min, ${C}km`),c.current&&p&&E()}else throw new Error("Invalid route geometry received")}else throw new Error(M.message||"No routes found")}catch(i){console.error("Error calculating route:",i),ne(`Route calculation failed: ${i.message}`);const d=e.filter(l=>l.latitude&&l.longitude&&!isNaN(parseFloat(l.latitude))&&!isNaN(parseFloat(l.longitude)));if(d.length>0){const l=d.map(g=>[parseFloat(g.longitude),parseFloat(g.latitude)]);Y(l),K({duration:Math.round(ke(l)*2),formattedDuration:"Estimated",distance:ke(l).toFixed(1),isFallback:!0,totalStops:d.length,isRealTime:!1}),c.current&&p&&E()}}finally{a||(je(!1),_())}},ke=e=>{let r=0;for(let s=1;s<e.length;s++){const[a,o]=e[s-1],[i,d]=e[s];r+=ee(o,a,d,i)}return r},ce=async()=>{if(!(!b||!h||!R.length)){if(ie.current){const[e,r]=ie.current,[s,a]=h;if(ee(r,e,a,s)*1e3<50)return}ie.current=h,console.log("Updating complete sequential route from driver location through all sites");try{const e=[`${h[0].toFixed(6)},${h[1].toFixed(6)}`,...R.map(s=>`${parseFloat(s.longitude).toFixed(6)},${parseFloat(s.latitude).toFixed(6)}`)],r=await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${e.join(";")}?access_token=${$}&geometries=geojson&overview=full&steps=true&alternatives=false&continue_straight=false&roundabout_exits=true`);if(r.ok){const s=await r.json();if(s.routes&&s.routes.length>0){const a=s.routes[0],o=Math.round(a.duration/60),i=(a.distance/1e3).toFixed(1);Y(a.geometry.coordinates),K(d=>({...d,duration:o,formattedDuration:le(o),distance:i,targetSite:R[0].site_name,isRealTime:!0,totalStops:R.length,lastUpdated:new Date().toLocaleTimeString()})),console.log(`Sequential route updated: Driver through ${R.length} sites (${i}km, ${o}min)`),c.current&&p&&E()}}}catch(e){console.error("Error updating real-time route:",e)}}},Ve=()=>{O.current&&clearInterval(O.current),O.current=setInterval(()=>{b&&h&&R.length>0&&ce()},2e3),console.log("Started real-time route updates")},Ge=()=>{O.current&&(clearInterval(O.current),O.current=null),console.log("Stopped real-time route updates")},E=()=>{if(!(!c.current||k.length===0)){if(!c.current.isStyleLoaded()){c.current.once("styledata",()=>{setTimeout(E,100)});return}["route","route-glow","route-direction","route-start","route-end","route-waypoints","driver-route","driver-route-glow"].forEach(e=>{c.current.getLayer(e)&&c.current.removeLayer(e)}),c.current.getSource("route")&&c.current.removeSource("route"),c.current.getSource("driver-route")&&c.current.removeSource("driver-route"),["route-start-marker","route-end-marker","route-waypoints-marker"].forEach(e=>{c.current.getSource(e)&&c.current.removeSource(e)});try{const e=m!=null&&m.isRealTime?"driver-route":"route",r=m!=null&&m.isRealTime?"driver-route":"route",s=m!=null&&m.isRealTime?"driver-route-glow":"route-glow";c.current.addSource(e,{type:"geojson",data:{type:"Feature",properties:{},geometry:{type:"LineString",coordinates:k}}});const a=m!=null&&m.isRealTime?"#000000":"#6B7280",o=n?6:5,i=n?14:12;c.current.addLayer({id:s,type:"line",source:e,layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":a,"line-width":i,"line-opacity":m!=null&&m.isRealTime?.4:.3,"line-blur":10}}),c.current.addLayer({id:r,type:"line",source:e,layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":a,"line-width":o,"line-opacity":.9,"line-dasharray":m!=null&&m.isRealTime?[2,1]:[1,0]}}),c.current.addLayer({id:"route-direction",type:"symbol",source:e,layout:{"symbol-placement":"line","text-field":"‚ñ∂","text-size":n?14:12,"symbol-spacing":100},paint:{"text-color":a}});const d=[];S&&S.latitude&&S.longitude&&!(m!=null&&m.isRealTime)&&d.push({coordinates:[parseFloat(S.longitude),parseFloat(S.latitude)],type:"station",sequence:0}),R.forEach((l,g)=>{l.latitude&&l.longitude&&d.push({coordinates:[parseFloat(l.longitude),parseFloat(l.latitude)],type:"site",sequence:g+1,isTarget:(m==null?void 0:m.isRealTime)&&g===0})}),d.length>0&&(c.current.addSource("route-waypoints-marker",{type:"geojson",data:{type:"FeatureCollection",features:d.map((l,g)=>({type:"Feature",geometry:{type:"Point",coordinates:l.coordinates},properties:{description:l.type==="station"?"Station":l.isTarget?`Target: ${l.sequence}`:`Site ${l.sequence}`,type:l.type,sequence:l.sequence,isTarget:l.isTarget}}))}}),c.current.addLayer({id:"route-waypoints",type:"circle",source:"route-waypoints-marker",paint:{"circle-radius":["case",["==",["get","type"],"station"],n?10:8,["==",["get","isTarget"],!0],n?12:10,n?8:6],"circle-color":["case",["==",["get","type"],"station"],"#dc2626",["==",["get","isTarget"],!0],"#10B981","#3b82f6"],"circle-stroke-width":2,"circle-stroke-color":"#ffffff"}})),!(m!=null&&m.isRealTime)&&k.length>=2&&(c.current.addSource("route-start-marker",{type:"geojson",data:{type:"Feature",geometry:{type:"Point",coordinates:k[0]},properties:{description:"Start"}}}),c.current.addSource("route-end-marker",{type:"geojson",data:{type:"Feature",geometry:{type:"Point",coordinates:k[k.length-1]},properties:{description:"End"}}}),c.current.addLayer({id:"route-start",type:"circle",source:"route-start-marker",paint:{"circle-radius":n?8:6,"circle-color":"#22c55e","circle-stroke-width":2,"circle-stroke-color":"#ffffff"}}),c.current.addLayer({id:"route-end",type:"circle",source:"route-end-marker",paint:{"circle-radius":n?8:6,"circle-color":"#ef4444","circle-stroke-width":2,"circle-stroke-color":"#ffffff"}})),setTimeout(()=>{Le()},200)}catch(e){console.error("Error adding route layer:",e),setTimeout(()=>{E()},500)}}},Le=()=>{if(!c.current||k.length===0||x.length===0)return;const e=new z.LngLatBounds;k.forEach(s=>{e.extend(s)}),S&&e.extend([parseFloat(S.longitude),parseFloat(S.latitude)]),x.forEach(s=>{s.longitude&&s.latitude&&e.extend([parseFloat(s.longitude),parseFloat(s.latitude)])}),h&&e.extend(h);const r=n?40:80;try{c.current.fitBounds(e,{padding:r,duration:1500,essential:!0,maxZoom:n?16:15,offset:[0,n?-50:0]})}catch(s){console.error("Error fitting map to bounds:",s)}},de=e=>e.find(r=>r.type==="station")||null;u.useEffect(()=>(W&&$&&G&&(()=>{if(I.current&&!c.current){if(!$){U("Mapbox key is missing.");return}console.log("Starting map initialization..."),Q("Initializing map...");try{z.accessToken=$;const r={container:I.current,style:"mapbox://styles/mapbox/streets-v12",center:[125.94849837776422,8.483022468128098],zoom:n?11:10.5,attributionControl:!1,interactive:!0,scrollZoom:!0,dragPan:!0,dragRotate:!1,keyboard:!1,doubleClickZoom:!n,touchZoomRotate:!0,touchPitch:!1,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!0,maxTileCacheSize:50,refreshExpiredTiles:xe,transformRequest:(i,d)=>!xe&&d==="Tile"?{url:i,headers:{"Cache-Control":"max-age=86400"}}:{url:i}};c.current=new z.Map(r);const s=()=>{console.log("Map loaded successfully!"),D(!0),U(null),x.length>0&&Re(x),h&&fe(h,{}),k.length>0&&setTimeout(()=>{E()},500),b&&Ve(),_()},a=i=>{var d;if(console.error("Map error:",i),!navigator.onLine||Z){console.warn("Map error suppressed - continuing in offline mode"),J(!0),U(null),p||D(!0);return}U(`Map error: ${((d=i.error)==null?void 0:d.message)||"Unknown error"}`),D(!0),_()};c.current.once("load",s),c.current.on("error",a),c.current.on("dataloading",i=>{var d;(!navigator.onLine||Z)&&((d=i.preventDefault)==null||d.call(i))}),c.current.on("sourcedataloading",i=>{var d;(!navigator.onLine||Z)&&((d=i.preventDefault)==null||d.call(i))});const o=setTimeout(()=>{p||(console.warn("Map load timeout - continuing anyway"),D(!0),_())},1e4);return()=>clearTimeout(o)}catch(r){console.error("Error creating map:",r),U(`Failed to create map: ${r.message}`),D(!0),_()}}})(),()=>{Ge(),c.current&&(console.log("Cleaning up map"),c.current.remove(),c.current=null,D(!1))}),[W,$,G,n]),u.useEffect(()=>{if(x.length>0&&S&&$&&p){if(x.filter(r=>r.type!=="station"&&r.status!=="finished"&&r.status!=="completed").length===0){console.log("‚ö†Ô∏è All sites finished - skipping route calculation");return}console.log("All data available, calculating optimal route..."),te(x,S,b,!0)}},[x,S,$,p]),u.useEffect(()=>{if(b&&h&&R.length>0){const e=setTimeout(()=>{ce()},1e3);return()=>clearTimeout(e)}},[h,b]),u.useEffect(()=>{c.current&&k.length>0&&p&&E()},[k,p]),u.useEffect(()=>{p&&x.length>0&&(console.log("üîÑ Force updating site markers due to state change"),console.log("üìä Sites to render:",x.map(e=>({id:e.id,name:e.site_name,status:e.status}))),Re(x))},[p,x,n,b,T]),u.useEffect(()=>{if(!(N!=null&&N.id))return;console.log("‚è∞ Starting polling for site updates every 5 seconds");const e=setInterval(async()=>{try{const r=await B.get(`/schedule/${N.id}/sites`);if(r.data.success){const s=r.data.data;if(s.some((o,i)=>{const d=x.find(l=>l.id===o.id);return d&&d.status!==o.status}))if(console.log("üîÑ POLLING: Site status changed, updating silently"),X(s),s.filter(i=>i.type!=="station"&&i.status!=="finished"&&i.status!=="completed").length>0){const i=de(s);i&&p&&setTimeout(()=>{te(s,i,b&&h,!0)},200)}else console.log("‚ö†Ô∏è All sites finished - no route calculation needed")}}catch(r){console.error("Polling error:",r)}},5e3);return()=>{console.log("‚è∞ Stopping site polling"),clearInterval(e)}},[N==null?void 0:N.id,x]),u.useEffect(()=>{p&&h&&(console.log("Force updating driver marker"),fe(h,{}))},[p,h,n]),u.useEffect(()=>{if(!y)return;const e=async()=>{try{console.log("Initializing Reverb connection for real-time location updates..."),st();const a=Te();if(!a)throw new Error("Echo not initialized");a.channel(`driver-locations.${y}`).listen("DriverLocationUpdated",o=>{console.log("Real-time driver location update received:",o),P("connected"),me(o)}),a.channel(`schedule-updates.${y}`).listen("ScheduleStatusUpdated",o=>{console.log("Schedule update received:",o),Je(o.schedule)}),a.channel(`site-completion.${y}`).listen("SiteCompletionUpdated",o=>{console.log("üéØ REALTIME: Site completion event received:",{barangay_id:y,event_data:o,site_id:o.site_id||o.siteId,status:o.status,site_name:o.site_name||o.siteName,completed_sites:o.completed_sites,total_sites:o.total_sites}),Me(o),ue()}),P("connected"),await Ze(),r()}catch(a){console.error("Realtime connection failed:",a),P("disconnected"),r()}},r=()=>{const a=setInterval(()=>{s()},1e4);return()=>clearInterval(a)},s=async()=>{try{if(F){const a=await B.get(`/schedule/${F}/driver-location`);a.data.success&&a.data.data&&me(a.data.data)}}catch(a){console.error("Error polling driver location:",a)}};return e(),()=>{const a=Te();a&&(a.leave(`driver-locations.${y}`),a.leave(`schedule-updates.${y}`),a.leave(`site-completion.${y}`))}},[y,F]);const ue=async(e=!0)=>{try{if(e||console.log("üîÑ Refreshing sites from server..."),!N||!N.id){console.warn("No current schedule available to refresh sites");return}const r=await B.get(`/schedule/${N.id}/sites`);if(r.data.success){const s=r.data.data;if(e||console.log("‚úÖ Sites refreshed from server:",s.map(o=>({id:o.id,name:o.site_name,status:o.status}))),X(s),s.filter(o=>o.type!=="station"&&o.status!=="finished"&&o.status!=="completed").length>0){const o=de(s);o&&p&&setTimeout(()=>{te(s,o,b&&h,!0)},200)}else console.log("‚ö†Ô∏è All sites finished - no route calculation needed")}}catch(r){console.error("Error refreshing sites from server:",r)}};u.useEffect(()=>{window.testSiteCompletion=e=>{console.log("üß™ TEST: Manually triggering site completion for site ID:",e),Me({site_id:e,status:"finished",completed_at:new Date().toISOString(),site_name:"Test Site"})},window.refreshResidentMap=()=>{console.log("üß™ TEST: Manually refreshing resident map"),ue()}},[x,N]);const Ze=async()=>{try{ve(!0),Q("Loading collection sites...");const e=await B.get(`/barangay/${y}/current-schedule`);if(e.data.success){const r=e.data.data;if(pe(r),r.id){const s=await B.get(`/schedule/${r.id}/sites`);if(s.data.success){const a=s.data.data;X(a);const o=de(a);o&&(Oe(o),console.log("Station found:",o.site_name))}}if(F){const s=await B.get(`/schedule/${F}/driver-location`);s.data.success&&s.data.data&&me(s.data.data)}}_(),ye(!1)}catch(e){console.error("Error loading initial data:",e),_(),ye(!1)}finally{ve(!1)}},me=e=>{if(!e.longitude||!e.latitude){console.warn("Invalid location data received:",e);return}const r=[parseFloat(e.longitude),parseFloat(e.latitude)];console.log("Updating driver location on map:",r),Ee(r),p&&c.current&&(fe(r,e),We()||c.current.flyTo({center:r,zoom:n?16:15,duration:2e3,essential:!0,offset:[0,n?-100:0]}),b&&ce())},Me=e=>{console.log("üéØ PROCESSING site completion:",{received_data:e,site_id_variants:{site_id:e.site_id,siteId:e.siteId},current_sites_count:x.length}),X(r=>{console.log("üìã Current sites before update:",r.map(a=>({id:a.id,name:a.site_name,status:a.status})));const s=r.map(a=>a.id===e.site_id||a.id===e.siteId?(console.log(`‚úÖ MARKING site ${a.site_name} (ID: ${a.id}) as FINISHED`),{...a,status:"finished",collectionStatus:"finished",completed_at:e.completed_at||new Date().toISOString()}):a);return console.log("üìã Sites after update:",s.map(a=>({id:a.id,name:a.site_name,status:a.status}))),s}),setTimeout(()=>{console.log("üîÑ Refreshing sites from server"),ue()},1e3)},fe=(e,r)=>{if(!c.current||!p)return;he&&he.remove();const s=n?"w-12 h-12":"w-10 h-10",a=n?"w-6 h-6":"w-5 h-5",o=document.createElement("div");o.className="driver-location-marker";const d=(r.timestamp?(new Date-new Date(r.timestamp))/1e3:0)<30;o.innerHTML=`
      <div class="relative">
        <div class="${s} bg-blue-600 border-3 border-white rounded-full shadow-lg flex items-center justify-center relative z-10">
          <svg class="${a} text-white" viewBox="0 0 24 24" fill="currentColor">
            <path d="M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z"/>
            <path d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0"/>
          </svg>
          ${d?"":`
            <div class="absolute -top-1 -right-1 w-3 h-3 bg-yellow-500 rounded-full border border-white"></div>
          `}
        </div>
        <div class="absolute inset-0 bg-blue-400 rounded-full animate-ping opacity-30"></div>
        ${r.accuracy?`
          <div class="absolute inset-0 border-2 border-blue-300 rounded-full opacity-50" 
               style="transform: scale(${Math.min(r.accuracy/10,3)})"></div>
        `:""}
      </div>
    `;try{const l=new z.Marker({element:o,draggable:!1}).setLngLat(e).addTo(c.current),g=new z.Popup({offset:25,closeButton:!1,className:`custom-popup ${n?"max-w-xs":"max-w-sm"}`}).setHTML(`
        <div class="text-sm ${n?"p-2":"p-3"}">
          <div class="font-semibold text-gray-900 ${n?"text-base":""}">üöó Driver Location</div>
          <div class="text-xs text-gray-500 mt-1">
            ${r.timestamp?`Updated: ${new Date(r.timestamp).toLocaleTimeString()}`:"Live"}
          </div>
          ${r.accuracy?`
            <div class="text-xs text-gray-500 mt-1">
              Accuracy: ¬±${Math.round(r.accuracy)} meters
            </div>
          `:""}
          ${d?"":`
            <div class="text-xs text-yellow-600 mt-1 font-medium">
              ‚ö†Ô∏è Location data may be delayed
            </div>
          `}
        </div>
      `);l.setPopup(g),Ce(l)}catch(l){console.error("Error creating driver marker:",l)}},Je=e=>{pe(e)},Re=e=>{if(!c.current||!p)return;re.forEach(s=>{s&&s.remove&&s.remove()});const r=e.map((s,a)=>{if(!s.longitude||!s.latitude)return null;try{const o=document.createElement("div");o.className="site-marker";const i=s.status==="completed"||s.status==="finished"||s.collectionStatus==="finished",d=s.status==="in_progress",l=s.type==="station",g=s.purok_name||s.site_name||"Site",w=b&&T&&T.id===s.id&&!i;i&&console.log(`‚úì Rendering completed site: ${s.site_name} (ID: ${s.id})`);const L=()=>l?"#DC2626":i||w?"#10B981":"#6B7280",M=()=>l?`
              <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
              </svg>
            `:i?`
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
              </svg>
            `:`
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M3 6h18"/>
                <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
              </svg>
            `,f=n?"w-14 h-14":"w-12 h-12",j=n?"w-7 h-7":"w-6 h-6",C=n?"w-8 h-8":"w-7 h-7",q=R.findIndex(tt=>tt.id===s.id)+1,se=q>0;o.innerHTML=`
          <div class="relative ${d||w?"animate-pulse":""}">
            ${se&&!l&&!i?`
              <div class="absolute -top-2 -right-2 bg-blue-500 text-white rounded-full ${n?"w-7 h-7 text-sm":"w-6 h-6 text-xs"} flex items-center justify-center font-bold shadow-lg border-2 border-white z-20">
                ${q}
              </div>
            `:""}
            ${l?`
              <div class="${f} rounded-full bg-white shadow-2xl border-4 border-red-600 flex items-center justify-center">
                <div class="${C} text-red-600">
                  ${M()}
                </div>
              </div>
            `:`
              <div class="${f} rounded-full border-3 border-white flex items-center justify-center shadow-lg" 
                    style="background-color: ${L()}; ${i?"opacity: 0.7;":""}">
                <div class="${j} text-white">
                  ${M()}
                </div>
              </div>
            `}
            ${d?'<div class="absolute inset-0 rounded-full border-3 border-yellow-500 animate-ping"></div>':""}
            ${w&&!d?'<div class="absolute inset-0 rounded-full border-3 border-green-500 animate-ping"></div>':""}
          </div>
        `;const ge=[parseFloat(s.longitude),parseFloat(s.latitude)],et=new z.Popup({offset:25,closeButton:!1,className:`custom-popup ${n?"max-w-xs":"max-w-sm"}`}).setHTML(`
          <div class="text-sm ${n?"p-2":"p-3"}">
            <div class="font-semibold text-gray-900 ${n?"text-base":""}">${g}</div>
            <div class="text-xs text-gray-500 mt-1">
              ${l?"Collection Station":i?"Completed":d?"In Progress":"Pending"}
            </div>
            ${w&&b&&'<div class="text-xs text-green-600 mt-1 font-medium">üéØ Current Target</div>'}
            ${T&&T.id===s.id&&!w&&'<div class="text-xs text-green-600 mt-1 font-medium">üìç Nearest Site</div>'}
          </div>
        `);return new z.Marker({element:o,draggable:!1}).setLngLat(ge).setPopup(et).addTo(c.current)}catch(o){return console.error("Error creating marker:",o),null}}).filter(s=>s!==null);Fe(r)},Qe=async()=>{x.length>0&&S&&(Q("Refreshing route..."),await te(x,S,b))},Ye=()=>{Se(!H)},Ke=()=>v?"100%":Ne.width<640?"400px":Ne.width<768?"500px":"600px";return u.useEffect(()=>{console.log("Current state:",{cssLoaded:W,mapInitialized:p,containerReady:G,siteLocationsCount:x.length,siteMarkersCount:re.length,driverLocation:!!h})},[W,p,G,x,re,h]),t.jsxs("div",{className:`${v?"w-full h-full":"w-full"} bg-white ${v?"":"rounded-lg border border-gray-200"} overflow-hidden`,children:[t.jsx(it,{isLoading:ze,message:Ie,size:n?"medium":"large",variant:"default"}),Z&&t.jsxs("div",{className:"absolute top-0 left-0 right-0 bg-yellow-500 text-black px-4 py-2 z-50 flex items-center justify-center gap-2 shadow-lg",children:[t.jsx(rt,{className:"w-5 h-5"}),t.jsx("span",{className:"font-semibold text-sm",children:"Offline Mode - Using cached map data"})]}),t.jsxs("div",{className:`relative w-full ${v?"h-full":""}`,style:{height:v?"100%":Ke()},children:[t.jsx("div",{ref:I,className:"w-full h-full absolute inset-0"}),p&&t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:`absolute ${n?"bottom-2 left-2":"bottom-4 left-4"} bg-white/95 backdrop-blur-sm rounded-lg shadow-lg border border-gray-200 ${n?"p-2":"p-3"} z-10 ${n?"min-w-40 max-w-48":v?"min-w-52":"min-w-48"}`,children:[t.jsxs("div",{className:`font-semibold ${n?"text-xs":"text-sm"} text-gray-900 ${n?"mb-2":"mb-3"} flex items-center justify-between`,children:[t.jsx("span",{children:"Legend"}),v&&!n&&t.jsx("span",{className:"text-xs font-normal text-gray-500",children:"Live Tracking"})]}),t.jsxs("div",{className:`space-y-1 ${n?"text-xs":"text-sm"}`,children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("div",{className:"w-4 h-4 bg-blue-600 rounded-full flex items-center justify-center flex-shrink-0 relative",children:t.jsx("div",{className:"absolute inset-0 bg-blue-400 rounded-full animate-ping opacity-30"})}),t.jsx("span",{className:"text-gray-700",children:"Driver"})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("div",{className:"w-4 h-4 bg-red-600 rounded-full flex-shrink-0"}),t.jsx("span",{className:"text-gray-700",children:"Station"})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("div",{className:"w-4 h-4 bg-gray-500 rounded-full flex-shrink-0"}),t.jsx("span",{className:"text-gray-700",children:"Pending"})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("div",{className:"w-4 h-4 bg-green-600 rounded-full flex-shrink-0"}),t.jsx("span",{className:"text-gray-700",children:"Completed"})]}),b&&T&&t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("div",{className:"w-4 h-4 bg-green-500 rounded-full flex-shrink-0 relative",children:t.jsx("div",{className:"absolute inset-0 rounded-full border-2 border-white animate-ping"})}),t.jsx("span",{className:"text-gray-700",children:"Target Site"})]}),m&&t.jsxs("div",{className:"flex items-center gap-2 pt-1 border-t border-gray-200",children:[t.jsx("div",{className:"w-4 h-1 rounded-full flex-shrink-0",style:{backgroundColor:m.isRealTime?"#000000":"#6B7280"}}),t.jsx("span",{className:"text-gray-700",children:m.isRealTime?"Live Route":"Planned Route"})]})]})]}),t.jsxs("div",{className:`absolute ${n?"top-2 right-2":"top-4 right-4"} flex ${v&&!n?"flex-row gap-2":"flex-col gap-2"} z-10`,children:[t.jsx("button",{onClick:Qe,disabled:oe,className:`${v?"bg-white/95 backdrop-blur-sm":"bg-white"} rounded-lg shadow-lg border border-gray-200 hover:bg-gray-50 transition-colors flex items-center justify-center ${n?"p-2":"p-3"} ${oe?"opacity-50 cursor-not-allowed":""}`,title:"Refresh route",children:oe?t.jsx("div",{className:`animate-spin rounded-full border-b-2 border-gray-700 ${n?"w-4 h-4":"w-5 h-5"}`}):t.jsx(at,{className:`text-gray-700 ${n?"w-4 h-4":"w-5 h-5"}`})}),t.jsx("button",{onClick:Ye,className:`${v?"bg-white/95 backdrop-blur-sm":"bg-white"} rounded-lg shadow-lg border ${H?"border-blue-500 bg-blue-50":"border-gray-200"} hover:bg-gray-50 transition-colors flex items-center justify-center ${n?"p-2":"p-3"}`,title:H?"Hide route info":"Show route info",children:t.jsx(ot,{className:`${H?"text-blue-600":"text-gray-700"} ${n?"w-4 h-4":"w-5 h-5"}`})}),t.jsx("button",{onClick:Le,className:`${v?"bg-white/95 backdrop-blur-sm":"bg-white"} rounded-lg shadow-lg border border-gray-200 hover:bg-gray-50 transition-colors flex items-center justify-center ${n?"p-2":"p-3"}`,title:"Fit to route",children:t.jsx(nt,{className:`text-gray-700 ${n?"w-4 h-4":"w-5 h-5"}`})})]}),t.jsx("div",{className:`absolute ${n?"top-2 left-2":"top-4 left-4"} bg-white/95 backdrop-blur-sm rounded-lg shadow-lg border border-gray-200 ${n?"px-2 py-1":"px-3 py-2"} z-10`,children:t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("div",{className:`w-2 h-2 rounded-full ${V==="connected"?"bg-green-500":V==="connecting"?"bg-yellow-500":"bg-red-500"} ${V==="connected"?"animate-pulse":""}`}),t.jsx("span",{className:`font-medium text-gray-700 capitalize ${n?"text-xs":"text-sm"}`,children:V})]})}),m&&H&&t.jsxs("div",{className:`absolute ${n?"top-12 left-2 right-2":v?"top-4 left-1/2 transform -translate-x-1/2":"top-16 left-4"} bg-white/95 backdrop-blur-sm rounded-lg shadow-lg border border-gray-200 ${n?"p-3":"p-4"} z-10 ${n?"":v?"min-w-80 max-w-md":"min-w-64"}`,children:[t.jsxs("div",{className:`font-semibold text-gray-900 ${n?"text-sm mb-2":"text-base mb-3"} flex items-center justify-between`,children:[t.jsx("span",{children:m.isRealTime?"Live Route":"Planned Route"}),t.jsxs("div",{className:"flex gap-1",children:[m.isRealTime&&t.jsxs("span",{className:"text-xs bg-green-100 text-green-800 px-2 py-1 rounded flex items-center gap-1",children:[t.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-pulse"}),"Live"]}),m.isFallback&&t.jsx("span",{className:"text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded",children:"Estimated"})]})]}),t.jsxs("div",{className:`space-y-2 ${n?"text-xs":"text-sm"} text-gray-600`,children:[t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsx("span",{children:"Estimated Time:"}),t.jsx("span",{className:"font-semibold text-blue-600",children:m.formattedDuration})]}),t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsx("span",{children:"Distance:"}),t.jsxs("span",{className:"font-semibold",children:[m.distance," km"]})]}),t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsx("span",{children:"Total Stops:"}),t.jsxs("span",{className:"font-semibold",children:[m.totalStops," sites"]})]}),m.targetSite&&t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsx("span",{children:"Target Site:"}),t.jsx("span",{className:"font-semibold text-green-600",children:m.targetSite})]}),T&&!m.targetSite&&t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsx("span",{children:"Nearest Site:"}),t.jsx("span",{className:"font-semibold text-green-600",children:T.site_name})]}),m.lastUpdated&&t.jsxs("div",{className:"flex justify-between items-center text-xs text-gray-500",children:[t.jsx("span",{children:"Last Updated:"}),t.jsx("span",{children:m.lastUpdated})]})]}),$e&&t.jsx("div",{className:`mt-2 p-2 bg-red-50 border border-red-200 rounded ${n?"text-xs":"text-sm"} text-red-600`,children:$e})]})]})]})]})};export{ht as default};
