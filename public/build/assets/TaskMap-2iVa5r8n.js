import{r as L,j as e}from"./app-Cc2yil4n.js";import"./mapbox-gl-BDCb7C5Y.js";import{I as G,a as O,b as ee,c as se}from"./index-DWIXb_JG.js";import{useTaskMap as te}from"./useTaskMap-CvMQdHKG.js";import ae from"./CompletionReportModal-C4Vb_K2I.js";import{g as f}from"./useSiteManagement-CGgM1KaP.js";/* empty css                  */import"./iconBase-Cb3GE4JV.js";import"./useLocationTracking-CttQMp45.js";import"./useMapboxSetup-BzTPYKFX.js";import"./useMapLayers-CSVJnvwG.js";import"./index-DxqkS5Mx.js";import"./can-3MqaZyCZ.js";import"./useRouteCalculations-BEc4-flV.js";const Pe=L.forwardRef(({mapboxKey:s,scheduleId:t,onTaskComplete:a,onTaskCancel:n,autoGetLocation:i=!1},r)=>{const{mapContainer:l,siteMarkersRef:d,cssLoaded:o,siteLocations:x,stationLocation:j,mapInitialized:b,activeSchedule:c,routeCoordinates:he,loading:N,currentLocation:u,routeInfo:D,mapError:v,customStyleLoaded:ue,aiOptimizedRoute:y,nearestSiteToStation:ge,isMobile:g,showAIPanel:E,showControls:A,optimizedSiteOrder:w,isOnline:pe,locationAccuracy:fe,lastLocationUpdate:je,completedSites:p,currentSiteIndex:k,isTaskActive:C,isFakeLocationActive:z,showCompletionModal:$,setShowCompletionModal:R,formatDuration:be,getCurrentLocation:T,getAIOptimizedRoute:B,setShowAIPanel:F,setShowControls:H,startRealtimeLocationTracking:U,stopRealtimeLocationTracking:V,updateLocationManually:_,resetCompletedSites:M,markSiteAsCompleted:q,startTaskAndBroadcast:I,completeTaskAndBroadcast:S,sendLocationToReverb:Ne,startFakeLocationTest:J,stopFakeLocationTest:K,sendTestLocation:Q,simulateRouteFollowing:W}=te({mapboxKey:s,scheduleId:t,onTaskComplete:a,onTaskCancel:n});L.useImperativeHandle(r,()=>({getCurrentLocation:()=>{T()},fitMapToRoute:()=>{console.log("Fit map to route function called")},startRealtimeLocationTracking:()=>{U()},stopRealtimeLocationTracking:()=>{V()},updateLocationManually:(h,m)=>{_(h,m)},resetCompletedSites:()=>{M()},markSiteAsCompleted:h=>{const m=x.find(Z=>Z.id===h);m&&q(m)},startTaskAndBroadcast:()=>{I()},completeTaskAndBroadcast:()=>{S()},startFakeLocationTest:()=>{J()},stopFakeLocationTest:()=>{K()},sendTestLocation:(h,m)=>{Q(h,m)},simulateRouteFollowing:()=>{W()}})),L.useEffect(()=>{i&&!u&&!N&&b&&(console.log("Auto-getting location on component mount"),T())},[i,u,N,b]);const X=()=>{S()},Y=()=>{I()};return e.jsxs("div",{className:"relative w-full h-full bg-white",children:[N&&e.jsx(ne,{}),v&&e.jsx(le,{error:v}),!o&&!v&&e.jsx(ie,{}),g&&e.jsx(re,{showControls:A,setShowControls:H,siteLocations:x,currentLocation:u,completedSites:p,currentSiteIndex:k,optimizedSiteOrder:w,isTaskActive:C,isFakeLocationActive:z}),y&&e.jsx(oe,{aiOptimizedRoute:y,isMobile:g,showAIPanel:E,setShowAIPanel:F,completedSites:p,currentSiteIndex:k,optimizedSiteOrder:w}),e.jsx(xe,{isMobile:g,showControls:A,getAIOptimizedRoute:B,getCurrentLocation:T,onTaskComplete:X,onTaskCancel:n,onTaskStart:Y,scheduleId:t,currentLocation:u,completedSites:p,resetCompletedSites:M,activeSchedule:c,isTaskActive:C}),!1,c&&e.jsx(me,{activeSchedule:c,siteLocations:x,routeInfo:D,isMobile:g,aiOptimizedRoute:y,setShowAIPanel:F,completedSites:p,currentSiteIndex:k,optimizedSiteOrder:w,isTaskActive:C,isFakeLocationActive:z}),e.jsx("div",{ref:l,className:"w-full h-full absolute inset-0",style:{width:"100%",height:"100%",minHeight:"400px"}}),e.jsx(ae,{isOpen:$,onClose:()=>R(!1),scheduleId:t,scheduleName:(c==null?void 0:c.barangay_name)||"Collection Schedule",onSubmitSuccess:()=>{R(!1),a&&a(null,!0)}})]})}),ne=()=>e.jsx("div",{className:"absolute inset-0 bg-white bg-opacity-80 flex items-center justify-center z-50",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-3"}),e.jsx("p",{className:"text-sm text-gray-600 font-medium",children:"AI analyzing optimal route..."}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Finding fastest path to nearest site"})]})}),le=({error:s})=>e.jsx("div",{className:"absolute inset-0 bg-white flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"text-center p-6 bg-white rounded-lg shadow-xl max-w-sm",children:[e.jsx("div",{className:"text-red-500 text-lg font-semibold mb-2",children:"Map Error"}),e.jsx("div",{className:"text-gray-600 mb-4 text-sm",children:s}),e.jsx("button",{onClick:()=>window.location.reload(),className:"bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors font-medium text-sm",children:"Retry"})]})}),ie=()=>e.jsx("div",{className:"absolute inset-0 bg-white flex items-center justify-center z-40",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-3"}),e.jsx("p",{className:"text-sm text-gray-600 font-medium",children:"Loading map..."})]})}),re=({showControls:s,setShowControls:t,siteLocations:a,currentLocation:n,completedSites:i,currentSiteIndex:r,optimizedSiteOrder:l,isTaskActive:d,isFakeLocationActive:o})=>e.jsx("div",{className:"absolute top-0 left-0 right-0 z-30 bg-white/95 backdrop-blur-sm border-b border-gray-200 px-4 py-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:()=>t(!s),className:"p-2 rounded-lg bg-gray-100 hover:bg-gray-200 transition-colors",children:s?e.jsx(G,{className:"w-5 h-5"}):e.jsx(O,{className:"w-5 h-5"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"font-semibold text-gray-900 text-sm",children:"Collection Route"}),e.jsxs("p",{className:"text-xs text-gray-600",children:[i.size,"/",a.length," sites completed"]}),r<l.length&&e.jsxs("p",{className:"text-xs text-blue-600 font-medium",children:["Next: ",f(l[r])]}),d&&e.jsx("p",{className:"text-xs text-green-600 font-medium",children:"ðŸ”´ Live - Broadcasting to residents"}),o&&e.jsx("p",{className:"text-xs text-purple-600 font-medium",children:"ðŸ§ª Fake Location Test Active"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[n&&e.jsx("div",{className:"w-3 h-3 bg-green-500 rounded-full animate-pulse"}),i.size>0&&e.jsxs("div",{className:"text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full",children:[i.size," done"]}),o&&e.jsx("div",{className:"text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded-full",children:"Testing"})]})]})}),oe=({aiOptimizedRoute:s,isMobile:t,showAIPanel:a,setShowAIPanel:n,completedSites:i,currentSiteIndex:r,optimizedSiteOrder:l})=>t?e.jsx("div",{className:`absolute bottom-0 left-0 right-0 z-40 bg-white border-t border-gray-200 rounded-t-2xl shadow-2xl transition-transform duration-300 ${a?"transform translate-y-0":"transform translate-y-full"}`,children:e.jsx(ce,{aiOptimizedRoute:s,setShowAIPanel:n,completedSites:i,currentSiteIndex:r,optimizedSiteOrder:l})}):e.jsx("div",{className:"absolute top-4 left-4 z-20 bg-green-50 border border-green-200 rounded-lg p-4 shadow-lg max-w-sm",children:e.jsx(de,{aiOptimizedRoute:s,completedSites:i,currentSiteIndex:r,optimizedSiteOrder:l})}),ce=({aiOptimizedRoute:s,setShowAIPanel:t,completedSites:a,currentSiteIndex:n,optimizedSiteOrder:i})=>e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex justify-center pt-3 pb-2",children:e.jsx("div",{className:"w-12 h-1 bg-gray-300 rounded-full"})}),e.jsx("button",{onClick:()=>t(!1),className:"absolute top-3 right-4 p-1 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors",children:e.jsx(ee,{className:"w-4 h-4 text-gray-600"})}),e.jsx("div",{className:"p-4 max-h-64 overflow-y-auto",children:e.jsx(P,{aiOptimizedRoute:s,completedSites:a,currentSiteIndex:n,optimizedSiteOrder:i})})]}),de=({aiOptimizedRoute:s,completedSites:t,currentSiteIndex:a,optimizedSiteOrder:n})=>e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(se,{className:"w-5 h-5 text-green-600"}),e.jsx("h3",{className:"font-semibold text-green-800",children:"AI Route Optimized"}),t.size>0&&e.jsxs("span",{className:"bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full",children:[t.size," completed"]})]}),e.jsx(P,{aiOptimizedRoute:s,completedSites:t,currentSiteIndex:a,optimizedSiteOrder:n})]}),P=({aiOptimizedRoute:s,completedSites:t,currentSiteIndex:a,optimizedSiteOrder:n})=>e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Current Target:"}),e.jsx("span",{className:"font-semibold",children:f(n[a])||f(s.nearestSite)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Progress:"}),e.jsxs("span",{className:"font-semibold",children:[t.size,"/",n.length," sites"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Distance:"}),e.jsxs("span",{className:"font-semibold",children:[s.distance," km"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Est. Time:"}),e.jsx("span",{className:"font-semibold",children:s.formattedDuration})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Traffic:"}),e.jsx("span",{className:`font-semibold ${s.trafficConditions.conditions==="heavy"?"text-red-600":s.trafficConditions.conditions==="moderate"?"text-yellow-600":"text-green-600"}`,children:s.trafficConditions.conditions})]})]}),e.jsxs("div",{className:"mt-3 p-2 bg-white rounded border",children:[e.jsx("p",{className:"text-xs text-gray-700",children:s.recommendation.text}),e.jsxs("p",{className:"text-xs text-blue-600 mt-1",children:["ðŸ’¡ ",s.recommendation.suggestedAction]}),t.size>0&&e.jsxs("p",{className:"text-xs text-green-600 mt-2 font-medium",children:["âœ… ",t.size," site(s) completed"]})]})]}),xe=({isMobile:s,showControls:t,getAIOptimizedRoute:a,getCurrentLocation:n,onTaskComplete:i,onTaskCancel:r,onTaskStart:l,scheduleId:d,currentLocation:o,completedSites:x,resetCompletedSites:j,activeSchedule:b,isTaskActive:c})=>e.jsx("div",{className:`absolute ${s?"top-16":"top-4"} right-4 z-10 flex flex-col gap-3 transition-all duration-300 ${s&&!t?"opacity-0 pointer-events-none":"opacity-100"}`}),me=({activeSchedule:s,siteLocations:t,routeInfo:a,isMobile:n,aiOptimizedRoute:i,setShowAIPanel:r,completedSites:l,currentSiteIndex:d,optimizedSiteOrder:o,isTaskActive:x,isFakeLocationActive:j})=>e.jsxs("div",{className:`absolute ${n?"bottom-20 left-4 right-4":"bottom-4 left-4"} z-10 bg-white/95 backdrop-blur-sm p-3 rounded-lg shadow-lg ${n?"max-w-full":"max-w-xs"}`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"text-sm font-medium text-gray-900",children:[e.jsx("span",{className:"text-blue-600 font-bold",children:t.length})," sites to collect"]}),l.size>0&&e.jsxs("div",{className:"text-xs text-green-600 font-medium",children:[l.size," completed â€¢ ",t.length-l.size," remaining"]}),d<o.length&&e.jsxs("div",{className:"text-xs text-blue-600",children:["Current: ",f(o[d])]}),x&&e.jsxs("div",{className:"text-xs text-green-600 font-medium flex items-center gap-1",children:[e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-pulse"}),"Live - Residents can see your location"]}),j&&e.jsxs("div",{className:"text-xs text-purple-600 font-medium flex items-center gap-1",children:[e.jsx("div",{className:"w-2 h-2 bg-purple-500 rounded-full animate-pulse"}),"Testing Mode - Fake locations active"]})]}),a&&e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-xs text-gray-600",children:[e.jsx("span",{className:"font-medium",children:a.formattedDuration})," â€¢",e.jsxs("span",{className:"font-medium",children:[" ",a.distance," km"]})]}),a.toSite&&e.jsxs("div",{className:"text-xs text-gray-500",children:["To: ",a.toSite]}),a.recalculated&&e.jsx("div",{className:"text-xs text-orange-600 font-medium",children:"Route Recalculated"}),n&&i&&e.jsx("button",{onClick:()=>r(!0),className:"text-xs text-blue-600 font-medium mt-1",children:"View AI Route"})]})]}),l.size>0&&e.jsxs("div",{className:"mt-2",children:[e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2",children:e.jsx("div",{className:"bg-green-500 h-2 rounded-full transition-all duration-300",style:{width:`${l.size/t.length*100}%`}})}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1 text-center",children:[Math.round(l.size/t.length*100),"% complete"]})]})]});export{Pe as default};
