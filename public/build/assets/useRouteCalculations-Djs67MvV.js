import{r as S}from"./app-Fn98fs5j.js";const tt=({mapboxKey:m,isOnline:C,activeSchedule:X,optimizedSiteOrder:D,completedSites:M,siteLocations:U,currentLocation:H,routeCoordinates:Z,routeInfo:K,map:$,isMobile:O,addRouteLayer:F})=>{const k=S.useRef(new Map),[R,d]=S.useState([]),[_,g]=S.useState(null),[J,x]=S.useState(null),w=(t,e,o,a)=>{const s=(o-t)*Math.PI/180,r=(a-e)*Math.PI/180,i=Math.sin(s/2)*Math.sin(s/2)+Math.cos(t*Math.PI/180)*Math.cos(o*Math.PI/180)*Math.sin(r/2)*Math.sin(r/2);return 6371*(2*Math.atan2(Math.sqrt(i),Math.sqrt(1-i)))},f=t=>{if(t<60)return`${t} min`;{const e=Math.floor(t/60),o=t%60;return o===0?`${e}h`:`${e}h ${o}min`}},j=t=>{if(t<60)return`${t} minutes`;{const e=Math.floor(t/60),o=t%60;return o===0?`${e} hour${e>1?"s":""}`:`${e} hour${e>1?"s":""} ${o} minute${o>1?"s":""}`}},y=(t,e)=>{const o={data:e,timestamp:Date.now(),ttl:864e5};k.current.set(t,o);try{const a=JSON.parse(localStorage.getItem("routeCache")||"{}");a[t]=o,localStorage.setItem("routeCache",JSON.stringify(a))}catch(a){console.warn("Failed to cache route in localStorage:",a)}},p=t=>{const e=k.current.get(t);if(e&&Date.now()-e.timestamp<e.ttl)return e.data;try{const a=JSON.parse(localStorage.getItem("routeCache")||"{}")[t];if(a&&Date.now()-a.timestamp<a.ttl)return k.current.set(t,a),a.data}catch(o){console.warn("Failed to read route from cache:",o)}return null},b=()=>{for(let t=0;t<D.length;t++)if(!M.has(D[t].id))return t;return-1},q=()=>M.size===U.length,z=(t,e)=>{if(!t||!e)return;const o=[t,[parseFloat(e.longitude),parseFloat(e.latitude)]];d(o);const a=w(t[1],t[0],parseFloat(e.latitude),parseFloat(e.longitude)),n=Math.round(a*2);g({duration:n,formattedDuration:f(n),distance:a.toFixed(1),toSite:e.site_name,isFallback:!0,recalculated:!0}),setTimeout(()=>{$.current&&F()},300)},Y=async t=>{if(!t||!D.length)return;const e=b();if(e===-1){console.log("All sites completed, no route to recalculate");return}const o=D[e];console.log(`Recalculating route from current position to: ${o.site_name}`);try{const a=`${t[0]},${t[1]};${parseFloat(o.longitude)},${parseFloat(o.latitude)}`,n=`current_to_site_${o.id}_${Date.now()}`,s=p(n);if(s&&!C){console.log("Using cached route (offline mode)"),d(s.route),g({duration:s.duration,formattedDuration:f(s.duration),distance:s.distance,toSite:o.site_name,recalculated:!0}),setTimeout(()=>{$.current&&F()},100);return}const r=await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${a}?access_token=${m}&geometries=geojson&overview=full&steps=true&alternatives=false`);if(!r.ok)throw new Error(`HTTP ${r.status}: ${r.statusText}`);const i=await r.json();if(i.routes&&i.routes.length>0){const c=i.routes[0],l=Math.round(c.duration/60),u={route:c.geometry.coordinates,duration:l,formattedDuration:f(l),distance:(c.distance/1e3).toFixed(1),toSite:o.site_name};d(c.geometry.coordinates),g({duration:l,formattedDuration:f(l),distance:(c.distance/1e3).toFixed(1),toSite:o.site_name,recalculated:!0}),y(n,u),console.log(`Route recalculated: Current position → ${o.site_name}`),setTimeout(()=>{$.current&&c.geometry.coordinates.length>0&&F()},300)}}catch(a){console.error("Error recalculating route from current position:",a),z(t,o)}},G=t=>{if(!H||!R.length||R.length<2)return!0;const e=w(t[1],t[0],R[0][1],R[0][0]),o=M.size>0,a=e>.2,n=!(_!=null&&_.recalculated),s=a||o&&n;return s&&console.log(`Recalculating route - Off route: ${a}, Completed sites: ${M.size}, Already recalculated: ${_==null?void 0:_.recalculated}`),s},I=t=>{const e=t.duration/60,a=t.distance/1e3/(e/60);let n="good",s="low";return a<20?(n="heavy",s="high"):a<40&&(n="moderate",s="medium"),{conditions:n,congestionLevel:s,averageSpeed:a.toFixed(1),estimatedDelay:a<40?"5-15 minutes":"0-5 minutes"}},E=(t,e,o,a)=>{const n=I(t),s=j(o);let r="",i="low";return o<10?(r=`Start from station. You'll reach ${e.site_name} in ${s}. Total ${a} stops.`,i="low"):o<60?(r=`Start from station. Head to ${e.site_name} - ${s} away. ${a} stops total. ${n.conditions==="heavy"?"Heavy traffic expected.":"Good road conditions."}`,i="medium"):(r=`Start from station. Long route to ${e.site_name} (${s}). ${a} stops. Consider taking breaks. ${n.conditions==="heavy"?"Significant delays expected.":""}`,i="high"),{text:r,urgency:i,suggestedAction:L(o,n.conditions)}},L=(t,e)=>t>120?"Consider alternative routes":e==="heavy"?"Leave early to avoid peak hours":t<15?"Proceed directly from station":"Normal driving conditions",T=(t,e)=>{if(!t||e.length===0)return e;const o=[...e],a=[],n=o.map(c=>{const l=w(parseFloat(t.latitude),parseFloat(t.longitude),parseFloat(c.latitude),parseFloat(c.longitude));return{...c,distance:l,coordinates:[parseFloat(c.longitude),parseFloat(c.latitude)]}});n.sort((c,l)=>c.distance-l.distance);const s=n[0];a.push(s);const r=n.slice(1);let i=s;for(;r.length>0;){let c=-1,l=1/0;for(let u=0;u<r.length;u++){const h=w(parseFloat(i.latitude),parseFloat(i.longitude),parseFloat(r[u].latitude),parseFloat(r[u].longitude));h<l&&(l=h,c=u)}c!==-1&&(i=r[c],a.push(i),r.splice(c,1))}return a},W=async(t,e)=>{if(!t||e.length===0)return null;try{const o=T(t,e),a=o[0],s=[[parseFloat(t.longitude),parseFloat(t.latitude)],...o.map(u=>[parseFloat(u.longitude),parseFloat(u.latitude)])].map(u=>`${u[0]},${u[1]}`).join(";"),r=`route_${s}`,i=p(r);if(i&&!C){console.log("Using cached route (offline mode)");const u={...i,isCached:!0};return x(u),d(i.route),u}const c=await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${s}?access_token=${m}&geometries=geojson&overview=full&steps=true`);if(!c.ok)throw new Error(`HTTP ${c.status}: ${c.statusText}`);const l=await c.json();if(l.routes&&l.routes.length>0){const u=l.routes[0],h=Math.round(u.duration/60),v={station:t,nearestSite:a,optimizedOrder:o,route:u.geometry.coordinates,duration:h,formattedDuration:f(h),distance:(u.distance/1e3).toFixed(1),trafficConditions:I(u),recommendation:E(u,a,h,o.length),isCached:!1};return x(v),y(r,v),v}}catch(o){console.error("AI route analysis from station failed:",o);const a=p(`route_station_${t.id}`);if(a)return console.log("Using cached route as fallback"),x({...a,isCached:!0}),d(a.route),a}return null},B=async(t,e)=>{if(!(!t||!e||!m))try{const o=`${t[0]},${t[1]};${parseFloat(e.longitude)},${parseFloat(e.latitude)}`;console.log(`Calculating route to next site: ${e.site_name}`);const a=await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${o}?access_token=${m}&geometries=geojson&overview=full&steps=true&alternatives=false`);if(!a.ok)throw new Error(`HTTP ${a.status}: ${a.statusText}`);const n=await a.json();if(n.routes&&n.routes.length>0){const s=n.routes[0],r=Math.round(s.duration/60);d(s.geometry.coordinates),g({duration:r,formattedDuration:f(r),distance:(s.distance/1e3).toFixed(1),toSite:e.site_name}),setTimeout(()=>{$.current&&s.geometry.coordinates.length>0&&F()},500)}}catch(o){console.error("Error calculating route to next site:",o)}},Q=async(t,e)=>{if(!t||!e||!m){console.log("Missing data for route calculation:",{currentPos:t,nearestSiteToStation:e,mapboxKey:!!m});return}try{const o=`${t[0]},${t[1]};${parseFloat(e.longitude)},${parseFloat(e.latitude)}`;console.log("Calculating route from current location to nearest site from station:",o);const a=`current_to_nearest_from_station_${o}`,n=p(a);if(n&&!C)return console.log("Using cached route to nearest site from station (offline mode)"),d(n.route),g({duration:n.duration,formattedDuration:f(n.duration),distance:n.distance,toSite:e.site_name}),setTimeout(()=>{$.current&&F()},100),n;const s=await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${o}?access_token=${m}&geometries=geojson&overview=full&steps=true&alternatives=false`);if(!s.ok)throw new Error(`HTTP ${s.status}: ${s.statusText}`);const r=await s.json();if(r.routes&&r.routes.length>0){const i=r.routes[0],c=Math.round(i.duration/60),l={route:i.geometry.coordinates,duration:c,formattedDuration:f(c),distance:(i.distance/1e3).toFixed(1),toSite:e.site_name};return d(i.geometry.coordinates),g({duration:c,formattedDuration:f(c),distance:(i.distance/1e3).toFixed(1),toSite:e.site_name}),y(a,l),console.log(`Route calculated: Your location → ${e.site_name} (nearest to station)`),setTimeout(()=>{$.current&&i.geometry.coordinates.length>0&&F()},500),l}}catch(o){console.error("Error calculating route to nearest site from station:",o);const a=`current_to_nearest_from_station_${e.id}`,n=p(a);n&&(console.log("Using cached route as fallback"),d(n.route),g({duration:n.duration,formattedDuration:f(n.duration),distance:n.distance,toSite:e.site_name}),setTimeout(()=>{$.current&&F()},100))}return null},V=async(t,e)=>{var o,a;if(!(!m||t.length<1))try{const n=e?T(e,t):A(t),s=e?[`${e.longitude},${e.latitude}`,...n.map(u=>`${parseFloat(u.longitude)},${parseFloat(u.latitude)}`)].join(";"):n.map(u=>`${parseFloat(u.longitude)},${parseFloat(u.latitude)}`).join(";"),r=`route_${s}`,i=p(r);if(i&&!C){console.log("Using cached route data (offline mode)"),d(i.route),g({duration:i.duration,formattedDuration:f(i.duration),distance:i.distance,toSite:i.toSite});return}const c=await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${s}?access_token=${m}&geometries=geojson&overview=full&steps=true&alternatives=false&continue_straight=false`);if(!c.ok)throw new Error(`HTTP ${c.status}: ${c.statusText}`);const l=await c.json();if(l.routes&&l.routes.length>0){const u=l.routes.reduce((v,N)=>N.duration<v.duration?N:v),h=Math.round(u.duration/60);d(u.geometry.coordinates),g({duration:h,formattedDuration:f(h),distance:(u.distance/1e3).toFixed(1),toSite:(o=n[0])==null?void 0:o.site_name}),y(r,{route:u.geometry.coordinates,duration:h,distance:(u.distance/1e3).toFixed(1),toSite:(a=n[0])==null?void 0:a.site_name})}}catch(n){console.error("Error calculating route:",n);const s=`route_${t.map(i=>`${i.longitude},${i.latitude}`).join(";")}`,r=p(s);if(r)console.log("Using cached route as fallback"),d(r.route),g({duration:r.duration,formattedDuration:f(r.duration),distance:r.distance,toSite:r.toSite});else{const i=t.map(c=>[parseFloat(c.longitude),parseFloat(c.latitude)]);d(i)}}},A=t=>{if(t.length<=2)return t;const e=new Set,o=[];let a=t[0];for(o.push(a),e.add(0);o.length<t.length;){let n=-1,s=1/0;for(let r=0;r<t.length;r++)if(!e.has(r)){const i=w(parseFloat(a.latitude),parseFloat(a.longitude),parseFloat(t[r].latitude),parseFloat(t[r].longitude));i<s&&(s=i,n=r)}n!==-1&&(a=t[n],o.push(a),e.add(n))}return o};return{routeCoordinates:R,routeInfo:_,aiOptimizedRoute:J,setRouteCoordinates:d,setRouteInfo:g,setAiOptimizedRoute:x,calculateDistance:w,formatDuration:f,formatDurationForAI:j,cacheRoute:y,getCachedRoute:p,getNextUncompletedSiteIndex:b,areAllSitesCompleted:q,createStraightLineRoute:z,recalculateRouteFromCurrentPosition:Y,shouldRecalculateRoute:G,analyzeTrafficConditions:I,generateRecommendation:E,optimizeSiteOrderFromStation:T,optimizeSiteOrder:A,analyzeAndOptimizeRouteFromStation:W,calculateRouteToNextSite:B,calculateRouteToNearestSiteFromStation:Q,calculateOptimalRoute:V}};export{tt as useRouteCalculations};
