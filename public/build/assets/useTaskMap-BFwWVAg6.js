import{r as s}from"./app-BoaxTvwX.js";import{useLocationTracking as O}from"./useLocationTracking-CnJtWrxm.js";import{useMapboxSetup as M}from"./useMapboxSetup-D4hjXCLR.js";import{useMapLayers as x}from"./useMapLayers-CzUlcTzp.js";import{useRouteCalculations as E}from"./useRouteCalculations-Csw4sI_m.js";import{useSiteManagement as U}from"./useSiteManagement-BtO2pt7l.js";import"./mapbox-gl-Gh-EHacf.js";import"./index-BZdoO15O.js";import"./iconBase-CAMOzoB0.js";import"./can-3MqaZyCZ.js";const V=({mapboxKey:S,scheduleId:m,onTaskComplete:f,onTaskCancel:R})=>{const[c,h]=s.useState(!1),[y,g]=s.useState(!1),[w,T]=s.useState(!0),[k,v]=s.useState(navigator.onLine),n=M({mapboxKey:S,isMobile:c}),i=E({mapboxKey:S,isOnline:k,activeSchedule:null,optimizedSiteOrder:[],completedSites:new Set,siteLocations:[],currentLocation:null,routeCoordinates:[],routeInfo:null,map:n.map,isMobile:c,addRouteLayer:()=>{}}),e=U({scheduleId:m,onTaskComplete:f,onTaskCancel:R,calculateDistance:i.calculateDistance,showCompletionNotification:o=>{if(console.log(`Site completed: ${o}`),c){const t=document.createElement("div");t.className="fixed top-4 left-4 right-4 bg-green-500 text-white px-4 py-3 rounded-lg shadow-lg z-50 text-center",t.innerHTML=`
          <div class="font-semibold">✅ ${o} Completed!</div>
          <div class="text-sm opacity-90">Progress: ${e.completedSites.size+1}/${e.siteLocations.length} sites</div>
        `,document.body.appendChild(t),setTimeout(()=>{document.body.contains(t)&&document.body.removeChild(t)},3e3)}else{const t=document.createElement("div");t.className="fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50",t.innerHTML=`
          <div class="font-semibold">✅ ${o}</div>
          <div class="text-xs opacity-90">${e.completedSites.size+1}/${e.siteLocations.length} sites</div>
        `,document.body.appendChild(t),setTimeout(()=>{document.body.contains(t)&&document.body.removeChild(t)},3e3)}},updateSiteMarkers:()=>{},recalculateRouteFromCurrentPosition:i.recalculateRouteFromCurrentPosition,currentLocation:null}),r=x({map:n.map,isMobile:c,activeSchedule:e.activeSchedule,completedSites:e.completedSites,optimizedSiteOrder:e.optimizedSiteOrder,currentSiteIndex:e.currentSiteIndex,nearestSiteToStation:e.nearestSiteToStation,routeCoordinates:i.routeCoordinates,routeInfo:i.routeInfo,currentLocation:null,isTaskActive:e.isTaskActive,siteLocations:e.siteLocations,stationLocation:e.stationLocation}),a=O({scheduleId:m,activeSchedule:e.activeSchedule,siteLocations:e.siteLocations,completedSites:e.completedSites,optimizedSiteOrder:e.optimizedSiteOrder,currentSiteIndex:e.currentSiteIndex,isTaskActive:e.isTaskActive,onTaskComplete:f,map:n.map,isMobile:c,currentLocation:null,routeCoordinates:i.routeCoordinates,routeInfo:i.routeInfo,smoothUpdateUserLocation:r.smoothUpdateUserLocation,checkSiteProximity:e.checkSiteProximity,recalculateRouteFromCurrentPosition:i.recalculateRouteFromCurrentPosition,shouldRecalculateRoute:i.shouldRecalculateRoute,updateUserLocationSource:r.updateUserLocationSource,animatePulse:r.animatePulse,clearUserLocationLayers:r.clearUserLocationLayers,updateCurrentLocationMarker:r.updateCurrentLocationMarker,handleLocationError:o=>{let t="Location tracking error: ";switch(o.code){case o.PERMISSION_DENIED:t+="Location access denied. Please enable location permissions.";break;case o.POSITION_UNAVAILABLE:t+="Location unavailable. Using last known position.";break;case o.TIMEOUT:t+="Location request timeout. Retrying...",setTimeout(a.startRealtimeLocationTracking,5e3);break;default:t+="Unknown location error.";break}console.warn(t)},sendLocationToReverb:async(o,t,l=null)=>{var p;if(!m){console.error("No schedule ID available");return}try{const d=((p=e.activeSchedule)==null?void 0:p.barangay_id)||"unknown";(await axios.post("/driver/location/update",{latitude:o,longitude:t,accuracy:l,schedule_id:m,barangay_id:d,timestamp:new Date().toISOString()})).data.success&&console.log("Location successfully sent to backend")}catch(d){throw console.error("Failed to send location to backend:",d),d}}});s.useEffect(()=>{const o=()=>{const t=window.innerWidth<768;h(t),t&&(g(!1),T(!0))};return o(),window.addEventListener("resize",o),()=>window.removeEventListener("resize",o)},[]),s.useEffect(()=>{const o=()=>{v(!0),console.log("Connection restored")},t=()=>{v(!1),console.log("Connection lost - switching to offline mode")};return window.addEventListener("online",o),window.addEventListener("offline",t),()=>{window.removeEventListener("online",o),window.removeEventListener("offline",t)}},[]),s.useEffect(()=>{const o=n.initializeMap(()=>{a.startRealtimeLocationTracking()});return()=>{a.stopRealtimeLocationTracking(),a.stopFakeLocationTest(),r.clearUserLocationLayers(),o&&o()}},[n.cssLoaded]),s.useEffect(()=>{n.mapInitialized&&n.customStyleLoaded&&e.siteLocations.length>0&&(r.clearSiteMarkers(),r.addSiteMarkers(),i.routeCoordinates.length>0&&setTimeout(()=>{r.addRouteLayer()},300))},[n.mapInitialized,n.customStyleLoaded,e.siteLocations,i.routeCoordinates,e.optimizedSiteOrder,e.nearestSiteToStation,e.completedSites]),s.useEffect(()=>{a.currentLocation&&e.nearestSiteToStation&&n.mapInitialized&&(console.log("All data available, calculating route automatically"),i.calculateRouteToNearestSiteFromStation(a.currentLocation,e.nearestSiteToStation))},[a.currentLocation,e.nearestSiteToStation,n.mapInitialized]);const z=()=>{navigator.geolocation?(e.setLoading(!0),navigator.geolocation.getCurrentPosition(async o=>{var L;const{latitude:t,longitude:l,accuracy:p}=o.coords,d=[l,t];if(a.setCurrentLocation(d),a.setLocationAccuracy(p),a.setLastLocationUpdate(new Date),r.smoothUpdateUserLocation(t,l),e.stationLocation&&e.siteLocations.length>0){const u=await i.analyzeAndOptimizeRouteFromStation(e.stationLocation,e.siteLocations);u&&(i.setRouteCoordinates(u.route),i.setRouteInfo({duration:u.duration,distance:u.distance,toSite:(L=u.nearestSite)==null?void 0:L.site_name}),setTimeout(()=>{n.map.current&&u.route.length>0&&r.addRouteLayer()},500))}n.map.current&&n.map.current.flyTo({center:d,zoom:c?15:14,essential:!0,duration:1500}),e.setLoading(!1)},o=>{console.error("Error getting location:",o),e.setLoading(!1),a.handleLocationError(o)},{enableHighAccuracy:!0,timeout:3e4,maximumAge:0})):alert("Geolocation is not supported by your browser.")},C=()=>{if(!e.stationLocation){alert("No station found. Please check site configuration.");return}if(e.siteLocations.length===0){alert("No sites available for optimization.");return}i.analyzeAndOptimizeRouteFromStation(e.stationLocation,e.siteLocations)},b=(o,t)=>{const l=[t,o];a.setCurrentLocation(l),r.smoothUpdateUserLocation(o,t),e.nearestSiteToStation&&i.calculateRouteToNearestSiteFromStation(l,e.nearestSiteToStation)},I=()=>{r.fitMapToRouteAndDriver(i.getNextUncompletedSiteIndex,e.optimizedSiteOrder)},A=()=>{r.fitMapToRoute()};return{mapContainer:n.mapContainer,siteMarkersRef:r.siteMarkersRef,cssLoaded:n.cssLoaded,siteLocations:e.siteLocations,stationLocation:e.stationLocation,mapInitialized:n.mapInitialized,activeSchedule:e.activeSchedule,routeCoordinates:i.routeCoordinates,loading:e.loading,currentLocation:a.currentLocation,routeInfo:i.routeInfo,mapError:n.mapError,customStyleLoaded:n.customStyleLoaded,aiOptimizedRoute:i.aiOptimizedRoute,nearestSiteToStation:e.nearestSiteToStation,isMobile:c,showAIPanel:y,showControls:w,optimizedSiteOrder:e.optimizedSiteOrder,isOnline:k,locationAccuracy:a.locationAccuracy,lastLocationUpdate:a.lastLocationUpdate,completedSites:e.completedSites,currentSiteIndex:e.currentSiteIndex,isTaskActive:e.isTaskActive,isFakeLocationActive:a.isFakeLocationActive,formatDuration:i.formatDuration,getCurrentLocation:z,getAIOptimizedRoute:C,setShowAIPanel:g,setShowControls:T,startRealtimeLocationTracking:a.startRealtimeLocationTracking,stopRealtimeLocationTracking:a.stopRealtimeLocationTracking,updateLocationManually:b,resetCompletedSites:e.resetCompletedSites,markSiteAsCompleted:e.markSiteAsCompleted,startTaskAndBroadcast:e.startTaskAndBroadcast,completeTaskAndBroadcast:e.completeTaskAndBroadcast,sendLocationToReverb:a.sendLocationToReverb,startFakeLocationTest:a.startFakeLocationTest,stopFakeLocationTest:a.stopFakeLocationTest,sendTestLocation:a.sendTestLocation,simulateRouteFollowing:a.simulateRouteFollowing,fitMapToRouteAndDriver:I,fitMapToRoute:A,updateSiteMarkers:r.updateSiteMarkers,addRouteLayer:r.addRouteLayer,calculateRouteToNextSite:i.calculateRouteToNextSite,calculateOptimalRoute:i.calculateOptimalRoute,optimizeSiteOrder:i.optimizeSiteOrder,analyzeAndOptimizeRouteFromStation:i.analyzeAndOptimizeRouteFromStation}};export{V as useTaskMap};
