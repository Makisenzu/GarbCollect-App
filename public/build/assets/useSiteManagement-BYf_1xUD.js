import{r as p,a as f,S as V}from"./app-CJ-FHKkp.js";const Z=({scheduleId:l,onTaskComplete:w,onTaskCancel:X,calculateDistance:F,showCompletionNotification:D,updateSiteMarkers:k,recalculateRouteFromCurrentPosition:P,currentLocation:q})=>{const[m,h]=p.useState([]),[U,x]=p.useState(null),[u,E]=p.useState(null),[B,z]=p.useState(null),[S,A]=p.useState([]),[L,_]=p.useState(new Set),[W,y]=p.useState(0),[G,C]=p.useState(!1),[Q,v]=p.useState(!1),$=(e,o)=>{if(!e||o.length===0)return null;let s=null,a=1/0;return o.forEach(t=>{if(t.longitude&&t.latitude){const n=F(parseFloat(e.latitude),parseFloat(e.longitude),parseFloat(t.latitude),parseFloat(t.longitude));n<a&&(a=n,s=t)}}),s},j=(e,o)=>{if(!e||o.length===0)return!1;const[s,a]=e;let t=!1;return o.forEach((n,r)=>{if(L.has(n.id))return;const d=parseFloat(n.longitude),c=parseFloat(n.latitude);F(a,s,c,d)<.05&&(T(n),t=!0)}),t},H=async()=>{try{console.log("Generating access token for schedule:",l);const e=await f.post("/generate-report-token",{schedule_id:l});e.data.success&&e.data.access_token?(console.log("Access token generated, redirecting to report form"),V.visit(`/driver/report/${l}?token=${e.data.access_token}`)):(console.error("Failed to generate access token:",e.data.message),alert("Failed to generate report access. Please contact support."))}catch(e){console.error("Error generating access token:",e),alert("Error generating report access. Please try again.")}},O=async()=>{var e;try{if(!m.length){console.log("No sites available to initialize collection queue");return}const o=m.map(a=>a.id);console.log("Initializing collection queue with sites:",o);const s=await f.post("/initialize",{schedule_id:l,site_id:o});s.data.success?console.log("Collection queue initialized with",s.data.total_sites,"sites"):console.error("Failed to initialize collection queue:",s.data.message)}catch(o){console.error("Error initializing collection queue:",o),console.error("Error details:",(e=o.response)==null?void 0:e.data)}},T=async(e,o)=>{var s;console.log(`Site reached: ${e.site_name}`);try{const a=await f.post("/mark-completed",{schedule_id:l,site_id:e.id});if(a.data.success){if(console.log("Site marked as completed in database:",e.site_name),_(t=>{const n=new Set(t);return n.add(e.id),console.log("Updated completed sites:",Array.from(n)),n}),h(t=>t.map(n=>n.id===e.id?{...n,collectionStatus:"finished",status:"finished",completed_at:new Date().toISOString()}:n)),a.data.all_completed?(console.log("ðŸŽ‰ All sites completed! Task finished."),H(),w&&w(e)):console.log(`Progress: ${a.data.completed_sites}/${a.data.total_sites} sites completed`),S.length>0){const t=S.findIndex(n=>n.id===e.id);if(t!==-1&&t<S.length-1){const n=t+1;y(n);const r=S[n];console.log(`Moving to next site: ${r.site_name}`),q&&(console.log("Immediately recalculating route from current location to next site"),P(q))}else t===S.length-1&&(console.log("ðŸ Last site reached!"),y(t))}k(),D(e.site_name)}}catch(a){console.error("Error marking site as completed:",a),console.error("Error details:",(s=a.response)==null?void 0:s.data)}},I=async()=>{if(!l){console.error("Cannot start task: missing schedule ID");return}try{const e=(u==null?void 0:u.barangay_id)||"unknown",o=await f.post("/schedule/start",{schedule_id:l,barangay_id:e});o.data.success&&(console.log("Task started and broadcasted to residents"),C(!0),m.length>0&&await O(),o.data.data&&E(s=>({...s,...o.data.data,status:"in_progress"})))}catch(e){console.error("Failed to start task:",e)}},J=async()=>{if(!l){console.error("Cannot complete task: missing schedule ID");return}try{(await f.post("/schedule/complete",{schedule_id:l})).data.success&&(console.log("Task completed and broadcasted to residents"),C(!1),w&&w())}catch(e){console.error("Failed to complete task:",e)}},K=()=>{_(new Set),y(0),k()},R=async()=>{if(!l){console.warn("No schedule ID provided");return}v(!0);try{let e=null;try{const o=await f.get(`/schedules/${l}`);o.data.success&&o.data.data?(e=o.data.data,E(e),console.log("Schedule data loaded:",e)):console.warn("No schedule data received from API")}catch(o){console.warn("Could not fetch schedule details:",o),e={id:l,barangay_id:"unknown",status:"pending"},E(e)}if(e!=null&&e.barangay_id&&e.barangay_id!=="unknown")try{const o=await f.get(`/barangay/${e.barangay_id}/sites?status=active`);if(o.data.success){const s=o.data.data;console.log("Sites loaded:",s.length);try{const a=await f.get(`/progress/${l}`);if(a.data.success){const t=a.data.progress,n=new Set(t.filter(i=>i.status==="finished").map(i=>i.site_id));console.log("Collection queue loaded, completed sites:",n.size),_(n);const r=s.map(i=>{var g;return{...i,collectionStatus:((g=t.find(b=>b.site_id===i.id))==null?void 0:g.status)||"unfinished"}}),d=r.find(i=>i.type==="station"),c=r.filter(i=>i.type!=="station");if(d&&(x({...d,coordinates:[parseFloat(d.longitude),parseFloat(d.latitude)]}),c.length>0)){const i=$(d,c);z(i),console.log("Nearest site to station found:",i==null?void 0:i.site_name);const g=N(d,c);A(g),y(0)}h(c)}}catch{console.warn("Could not fetch collection queue progress, using default statuses");const t=s.find(r=>r.type==="station"),n=s.filter(r=>r.type!=="station");if(t&&(x({...t,coordinates:[parseFloat(t.longitude),parseFloat(t.latitude)]}),n.length>0)){const r=$(t,n);z(r),console.log("Nearest site to station found:",r==null?void 0:r.site_name);const d=N(t,n);A(d),y(0)}h(n)}}}catch(o){console.error("Error fetching sites:",o)}else console.warn("No valid barangay_id available to fetch sites")}catch(e){console.error("Error in schedule and sites setup: ",e)}finally{v(!1)}},N=(e,o)=>{if(!e||o.length===0)return o;const s=[...o],a=[],t=s.map(c=>{const i=F(parseFloat(e.latitude),parseFloat(e.longitude),parseFloat(c.latitude),parseFloat(c.longitude));return{...c,distance:i,coordinates:[parseFloat(c.longitude),parseFloat(c.latitude)]}});t.sort((c,i)=>c.distance-i.distance);const n=t[0];a.push(n);const r=t.slice(1);let d=n;for(;r.length>0;){let c=-1,i=1/0;for(let g=0;g<r.length;g++){const b=F(parseFloat(d.latitude),parseFloat(d.longitude),parseFloat(r[g].latitude),parseFloat(r[g].longitude));b<i&&(i=b,c=g)}c!==-1&&(d=r[c],a.push(d),r.splice(c,1))}return a};return p.useEffect(()=>{R()},[l]),p.useEffect(()=>{m.length>0&&l&&(console.log("Sites loaded, initializing collection queue..."),O())},[m,l]),p.useEffect(()=>{if(!(u!=null&&u.barangay_id)||!l)return;console.log("Setting up site completion listener for barangay:",u.barangay_id);const e=`site-completion.${u.barangay_id}`,o=`site-completion-schedule.${l}`;return window.Echo.channel(e).listen("SiteCompletionUpdated",s=>{console.log("Site completion update received:",s),s.schedule_id===l&&(_(a=>{const t=new Set(a);return t.add(s.site_id),console.log("Site completion broadcast received, updated completed sites:",Array.from(t)),t}),h(a=>a.map(t=>t.id===s.site_id?{...t,collectionStatus:"finished",status:"finished",completed_at:s.completed_at}:t)),k())}),window.Echo.channel(o).listen("SiteCompletionUpdated",s=>{console.log("Schedule-specific site completion update:",s),_(a=>{const t=new Set(a);return t.add(s.site_id),t}),h(a=>a.map(t=>t.id===s.site_id?{...t,collectionStatus:"finished",status:"finished",completed_at:s.completed_at}:t)),k()}),()=>{window.Echo&&(window.Echo.leave(e),window.Echo.leave(o),console.log("Left site completion channels"))}},[u==null?void 0:u.barangay_id,l]),{siteLocations:m,stationLocation:U,activeSchedule:u,nearestSiteToStation:B,optimizedSiteOrder:S,completedSites:L,currentSiteIndex:W,isTaskActive:G,loading:Q,setSiteLocations:h,setStationLocation:x,setActiveSchedule:E,setNearestSiteToStation:z,setOptimizedSiteOrder:A,setCompletedSites:_,setCurrentSiteIndex:y,setIsTaskActive:C,setLoading:v,findNearestSiteToStation:$,checkSiteProximity:j,markSiteAsCompleted:T,startTaskAndBroadcast:I,completeTaskAndBroadcast:J,resetCompletedSites:K,fetchScheduleAndSites:R,optimizeSiteOrderFromStation:N}};export{Z as useSiteManagement};
