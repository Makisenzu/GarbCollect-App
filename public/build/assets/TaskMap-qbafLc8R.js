import{r as C,j as e}from"./app-BsNP_-6E.js";import"./mapbox-gl-DkkjTQA8.js";import{I as X,a as Y,b as Z,c as G}from"./index-CaQLCdEb.js";import{useTaskMap as O}from"./useTaskMap-DqCxJP05.js";/* empty css                  */import"./iconBase-d14FRHqr.js";import"./useLocationTracking-BggNQT3P.js";import"./useMapboxSetup-DzvtBy08.js";import"./useMapLayers-DRi5E-0o.js";import"./index-BUxR5m76.js";import"./can-3MqaZyCZ.js";import"./useRouteCalculations-Bgn5Wers.js";import"./useSiteManagement-C2J1Fmq2.js";const Fe=C.forwardRef(({mapboxKey:s,scheduleId:t,onTaskComplete:a,onTaskCancel:n,autoGetLocation:l=!1},r)=>{const{mapContainer:i,siteMarkersRef:d,cssLoaded:c,siteLocations:o,stationLocation:f,mapInitialized:x,activeSchedule:u,routeCoordinates:ce,loading:b,currentLocation:g,routeInfo:P,mapError:N,customStyleLoaded:de,aiOptimizedRoute:v,nearestSiteToStation:xe,isMobile:p,showAIPanel:E,showControls:L,optimizedSiteOrder:y,isOnline:me,locationAccuracy:he,lastLocationUpdate:ue,completedSites:j,currentSiteIndex:w,isTaskActive:k,isFakeLocationActive:A,formatDuration:ge,getCurrentLocation:T,getAIOptimizedRoute:$,setShowAIPanel:z,setShowControls:B,startRealtimeLocationTracking:D,stopRealtimeLocationTracking:S,updateLocationManually:_,resetCompletedSites:F,markSiteAsCompleted:H,startTaskAndBroadcast:I,completeTaskAndBroadcast:R,sendLocationToReverb:pe,startFakeLocationTest:U,stopFakeLocationTest:V,sendTestLocation:q,simulateRouteFollowing:J}=O({mapboxKey:s,scheduleId:t,onTaskComplete:a,onTaskCancel:n});C.useImperativeHandle(r,()=>({getCurrentLocation:()=>{T()},fitMapToRoute:()=>{console.log("Fit map to route function called")},startRealtimeLocationTracking:()=>{D()},stopRealtimeLocationTracking:()=>{S()},updateLocationManually:(h,m)=>{_(h,m)},resetCompletedSites:()=>{F()},markSiteAsCompleted:h=>{const m=o.find(W=>W.id===h);m&&H(m)},startTaskAndBroadcast:()=>{I()},completeTaskAndBroadcast:()=>{R()},startFakeLocationTest:()=>{U()},stopFakeLocationTest:()=>{V()},sendTestLocation:(h,m)=>{q(h,m)},simulateRouteFollowing:()=>{J()}})),C.useEffect(()=>{l&&!g&&!b&&x&&(console.log("Auto-getting location on component mount"),T())},[l,g,b,x]);const K=()=>{R()},Q=()=>{I()};return e.jsxs("div",{className:"relative w-full h-full bg-white",children:[b&&e.jsx(ee,{}),N&&e.jsx(se,{error:N}),!c&&!N&&e.jsx(te,{}),p&&e.jsx(ae,{showControls:L,setShowControls:B,siteLocations:o,currentLocation:g,completedSites:j,currentSiteIndex:w,optimizedSiteOrder:y,isTaskActive:k,isFakeLocationActive:A}),v&&e.jsx(ne,{aiOptimizedRoute:v,isMobile:p,showAIPanel:E,setShowAIPanel:z,completedSites:j,currentSiteIndex:w,optimizedSiteOrder:y}),e.jsx(re,{isMobile:p,showControls:L,getAIOptimizedRoute:$,getCurrentLocation:T,onTaskComplete:K,onTaskCancel:n,onTaskStart:Q,scheduleId:t,currentLocation:g,completedSites:j,resetCompletedSites:F,activeSchedule:u,isTaskActive:k}),!1,u&&e.jsx(oe,{activeSchedule:u,siteLocations:o,routeInfo:P,isMobile:p,aiOptimizedRoute:v,setShowAIPanel:z,completedSites:j,currentSiteIndex:w,optimizedSiteOrder:y,isTaskActive:k,isFakeLocationActive:A}),e.jsx("div",{ref:i,className:"w-full h-full absolute inset-0",style:{width:"100%",height:"100%",minHeight:"400px"}})]})}),ee=()=>e.jsx("div",{className:"absolute inset-0 bg-white bg-opacity-80 flex items-center justify-center z-50",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-3"}),e.jsx("p",{className:"text-sm text-gray-600 font-medium",children:"AI analyzing optimal route..."}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Finding fastest path to nearest site"})]})}),se=({error:s})=>e.jsx("div",{className:"absolute inset-0 bg-white flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"text-center p-6 bg-white rounded-lg shadow-xl max-w-sm",children:[e.jsx("div",{className:"text-red-500 text-lg font-semibold mb-2",children:"Map Error"}),e.jsx("div",{className:"text-gray-600 mb-4 text-sm",children:s}),e.jsx("button",{onClick:()=>window.location.reload(),className:"bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors font-medium text-sm",children:"Retry"})]})}),te=()=>e.jsx("div",{className:"absolute inset-0 bg-white flex items-center justify-center z-40",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-3"}),e.jsx("p",{className:"text-sm text-gray-600 font-medium",children:"Loading map..."})]})}),ae=({showControls:s,setShowControls:t,siteLocations:a,currentLocation:n,completedSites:l,currentSiteIndex:r,optimizedSiteOrder:i,isTaskActive:d,isFakeLocationActive:c})=>{var o;return e.jsx("div",{className:"absolute top-0 left-0 right-0 z-30 bg-white/95 backdrop-blur-sm border-b border-gray-200 px-4 py-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:()=>t(!s),className:"p-2 rounded-lg bg-gray-100 hover:bg-gray-200 transition-colors",children:s?e.jsx(X,{className:"w-5 h-5"}):e.jsx(Y,{className:"w-5 h-5"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"font-semibold text-gray-900 text-sm",children:"Collection Route"}),e.jsxs("p",{className:"text-xs text-gray-600",children:[l.size,"/",a.length," sites completed"]}),r<i.length&&e.jsxs("p",{className:"text-xs text-blue-600 font-medium",children:["Next: ",(o=i[r])==null?void 0:o.site_name]}),d&&e.jsx("p",{className:"text-xs text-green-600 font-medium",children:"ðŸ”´ Live - Broadcasting to residents"}),c&&e.jsx("p",{className:"text-xs text-purple-600 font-medium",children:"ðŸ§ª Fake Location Test Active"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[n&&e.jsx("div",{className:"w-3 h-3 bg-green-500 rounded-full animate-pulse"}),l.size>0&&e.jsxs("div",{className:"text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full",children:[l.size," done"]}),c&&e.jsx("div",{className:"text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded-full",children:"Testing"})]})]})})},ne=({aiOptimizedRoute:s,isMobile:t,showAIPanel:a,setShowAIPanel:n,completedSites:l,currentSiteIndex:r,optimizedSiteOrder:i})=>t?e.jsx("div",{className:`absolute bottom-0 left-0 right-0 z-40 bg-white border-t border-gray-200 rounded-t-2xl shadow-2xl transition-transform duration-300 ${a?"transform translate-y-0":"transform translate-y-full"}`,children:e.jsx(le,{aiOptimizedRoute:s,setShowAIPanel:n,completedSites:l,currentSiteIndex:r,optimizedSiteOrder:i})}):e.jsx("div",{className:"absolute top-4 left-4 z-20 bg-green-50 border border-green-200 rounded-lg p-4 shadow-lg max-w-sm",children:e.jsx(ie,{aiOptimizedRoute:s,completedSites:l,currentSiteIndex:r,optimizedSiteOrder:i})}),le=({aiOptimizedRoute:s,setShowAIPanel:t,completedSites:a,currentSiteIndex:n,optimizedSiteOrder:l})=>e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex justify-center pt-3 pb-2",children:e.jsx("div",{className:"w-12 h-1 bg-gray-300 rounded-full"})}),e.jsx("button",{onClick:()=>t(!1),className:"absolute top-3 right-4 p-1 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors",children:e.jsx(Z,{className:"w-4 h-4 text-gray-600"})}),e.jsx("div",{className:"p-4 max-h-64 overflow-y-auto",children:e.jsx(M,{aiOptimizedRoute:s,completedSites:a,currentSiteIndex:n,optimizedSiteOrder:l})})]}),ie=({aiOptimizedRoute:s,completedSites:t,currentSiteIndex:a,optimizedSiteOrder:n})=>e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(G,{className:"w-5 h-5 text-green-600"}),e.jsx("h3",{className:"font-semibold text-green-800",children:"AI Route Optimized"}),t.size>0&&e.jsxs("span",{className:"bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full",children:[t.size," completed"]})]}),e.jsx(M,{aiOptimizedRoute:s,completedSites:t,currentSiteIndex:a,optimizedSiteOrder:n})]}),M=({aiOptimizedRoute:s,completedSites:t,currentSiteIndex:a,optimizedSiteOrder:n})=>{var l;return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Current Target:"}),e.jsx("span",{className:"font-semibold",children:((l=n[a])==null?void 0:l.site_name)||s.nearestSite.site_name})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Progress:"}),e.jsxs("span",{className:"font-semibold",children:[t.size,"/",n.length," sites"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Distance:"}),e.jsxs("span",{className:"font-semibold",children:[s.distance," km"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Est. Time:"}),e.jsx("span",{className:"font-semibold",children:s.formattedDuration})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Traffic:"}),e.jsx("span",{className:`font-semibold ${s.trafficConditions.conditions==="heavy"?"text-red-600":s.trafficConditions.conditions==="moderate"?"text-yellow-600":"text-green-600"}`,children:s.trafficConditions.conditions})]})]}),e.jsxs("div",{className:"mt-3 p-2 bg-white rounded border",children:[e.jsx("p",{className:"text-xs text-gray-700",children:s.recommendation.text}),e.jsxs("p",{className:"text-xs text-blue-600 mt-1",children:["ðŸ’¡ ",s.recommendation.suggestedAction]}),t.size>0&&e.jsxs("p",{className:"text-xs text-green-600 mt-2 font-medium",children:["âœ… ",t.size," site(s) completed"]})]})]})},re=({isMobile:s,showControls:t,getAIOptimizedRoute:a,getCurrentLocation:n,onTaskComplete:l,onTaskCancel:r,onTaskStart:i,scheduleId:d,currentLocation:c,completedSites:o,resetCompletedSites:f,activeSchedule:x,isTaskActive:u})=>e.jsx("div",{className:`absolute ${s?"top-16":"top-4"} right-4 z-10 flex flex-col gap-3 transition-all duration-300 ${s&&!t?"opacity-0 pointer-events-none":"opacity-100"}`}),oe=({activeSchedule:s,siteLocations:t,routeInfo:a,isMobile:n,aiOptimizedRoute:l,setShowAIPanel:r,completedSites:i,currentSiteIndex:d,optimizedSiteOrder:c,isTaskActive:o,isFakeLocationActive:f})=>{var x;return e.jsxs("div",{className:`absolute ${n?"bottom-20 left-4 right-4":"bottom-4 left-4"} z-10 bg-white/95 backdrop-blur-sm p-3 rounded-lg shadow-lg ${n?"max-w-full":"max-w-xs"}`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"text-sm font-medium text-gray-900",children:[e.jsx("span",{className:"text-blue-600 font-bold",children:t.length})," sites to collect"]}),i.size>0&&e.jsxs("div",{className:"text-xs text-green-600 font-medium",children:[i.size," completed â€¢ ",t.length-i.size," remaining"]}),d<c.length&&e.jsxs("div",{className:"text-xs text-blue-600",children:["Current: ",(x=c[d])==null?void 0:x.site_name]}),o&&e.jsxs("div",{className:"text-xs text-green-600 font-medium flex items-center gap-1",children:[e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-pulse"}),"Live - Residents can see your location"]}),f&&e.jsxs("div",{className:"text-xs text-purple-600 font-medium flex items-center gap-1",children:[e.jsx("div",{className:"w-2 h-2 bg-purple-500 rounded-full animate-pulse"}),"Testing Mode - Fake locations active"]})]}),a&&e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-xs text-gray-600",children:[e.jsx("span",{className:"font-medium",children:a.formattedDuration})," â€¢",e.jsxs("span",{className:"font-medium",children:[" ",a.distance," km"]})]}),a.toSite&&e.jsxs("div",{className:"text-xs text-gray-500",children:["To: ",a.toSite]}),a.recalculated&&e.jsx("div",{className:"text-xs text-orange-600 font-medium",children:"Route Recalculated"}),n&&l&&e.jsx("button",{onClick:()=>r(!0),className:"text-xs text-blue-600 font-medium mt-1",children:"View AI Route"})]})]}),i.size>0&&e.jsxs("div",{className:"mt-2",children:[e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2",children:e.jsx("div",{className:"bg-green-500 h-2 rounded-full transition-all duration-300",style:{width:`${i.size/t.length*100}%`}})}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1 text-center",children:[Math.round(i.size/t.length*100),"% complete"]})]})]})};export{Fe as default};
