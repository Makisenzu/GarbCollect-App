import{r as u,a as p,S as U}from"./app-BsNP_-6E.js";const Y=({scheduleId:c,onTaskComplete:h,onTaskCancel:V,calculateDistance:y,showCompletionNotification:P,updateSiteMarkers:$,recalculateRouteFromCurrentPosition:D,currentLocation:N})=>{const[f,x]=u.useState([]),[I,z]=u.useState(null),[_,F]=u.useState(null),[B,E]=u.useState(null),[m,b]=u.useState([]),[L,w]=u.useState(new Set),[W,S]=u.useState(0),[G,v]=u.useState(!1),[M,A]=u.useState(!1),C=(e,t)=>{if(!e||t.length===0)return null;let o=null,n=1/0;return t.forEach(s=>{if(s.longitude&&s.latitude){const i=y(parseFloat(e.latitude),parseFloat(e.longitude),parseFloat(s.latitude),parseFloat(s.longitude));i<n&&(n=i,o=s)}}),o},Q=(e,t)=>{if(!e||t.length===0)return!1;const[o,n]=e;let s=!1;return t.forEach((i,r)=>{if(L.has(i.id))return;const d=parseFloat(i.longitude),l=parseFloat(i.latitude);y(n,o,l,d)<.05&&(T(i),s=!0)}),s},j=async()=>{try{console.log("Generating access token for schedule:",c);const e=await p.post("/generate-report-token",{schedule_id:c});e.data.success&&e.data.access_token?(console.log("Access token generated, redirecting to report form"),U.visit(`/driver/report/${c}?token=${e.data.access_token}`)):(console.error("Failed to generate access token:",e.data.message),alert("Failed to generate report access. Please contact support."))}catch(e){console.error("Error generating access token:",e),alert("Error generating report access. Please try again.")}},O=async()=>{var e;try{if(!f.length){console.log("No sites available to initialize collection queue");return}const t=f.map(n=>n.id);console.log("Initializing collection queue with sites:",t);const o=await p.post("/initialize",{schedule_id:c,site_id:t});o.data.success?console.log("Collection queue initialized with",o.data.total_sites,"sites"):console.error("Failed to initialize collection queue:",o.data.message)}catch(t){console.error("Error initializing collection queue:",t),console.error("Error details:",(e=t.response)==null?void 0:e.data)}},T=async(e,t)=>{console.log(`Site reached: ${e.site_name}`);try{const o=await p.post("/mark-completed",{schedule_id:c,site_id:e.id});if(o.data.success){if(w(n=>{const s=new Set(n).add(e.id);return o.data.all_completed?(console.log("ðŸŽ‰ All sites completed! Task finished."),j(),h&&h(e)):console.log(`Progress: ${o.data.completed_sites}/${o.data.total_sites} sites completed`),s}),m.length>0){const n=m.findIndex(s=>s.id===e.id);if(n!==-1&&n<m.length-1){const s=n+1;S(s);const i=m[s];console.log(`Moving to next site: ${i.site_name}`),N&&(console.log("Immediately recalculating route from current location to next site"),D(N))}else n===m.length-1&&(console.log("ðŸ Last site reached!"),S(n))}$(),P(e.site_name)}}catch(o){console.error("Error marking site as completed:",o)}},H=async()=>{if(!c){console.error("Cannot start task: missing schedule ID");return}try{const e=(_==null?void 0:_.barangay_id)||"unknown",t=await p.post("/schedule/start",{schedule_id:c,barangay_id:e});t.data.success&&(console.log("Task started and broadcasted to residents"),v(!0),f.length>0&&await O(),t.data.data&&F(o=>({...o,...t.data.data,status:"in_progress"})))}catch(e){console.error("Failed to start task:",e)}},J=async()=>{if(!c){console.error("Cannot complete task: missing schedule ID");return}try{(await p.post("/schedule/complete",{schedule_id:c})).data.success&&(console.log("Task completed and broadcasted to residents"),v(!1),h&&h())}catch(e){console.error("Failed to complete task:",e)}},K=()=>{w(new Set),S(0),$()},R=async()=>{if(!c){console.warn("No schedule ID provided");return}A(!0);try{let e=null;try{const t=await p.get(`/schedules/${c}`);t.data.success&&t.data.data?(e=t.data.data,F(e),console.log("Schedule data loaded:",e)):console.warn("No schedule data received from API")}catch(t){console.warn("Could not fetch schedule details:",t),e={id:c,barangay_id:"unknown",status:"pending"},F(e)}if(e!=null&&e.barangay_id&&e.barangay_id!=="unknown")try{const t=await p.get(`/barangay/${e.barangay_id}/sites?status=active`);if(t.data.success){const o=t.data.data;console.log("Sites loaded:",o.length);try{const n=await p.get(`/progress/${c}`);if(n.data.success){const s=n.data.progress,i=new Set(s.filter(a=>a.status==="finished").map(a=>a.site_id));console.log("Collection queue loaded, completed sites:",i.size),w(i);const r=o.map(a=>{var g;return{...a,collectionStatus:((g=s.find(k=>k.site_id===a.id))==null?void 0:g.status)||"unfinished"}}),d=r.find(a=>a.type==="station"),l=r.filter(a=>a.type!=="station");if(d&&(z({...d,coordinates:[parseFloat(d.longitude),parseFloat(d.latitude)]}),l.length>0)){const a=C(d,l);E(a),console.log("Nearest site to station found:",a==null?void 0:a.site_name);const g=q(d,l);b(g),S(0)}x(l)}}catch{console.warn("Could not fetch collection queue progress, using default statuses");const s=o.find(r=>r.type==="station"),i=o.filter(r=>r.type!=="station");if(s&&(z({...s,coordinates:[parseFloat(s.longitude),parseFloat(s.latitude)]}),i.length>0)){const r=C(s,i);E(r),console.log("Nearest site to station found:",r==null?void 0:r.site_name);const d=q(s,i);b(d),S(0)}x(i)}}}catch(t){console.error("Error fetching sites:",t)}else console.warn("No valid barangay_id available to fetch sites")}catch(e){console.error("Error in schedule and sites setup: ",e)}finally{A(!1)}},q=(e,t)=>{if(!e||t.length===0)return t;const o=[...t],n=[],s=o.map(l=>{const a=y(parseFloat(e.latitude),parseFloat(e.longitude),parseFloat(l.latitude),parseFloat(l.longitude));return{...l,distance:a,coordinates:[parseFloat(l.longitude),parseFloat(l.latitude)]}});s.sort((l,a)=>l.distance-a.distance);const i=s[0];n.push(i);const r=s.slice(1);let d=i;for(;r.length>0;){let l=-1,a=1/0;for(let g=0;g<r.length;g++){const k=y(parseFloat(d.latitude),parseFloat(d.longitude),parseFloat(r[g].latitude),parseFloat(r[g].longitude));k<a&&(a=k,l=g)}l!==-1&&(d=r[l],n.push(d),r.splice(l,1))}return n};return u.useEffect(()=>{R()},[c]),u.useEffect(()=>{f.length>0&&c&&(console.log("Sites loaded, initializing collection queue..."),O())},[f,c]),{siteLocations:f,stationLocation:I,activeSchedule:_,nearestSiteToStation:B,optimizedSiteOrder:m,completedSites:L,currentSiteIndex:W,isTaskActive:G,loading:M,setSiteLocations:x,setStationLocation:z,setActiveSchedule:F,setNearestSiteToStation:E,setOptimizedSiteOrder:b,setCompletedSites:w,setCurrentSiteIndex:S,setIsTaskActive:v,setLoading:A,findNearestSiteToStation:C,checkSiteProximity:Q,markSiteAsCompleted:T,startTaskAndBroadcast:H,completeTaskAndBroadcast:J,resetCompletedSites:K,fetchScheduleAndSites:R,optimizeSiteOrderFromStation:q}};export{Y as useSiteManagement};
