import{r as F,c as te,j as ne}from"./app-BOb0HgxJ.js";import{a as x}from"./mapbox-gl-DLUiATf0.js";import{G as oe}from"./index-DSxfX0kn.js";import{c as ae}from"./can-3MqaZyCZ.js";import"./iconBase-BHEkeEIS.js";const ge=({map:r,isMobile:c,activeSchedule:p,completedSites:K,optimizedSiteOrder:L,currentSiteIndex:V,nearestSiteToStation:A,routeCoordinates:y,routeInfo:s,currentLocation:b,isTaskActive:J,siteLocations:B,stationLocation:u})=>{const m=F.useRef([]),f=F.useRef(null),E=F.useRef(null),k=F.useRef(null),d=F.useRef(null),h={Alegria:"#FF5733","Barangay 1":"#33FF57","Barangay 2":"#3357FF","Barangay 3":"#F033FF","Barangay 4":"#FF33F0","Barangay 5":"#33FFF0","Bayugan 2":"#8A2BE2","Bitan-agan":"#A52A2A",Borbon:"#DEB887",Buenasuerte:"#5F9EA0",Caimpugan:"#7FFF00","Das-agan":"#D2691E",Ebro:"#FF7F50",Hubang:"#6495ED",Karaus:"#DC143C",Ladgadan:"#00FFFF",Lapinigan:"#00008B",Lucac:"#008B8B",Mate:"#B8860B","New Visayas":"#006400",Ormaca:"#8B008B",Pasta:"#556B2F","Pisa-an":"#FF8C00",Rizal:"#9932CC","San Isidro":"#8FBC8F","Santa Ana":"#483D8B",Tagapua:"#2F4F4F","San Francisco":"#FFE659",_default:"#4F262A"},Q=(e,t)=>{if(!r.current)return;const n=[t,e];C(t,e),f.current&&f.current.setLngLat(n),J&&r.current&&!r.current.hasUserInteracted()&&r.current.flyTo({center:n,zoom:c?16:15,speed:.8,curve:1,essential:!0,duration:1e3})},C=(e,t)=>{if(!r.current)return;const n={type:"FeatureCollection",features:[{type:"Feature",geometry:{type:"Point",coordinates:[e,t]},properties:{description:"Driver current location"}}]};if(!r.current.getSource("driver-location"))r.current.addSource("driver-location",{type:"geojson",data:n}),r.current.addLayer({id:"driver-location-layer",type:"circle",source:"driver-location",paint:{"circle-radius":8,"circle-color":"#2563eb","circle-stroke-width":2,"circle-stroke-color":"#ffffff","circle-opacity":.9}}),r.current.addLayer({id:"driver-location-pulse",type:"circle",source:"driver-location",paint:{"circle-radius":{base:8,stops:[[0,8],[20,25]]},"circle-color":"#2563eb","circle-opacity":{base:.4,stops:[[0,.4],[1,0]]},"circle-stroke-width":1,"circle-stroke-color":"#2563eb"}}),E.current=r.current.getSource("driver-location"),k.current="driver-location-layer";else{const o=r.current.getSource("driver-location");o&&o.setData(n)}j()},j=()=>{if(!r.current||!r.current.getLayer("driver-location-pulse"))return;d.current&&cancelAnimationFrame(d.current);const e=Date.now(),t=2e3,n=()=>{const l=(Date.now()-e)%t/t,a=8+l*17;r.current.setPaintProperty("driver-location-pulse","circle-radius",a),r.current.setPaintProperty("driver-location-pulse","circle-opacity",.4*(1-l)),d.current=requestAnimationFrame(n)};d.current=requestAnimationFrame(n)},z=(e,t)=>{if(!r.current||y.length===0)return;const n=new x.LngLatBounds;y.forEach(a=>{n.extend(a)}),b&&n.extend(b);const o=e();if(o!==-1&&t[o]){const a=t[o];n.extend([parseFloat(a.longitude),parseFloat(a.latitude)])}const l=c?40:80;try{r.current.fitBounds(n,{padding:l,duration:1e3,essential:!0,maxZoom:c?16:15})}catch(a){console.error("Error fitting map to bounds:",a)}},X=()=>{if(!r.current||y.length===0||B.length===0)return;const e=new x.LngLatBounds;u&&e.extend([parseFloat(u.longitude),parseFloat(u.latitude)]),B.forEach(n=>{n.longitude&&n.latitude&&e.extend([parseFloat(n.longitude),parseFloat(n.latitude)])}),y.forEach(n=>{e.extend(n)}),b&&e.extend(b);const t=c?20:50;try{r.current.fitBounds(e,{padding:t,duration:1e3,essential:!0,maxZoom:c?16:15})}catch(n){console.error("Error fitting map to bounds:",n)}},Y=()=>{r.current&&(["driver-location-layer","driver-location-pulse"].forEach(e=>{r.current.getLayer(e)&&r.current.removeLayer(e)}),["route","route-glow","route-direction","route-recalculated"].forEach(e=>{r.current.getLayer(e)&&r.current.removeLayer(e)}),r.current.getSource("driver-location")&&r.current.removeSource("driver-location"),r.current.getSource("route")&&r.current.removeSource("route"),E.current=null,k.current=null,d.current&&(cancelAnimationFrame(d.current),d.current=null))},D=e=>{if(!r.current)return;f.current&&f.current.remove();const t=document.createElement("div");t.className="current-location-marker";const n=c?"w-8 h-8":"w-6 h-6";t.innerHTML=`
      <div class="relative">
        <div class="${n} bg-blue-600 border-2 border-white rounded-full shadow-lg z-50"></div>
        <div class="absolute inset-0 bg-blue-400 rounded-full animate-ping"></div>
      </div>
    `,f.current=new x.Marker({element:t,draggable:!1}).setLngLat(e).addTo(r.current)},S=()=>{if(!r.current||y.length===0){console.log("Cannot add route layer - missing map or route coordinates");return}if(!r.current.isStyleLoaded()){console.log("Map style not loaded yet, waiting..."),r.current.once("styledata",()=>{setTimeout(S,100)});return}["route","route-glow","route-direction","route-recalculated"].forEach(e=>{r.current.getLayer(e)&&r.current.removeLayer(e)}),r.current.getSource("route")&&r.current.removeSource("route");try{console.log("Adding route layer to map with coordinates:",y.length),r.current.addSource("route",{type:"geojson",data:{type:"Feature",properties:{recalculated:(s==null?void 0:s.recalculated)||!1},geometry:{type:"LineString",coordinates:y}}});const e=(p==null?void 0:p.barangay_name)||"San Francisco",t=h[e]||h._default,n=s!=null&&s.recalculated?"#FF6B35":t,o=c?6:5,l=c?14:12;r.current.addLayer({id:"route-glow",type:"line",source:"route",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":n,"line-width":l,"line-opacity":.4,"line-blur":8}}),r.current.addLayer({id:"route",type:"line",source:"route",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":n,"line-width":o,"line-opacity":.9}}),r.current.addLayer({id:"route-direction",type:"symbol",source:"route",layout:{"symbol-placement":"line","text-field":"‚ñ∂","text-size":c?14:12,"symbol-spacing":100},paint:{"text-color":n}}),s!=null&&s.recalculated&&r.current.addLayer({id:"route-recalculated",type:"line",source:"route",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#FF6B35","line-width":o-1,"line-dasharray":[2,2],"line-opacity":.7}}),console.log("Route layer added successfully"),setTimeout(()=>{z()},200)}catch(e){console.error("Error adding route layer:",e),setTimeout(()=>{S()},500)}},_=(e,t)=>{var U,G,W,Z;const n=(G=(U=e==null?void 0:e.purok)==null?void 0:U.baranggay)==null?void 0:G.baranggay_name,o=h[n]||h._default,l=A&&A.id===e.id,a=e.type==="station",i=K.has(e.id),g=((W=L[V])==null?void 0:W.id)===e.id,v=c?"w-12 h-12":"w-10 h-10",P=c?"w-10 h-10":"w-8 h-8",T=document.createElement("div");T.className="custom-image-marker";let q="";if(p){const re=c?"w-7 h-7 text-xs":"w-6 h-6 text-xs";let w="bg-blue-500";i?w="bg-green-500":g?w="bg-yellow-500":a&&(w="bg-red-500"),q=`
        <div class="absolute -top-2 -right-2 ${w} text-white rounded-full ${re} flex items-center justify-center font-bold shadow-lg border-2 border-white z-20">
          ${a?"üè†":i?"‚úì":t}
        </div>
      `}const O=i?"opacity-50":"opacity-100",H=i?"grayscale":"",I=g&&!i?"ring-4 ring-yellow-500 ring-opacity-70":"",ee=l&&!i&&!g?"ring-4 ring-green-500 ring-opacity-70":"";return T.innerHTML=`
      <div class="relative ${O}">
        ${q}
        <div class="${v} rounded-full border-3 flex items-center justify-center overflow-hidden shadow-lg bg-white relative ${I} ${ee} ${H}" 
             style="border-color: ${o};">
          ${g&&!i?`
            <div class="absolute -inset-3 rounded-full border-4 border-yellow-500 border-opacity-70 animate-pulse pointer-events-none z-10"></div>
          `:""}
          ${l&&!i&&!g?`
            <div class="absolute -inset-3 rounded-full border-4 border-green-500 border-opacity-70 animate-pulse pointer-events-none z-10"></div>
          `:""}
          <img src="${ae}" 
               alt="${e.site_name}" 
               class="${P} object-cover rounded-full z-0 ${H}"
               onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\\'${P} rounded-full flex items-center justify-center text-white text-xs font-bold bg-white\\' style=\\'border: 2px solid ${o}; color: ${o}\\'>${((Z=e.site_name)==null?void 0:Z.charAt(0))||"S"}</div>'">
        </div>
      </div>
    `,T},M=e=>{const t=document.createElement("div");t.className="custom-marker relative";let n="";p&&(n=`
        <div class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full ${c?"w-7 h-7 text-xs":"w-6 h-6 text-xs"} flex items-center justify-center font-bold shadow-lg border-2 border-white">
          üè†
        </div>
      `),t.innerHTML=n;const o=te.createRoot(t);return o.render(ne.jsx(oe,{size:c?36:30,color:"#4F262A"})),{element:t,root:o}},$=(e,t="manual",n="",o=null,l=0)=>{let a,i=null;if(t==="manual")a=document.createElement("div"),a.className="custom-marker";else if((o==null?void 0:o.type)==="station"){const v=M();a=v.element,i=v.root}else a=_(o,l);const g=new x.Marker({element:a,draggable:!1}).setLngLat(e).addTo(r.current);return i&&(g._root=i),g},N=()=>{if(R(),u){const t=$([parseFloat(u.longitude),parseFloat(u.latitude)],"station",u.site_name,u,0);m.current.push(t)}(L.length>0?L:B).forEach((t,n)=>{if(t.longitude&&t.latitude){const o=$([parseFloat(t.longitude),parseFloat(t.latitude)],"site",t.site_name,t,n+1);m.current.push(o)}})},R=()=>{m.current.forEach(e=>{e._root&&setTimeout(()=>e._root.unmount(),0),e.remove()}),m.current=[]};return{siteMarkersRef:m,currentLocationMarkerRef:f,userLocationSourceRef:E,userLocationLayerRef:k,animationFrameRef:d,smoothUpdateUserLocation:Q,updateUserLocationSource:C,animatePulse:j,fitMapToRouteAndDriver:z,fitMapToRoute:X,clearUserLocationLayers:Y,updateCurrentLocationMarker:D,addRouteLayer:S,addSiteMarkers:N,clearSiteMarkers:R,updateSiteMarkers:()=>{R(),N()},addMarker:$,createImageMarker:_,createStationIcon:M}};export{ge as useMapLayers};
