import{j as t,r as d,a as C,i as nt,g as Me}from"./app-BOwIOK84.js";import{a as F}from"./mapbox-gl-CcLdEyCe.js";import{h as ot,i as it,j as lt,g as ct}from"./index-Cz3ViT4p.js";import"./iconBase-ewXdmVfX.js";const dt=({isLoading:y=!1,size:S="medium",message:R="Collecting garbage..."})=>{if(!y)return null;const v={small:"w-16 h-16",medium:"w-24 h-24",large:"w-32 h-32",xlarge:"w-48 h-48"},z={small:"text-xs",medium:"text-sm",large:"text-base",xlarge:"text-lg"};return t.jsxs("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:[t.jsxs("div",{className:"bg-white rounded-2xl p-8 shadow-2xl flex flex-col items-center",children:[t.jsxs("div",{className:`relative ${v[S]} mb-4`,children:[t.jsx("div",{className:"absolute bottom-0 left-0 right-0 h-2 bg-gray-600 rounded-full"}),t.jsx("div",{className:"absolute bottom-3 left-4 w-3 h-4 bg-gray-400 rounded-sm",children:t.jsx("div",{className:"absolute -top-1 left-0.5 w-2 h-1 bg-gray-500 rounded-sm"})}),t.jsx("div",{className:"absolute bottom-3 left-8 w-3 h-5 bg-gray-400 rounded-sm",children:t.jsx("div",{className:"absolute -top-1 left-0.5 w-2 h-1 bg-gray-500 rounded-sm"})}),t.jsx("div",{className:"absolute bottom-3 left-12 w-3 h-4 bg-gray-400 rounded-sm",children:t.jsx("div",{className:"absolute -top-1 left-0.5 w-2 h-1 bg-gray-500 rounded-sm"})}),t.jsx("div",{className:"absolute bottom-2 left-0 animate-collect-garbage",children:t.jsxs("div",{className:"relative",children:[t.jsxs("div",{className:"w-6 h-4 bg-green-600 rounded-t-sm",children:[t.jsx("div",{className:"absolute top-0.5 left-1 w-3 h-1.5 bg-blue-300 rounded-sm"}),t.jsx("div",{className:"absolute bottom-0 left-1 w-1 h-0.5 bg-yellow-300 rounded-full"})]}),t.jsx("div",{className:"absolute left-6 top-1 w-8 h-3 bg-green-700 rounded-sm",children:t.jsx("div",{className:"absolute top-0.5 left-1 w-6 h-2 bg-gray-800 rounded",children:t.jsx("div",{className:"absolute -top-1 left-0 right-0 h-1 bg-gray-700 rounded-t animate-garbage-fill"})})}),t.jsx("div",{className:"absolute -bottom-1 left-1 w-2 h-2 bg-black rounded-full",children:t.jsx("div",{className:"absolute inset-0.5 w-1 h-1 bg-gray-600 rounded-full"})}),t.jsx("div",{className:"absolute -bottom-1 left-5 w-2 h-2 bg-black rounded-full",children:t.jsx("div",{className:"absolute inset-0.5 w-1 h-1 bg-gray-600 rounded-full"})}),t.jsx("div",{className:"absolute -bottom-1 left-11 w-2 h-2 bg-black rounded-full",children:t.jsx("div",{className:"absolute inset-0.5 w-1 h-1 bg-gray-600 rounded-full"})})]})}),t.jsx("div",{className:"absolute bottom-3 left-16 w-4 h-1 bg-gray-400 rounded-full animate-dust-cloud opacity-0"})]}),t.jsx("div",{className:`text-center ${z[S]} text-gray-700 font-semibold`,children:R}),t.jsxs("div",{className:"flex space-x-1 mt-2",children:[t.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-bounce",style:{animationDelay:"0ms"}}),t.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-bounce",style:{animationDelay:"150ms"}}),t.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-bounce",style:{animationDelay:"300ms"}})]})]}),t.jsx("style",{jsx:!0,children:`
        @keyframes collect-garbage {
          0% {
            transform: translateX(-20px);
          }
          20% {
            transform: translateX(40px);
          }
          40% {
            transform: translateX(80px);
          }
          60% {
            transform: translateX(120px);
          }
          80% {
            transform: translateX(160px);
          }
          100% {
            transform: translateX(200px);
          }
        }
        
        @keyframes garbage-fill {
          0%, 20% {
            height: 0px;
            opacity: 0;
          }
          25% {
            height: 1px;
            opacity: 1;
          }
          40% {
            height: 2px;
            opacity: 1;
          }
          60% {
            height: 3px;
            opacity: 1;
          }
          80% {
            height: 4px;
            opacity: 1;
          }
          100% {
            height: 4px;
            opacity: 0;
          }
        }
        
        @keyframes dust-cloud {
          0%, 60% {
            opacity: 0;
            transform: scale(0.5);
          }
          70% {
            opacity: 0.8;
            transform: scale(1);
          }
          80% {
            opacity: 0.6;
            transform: scale(1.2);
          }
          90% {
            opacity: 0.4;
            transform: scale(1.4);
          }
          100% {
            opacity: 0;
            transform: scale(1.6);
          }
        }
        
        .animate-collect-garbage {
          animation: collect-garbage 4s ease-in-out infinite;
        }
        
        .animate-garbage-fill {
          animation: garbage-fill 4s ease-in-out infinite;
        }
        
        .animate-dust-cloud {
          animation: dust-cloud 4s ease-in-out infinite;
        }
      `})]})},bt=({mapboxKey:y,barangayId:S,scheduleId:R,isFullscreen:v=!1})=>{const z=d.useRef(null),c=d.useRef(null),[B,O]=d.useState(!1),[g,D]=d.useState(!1),[N,le]=d.useState(null),[h,Re]=d.useState(null),[ce,Ee]=d.useState(null),[x,q]=d.useState([]),[Y,Te]=d.useState([]),[de,K]=d.useState(navigator.onLine),[ut,ue]=d.useState(!0),[H,P]=d.useState("connecting"),[ft,_]=d.useState(null),[W,Ce]=d.useState(!1),[X,A]=d.useState(!1),[Fe,fe]=d.useState(!1),[ze,De]=d.useState("Loading map data..."),[me,ge]=d.useState(!0),V=(e="Loading map data...")=>{me&&(De(e),fe(!0))},E=()=>{me&&fe(!1)},[$,Z]=d.useState([]),[f,G]=d.useState(null),[k,Pe]=d.useState([]),[L,_e]=d.useState(null),[p,Ie]=d.useState(null),[l,Ue]=d.useState(!1),[U,he]=d.useState(!0),[ee,pe]=d.useState(!1),[xe,te]=d.useState(null),[j,mt]=d.useState(!0),I=d.useRef(null),se=d.useRef(null),[Be,Oe]=d.useState(Date.now()),qe=()=>Date.now()-Be<3e4,[ve,He]=d.useState({width:typeof window<"u"?window.innerWidth:1200,height:typeof window<"u"?window.innerHeight:800});d.useEffect(()=>{if(!c.current)return;const e=["mousedown","touchstart","wheel","movestart","dragstart"],s=()=>{Oe(Date.now())};return e.forEach(a=>{c.current.on(a,s)}),()=>{e.forEach(a=>{c.current&&c.current.off(a,s)})}},[c.current]),d.useEffect(()=>{const e=()=>{const s=window.innerWidth<768;Ue(s),He({width:window.innerWidth,height:window.innerHeight}),s&&he(!1)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),d.useEffect(()=>{const e=()=>{K(!0),A(!1),P("online")},s=()=>{K(!1),A(!0),P("offline"),_(null)};return K(navigator.onLine),A(!navigator.onLine),P(navigator.onLine?"online":"offline"),window.addEventListener("online",e),window.addEventListener("offline",s),()=>{window.removeEventListener("online",e),window.removeEventListener("offline",s)}},[]),d.useEffect(()=>{const e=()=>{z.current?Ce(!0):setTimeout(e,100)};e()},[]),d.useEffect(()=>{if((()=>{const i=document.querySelector('link[href*="mapbox-gl.css"]');return i&&i.sheet?(O(!0),!0):!1})())return;const s=document.createElement("link");s.href="https://api.mapbox.com/mapbox-gl-js/v3.0.0/mapbox-gl.css",s.rel="stylesheet",s.type="text/css";let a;const r=()=>{clearTimeout(a),O(!0)},u=()=>{clearTimeout(a),console.warn("Mapbox CSS failed to load, continuing anyway"),O(!0)};s.onload=r,s.onerror=u,document.head.appendChild(s),a=setTimeout(()=>{console.warn("Mapbox CSS load timeout, continuing anyway"),O(!0)},5e3)},[]);const re=e=>{if(e<60)return`${e} min`;{const s=Math.floor(e/60),a=e%60;return a===0?`${s}h`:`${s}h ${a}min`}},J=(e,s,a,r)=>{const i=(a-e)*Math.PI/180,n=(r-s)*Math.PI/180,o=Math.sin(i/2)*Math.sin(i/2)+Math.cos(e*Math.PI/180)*Math.cos(a*Math.PI/180)*Math.sin(n/2)*Math.sin(n/2);return 6371*(2*Math.atan2(Math.sqrt(o),Math.sqrt(1-o)))},We=(e,s)=>{if(!e||s.length===0)return s;const a=[...s],r=[],u=a.map(m=>{const w=J(parseFloat(e.latitude),parseFloat(e.longitude),parseFloat(m.latitude),parseFloat(m.longitude));return{...m,distance:w,coordinates:[parseFloat(m.longitude),parseFloat(m.latitude)]}});u.sort((m,w)=>m.distance-w.distance);const i=u[0];r.push(i);const n=u.slice(1);let o=i;for(;n.length>0;){let m=-1,w=1/0;for(let b=0;b<n.length;b++){const T=J(parseFloat(o.latitude),parseFloat(o.longitude),parseFloat(n[b].latitude),parseFloat(n[b].longitude));T<w&&(w=T,m=b)}m!==-1&&(o=n[m],r.push(o),n.splice(m,1))}return r},be=async(e,s,a=!1,r=!1)=>{if(!y||e.length<1)return;if(e.filter(i=>i.type!=="station"&&i.status!=="finished"&&i.status!=="completed").length===0){s&&await we(e,s,r);return}r||(pe(!0),V("Calculating optimal route...")),te(null);try{const i=e.filter(o=>o.latitude&&o.longitude&&!isNaN(parseFloat(o.latitude))&&!isNaN(parseFloat(o.longitude))&&o.type!=="station"&&o.status!=="finished"&&o.status!=="completed");if(i.length<1){console.warn("No valid unfinished sites with coordinates found"),te("No valid sites with coordinates found");return}const n=s?We(s,i):i;if(Pe(n),n.length>0&&_e(n[0]),a&&h&&n.length>0){const o=[`${h[0].toFixed(6)},${h[1].toFixed(6)}`,...n.map(m=>`${parseFloat(m.longitude).toFixed(6)},${parseFloat(m.latitude).toFixed(6)}`)];try{const m=await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${o.join(";")}?access_token=${y}&geometries=geojson&overview=full&steps=true&alternatives=false&continue_straight=false&roundabout_exits=true`);if(m.ok){const w=await m.json();if(w.routes&&w.routes.length>0){const b=w.routes[0],T=Math.round(b.duration/60),Q=(b.distance/1e3).toFixed(1);Z(b.geometry.coordinates),G({duration:T,formattedDuration:re(T),distance:Q,targetSite:n[0].site_name,isRealTime:!0,totalStops:n.length}),c.current&&g&&M();return}}}catch(m){console.error("Error calculating driver route:",m)}}await we(n,s,r)}catch(i){console.error("Error calculating route:",i),te(`Route calculation failed: ${i.message}`);const n=e.filter(o=>o.latitude&&o.longitude&&!isNaN(parseFloat(o.latitude))&&!isNaN(parseFloat(o.longitude))&&o.type!=="station"&&o.status!=="finished"&&o.status!=="completed");if(n.length>0){const o=n.map(m=>[parseFloat(m.longitude),parseFloat(m.latitude)]);Z(o),G({duration:Math.round(ye(o)*2),formattedDuration:"Estimated",distance:ye(o).toFixed(1),isFallback:!0,totalStops:n.length,isRealTime:!1}),c.current&&g&&M()}}finally{r||(pe(!1),E())}},we=async(e,s,a=!1)=>{if(!(!y||e.length<1))try{const r=[];if(s&&s.longitude&&s.latitude&&r.push(`${parseFloat(s.longitude).toFixed(6)},${parseFloat(s.latitude).toFixed(6)}`),e.forEach(n=>{n.type!=="station"&&r.push(`${parseFloat(n.longitude).toFixed(6)},${parseFloat(n.latitude).toFixed(6)}`)}),r.length<2){console.warn("Not enough coordinates for station route");return}const u=await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${r.join(";")}?access_token=${y}&geometries=geojson&overview=full&steps=true&alternatives=false&continue_straight=false`+(r.length>2?"&roundabout_exits=true":""));if(!u.ok)throw new Error(`HTTP error! status: ${u.status}`);const i=await u.json();if(i.routes&&i.routes.length>0){const n=i.routes[0],o=Math.round(n.duration/60),m=(n.distance/1e3).toFixed(1);Z(n.geometry.coordinates),G({duration:o,formattedDuration:re(o),distance:m,totalStops:e.filter(w=>w.type!=="station").length,isRealTime:!1}),c.current&&g&&M()}}catch(r){console.error("Error calculating station route:",r)}},ye=e=>{let s=0;for(let a=1;a<e.length;a++){const[r,u]=e[a-1],[i,n]=e[a];s+=J(u,r,n,i)}return s},ae=async()=>{if(!(!j||!h||!k.length)){if(se.current){const[e,s]=se.current,[a,r]=h;if(J(s,e,r,a)*1e3<50)return}se.current=h;try{const e=[`${h[0].toFixed(6)},${h[1].toFixed(6)}`,...k.map(a=>`${parseFloat(a.longitude).toFixed(6)},${parseFloat(a.latitude).toFixed(6)}`)],s=await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${e.join(";")}?access_token=${y}&geometries=geojson&overview=full&steps=true&alternatives=false&continue_straight=false&roundabout_exits=true`);if(s.ok){const a=await s.json();if(a.routes&&a.routes.length>0){const r=a.routes[0],u=Math.round(r.duration/60),i=(r.distance/1e3).toFixed(1);Z(r.geometry.coordinates),G(n=>({...n,duration:u,formattedDuration:re(u),distance:i,targetSite:k[0].site_name,isRealTime:!0,totalStops:k.length,lastUpdated:new Date().toLocaleTimeString()})),c.current&&g&&M()}}}catch(e){console.error("Error updating real-time route:",e)}}},Xe=()=>{I.current&&clearInterval(I.current),I.current=setInterval(()=>{j&&h&&k.length>0&&ae()},2e3)},Ae=()=>{I.current&&(clearInterval(I.current),I.current=null)},M=()=>{if(!(!c.current||$.length===0)){if(!c.current.isStyleLoaded()){c.current.once("styledata",()=>{setTimeout(M,100)});return}["route","route-glow","route-direction","route-start","route-end","route-waypoints","driver-route","driver-route-glow"].forEach(e=>{c.current.getLayer(e)&&c.current.removeLayer(e)}),c.current.getSource("route")&&c.current.removeSource("route"),c.current.getSource("driver-route")&&c.current.removeSource("driver-route"),["route-start-marker","route-end-marker","route-waypoints-marker"].forEach(e=>{c.current.getSource(e)&&c.current.removeSource(e)});try{const e=f!=null&&f.isRealTime?"driver-route":"route",s=f!=null&&f.isRealTime?"driver-route":"route",a=f!=null&&f.isRealTime?"driver-route-glow":"route-glow";c.current.addSource(e,{type:"geojson",data:{type:"Feature",properties:{},geometry:{type:"LineString",coordinates:$}}});const r=f!=null&&f.isRealTime?"#000000":"#6B7280",u=l?6:5,i=l?14:12;c.current.addLayer({id:a,type:"line",source:e,layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":r,"line-width":i,"line-opacity":f!=null&&f.isRealTime?.4:.3,"line-blur":10}}),c.current.addLayer({id:s,type:"line",source:e,layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":r,"line-width":u,"line-opacity":.9,"line-dasharray":f!=null&&f.isRealTime?[2,1]:[1,0]}}),c.current.addLayer({id:"route-direction",type:"symbol",source:e,layout:{"symbol-placement":"line","text-field":"‚ñ∂","text-size":l?14:12,"symbol-spacing":100},paint:{"text-color":r}});const n=[];p&&p.latitude&&p.longitude&&!(f!=null&&f.isRealTime)&&n.push({coordinates:[parseFloat(p.longitude),parseFloat(p.latitude)],type:"station",sequence:0}),k.forEach((o,m)=>{o.latitude&&o.longitude&&n.push({coordinates:[parseFloat(o.longitude),parseFloat(o.latitude)],type:"site",sequence:m+1,isTarget:(f==null?void 0:f.isRealTime)&&m===0})}),n.length>0&&(c.current.addSource("route-waypoints-marker",{type:"geojson",data:{type:"FeatureCollection",features:n.map((o,m)=>({type:"Feature",geometry:{type:"Point",coordinates:o.coordinates},properties:{description:o.type==="station"?"Station":o.isTarget?`Target: ${o.sequence}`:`Site ${o.sequence}`,type:o.type,sequence:o.sequence,isTarget:o.isTarget}}))}}),c.current.addLayer({id:"route-waypoints",type:"circle",source:"route-waypoints-marker",paint:{"circle-radius":["case",["==",["get","type"],"station"],l?10:8,["==",["get","isTarget"],!0],l?12:10,l?8:6],"circle-color":["case",["==",["get","type"],"station"],"#dc2626",["==",["get","isTarget"],!0],"#10B981","#3b82f6"],"circle-stroke-width":2,"circle-stroke-color":"#ffffff"}})),!(f!=null&&f.isRealTime)&&$.length>=2&&(c.current.addSource("route-start-marker",{type:"geojson",data:{type:"Feature",geometry:{type:"Point",coordinates:$[0]},properties:{description:"Start"}}}),c.current.addSource("route-end-marker",{type:"geojson",data:{type:"Feature",geometry:{type:"Point",coordinates:$[$.length-1]},properties:{description:"End"}}}),c.current.addLayer({id:"route-start",type:"circle",source:"route-start-marker",paint:{"circle-radius":l?8:6,"circle-color":"#22c55e","circle-stroke-width":2,"circle-stroke-color":"#ffffff"}}),c.current.addLayer({id:"route-end",type:"circle",source:"route-end-marker",paint:{"circle-radius":l?8:6,"circle-color":"#ef4444","circle-stroke-width":2,"circle-stroke-color":"#ffffff"}})),setTimeout(()=>{Se()},200)}catch(e){console.error("Error adding route layer:",e),setTimeout(()=>{M()},500)}}},Se=()=>{if(!c.current||$.length===0||x.length===0)return;const e=new F.LngLatBounds;$.forEach(a=>{e.extend(a)}),p&&e.extend([parseFloat(p.longitude),parseFloat(p.latitude)]),x.forEach(a=>{a.longitude&&a.latitude&&e.extend([parseFloat(a.longitude),parseFloat(a.latitude)])}),h&&e.extend(h);const s=l?40:80;try{c.current.fitBounds(e,{padding:s,duration:1500,essential:!0,maxZoom:l?16:15,offset:[0,l?-50:0]})}catch(a){console.error("Error fitting map to bounds:",a)}},je=e=>null,Ve=async()=>{try{const e=await C.get("/api/station");if(e.data.success&&e.data.data){const s=e.data.data;return Ie(s),s}}catch(e){console.warn("Could not load station:",e)}return null};d.useEffect(()=>(B&&y&&W&&(()=>{if(z.current&&!c.current){if(!y){_("Mapbox key is missing.");return}V("Initializing map...");try{F.accessToken=y;const s={container:z.current,style:"mapbox://styles/mapbox/streets-v12",center:[125.94849837776422,8.483022468128098],zoom:l?11:10.5,attributionControl:!1,interactive:!0,scrollZoom:!0,dragPan:!0,dragRotate:!1,keyboard:!1,doubleClickZoom:!l,touchZoomRotate:!0,touchPitch:!1,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!0,maxTileCacheSize:50,refreshExpiredTiles:de,transformRequest:(i,n)=>!de&&n==="Tile"?{url:i,headers:{"Cache-Control":"max-age=86400"}}:{url:i}};c.current=new F.Map(s);const a=()=>{D(!0),_(null),x.length>0&&$e(x),h&&ie(h,{}),$.length>0&&setTimeout(()=>{M()},500),j&&Xe(),E()},r=i=>{var n;if(console.error("Map error:",i),!navigator.onLine||X){console.warn("Map error suppressed - continuing in offline mode"),A(!0),_(null),g||D(!0);return}_(`Map error: ${((n=i.error)==null?void 0:n.message)||"Unknown error"}`),D(!0),E()};c.current.once("load",a),c.current.on("error",r),c.current.on("dataloading",i=>{var n;(!navigator.onLine||X)&&((n=i.preventDefault)==null||n.call(i))}),c.current.on("sourcedataloading",i=>{var n;(!navigator.onLine||X)&&((n=i.preventDefault)==null||n.call(i))});const u=setTimeout(()=>{g||(console.warn("Map load timeout - continuing anyway"),D(!0),E())},1e4);return()=>clearTimeout(u)}catch(s){console.error("Error creating map:",s),_(`Failed to create map: ${s.message}`),D(!0),E()}}})(),()=>{Ae(),c.current&&(c.current.remove(),c.current=null,D(!1))}),[B,y,W,l]),d.useEffect(()=>{if(x.length>0&&p&&y&&g){if(x.filter(s=>s.type!=="station"&&s.status!=="finished"&&s.status!=="completed").length===0)return;be(x,p,j,!0)}},[x,p,y,g]),d.useEffect(()=>{if(j&&h&&k.length>0){const e=setTimeout(()=>{ae()},1e3);return()=>clearTimeout(e)}},[h,j]),d.useEffect(()=>{c.current&&$.length>0&&g&&M()},[$,g]),d.useEffect(()=>{g&&x.length>0&&(console.log("üìç Updating site markers with",x.length,"sites and station:",!!p),$e(x))},[g,x,p,l,j,L]),d.useEffect(()=>{if(!(N!=null&&N.id))return;const e=setInterval(async()=>{try{const s=await C.get(`/schedule/${N.id}/sites`);if(s.data.success){const a=s.data.data;if(a.some((u,i)=>{const n=x.find(o=>o.id===u.id);return n&&n.status!==u.status}))if(q(a),a.filter(i=>i.type!=="station"&&i.status!=="finished"&&i.status!=="completed").length>0){const i=je(a)}else console.log("‚ö†Ô∏è All sites finished - no route calculation needed")}}catch(s){console.error("Polling error:",s)}},5e3);return()=>{clearInterval(e)}},[N==null?void 0:N.id,x]),d.useEffect(()=>{g&&h&&ie(h,{})},[g,h,l]),d.useEffect(()=>{if(!S)return;const e=async()=>{try{nt();const r=Me();if(!r)throw new Error("Echo not initialized");r.channel(`driver-locations.${S}`).listen("DriverLocationUpdated",u=>{P("connected"),oe(u)}),r.channel(`schedule-updates.${S}`).listen("ScheduleStatusUpdated",u=>{Ge(u.schedule)}),r.channel(`site-completion.${S}`).listen("SiteCompletionUpdated",u=>{Ne(u),ne()}),P("connected"),await Ze(),s()}catch(r){console.error("Realtime connection failed:",r),P("disconnected"),s()}},s=()=>{const r=setInterval(()=>{a()},1e4);return()=>clearInterval(r)},a=async()=>{try{if(R){const r=await C.get(`/schedule/${R}/driver-location`);r.data.success&&r.data.data&&oe(r.data.data)}}catch(r){console.error("Error polling driver location:",r)}};return e(),()=>{const r=Me();r&&(r.leave(`driver-locations.${S}`),r.leave(`schedule-updates.${S}`),r.leave(`site-completion.${S}`))}},[S,R]);const ne=async(e=!0)=>{try{if(!N||!N.id){console.warn("No current schedule available to refresh sites");return}const s=await C.get(`/schedule/${N.id}/sites`);if(s.data.success){const a=s.data.data;if(q(a),a.filter(u=>u.type!=="station"&&u.status!=="finished"&&u.status!=="completed").length>0){const u=je(a)}else console.log("‚ö†Ô∏è All sites finished - no route calculation needed")}}catch(s){console.error("Error refreshing sites from server:",s)}};d.useEffect(()=>{window.testSiteCompletion=e=>{Ne({site_id:e,completed_at:new Date().toISOString()})},window.refreshResidentMap=()=>{ne()}},[x,N]);const Ze=async()=>{try{ue(!0),V("Loading collection sites...");const e=await C.get(`/barangay/${S}/current-schedule`);if(e.data.success){const s=e.data.data;if(le(s),s.id){const[a,r]=await Promise.all([C.get(`/schedule/${s.id}/sites`),Ve()]);if(a.data.success){const u=a.data.data;console.log("üìç Loaded sites:",u.length),q(u),r&&console.log("üè¢ Station loaded:",r)}}if(R){const a=await C.get(`/schedule/${R}/driver-location`);a.data.success&&a.data.data&&oe(a.data.data)}}E(),ge(!1)}catch(e){console.error("Error loading initial data:",e),E(),ge(!1)}finally{ue(!1)}},oe=e=>{if(!e.longitude||!e.latitude){console.warn("Invalid location data received:",e);return}const s=[parseFloat(e.longitude),parseFloat(e.latitude)];Re(s),g&&c.current&&(ie(s,e),qe()||c.current.flyTo({center:s,zoom:l?16:15,duration:2e3,essential:!0,offset:[0,l?-100:0]}),j&&ae())},Ne=e=>{q(s=>s.map(r=>r.id===e.site_id||r.id===e.siteId?{...r,status:"finished",collectionStatus:"finished",completed_at:e.completed_at||new Date().toISOString()}:r)),setTimeout(()=>{console.log("üîÑ Refreshing sites from server"),ne()},1e3)},ie=(e,s)=>{if(!c.current||!g)return;ce&&ce.remove();const a=l?"w-12 h-12":"w-10 h-10",r=l?"w-6 h-6":"w-5 h-5",u=document.createElement("div");u.className="driver-location-marker";const n=(s.timestamp?(new Date-new Date(s.timestamp))/1e3:0)<30;u.innerHTML=`
      <div class="relative">
        <div class="${a} bg-blue-600 border-3 border-white rounded-full shadow-lg flex items-center justify-center relative z-10">
          <svg class="${r} text-white" viewBox="0 0 24 24" fill="currentColor">
            <path d="M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z"/>
            <path d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0"/>
          </svg>
          ${n?"":`
            <div class="absolute -top-1 -right-1 w-3 h-3 bg-yellow-500 rounded-full border border-white"></div>
          `}
        </div>
        <div class="absolute inset-0 bg-blue-400 rounded-full animate-ping opacity-30"></div>
        ${s.accuracy?`
          <div class="absolute inset-0 border-2 border-blue-300 rounded-full opacity-50" 
               style="transform: scale(${Math.min(s.accuracy/10,3)})"></div>
        `:""}
      </div>
    `;try{const o=new F.Marker({element:u,draggable:!1}).setLngLat(e).addTo(c.current),m=new F.Popup({offset:25,closeButton:!1,className:`custom-popup ${l?"max-w-xs":"max-w-sm"}`}).setHTML(`
        <div class="text-sm ${l?"p-2":"p-3"}">
          <div class="font-semibold text-gray-900 ${l?"text-base":""}">üöó Driver Location</div>
          <div class="text-xs text-gray-500 mt-1">
            ${s.timestamp?`Updated: ${new Date(s.timestamp).toLocaleTimeString()}`:"Live"}
          </div>
          ${s.accuracy?`
            <div class="text-xs text-gray-500 mt-1">
              Accuracy: ¬±${Math.round(s.accuracy)} meters
            </div>
          `:""}
          ${n?"":`
            <div class="text-xs text-yellow-600 mt-1 font-medium">
              ‚ö†Ô∏è Location data may be delayed
            </div>
          `}
        </div>
      `);o.setPopup(m),Ee(o)}catch(o){console.error("Error creating driver marker:",o)}},Ge=e=>{le(e)},$e=e=>{if(!c.current||!g)return;Y.forEach(r=>{r&&r.remove&&r.remove()});const s=[...e];p&&p.latitude&&p.longitude&&s.push({...p,type:"station",site_name:p.site_name||"Collection Station",status:"active"});const a=s.map((r,u)=>{if(!r.longitude||!r.latitude)return null;try{const i=document.createElement("div");i.className="site-marker";const n=r.status==="completed"||r.status==="finished"||r.collectionStatus==="finished",o=r.status==="in_progress",m=r.type==="station",w=r.purok_name||r.site_name||"Site",b=j&&L&&L.id===r.id&&!n,T=()=>m?"#DC2626":n||b?"#10B981":"#6B7280",Q=()=>m?`
              <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
              </svg>
            `:n?`
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
              </svg>
            `:`
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M3 6h18"/>
                <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
              </svg>
            `,ke=l?"w-14 h-14":"w-12 h-12",Ke=l?"w-7 h-7":"w-6 h-6",et=l?"w-8 h-8":"w-7 h-7",Le=k.findIndex(at=>at.id===r.id)+1,tt=Le>0;i.innerHTML=`
          <div class="relative ${o||b?"animate-pulse":""}">
            ${tt&&!m&&!n?`
              <div class="absolute -top-2 -right-2 bg-blue-500 text-white rounded-full ${l?"w-7 h-7 text-sm":"w-6 h-6 text-xs"} flex items-center justify-center font-bold shadow-lg border-2 border-white z-20">
                ${Le}
              </div>
            `:""}
            ${m?`
              <div class="${ke} rounded-full bg-white shadow-2xl border-4 border-red-600 flex items-center justify-center">
                <div class="${et} text-red-600">
                  ${Q()}
                </div>
              </div>
            `:`
              <div class="${ke} rounded-full border-3 border-white flex items-center justify-center shadow-lg" 
                    style="background-color: ${T()}; ${n?"opacity: 0.7;":""}">
                <div class="${Ke} text-white">
                  ${Q()}
                </div>
              </div>
            `}
            ${o?'<div class="absolute inset-0 rounded-full border-3 border-yellow-500 animate-ping"></div>':""}
            ${b&&!o?'<div class="absolute inset-0 rounded-full border-3 border-green-500 animate-ping"></div>':""}
          </div>
        `;const st=[parseFloat(r.longitude),parseFloat(r.latitude)],rt=new F.Popup({offset:25,closeButton:!1,className:`custom-popup ${l?"max-w-xs":"max-w-sm"}`}).setHTML(`
          <div class="text-sm ${l?"p-2":"p-3"}">
            <div class="font-semibold text-gray-900 ${l?"text-base":""}">${w}</div>
            <div class="text-xs text-gray-500 mt-1">
              ${m?"Collection Station":n?"Completed":o?"In Progress":"Pending"}
            </div>
            ${b&&j&&'<div class="text-xs text-green-600 mt-1 font-medium">üéØ Current Target</div>'}
            ${L&&L.id===r.id&&!b&&'<div class="text-xs text-green-600 mt-1 font-medium">üìç Nearest Site</div>'}
          </div>
        `);return new F.Marker({element:i,draggable:!1}).setLngLat(st).setPopup(rt).addTo(c.current)}catch(i){return console.error("Error creating marker:",i),null}}).filter(r=>r!==null);Te(a)},Je=async()=>{x.length>0&&p&&(V("Refreshing route..."),await be(x,p,j))},Qe=()=>{he(!U)},Ye=()=>v?"100%":ve.width<640?"400px":ve.width<768?"500px":"600px";return d.useEffect(()=>{console.log("Current state:",{cssLoaded:B,mapInitialized:g,containerReady:W,siteLocationsCount:x.length,siteMarkersCount:Y.length,driverLocation:!!h})},[B,g,W,x,Y,h]),t.jsxs("div",{className:`${v?"w-full h-full":"w-full"} bg-white ${v?"":"rounded-lg border border-gray-200"} overflow-hidden`,children:[t.jsx(dt,{isLoading:Fe,message:ze,size:l?"medium":"large",variant:"default"}),X&&t.jsxs("div",{className:"absolute top-0 left-0 right-0 bg-yellow-500 text-black px-4 py-2 z-50 flex items-center justify-center gap-2 shadow-lg",children:[t.jsx(ot,{className:"w-5 h-5"}),t.jsx("span",{className:"font-semibold text-sm",children:"Offline Mode - Using cached map data"})]}),t.jsxs("div",{className:`relative w-full ${v?"h-full":""}`,style:{height:v?"100%":Ye()},children:[t.jsx("div",{ref:z,className:"w-full h-full absolute inset-0"}),g&&t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:`absolute ${l?"bottom-2 left-2":"bottom-4 left-4"} bg-white/95 backdrop-blur-sm rounded-lg shadow-lg border border-gray-200 ${l?"p-2":"p-3"} z-10 ${l?"min-w-40 max-w-48":v?"min-w-52":"min-w-48"}`,children:[t.jsxs("div",{className:`font-semibold ${l?"text-xs":"text-sm"} text-gray-900 ${l?"mb-2":"mb-3"} flex items-center justify-between`,children:[t.jsx("span",{children:"Legend"}),v&&!l&&t.jsx("span",{className:"text-xs font-normal text-gray-500",children:"Live Tracking"})]}),t.jsxs("div",{className:`space-y-1 ${l?"text-xs":"text-sm"}`,children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("div",{className:"w-4 h-4 bg-blue-600 rounded-full flex items-center justify-center flex-shrink-0 relative",children:t.jsx("div",{className:"absolute inset-0 bg-blue-400 rounded-full animate-ping opacity-30"})}),t.jsx("span",{className:"text-gray-700",children:"Driver"})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("div",{className:"w-4 h-4 bg-red-600 rounded-full flex-shrink-0"}),t.jsx("span",{className:"text-gray-700",children:"Station"})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("div",{className:"w-4 h-4 bg-gray-500 rounded-full flex-shrink-0"}),t.jsx("span",{className:"text-gray-700",children:"Pending"})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("div",{className:"w-4 h-4 bg-green-600 rounded-full flex-shrink-0"}),t.jsx("span",{className:"text-gray-700",children:"Completed"})]}),j&&L&&t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("div",{className:"w-4 h-4 bg-green-500 rounded-full flex-shrink-0 relative",children:t.jsx("div",{className:"absolute inset-0 rounded-full border-2 border-white animate-ping"})}),t.jsx("span",{className:"text-gray-700",children:"Target Site"})]}),f&&t.jsxs("div",{className:"flex items-center gap-2 pt-1 border-t border-gray-200",children:[t.jsx("div",{className:"w-4 h-1 rounded-full flex-shrink-0",style:{backgroundColor:f.isRealTime?"#000000":"#6B7280"}}),t.jsx("span",{className:"text-gray-700",children:f.isRealTime?"Live Route":"Planned Route"})]})]})]}),t.jsxs("div",{className:`absolute ${l?"top-2 right-2":"top-4 right-4"} flex ${v&&!l?"flex-row gap-2":"flex-col gap-2"} z-10`,children:[t.jsx("button",{onClick:Je,disabled:ee,className:`${v?"bg-white/95 backdrop-blur-sm":"bg-white"} rounded-lg shadow-lg border border-gray-200 hover:bg-gray-50 transition-colors flex items-center justify-center ${l?"p-2":"p-3"} ${ee?"opacity-50 cursor-not-allowed":""}`,title:"Refresh route",children:ee?t.jsx("div",{className:`animate-spin rounded-full border-b-2 border-gray-700 ${l?"w-4 h-4":"w-5 h-5"}`}):t.jsx(it,{className:`text-gray-700 ${l?"w-4 h-4":"w-5 h-5"}`})}),t.jsx("button",{onClick:Qe,className:`${v?"bg-white/95 backdrop-blur-sm":"bg-white"} rounded-lg shadow-lg border ${U?"border-blue-500 bg-blue-50":"border-gray-200"} hover:bg-gray-50 transition-colors flex items-center justify-center ${l?"p-2":"p-3"}`,title:U?"Hide route info":"Show route info",children:t.jsx(lt,{className:`${U?"text-blue-600":"text-gray-700"} ${l?"w-4 h-4":"w-5 h-5"}`})}),t.jsx("button",{onClick:Se,className:`${v?"bg-white/95 backdrop-blur-sm":"bg-white"} rounded-lg shadow-lg border border-gray-200 hover:bg-gray-50 transition-colors flex items-center justify-center ${l?"p-2":"p-3"}`,title:"Fit to route",children:t.jsx(ct,{className:`text-gray-700 ${l?"w-4 h-4":"w-5 h-5"}`})})]}),t.jsx("div",{className:`absolute ${l?"top-2 left-2":"top-4 left-4"} bg-white/95 backdrop-blur-sm rounded-lg shadow-lg border border-gray-200 ${l?"px-2 py-1":"px-3 py-2"} z-10`,children:t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("div",{className:`w-2 h-2 rounded-full ${H==="connected"?"bg-green-500":H==="connecting"?"bg-yellow-500":"bg-red-500"} ${H==="connected"?"animate-pulse":""}`}),t.jsx("span",{className:`font-medium text-gray-700 capitalize ${l?"text-xs":"text-sm"}`,children:H})]})}),f&&U&&t.jsxs("div",{className:`absolute ${l?"top-12 left-2 right-2":v?"top-4 left-1/2 transform -translate-x-1/2":"top-16 left-4"} bg-white/95 backdrop-blur-sm rounded-lg shadow-lg border border-gray-200 ${l?"p-3":"p-4"} z-10 ${l?"":v?"min-w-80 max-w-md":"min-w-64"}`,children:[t.jsxs("div",{className:`font-semibold text-gray-900 ${l?"text-sm mb-2":"text-base mb-3"} flex items-center justify-between`,children:[t.jsx("span",{children:f.isRealTime?"Live Route":"Planned Route"}),t.jsxs("div",{className:"flex gap-1",children:[f.isRealTime&&t.jsxs("span",{className:"text-xs bg-green-100 text-green-800 px-2 py-1 rounded flex items-center gap-1",children:[t.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-pulse"}),"Live"]}),f.isFallback&&t.jsx("span",{className:"text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded",children:"Estimated"})]})]}),t.jsxs("div",{className:`space-y-2 ${l?"text-xs":"text-sm"} text-gray-600`,children:[t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsx("span",{children:"Estimated Time:"}),t.jsx("span",{className:"font-semibold text-blue-600",children:f.formattedDuration})]}),t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsx("span",{children:"Distance:"}),t.jsxs("span",{className:"font-semibold",children:[f.distance," km"]})]}),t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsx("span",{children:"Total Stops:"}),t.jsxs("span",{className:"font-semibold",children:[f.totalStops," sites"]})]}),f.targetSite&&t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsx("span",{children:"Target Site:"}),t.jsx("span",{className:"font-semibold text-green-600",children:f.targetSite})]}),L&&!f.targetSite&&t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsx("span",{children:"Nearest Site:"}),t.jsx("span",{className:"font-semibold text-green-600",children:L.site_name})]}),f.lastUpdated&&t.jsxs("div",{className:"flex justify-between items-center text-xs text-gray-500",children:[t.jsx("span",{children:"Last Updated:"}),t.jsx("span",{children:f.lastUpdated})]})]}),xe&&t.jsx("div",{className:`mt-2 p-2 bg-red-50 border border-red-200 rounded ${l?"text-xs":"text-sm"} text-red-600`,children:xe})]})]})]})]})};export{bt as default};
