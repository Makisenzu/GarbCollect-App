import{r as s}from"./app-EgvoLMSF.js";import{a as L}from"./mapbox-gl-Bs5fO_fJ.js";/* empty css                  */import{c as pe}from"./can-3MqaZyCZ.js";const ve=(k,X)=>{const[ee,E]=s.useState(null),[d,T]=s.useState(null),[te,f]=s.useState(!1),[re,F]=s.useState(null),[M,_]=s.useState(!1),[m,oe]=s.useState(!1),[ne,I]=s.useState(null),[H,q]=s.useState(!1),[b,B]=s.useState(navigator.onLine),[ae,P]=s.useState(!1),C=s.useRef(null),o=s.useRef(null),R=s.useRef([]),Y=s.useRef(null),O=s.useRef(null),ce=s.useRef(null),g=s.useRef(null),Z=s.useRef(null),W=s.useRef(null),v=s.useRef(null),i={ROUTE:"cached_route",SITE:"cached_site",LOCATION:"cached_location",MAP_STYLE:"cached_map_style"};s.useEffect(()=>{const e=()=>{oe(window.innerWidth<768)},t=()=>{B(!0),P(!1)},r=()=>{B(!1),P(!0)};return e(),window.addEventListener("resize",e),window.addEventListener("online",t),window.addEventListener("offline",r),se(),()=>{window.removeEventListener("resize",e),window.removeEventListener("online",t),window.removeEventListener("offline",r)}},[]);const h=(e,t,r=24*60*60*1e3)=>{try{const n={data:t,timestamp:Date.now(),ttl:r};localStorage.setItem(e,JSON.stringify(n))}catch(n){console.warn("Failed to cache data:",n)}},y=e=>{try{const t=localStorage.getItem(e);if(!t)return null;const r=JSON.parse(t);return Date.now()-r.timestamp>r.ttl?(localStorage.removeItem(e),null):r.data}catch(t){return console.warn("Failed to retrieve cached data:",t),null}},se=()=>{const e=y(i.ROUTE),t=y(i.SITE),r=y(i.LOCATION);e&&(ce.current=e),t&&T(t),r&&(E(r),g.current=r)},$=e=>{if(e<60)return`${e} min`;{const t=Math.floor(e/60),r=e%60;return r===0?`${t}h`:`${t}h ${r}min`}};s.useEffect(()=>{if(!k){F("Mapbox API key is missing"),f(!1);return}if(C.current){try{L.accessToken=k,o.current=new L.Map({container:C.current,style:"mapbox://styles/mapbox/streets-v12",center:[125.94849837776422,8.483022468128098],zoom:11,attributionControl:!1,interactive:!0,scrollZoom:!0,dragPan:!0,dragRotate:!1,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!0}),o.current.addControl(new L.NavigationControl,"top-right"),o.current.addControl(new L.FullscreenControl,"top-right"),o.current.on("load",()=>{_(!0),f(!1),ie()}),o.current.on("error",e=>{var t;console.warn("Map loading error, attempting to use cached data:",(t=e.error)==null?void 0:t.message),_(!0),f(!1)}),o.current.on("sourcedata",e=>{if(e.sourceId==="route"&&e.isSourceLoaded){const t=o.current.getSource("route");if(t&&t.serialize){const r=t.serialize();h(i.ROUTE,r)}}})}catch(e){console.error("Failed to initialize map:",e),F("Failed to initialize map: "+e.message),f(!1)}return()=>{D(),U(),x(),J(),o.current&&(o.current.remove(),o.current=null)}}},[k]);const ie=()=>{if(!o.current)return;const e=o.current.getBounds(),t=o.current.getZoom(),r={bounds:e.toArray(),zoom:t,center:o.current.getCenter().toArray()};h(i.MAP_STYLE,r)},D=()=>{O.current&&(navigator.geolocation.clearWatch(O.current),O.current=null),v.current&&(cancelAnimationFrame(v.current),v.current=null),q(!1)},ue=(e,t,r)=>{navigator.geolocation&&(D(),h(i.SITE,r),h(i.LOCATION,{lat:e,lng:t}),O.current=navigator.geolocation.watchPosition(n=>{const a=n.coords.latitude,c=n.coords.longitude;E({lat:a,lng:c}),g.current={lat:a,lng:c},h(i.LOCATION,{lat:a,lng:c},5*60*1e3),o.current&&M&&r&&(K(a,c),b?V(a,c,r.latitude,r.longitude):S(a,c,r))},n=>{console.error("Error tracking location:",n),g.current&&(E(g.current),o.current&&M&&r&&(K(g.current.lat,g.current.lng),S(g.current.lat,g.current.lng,r)))},{enableHighAccuracy:!0,timeout:15e3,maximumAge:3e4}),q(!0))},K=(e,t)=>{if(!o.current)return;G(t,e);const r=R.current.find(n=>n.getElement().querySelector(".bg-red-500"));r&&r.setLngLat([t,e]),H&&o.current&&o.current.flyTo({center:[t,e],speed:.8,curve:1,essential:!0})},G=(e,t)=>{if(!o.current)return;const r={type:"FeatureCollection",features:[{type:"Feature",geometry:{type:"Point",coordinates:[e,t]},properties:{description:"Your current location"}}]};if(!o.current.getSource("user-location"))o.current.addSource("user-location",{type:"geojson",data:r}),o.current.addLayer({id:"user-location-layer",type:"circle",source:"user-location",paint:{"circle-radius":8,"circle-color":"#ff0000","circle-stroke-width":2,"circle-stroke-color":"#ffffff","circle-opacity":.8}}),o.current.addLayer({id:"user-location-pulse",type:"circle",source:"user-location",paint:{"circle-radius":{base:8,stops:[[0,8],[20,20]]},"circle-color":"#ff0000","circle-opacity":{base:.4,stops:[[0,.4],[1,0]]},"circle-stroke-width":1,"circle-stroke-color":"#ff0000"}}),Z.current=o.current.getSource("user-location"),W.current="user-location-layer";else{const n=o.current.getSource("user-location");n&&n.setData(r)}le()},le=()=>{if(!o.current||!o.current.getLayer("user-location-pulse"))return;v.current&&cancelAnimationFrame(v.current);const e=Date.now(),t=2e3,r=()=>{const a=(Date.now()-e)%t/t,c=8+a*12;o.current.setPaintProperty("user-location-pulse","circle-radius",c),o.current.setPaintProperty("user-location-pulse","circle-opacity",.4*(1-a)),v.current=requestAnimationFrame(r)};v.current=requestAnimationFrame(r)},J=()=>{o.current&&(["user-location-layer","user-location-pulse"].forEach(e=>{o.current.getLayer(e)&&o.current.removeLayer(e)}),o.current.getSource("user-location")&&o.current.removeSource("user-location"),Z.current=null,W.current=null)},S=(e,t,r)=>{const n=y(i.ROUTE);if(n&&n.data&&n.data.geometry){A(n.data.geometry.coordinates);const a=z(e,t,parseFloat(r.latitude),parseFloat(r.longitude)),c=Math.round(a*2);I({duration:c,formattedDuration:$(c),distance:a.toFixed(1),isCached:!0,isOffline:!0}),j(t,e,parseFloat(r.longitude),parseFloat(r.latitude))}else de(e,t,r)},de=(e,t,r)=>{const n=parseFloat(r.latitude),a=parseFloat(r.longitude);A([[t,e],[a,n]]);const l=z(e,t,n,a),u=Math.round(l*2);I({duration:u,formattedDuration:$(u),distance:l.toFixed(1),isFallback:!0,isOffline:!b}),j(t,e,a,n)},N=(e,t)=>{var a;if(!o.current)return;U();const r=document.createElement("div");r.className="custom-marker animate-pulse",r.innerHTML=`
            <div class="hover:scale-110 transition-transform duration-200 cursor-pointer">
                <div class="w-10 h-10 bg-red-500 rounded-full flex items-center justify-center shadow-lg border-3 border-white relative">
                    <span class="text-white text-sm">You</span>
                    <div class="absolute -inset-2 rounded-full border-2 border-red-500 border-opacity-50 animate-ping"></div>
                    ${b?"":'<div class="absolute -top-1 -right-1 w-3 h-3 bg-yellow-500 rounded-full border border-white"></div>'}
                </div>
            </div>
        `;const n=new L.Marker({element:r,anchor:"bottom"}).setLngLat([t,e]).addTo(o.current);if(R.current.push(n),G(t,e),d&&d.latitude&&d.longitude){const c="#3b82f6",l=m?"w-12 h-12":"w-10 h-10",u=m?"w-10 h-10":"w-8 h-8",w=document.createElement("div");w.className="custom-marker",w.innerHTML=`
                <div class="hover:scale-110 transition-transform duration-200 cursor-pointer relative">
                    <div class="${l} rounded-full border-3 flex items-center justify-center overflow-hidden shadow-lg bg-white relative ring-4 ring-green-500 ring-opacity-70" style="border-color: ${c};">
                        <div class="absolute -inset-3 rounded-full border-4 border-green-500 border-opacity-70 animate-pulse pointer-events-none z-10"></div>
                        <img src="${pe}" 
                             alt="${d.site_name}" 
                             class="${u} object-cover rounded-full z-0"
                             onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\\'${u} rounded-full flex items-center justify-center text-white text-xs font-bold bg-white\\' style=\\'border: 2px solid ${c}; color: ${c}\\'>${((a=d.site_name)==null?void 0:a.charAt(0))||"S"}</div>'">
                        ${b?"":'<div class="absolute -top-1 -right-1 w-3 h-3 bg-yellow-500 rounded-full border border-white"></div>'}
                    </div>
                </div>
            `;const p=new L.Marker({element:w,anchor:"bottom"}).setLngLat([parseFloat(d.longitude),parseFloat(d.latitude)]).addTo(o.current);R.current.push(p),Y.current=p}},U=()=>{R.current.forEach(e=>e.remove()),R.current=[],Y.current=null,J()},x=()=>{o.current&&(["route","route-glow","route-direction","route-start","route-end"].forEach(e=>{o.current.getLayer(e)&&o.current.removeLayer(e)}),["route","route-start-marker","route-end-marker"].forEach(e=>{o.current.getSource(e)&&o.current.removeSource(e)}))},A=e=>{if(!(!o.current||e.length===0)){if(!o.current.isStyleLoaded()){o.current.once("styledata",()=>{setTimeout(()=>A(e),100)});return}x();try{o.current.addSource("route",{type:"geojson",data:{type:"Feature",properties:{},geometry:{type:"LineString",coordinates:e}}});const t=m?6:5,r=m?14:12;o.current.addLayer({id:"route-glow",type:"line",source:"route",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#3b82f6","line-width":r,"line-opacity":.3,"line-blur":10}}),o.current.addLayer({id:"route",type:"line",source:"route",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#3b82f6","line-width":t,"line-opacity":.9}}),o.current.addLayer({id:"route-direction",type:"symbol",source:"route",layout:{"symbol-placement":"line","text-field":"â–¶","text-size":m?14:12,"symbol-spacing":100},paint:{"text-color":"#3b82f6"}}),e.length>=2&&(o.current.addSource("route-start-marker",{type:"geojson",data:{type:"Feature",geometry:{type:"Point",coordinates:e[0]},properties:{description:"Start"}}}),o.current.addSource("route-end-marker",{type:"geojson",data:{type:"Feature",geometry:{type:"Point",coordinates:e[e.length-1]},properties:{description:"End"}}}),o.current.addLayer({id:"route-start",type:"circle",source:"route-start-marker",paint:{"circle-radius":m?8:6,"circle-color":"#22c55e","circle-stroke-width":2,"circle-stroke-color":"#ffffff"}}),o.current.addLayer({id:"route-end",type:"circle",source:"route-end-marker",paint:{"circle-radius":m?8:6,"circle-color":"#ef4444","circle-stroke-width":2,"circle-stroke-color":"#ffffff"}}))}catch(t){console.error("Error adding route layer:",t)}}},V=async(e,t,r,n)=>{if(!k||!b){S(e,t,d);return}try{const a=[`${t.toFixed(6)},${e.toFixed(6)}`,`${parseFloat(n).toFixed(6)},${parseFloat(r).toFixed(6)}`],c=new AbortController,l=setTimeout(()=>c.abort(),15e3),u=await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${a.join(";")}?access_token=${k}&geometries=geojson&overview=full&steps=true&alternatives=false`,{signal:c.signal});if(clearTimeout(l),!u.ok)throw new Error(`HTTP error! status: ${u.status}`);const w=await u.json();if(w.routes&&w.routes.length>0){const p=w.routes[0];if(p.geometry&&p.geometry.coordinates){const Q=Math.round(p.duration/60),me=(p.distance/1e3).toFixed(1);A(p.geometry.coordinates),h(i.ROUTE,{data:p,geometry:p.geometry}),I({duration:Q,formattedDuration:$(Q),distance:me,isOnline:!0}),j(t,e,parseFloat(n),parseFloat(r))}}}catch(a){console.error("Error calculating route, using cached data:",a),S(e,t,d)}},j=(e,t,r,n)=>{if(!o.current)return;const a=new L.LngLatBounds;a.extend([e,t]),a.extend([r,n]);const c=m?40:80;try{o.current.fitBounds(a,{padding:c,duration:1500,essential:!0,maxZoom:m?16:15})}catch(l){console.error("Error fitting map to route:",l)}},z=(e,t,r,n)=>{const c=(r-e)*Math.PI/180,l=(n-t)*Math.PI/180,u=Math.sin(c/2)*Math.sin(c/2)+Math.cos(e*Math.PI/180)*Math.cos(r*Math.PI/180)*Math.sin(l/2)*Math.sin(l/2);return 6371*(2*Math.atan2(Math.sqrt(u),Math.sqrt(1-u)))},fe=(e,t)=>{let r=1/0,n=null;return X.forEach(a=>{const c=z(e,t,parseFloat(a.latitude),parseFloat(a.longitude));c<r&&(r=c,n={...a,distance:Math.round(c*100)/100})}),n};return{userLocation:ee,nearestSite:d,loading:te,error:re,mapLoaded:M,isMobile:m,routeInfo:ne,isTracking:H,isOnline:b,offlineMode:ae,mapContainer:C,getUserLocation:()=>{if(f(!0),F(null),x(),I(null),!navigator.geolocation){F("Geolocation is not supported by your browser"),f(!1);return}if(!b){const e=y(i.LOCATION),t=y(i.SITE);if(e&&t){E(e),T(t),o.current&&M&&(N(e.lat,e.lng),S(e.lat,e.lng,t)),f(!1),P(!0);return}}navigator.geolocation.getCurrentPosition(async e=>{const t=e.coords.latitude,r=e.coords.longitude;E({lat:t,lng:r}),g.current={lat:t,lng:r};const n=fe(t,r);T(n),h(i.LOCATION,{lat:t,lng:r}),h(i.SITE,n),o.current&&M&&n&&(N(t,r),await V(t,r,n.latitude,n.longitude),ue(t,r,n)),f(!1)},e=>{console.error("Location error:",e);const t=y(i.LOCATION),r=y(i.SITE);if(t&&r){E(t),T(r),o.current&&M&&(N(t.lat,t.lng),S(t.lat,t.lng,r)),f(!1);return}let n="Unable to retrieve your location. ";switch(e.code){case e.PERMISSION_DENIED:n+="Please enable location permissions.";break;case e.POSITION_UNAVAILABLE:n+="Location information is unavailable.";break;case e.TIMEOUT:n+="Location request timed out.";break;default:n+="Please ensure location permissions are enabled."}F(n),f(!1)},{enableHighAccuracy:!0,trackUserLocation:!0,showUserHeading:!0,timeout:2e4,maximumAge:6e4})},clearRoute:x,clearMarkers:U,stopTracking:D}};export{ve as default};
