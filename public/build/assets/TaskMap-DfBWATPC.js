import{r as T,j as e}from"./app-Dp-W5Iv5.js";import"./mapbox-gl-D4Caqtxm.js";import{I as X,a as Y,b as Z,c as G}from"./index-Bz_fbSBh.js";import{useTaskMap as O}from"./useTaskMap-BnFDAsEH.js";import ee from"./CompletionReportModal-BnuVHmfn.js";/* empty css                  */import"./iconBase-BjpKKBDg.js";import"./useLocationTracking-BWcQ5-Tc.js";import"./useMapboxSetup-cXO52C8o.js";import"./useMapLayers-DQK5X4Sb.js";import"./index-Ce4MgMr-.js";import"./can-3MqaZyCZ.js";import"./useRouteCalculations-DTAtalU0.js";import"./useSiteManagement-B4y5wiBy.js";const Pe=T.forwardRef(({mapboxKey:s,scheduleId:t,onTaskComplete:a,onTaskCancel:l,autoGetLocation:n=!1},i)=>{const{mapContainer:o,siteMarkersRef:d,cssLoaded:c,siteLocations:r,stationLocation:f,mapInitialized:m,activeSchedule:u,routeCoordinates:de,loading:b,currentLocation:p,routeInfo:P,mapError:N,customStyleLoaded:me,aiOptimizedRoute:v,nearestSiteToStation:xe,isMobile:g,showAIPanel:S,showControls:L,optimizedSiteOrder:y,isOnline:he,locationAccuracy:ue,lastLocationUpdate:pe,completedSites:j,currentSiteIndex:w,isTaskActive:C,isFakeLocationActive:A,showCompletionModal:ge,setShowCompletionModal:je,formatDuration:fe,getCurrentLocation:k,getAIOptimizedRoute:E,setShowAIPanel:z,setShowControls:$,startRealtimeLocationTracking:B,stopRealtimeLocationTracking:D,updateLocationManually:_,resetCompletedSites:I,markSiteAsCompleted:H,startTaskAndBroadcast:M,completeTaskAndBroadcast:R,sendLocationToReverb:be,startFakeLocationTest:U,stopFakeLocationTest:V,sendTestLocation:q,simulateRouteFollowing:J}=O({mapboxKey:s,scheduleId:t,onTaskComplete:a,onTaskCancel:l});T.useImperativeHandle(i,()=>({getCurrentLocation:()=>{k()},fitMapToRoute:()=>{console.log("Fit map to route function called")},startRealtimeLocationTracking:()=>{B()},stopRealtimeLocationTracking:()=>{D()},updateLocationManually:(h,x)=>{_(h,x)},resetCompletedSites:()=>{I()},markSiteAsCompleted:h=>{const x=r.find(W=>W.id===h);x&&H(x)},startTaskAndBroadcast:()=>{M()},completeTaskAndBroadcast:()=>{R()},startFakeLocationTest:()=>{U()},stopFakeLocationTest:()=>{V()},sendTestLocation:(h,x)=>{q(h,x)},simulateRouteFollowing:()=>{J()}})),T.useEffect(()=>{n&&!p&&!b&&m&&(console.log("Auto-getting location on component mount"),k())},[n,p,b,m]);const K=()=>{R()},Q=()=>{M()};return e.jsxs("div",{className:"relative w-full h-full bg-white",children:[b&&e.jsx(se,{}),N&&e.jsx(te,{error:N}),!c&&!N&&e.jsx(ae,{}),g&&e.jsx(le,{showControls:L,setShowControls:$,siteLocations:r,currentLocation:p,completedSites:j,currentSiteIndex:w,optimizedSiteOrder:y,isTaskActive:C,isFakeLocationActive:A}),v&&e.jsx(ne,{aiOptimizedRoute:v,isMobile:g,showAIPanel:S,setShowAIPanel:z,completedSites:j,currentSiteIndex:w,optimizedSiteOrder:y}),e.jsx(re,{isMobile:g,showControls:L,getAIOptimizedRoute:E,getCurrentLocation:k,onTaskComplete:K,onTaskCancel:l,onTaskStart:Q,scheduleId:t,currentLocation:p,completedSites:j,resetCompletedSites:I,activeSchedule:u,isTaskActive:C}),!1,u&&e.jsx(ce,{activeSchedule:u,siteLocations:r,routeInfo:P,isMobile:g,aiOptimizedRoute:v,setShowAIPanel:z,completedSites:j,currentSiteIndex:w,optimizedSiteOrder:y,isTaskActive:C,isFakeLocationActive:A}),e.jsx("div",{ref:o,className:"w-full h-full absolute inset-0",style:{width:"100%",height:"100%",minHeight:"400px"}})]})}),se=()=>e.jsx("div",{className:"absolute inset-0 bg-white bg-opacity-80 flex items-center justify-center z-50",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-3"}),e.jsx("p",{className:"text-sm text-gray-600 font-medium",children:"AI analyzing optimal route..."}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Finding fastest path to nearest site"})]})}),te=({error:s})=>e.jsx("div",{className:"absolute inset-0 bg-white flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"text-center p-6 bg-white rounded-lg shadow-xl max-w-sm",children:[e.jsx("div",{className:"text-red-500 text-lg font-semibold mb-2",children:"Map Error"}),e.jsx("div",{className:"text-gray-600 mb-4 text-sm",children:s}),e.jsx("button",{onClick:()=>window.location.reload(),className:"bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors font-medium text-sm",children:"Retry"})]})}),ae=()=>e.jsx("div",{className:"absolute inset-0 bg-white flex items-center justify-center z-40",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-3"}),e.jsx("p",{className:"text-sm text-gray-600 font-medium",children:"Loading map..."})]})}),le=({showControls:s,setShowControls:t,siteLocations:a,currentLocation:l,completedSites:n,currentSiteIndex:i,optimizedSiteOrder:o,isTaskActive:d,isFakeLocationActive:c})=>{var r;return e.jsx("div",{className:"absolute top-0 left-0 right-0 z-30 bg-white/95 backdrop-blur-sm border-b border-gray-200 px-4 py-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:()=>t(!s),className:"p-2 rounded-lg bg-gray-100 hover:bg-gray-200 transition-colors",children:s?e.jsx(X,{className:"w-5 h-5"}):e.jsx(Y,{className:"w-5 h-5"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"font-semibold text-gray-900 text-sm",children:"Collection Route"}),e.jsxs("p",{className:"text-xs text-gray-600",children:[n.size,"/",a.length," sites completed"]}),i<o.length&&e.jsxs("p",{className:"text-xs text-blue-600 font-medium",children:["Next: ",(r=o[i])==null?void 0:r.site_name]}),d&&e.jsx("p",{className:"text-xs text-green-600 font-medium",children:"ðŸ”´ Live - Broadcasting to residents"}),c&&e.jsx("p",{className:"text-xs text-purple-600 font-medium",children:"ðŸ§ª Fake Location Test Active"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[l&&e.jsx("div",{className:"w-3 h-3 bg-green-500 rounded-full animate-pulse"}),n.size>0&&e.jsxs("div",{className:"text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full",children:[n.size," done"]}),c&&e.jsx("div",{className:"text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded-full",children:"Testing"})]})]})})},ne=({aiOptimizedRoute:s,isMobile:t,showAIPanel:a,setShowAIPanel:l,completedSites:n,currentSiteIndex:i,optimizedSiteOrder:o})=>t?e.jsx("div",{className:`absolute bottom-0 left-0 right-0 z-40 bg-white border-t border-gray-200 rounded-t-2xl shadow-2xl transition-transform duration-300 ${a?"transform translate-y-0":"transform translate-y-full"}`,children:e.jsx(oe,{aiOptimizedRoute:s,setShowAIPanel:l,completedSites:n,currentSiteIndex:i,optimizedSiteOrder:o})}):e.jsx("div",{className:"absolute top-4 left-4 z-20 bg-green-50 border border-green-200 rounded-lg p-4 shadow-lg max-w-sm",children:e.jsx(ie,{aiOptimizedRoute:s,completedSites:n,currentSiteIndex:i,optimizedSiteOrder:o})}),oe=({aiOptimizedRoute:s,setShowAIPanel:t,completedSites:a,currentSiteIndex:l,optimizedSiteOrder:n})=>e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex justify-center pt-3 pb-2",children:e.jsx("div",{className:"w-12 h-1 bg-gray-300 rounded-full"})}),e.jsx("button",{onClick:()=>t(!1),className:"absolute top-3 right-4 p-1 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors",children:e.jsx(Z,{className:"w-4 h-4 text-gray-600"})}),e.jsx("div",{className:"p-4 max-h-64 overflow-y-auto",children:e.jsx(F,{aiOptimizedRoute:s,completedSites:a,currentSiteIndex:l,optimizedSiteOrder:n})})]}),ie=({aiOptimizedRoute:s,completedSites:t,currentSiteIndex:a,optimizedSiteOrder:l})=>e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(G,{className:"w-5 h-5 text-green-600"}),e.jsx("h3",{className:"font-semibold text-green-800",children:"AI Route Optimized"}),t.size>0&&e.jsxs("span",{className:"bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full",children:[t.size," completed"]})]}),e.jsx(F,{aiOptimizedRoute:s,completedSites:t,currentSiteIndex:a,optimizedSiteOrder:l})]}),F=({aiOptimizedRoute:s,completedSites:t,currentSiteIndex:a,optimizedSiteOrder:l})=>{var n;return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Current Target:"}),e.jsx("span",{className:"font-semibold",children:((n=l[a])==null?void 0:n.site_name)||s.nearestSite.site_name})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Progress:"}),e.jsxs("span",{className:"font-semibold",children:[t.size,"/",l.length," sites"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Distance:"}),e.jsxs("span",{className:"font-semibold",children:[s.distance," km"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Est. Time:"}),e.jsx("span",{className:"font-semibold",children:s.formattedDuration})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Traffic:"}),e.jsx("span",{className:`font-semibold ${s.trafficConditions.conditions==="heavy"?"text-red-600":s.trafficConditions.conditions==="moderate"?"text-yellow-600":"text-green-600"}`,children:s.trafficConditions.conditions})]})]}),e.jsxs("div",{className:"mt-3 p-2 bg-white rounded border",children:[e.jsx("p",{className:"text-xs text-gray-700",children:s.recommendation.text}),e.jsxs("p",{className:"text-xs text-blue-600 mt-1",children:["ðŸ’¡ ",s.recommendation.suggestedAction]}),t.size>0&&e.jsxs("p",{className:"text-xs text-green-600 mt-2 font-medium",children:["âœ… ",t.size," site(s) completed"]})]})]})},re=({isMobile:s,showControls:t,getAIOptimizedRoute:a,getCurrentLocation:l,onTaskComplete:n,onTaskCancel:i,onTaskStart:o,scheduleId:d,currentLocation:c,completedSites:r,resetCompletedSites:f,activeSchedule:m,isTaskActive:u})=>e.jsx("div",{className:`absolute ${s?"top-16":"top-4"} right-4 z-10 flex flex-col gap-3 transition-all duration-300 ${s&&!t?"opacity-0 pointer-events-none":"opacity-100"}`}),ce=({activeSchedule:s,siteLocations:t,routeInfo:a,isMobile:l,aiOptimizedRoute:n,setShowAIPanel:i,completedSites:o,currentSiteIndex:d,optimizedSiteOrder:c,isTaskActive:r,isFakeLocationActive:f})=>{var m;return e.jsxs("div",{className:`absolute ${l?"bottom-20 left-4 right-4":"bottom-4 left-4"} z-10 bg-white/95 backdrop-blur-sm p-3 rounded-lg shadow-lg ${l?"max-w-full":"max-w-xs"}`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"text-sm font-medium text-gray-900",children:[e.jsx("span",{className:"text-blue-600 font-bold",children:t.length})," sites to collect"]}),o.size>0&&e.jsxs("div",{className:"text-xs text-green-600 font-medium",children:[o.size," completed â€¢ ",t.length-o.size," remaining"]}),d<c.length&&e.jsxs("div",{className:"text-xs text-blue-600",children:["Current: ",(m=c[d])==null?void 0:m.site_name]}),r&&e.jsxs("div",{className:"text-xs text-green-600 font-medium flex items-center gap-1",children:[e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-pulse"}),"Live - Residents can see your location"]}),f&&e.jsxs("div",{className:"text-xs text-purple-600 font-medium flex items-center gap-1",children:[e.jsx("div",{className:"w-2 h-2 bg-purple-500 rounded-full animate-pulse"}),"Testing Mode - Fake locations active"]})]}),a&&e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-xs text-gray-600",children:[e.jsx("span",{className:"font-medium",children:a.formattedDuration})," â€¢",e.jsxs("span",{className:"font-medium",children:[" ",a.distance," km"]})]}),a.toSite&&e.jsxs("div",{className:"text-xs text-gray-500",children:["To: ",a.toSite]}),a.recalculated&&e.jsx("div",{className:"text-xs text-orange-600 font-medium",children:"Route Recalculated"}),l&&n&&e.jsx("button",{onClick:()=>i(!0),className:"text-xs text-blue-600 font-medium mt-1",children:"View AI Route"})]})]}),o.size>0&&e.jsxs("div",{className:"mt-2",children:[e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2",children:e.jsx("div",{className:"bg-green-500 h-2 rounded-full transition-all duration-300",style:{width:`${o.size/t.length*100}%`}})}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1 text-center",children:[Math.round(o.size/t.length*100),"% complete"]})]}),e.jsx(ee,{isOpen:showCompletionModal,onClose:()=>setShowCompletionModal(!1),scheduleId,scheduleName:(s==null?void 0:s.barangay_name)||"Collection Schedule",onSubmitSuccess:()=>{setShowCompletionModal(!1),onTaskComplete&&onTaskComplete(null,!0)}})]})};export{Pe as default};
