import{r as C,j as e}from"./app-CaiA3wOq.js";import"./mapbox-gl-iqvqYPZ_.js";import{I as S,a as ee,b as se,c as te}from"./index-CUWxQir8.js";import{useTaskMap as ae}from"./useTaskMap-CBcg2WYz.js";import le from"./CompletionReportModal-Bowd1fQj.js";import{g as f}from"./useSiteManagement-DQbWAMw6.js";/* empty css                  */import"./iconBase-BdlJZVzg.js";import"./useLocationTracking-vhXRMXEF.js";import"./useMapboxSetup-PJvmYJlS.js";import"./useMapLayers-DnIVpLyw.js";import"./index-BgchoCRf.js";import"./can-3MqaZyCZ.js";import"./useRouteCalculations-D5hgOzP8.js";const Pe=C.forwardRef(({mapboxKey:s,scheduleId:t,onTaskComplete:a,onTaskCancel:l,autoGetLocation:i=!1},r)=>{const{mapContainer:n,siteMarkersRef:d,cssLoaded:o,siteLocations:x,stationLocation:j,mapInitialized:b,activeSchedule:c,routeCoordinates:he,loading:N,currentLocation:u,routeInfo:D,mapError:$,customStyleLoaded:ue,aiOptimizedRoute:v,nearestSiteToStation:ge,isMobile:g,showAIPanel:B,showControls:L,optimizedSiteOrder:y,isOnline:pe,offlineMode:E,locationAccuracy:fe,lastLocationUpdate:je,completedSites:p,currentSiteIndex:w,isTaskActive:k,isFakeLocationActive:A,showCompletionModal:H,setShowCompletionModal:z,formatDuration:be,getCurrentLocation:T,getAIOptimizedRoute:U,setShowAIPanel:M,setShowControls:V,startRealtimeLocationTracking:_,stopRealtimeLocationTracking:q,updateLocationManually:J,resetCompletedSites:R,markSiteAsCompleted:K,startTaskAndBroadcast:F,completeTaskAndBroadcast:I,sendLocationToReverb:Ne,startFakeLocationTest:Q,stopFakeLocationTest:W,sendTestLocation:X,simulateRouteFollowing:Y}=ae({mapboxKey:s,scheduleId:t,onTaskComplete:a,onTaskCancel:l});C.useImperativeHandle(r,()=>({getCurrentLocation:()=>{T()},fitMapToRoute:()=>{},startRealtimeLocationTracking:()=>{_()},stopRealtimeLocationTracking:()=>{q()},updateLocationManually:(h,m)=>{J(h,m)},resetCompletedSites:()=>{R()},markSiteAsCompleted:h=>{const m=x.find(O=>O.id===h);m&&K(m)},startTaskAndBroadcast:()=>{F()},completeTaskAndBroadcast:()=>{I()},startFakeLocationTest:()=>{Q()},stopFakeLocationTest:()=>{W()},sendTestLocation:(h,m)=>{X(h,m)},simulateRouteFollowing:()=>{Y()}})),C.useEffect(()=>{i&&!u&&!N&&b&&T()},[i,u,N,b]);const Z=()=>{I()},G=()=>{F()};return e.jsxs("div",{className:"relative w-full h-full bg-white",children:[N&&e.jsx(ne,{}),!o&&!$&&e.jsx(ie,{}),E&&e.jsxs("div",{className:"absolute top-0 left-0 right-0 bg-yellow-500 text-black px-4 py-2 z-50 flex items-center justify-center gap-2 shadow-lg",children:[e.jsx(S,{className:"w-5 h-5"}),e.jsx("span",{className:"font-semibold text-sm",children:"Offline Mode - Using cached map data"})]}),g&&e.jsx(re,{showControls:L,setShowControls:V,siteLocations:x,currentLocation:u,completedSites:p,currentSiteIndex:w,optimizedSiteOrder:y,isTaskActive:k,isFakeLocationActive:A}),v&&e.jsx(oe,{aiOptimizedRoute:v,isMobile:g,showAIPanel:B,setShowAIPanel:M,completedSites:p,currentSiteIndex:w,optimizedSiteOrder:y}),e.jsx(xe,{isMobile:g,showControls:L,getAIOptimizedRoute:U,getCurrentLocation:T,onTaskComplete:Z,onTaskCancel:l,onTaskStart:G,scheduleId:t,currentLocation:u,completedSites:p,resetCompletedSites:R,activeSchedule:c,isTaskActive:k}),!1,c&&e.jsx(me,{activeSchedule:c,siteLocations:x,routeInfo:D,isMobile:g,aiOptimizedRoute:v,setShowAIPanel:M,completedSites:p,currentSiteIndex:w,optimizedSiteOrder:y,isTaskActive:k,isFakeLocationActive:A}),e.jsx("div",{ref:n,className:"w-full h-full absolute inset-0",style:{width:"100%",height:"100%",minHeight:"400px"}}),e.jsx(le,{isOpen:H,onClose:()=>z(!1),scheduleId:t,scheduleName:(c==null?void 0:c.barangay_name)||"Collection Schedule",onSubmitSuccess:()=>{z(!1),a&&a(null,!0)}})]})}),ne=()=>e.jsx("div",{className:"absolute inset-0 bg-white bg-opacity-80 flex items-center justify-center z-50",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-3"}),e.jsx("p",{className:"text-sm text-gray-600 font-medium",children:"AI analyzing optimal route..."}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Finding fastest path to nearest site"})]})}),ie=()=>e.jsx("div",{className:"absolute inset-0 bg-white flex items-center justify-center z-40",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-3"}),e.jsx("p",{className:"text-sm text-gray-600 font-medium",children:"Loading map..."})]})}),re=({showControls:s,setShowControls:t,siteLocations:a,currentLocation:l,completedSites:i,currentSiteIndex:r,optimizedSiteOrder:n,isTaskActive:d,isFakeLocationActive:o})=>e.jsx("div",{className:"absolute top-0 left-0 right-0 z-30 bg-white/95 backdrop-blur-sm border-b border-gray-200 px-4 py-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:()=>t(!s),className:"p-2 rounded-lg bg-gray-100 hover:bg-gray-200 transition-colors",children:s?e.jsx(ee,{className:"w-5 h-5"}):e.jsx(se,{className:"w-5 h-5"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"font-semibold text-gray-900 text-sm",children:"Collection Route"}),e.jsxs("p",{className:"text-xs text-gray-600",children:[i.size,"/",a.length," sites completed"]}),r<n.length&&e.jsxs("p",{className:"text-xs text-blue-600 font-medium",children:["Next: ",f(n[r])]}),d&&e.jsx("p",{className:"text-xs text-green-600 font-medium",children:"ðŸ”´ Live - Broadcasting to residents"}),o&&e.jsx("p",{className:"text-xs text-purple-600 font-medium",children:"ðŸ§ª Fake Location Test Active"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[l&&e.jsx("div",{className:"w-3 h-3 bg-green-500 rounded-full animate-pulse"}),i.size>0&&e.jsxs("div",{className:"text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full",children:[i.size," done"]}),o&&e.jsx("div",{className:"text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded-full",children:"Testing"})]})]})}),oe=({aiOptimizedRoute:s,isMobile:t,showAIPanel:a,setShowAIPanel:l,completedSites:i,currentSiteIndex:r,optimizedSiteOrder:n})=>t?e.jsx("div",{className:`absolute bottom-0 left-0 right-0 z-40 bg-white border-t border-gray-200 rounded-t-2xl shadow-2xl transition-transform duration-300 ${a?"transform translate-y-0":"transform translate-y-full"}`,children:e.jsx(ce,{aiOptimizedRoute:s,setShowAIPanel:l,completedSites:i,currentSiteIndex:r,optimizedSiteOrder:n})}):e.jsx("div",{className:"absolute top-4 left-4 z-20 bg-green-50 border border-green-200 rounded-lg p-4 shadow-lg max-w-sm",children:e.jsx(de,{aiOptimizedRoute:s,completedSites:i,currentSiteIndex:r,optimizedSiteOrder:n})}),ce=({aiOptimizedRoute:s,setShowAIPanel:t,completedSites:a,currentSiteIndex:l,optimizedSiteOrder:i})=>e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex justify-center pt-3 pb-2",children:e.jsx("div",{className:"w-12 h-1 bg-gray-300 rounded-full"})}),e.jsx("button",{onClick:()=>t(!1),className:"absolute top-3 right-4 p-1 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors",children:e.jsx(S,{className:"w-4 h-4 text-gray-600"})}),e.jsx("div",{className:"p-4 max-h-64 overflow-y-auto",children:e.jsx(P,{aiOptimizedRoute:s,completedSites:a,currentSiteIndex:l,optimizedSiteOrder:i})})]}),de=({aiOptimizedRoute:s,completedSites:t,currentSiteIndex:a,optimizedSiteOrder:l})=>e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(te,{className:"w-5 h-5 text-green-600"}),e.jsx("h3",{className:"font-semibold text-green-800",children:"AI Route Optimized"}),t.size>0&&e.jsxs("span",{className:"bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full",children:[t.size," completed"]})]}),e.jsx(P,{aiOptimizedRoute:s,completedSites:t,currentSiteIndex:a,optimizedSiteOrder:l})]}),P=({aiOptimizedRoute:s,completedSites:t,currentSiteIndex:a,optimizedSiteOrder:l})=>e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Current Target:"}),e.jsx("span",{className:"font-semibold",children:f(l[a])||f(s.nearestSite)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Progress:"}),e.jsxs("span",{className:"font-semibold",children:[t.size,"/",l.length," sites"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Distance:"}),e.jsxs("span",{className:"font-semibold",children:[s.distance," km"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Est. Time:"}),e.jsx("span",{className:"font-semibold",children:s.formattedDuration})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Traffic:"}),e.jsx("span",{className:`font-semibold ${s.trafficConditions.conditions==="heavy"?"text-red-600":s.trafficConditions.conditions==="moderate"?"text-yellow-600":"text-green-600"}`,children:s.trafficConditions.conditions})]})]}),e.jsxs("div",{className:"mt-3 p-2 bg-white rounded border",children:[e.jsx("p",{className:"text-xs text-gray-700",children:s.recommendation.text}),e.jsxs("p",{className:"text-xs text-blue-600 mt-1",children:["ðŸ’¡ ",s.recommendation.suggestedAction]}),t.size>0&&e.jsxs("p",{className:"text-xs text-green-600 mt-2 font-medium",children:["âœ… ",t.size," site(s) completed"]})]})]}),xe=({isMobile:s,showControls:t,getAIOptimizedRoute:a,getCurrentLocation:l,onTaskComplete:i,onTaskCancel:r,onTaskStart:n,scheduleId:d,currentLocation:o,completedSites:x,resetCompletedSites:j,activeSchedule:b,isTaskActive:c})=>e.jsx("div",{className:`absolute ${s?"top-16":"top-4"} right-4 z-10 flex flex-col gap-3 transition-all duration-300 ${s&&!t?"opacity-0 pointer-events-none":"opacity-100"}`}),me=({activeSchedule:s,siteLocations:t,routeInfo:a,isMobile:l,aiOptimizedRoute:i,setShowAIPanel:r,completedSites:n,currentSiteIndex:d,optimizedSiteOrder:o,isTaskActive:x,isFakeLocationActive:j})=>e.jsxs("div",{className:`absolute ${l?"bottom-20 left-4 right-4":"bottom-4 left-4"} z-10 bg-white/95 backdrop-blur-sm p-3 rounded-lg shadow-lg ${l?"max-w-full":"max-w-xs"}`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"text-sm font-medium text-gray-900",children:[e.jsx("span",{className:"text-blue-600 font-bold",children:t.length})," sites to collect"]}),n.size>0&&e.jsxs("div",{className:"text-xs text-green-600 font-medium",children:[n.size," completed â€¢ ",t.length-n.size," remaining"]}),d<o.length&&e.jsxs("div",{className:"text-xs text-blue-600",children:["Current: ",f(o[d])]}),x&&e.jsxs("div",{className:"text-xs text-green-600 font-medium flex items-center gap-1",children:[e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-pulse"}),"Live - Residents can see your location"]}),j&&e.jsxs("div",{className:"text-xs text-purple-600 font-medium flex items-center gap-1",children:[e.jsx("div",{className:"w-2 h-2 bg-purple-500 rounded-full animate-pulse"}),"Testing Mode - Fake locations active"]})]}),a&&e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-xs text-gray-600",children:[e.jsx("span",{className:"font-medium",children:a.formattedDuration})," â€¢",e.jsxs("span",{className:"font-medium",children:[" ",a.distance," km"]})]}),a.toSite&&e.jsxs("div",{className:"text-xs text-gray-500",children:["To: ",a.toSite]}),a.recalculated&&e.jsx("div",{className:"text-xs text-orange-600 font-medium",children:"Route Recalculated"}),l&&i&&e.jsx("button",{onClick:()=>r(!0),className:"text-xs text-blue-600 font-medium mt-1",children:"View AI Route"})]})]}),n.size>0&&e.jsxs("div",{className:"mt-2",children:[e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2",children:e.jsx("div",{className:"bg-green-500 h-2 rounded-full transition-all duration-300",style:{width:`${n.size/t.length*100}%`}})}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1 text-center",children:[Math.round(n.size/t.length*100),"% complete"]})]})]});export{Pe as default};
