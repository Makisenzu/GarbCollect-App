import{j as e,r as u,a as I,i as st,g as Le}from"./app-hBFkVOqz.js";import{a as C}from"./mapbox-gl-74b6tMDi.js";import{h as at,i as nt,j as ot,g as it}from"./index-BGYiXCV7.js";import"./iconBase-DjK8tALs.js";const lt=({isLoading:w=!1,size:j="medium",message:T="Collecting garbage..."})=>{if(!w)return null;const p={small:"w-16 h-16",medium:"w-24 h-24",large:"w-32 h-32",xlarge:"w-48 h-48"},F={small:"text-xs",medium:"text-sm",large:"text-base",xlarge:"text-lg"};return e.jsxs("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:[e.jsxs("div",{className:"bg-white rounded-2xl p-8 shadow-2xl flex flex-col items-center",children:[e.jsxs("div",{className:`relative ${p[j]} mb-4`,children:[e.jsx("div",{className:"absolute bottom-0 left-0 right-0 h-2 bg-gray-600 rounded-full"}),e.jsx("div",{className:"absolute bottom-3 left-4 w-3 h-4 bg-gray-400 rounded-sm",children:e.jsx("div",{className:"absolute -top-1 left-0.5 w-2 h-1 bg-gray-500 rounded-sm"})}),e.jsx("div",{className:"absolute bottom-3 left-8 w-3 h-5 bg-gray-400 rounded-sm",children:e.jsx("div",{className:"absolute -top-1 left-0.5 w-2 h-1 bg-gray-500 rounded-sm"})}),e.jsx("div",{className:"absolute bottom-3 left-12 w-3 h-4 bg-gray-400 rounded-sm",children:e.jsx("div",{className:"absolute -top-1 left-0.5 w-2 h-1 bg-gray-500 rounded-sm"})}),e.jsx("div",{className:"absolute bottom-2 left-0 animate-collect-garbage",children:e.jsxs("div",{className:"relative",children:[e.jsxs("div",{className:"w-6 h-4 bg-green-600 rounded-t-sm",children:[e.jsx("div",{className:"absolute top-0.5 left-1 w-3 h-1.5 bg-blue-300 rounded-sm"}),e.jsx("div",{className:"absolute bottom-0 left-1 w-1 h-0.5 bg-yellow-300 rounded-full"})]}),e.jsx("div",{className:"absolute left-6 top-1 w-8 h-3 bg-green-700 rounded-sm",children:e.jsx("div",{className:"absolute top-0.5 left-1 w-6 h-2 bg-gray-800 rounded",children:e.jsx("div",{className:"absolute -top-1 left-0 right-0 h-1 bg-gray-700 rounded-t animate-garbage-fill"})})}),e.jsx("div",{className:"absolute -bottom-1 left-1 w-2 h-2 bg-black rounded-full",children:e.jsx("div",{className:"absolute inset-0.5 w-1 h-1 bg-gray-600 rounded-full"})}),e.jsx("div",{className:"absolute -bottom-1 left-5 w-2 h-2 bg-black rounded-full",children:e.jsx("div",{className:"absolute inset-0.5 w-1 h-1 bg-gray-600 rounded-full"})}),e.jsx("div",{className:"absolute -bottom-1 left-11 w-2 h-2 bg-black rounded-full",children:e.jsx("div",{className:"absolute inset-0.5 w-1 h-1 bg-gray-600 rounded-full"})})]})}),e.jsx("div",{className:"absolute bottom-3 left-16 w-4 h-1 bg-gray-400 rounded-full animate-dust-cloud opacity-0"})]}),e.jsx("div",{className:`text-center ${F[j]} text-gray-700 font-semibold`,children:T}),e.jsxs("div",{className:"flex space-x-1 mt-2",children:[e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-bounce",style:{animationDelay:"0ms"}}),e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-bounce",style:{animationDelay:"150ms"}}),e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-bounce",style:{animationDelay:"300ms"}})]})]}),e.jsx("style",{jsx:!0,children:`
        @keyframes collect-garbage {
          0% {
            transform: translateX(-20px);
          }
          20% {
            transform: translateX(40px);
          }
          40% {
            transform: translateX(80px);
          }
          60% {
            transform: translateX(120px);
          }
          80% {
            transform: translateX(160px);
          }
          100% {
            transform: translateX(200px);
          }
        }
        
        @keyframes garbage-fill {
          0%, 20% {
            height: 0px;
            opacity: 0;
          }
          25% {
            height: 1px;
            opacity: 1;
          }
          40% {
            height: 2px;
            opacity: 1;
          }
          60% {
            height: 3px;
            opacity: 1;
          }
          80% {
            height: 4px;
            opacity: 1;
          }
          100% {
            height: 4px;
            opacity: 0;
          }
        }
        
        @keyframes dust-cloud {
          0%, 60% {
            opacity: 0;
            transform: scale(0.5);
          }
          70% {
            opacity: 0.8;
            transform: scale(1);
          }
          80% {
            opacity: 0.6;
            transform: scale(1.2);
          }
          90% {
            opacity: 0.4;
            transform: scale(1.4);
          }
          100% {
            opacity: 0;
            transform: scale(1.6);
          }
        }
        
        .animate-collect-garbage {
          animation: collect-garbage 4s ease-in-out infinite;
        }
        
        .animate-garbage-fill {
          animation: garbage-fill 4s ease-in-out infinite;
        }
        
        .animate-dust-cloud {
          animation: dust-cloud 4s ease-in-out infinite;
        }
      `})]})},xt=({mapboxKey:w,barangayId:j,scheduleId:T,isFullscreen:p=!1})=>{const F=u.useRef(null),d=u.useRef(null),[B,O]=u.useState(!1),[h,z]=u.useState(!1),[S,de]=u.useState(null),[g,Me]=u.useState(null),[ue,Re]=u.useState(null),[x,q]=u.useState([]),[K,Te]=u.useState([]),[fe,ee]=u.useState(navigator.onLine),[ct,me]=u.useState(!0),[H,D]=u.useState("connecting"),[dt,P]=u.useState(null),[W,Ee]=u.useState(!1),[X,A]=u.useState(!1),[Ce,he]=u.useState(!1),[Fe,ze]=u.useState("Loading map data..."),[ge,pe]=u.useState(!0),V=(t="Loading map data...")=>{ge&&(ze(t),he(!0))},E=()=>{ge&&he(!1)},[N,Z]=u.useState([]),[f,G]=u.useState(null),[k,De]=u.useState([]),[L,Pe]=u.useState(null),[y,_e]=u.useState(null),[l,Ie]=u.useState(!1),[U,xe]=u.useState(!0),[te,ve]=u.useState(!1),[be,re]=u.useState(null),[b,ut]=u.useState(!0),_=u.useRef(null),se=u.useRef(null),[Ue,Be]=u.useState(Date.now()),Oe=()=>Date.now()-Ue<3e4,[we,qe]=u.useState({width:typeof window<"u"?window.innerWidth:1200,height:typeof window<"u"?window.innerHeight:800});u.useEffect(()=>{if(!d.current)return;const t=["mousedown","touchstart","wheel","movestart","dragstart"],r=()=>{Be(Date.now())};return t.forEach(s=>{d.current.on(s,r)}),()=>{t.forEach(s=>{d.current&&d.current.off(s,r)})}},[d.current]),u.useEffect(()=>{const t=()=>{const r=window.innerWidth<768;Ie(r),qe({width:window.innerWidth,height:window.innerHeight}),r&&xe(!1)};return t(),window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)},[]),u.useEffect(()=>{const t=()=>{ee(!0),A(!1),D("online")},r=()=>{ee(!1),A(!0),D("offline"),P(null)};return ee(navigator.onLine),A(!navigator.onLine),D(navigator.onLine?"online":"offline"),window.addEventListener("online",t),window.addEventListener("offline",r),()=>{window.removeEventListener("online",t),window.removeEventListener("offline",r)}},[]),u.useEffect(()=>{const t=()=>{F.current?Ee(!0):setTimeout(t,100)};t()},[]),u.useEffect(()=>{if((()=>{const o=document.querySelector('link[href*="mapbox-gl.css"]');return o&&o.sheet?(O(!0),!0):!1})())return;const r=document.createElement("link");r.href="https://api.mapbox.com/mapbox-gl-js/v3.0.0/mapbox-gl.css",r.rel="stylesheet",r.type="text/css";let s;const a=()=>{clearTimeout(s),O(!0)},c=()=>{clearTimeout(s),console.warn("Mapbox CSS failed to load, continuing anyway"),O(!0)};r.onload=a,r.onerror=c,document.head.appendChild(r),s=setTimeout(()=>{console.warn("Mapbox CSS load timeout, continuing anyway"),O(!0)},5e3)},[]);const ae=t=>{if(t<60)return`${t} min`;{const r=Math.floor(t/60),s=t%60;return s===0?`${r}h`:`${r}h ${s}min`}},J=(t,r,s,a)=>{const o=(s-t)*Math.PI/180,n=(a-r)*Math.PI/180,i=Math.sin(o/2)*Math.sin(o/2)+Math.cos(t*Math.PI/180)*Math.cos(s*Math.PI/180)*Math.sin(n/2)*Math.sin(n/2);return 6371*(2*Math.atan2(Math.sqrt(i),Math.sqrt(1-i)))},He=(t,r)=>{if(!t||r.length===0)return r;const s=[...r],a=[],c=s.map(m=>{const v=J(parseFloat(t.latitude),parseFloat(t.longitude),parseFloat(m.latitude),parseFloat(m.longitude));return{...m,distance:v,coordinates:[parseFloat(m.longitude),parseFloat(m.latitude)]}});c.sort((m,v)=>m.distance-v.distance);const o=c[0];a.push(o);const n=c.slice(1);let i=o;for(;n.length>0;){let m=-1,v=1/0;for(let $=0;$<n.length;$++){const R=J(parseFloat(i.latitude),parseFloat(i.longitude),parseFloat(n[$].latitude),parseFloat(n[$].longitude));R<v&&(v=R,m=$)}m!==-1&&(i=n[m],a.push(i),n.splice(m,1))}return a},Q=async(t,r,s=!1,a=!1)=>{if(!w||t.length<1)return;if(t.filter(o=>o.type!=="station"&&o.status!=="finished"&&o.status!=="completed").length===0){r&&await ye(t,r,a);return}a||(ve(!0),V("Calculating optimal route...")),re(null);try{const o=t.filter(i=>i.latitude&&i.longitude&&!isNaN(parseFloat(i.latitude))&&!isNaN(parseFloat(i.longitude))&&i.type!=="station"&&i.status!=="finished"&&i.status!=="completed");if(o.length<1){console.warn("No valid unfinished sites with coordinates found"),re("No valid sites with coordinates found");return}const n=r?He(r,o):o;if(De(n),n.length>0&&Pe(n[0]),s&&g&&n.length>0){const i=[`${g[0].toFixed(6)},${g[1].toFixed(6)}`,...n.map(m=>`${parseFloat(m.longitude).toFixed(6)},${parseFloat(m.latitude).toFixed(6)}`)];try{const m=await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${i.join(";")}?access_token=${w}&geometries=geojson&overview=full&steps=true&alternatives=false&continue_straight=false&roundabout_exits=true`);if(m.ok){const v=await m.json();if(v.routes&&v.routes.length>0){const $=v.routes[0],R=Math.round($.duration/60),Y=($.distance/1e3).toFixed(1);Z($.geometry.coordinates),G({duration:R,formattedDuration:ae(R),distance:Y,targetSite:n[0].site_name,isRealTime:!0,totalStops:n.length}),d.current&&h&&M();return}}}catch(m){console.error("Error calculating driver route:",m)}}await ye(n,r,a)}catch(o){console.error("Error calculating route:",o),re(`Route calculation failed: ${o.message}`);const n=t.filter(i=>i.latitude&&i.longitude&&!isNaN(parseFloat(i.latitude))&&!isNaN(parseFloat(i.longitude))&&i.type!=="station"&&i.status!=="finished"&&i.status!=="completed");if(n.length>0){const i=n.map(m=>[parseFloat(m.longitude),parseFloat(m.latitude)]);Z(i),G({duration:Math.round(je(i)*2),formattedDuration:"Estimated",distance:je(i).toFixed(1),isFallback:!0,totalStops:n.length,isRealTime:!1}),d.current&&h&&M()}}finally{a||(ve(!1),E())}},ye=async(t,r,s=!1)=>{if(!(!w||t.length<1))try{const a=[];if(r&&r.longitude&&r.latitude&&a.push(`${parseFloat(r.longitude).toFixed(6)},${parseFloat(r.latitude).toFixed(6)}`),t.forEach(n=>{n.type!=="station"&&a.push(`${parseFloat(n.longitude).toFixed(6)},${parseFloat(n.latitude).toFixed(6)}`)}),a.length<2){console.warn("Not enough coordinates for station route");return}const c=await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${a.join(";")}?access_token=${w}&geometries=geojson&overview=full&steps=true&alternatives=false&continue_straight=false`+(a.length>2?"&roundabout_exits=true":""));if(!c.ok)throw new Error(`HTTP error! status: ${c.status}`);const o=await c.json();if(o.routes&&o.routes.length>0){const n=o.routes[0],i=Math.round(n.duration/60),m=(n.distance/1e3).toFixed(1);Z(n.geometry.coordinates),G({duration:i,formattedDuration:ae(i),distance:m,totalStops:t.filter(v=>v.type!=="station").length,isRealTime:!1}),d.current&&h&&M()}}catch(a){console.error("Error calculating station route:",a)}},je=t=>{let r=0;for(let s=1;s<t.length;s++){const[a,c]=t[s-1],[o,n]=t[s];r+=J(c,a,n,o)}return r},ne=async()=>{if(!(!b||!g||!k.length)){if(se.current){const[t,r]=se.current,[s,a]=g;if(J(r,t,a,s)*1e3<50)return}se.current=g;try{const t=[`${g[0].toFixed(6)},${g[1].toFixed(6)}`,...k.map(s=>`${parseFloat(s.longitude).toFixed(6)},${parseFloat(s.latitude).toFixed(6)}`)],r=await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${t.join(";")}?access_token=${w}&geometries=geojson&overview=full&steps=true&alternatives=false&continue_straight=false&roundabout_exits=true`);if(r.ok){const s=await r.json();if(s.routes&&s.routes.length>0){const a=s.routes[0],c=Math.round(a.duration/60),o=(a.distance/1e3).toFixed(1);Z(a.geometry.coordinates),G(n=>({...n,duration:c,formattedDuration:ae(c),distance:o,targetSite:k[0].site_name,isRealTime:!0,totalStops:k.length,lastUpdated:new Date().toLocaleTimeString()})),d.current&&h&&M()}}}catch(t){console.error("Error updating real-time route:",t)}}},We=()=>{_.current&&clearInterval(_.current),_.current=setInterval(()=>{b&&g&&k.length>0&&ne()},2e3)},Xe=()=>{_.current&&(clearInterval(_.current),_.current=null)},M=()=>{if(!(!d.current||N.length===0)){if(!d.current.isStyleLoaded()){d.current.once("styledata",()=>{setTimeout(M,100)});return}["route","route-glow","route-direction","route-start","route-end","route-waypoints","driver-route","driver-route-glow"].forEach(t=>{d.current.getLayer(t)&&d.current.removeLayer(t)}),d.current.getSource("route")&&d.current.removeSource("route"),d.current.getSource("driver-route")&&d.current.removeSource("driver-route"),["route-start-marker","route-end-marker","route-waypoints-marker"].forEach(t=>{d.current.getSource(t)&&d.current.removeSource(t)});try{const t=f!=null&&f.isRealTime?"driver-route":"route",r=f!=null&&f.isRealTime?"driver-route":"route",s=f!=null&&f.isRealTime?"driver-route-glow":"route-glow";d.current.addSource(t,{type:"geojson",data:{type:"Feature",properties:{},geometry:{type:"LineString",coordinates:N}}});const a=f!=null&&f.isRealTime?"#000000":"#6B7280",c=l?6:5,o=l?14:12;d.current.addLayer({id:s,type:"line",source:t,layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":a,"line-width":o,"line-opacity":f!=null&&f.isRealTime?.4:.3,"line-blur":10}}),d.current.addLayer({id:r,type:"line",source:t,layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":a,"line-width":c,"line-opacity":.9,"line-dasharray":f!=null&&f.isRealTime?[2,1]:[1,0]}}),d.current.addLayer({id:"route-direction",type:"symbol",source:t,layout:{"symbol-placement":"line","text-field":"‚ñ∂","text-size":l?14:12,"symbol-spacing":100},paint:{"text-color":a}});const n=[];y&&y.latitude&&y.longitude&&!(f!=null&&f.isRealTime)&&n.push({coordinates:[parseFloat(y.longitude),parseFloat(y.latitude)],type:"station",sequence:0}),k.forEach((i,m)=>{i.latitude&&i.longitude&&n.push({coordinates:[parseFloat(i.longitude),parseFloat(i.latitude)],type:"site",sequence:m+1,isTarget:(f==null?void 0:f.isRealTime)&&m===0})}),n.length>0&&(d.current.addSource("route-waypoints-marker",{type:"geojson",data:{type:"FeatureCollection",features:n.map((i,m)=>({type:"Feature",geometry:{type:"Point",coordinates:i.coordinates},properties:{description:i.type==="station"?"Station":i.isTarget?`Target: ${i.sequence}`:`Site ${i.sequence}`,type:i.type,sequence:i.sequence,isTarget:i.isTarget}}))}}),d.current.addLayer({id:"route-waypoints",type:"circle",source:"route-waypoints-marker",paint:{"circle-radius":["case",["==",["get","type"],"station"],l?10:8,["==",["get","isTarget"],!0],l?12:10,l?8:6],"circle-color":["case",["==",["get","type"],"station"],"#dc2626",["==",["get","isTarget"],!0],"#10B981","#3b82f6"],"circle-stroke-width":2,"circle-stroke-color":"#ffffff"}})),!(f!=null&&f.isRealTime)&&N.length>=2&&(d.current.addSource("route-start-marker",{type:"geojson",data:{type:"Feature",geometry:{type:"Point",coordinates:N[0]},properties:{description:"Start"}}}),d.current.addSource("route-end-marker",{type:"geojson",data:{type:"Feature",geometry:{type:"Point",coordinates:N[N.length-1]},properties:{description:"End"}}}),d.current.addLayer({id:"route-start",type:"circle",source:"route-start-marker",paint:{"circle-radius":l?8:6,"circle-color":"#22c55e","circle-stroke-width":2,"circle-stroke-color":"#ffffff"}}),d.current.addLayer({id:"route-end",type:"circle",source:"route-end-marker",paint:{"circle-radius":l?8:6,"circle-color":"#ef4444","circle-stroke-width":2,"circle-stroke-color":"#ffffff"}})),setTimeout(()=>{Se()},200)}catch(t){console.error("Error adding route layer:",t),setTimeout(()=>{M()},500)}}},Se=()=>{if(!d.current||N.length===0||x.length===0)return;const t=new C.LngLatBounds;N.forEach(s=>{t.extend(s)}),y&&t.extend([parseFloat(y.longitude),parseFloat(y.latitude)]),x.forEach(s=>{s.longitude&&s.latitude&&t.extend([parseFloat(s.longitude),parseFloat(s.latitude)])}),g&&t.extend(g);const r=l?40:80;try{d.current.fitBounds(t,{padding:r,duration:1500,essential:!0,maxZoom:l?16:15,offset:[0,l?-50:0]})}catch(s){console.error("Error fitting map to bounds:",s)}},oe=t=>t.find(r=>r.type==="station")||null;u.useEffect(()=>(B&&w&&W&&(()=>{if(F.current&&!d.current){if(!w){P("Mapbox key is missing.");return}V("Initializing map...");try{C.accessToken=w;const r={container:F.current,style:"mapbox://styles/mapbox/streets-v12",center:[125.94849837776422,8.483022468128098],zoom:l?11:10.5,attributionControl:!1,interactive:!0,scrollZoom:!0,dragPan:!0,dragRotate:!1,keyboard:!1,doubleClickZoom:!l,touchZoomRotate:!0,touchPitch:!1,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!0,maxTileCacheSize:50,refreshExpiredTiles:fe,transformRequest:(o,n)=>!fe&&n==="Tile"?{url:o,headers:{"Cache-Control":"max-age=86400"}}:{url:o}};d.current=new C.Map(r);const s=()=>{z(!0),P(null),x.length>0&&$e(x),g&&ce(g,{}),N.length>0&&setTimeout(()=>{M()},500),b&&We(),E()},a=o=>{var n;if(console.error("Map error:",o),!navigator.onLine||X){console.warn("Map error suppressed - continuing in offline mode"),A(!0),P(null),h||z(!0);return}P(`Map error: ${((n=o.error)==null?void 0:n.message)||"Unknown error"}`),z(!0),E()};d.current.once("load",s),d.current.on("error",a),d.current.on("dataloading",o=>{var n;(!navigator.onLine||X)&&((n=o.preventDefault)==null||n.call(o))}),d.current.on("sourcedataloading",o=>{var n;(!navigator.onLine||X)&&((n=o.preventDefault)==null||n.call(o))});const c=setTimeout(()=>{h||(console.warn("Map load timeout - continuing anyway"),z(!0),E())},1e4);return()=>clearTimeout(c)}catch(r){console.error("Error creating map:",r),P(`Failed to create map: ${r.message}`),z(!0),E()}}})(),()=>{Xe(),d.current&&(d.current.remove(),d.current=null,z(!1))}),[B,w,W,l]),u.useEffect(()=>{if(x.length>0&&y&&w&&h){if(x.filter(r=>r.type!=="station"&&r.status!=="finished"&&r.status!=="completed").length===0)return;Q(x,y,b,!0)}},[x,y,w,h]),u.useEffect(()=>{if(b&&g&&k.length>0){const t=setTimeout(()=>{ne()},1e3);return()=>clearTimeout(t)}},[g,b]),u.useEffect(()=>{d.current&&N.length>0&&h&&M()},[N,h]),u.useEffect(()=>{h&&x.length>0&&$e(x)},[h,x,l,b,L]),u.useEffect(()=>{if(!(S!=null&&S.id))return;const t=setInterval(async()=>{try{const r=await I.get(`/schedule/${S.id}/sites`);if(r.data.success){const s=r.data.data;if(s.some((c,o)=>{const n=x.find(i=>i.id===c.id);return n&&n.status!==c.status}))if(q(s),s.filter(o=>o.type!=="station"&&o.status!=="finished"&&o.status!=="completed").length>0){const o=oe(s);o&&h&&setTimeout(()=>{Q(s,o,b&&g,!0)},200)}else console.log("‚ö†Ô∏è All sites finished - no route calculation needed")}}catch(r){console.error("Polling error:",r)}},5e3);return()=>{clearInterval(t)}},[S==null?void 0:S.id,x]),u.useEffect(()=>{h&&g&&ce(g,{})},[h,g,l]),u.useEffect(()=>{if(!j)return;const t=async()=>{try{st();const a=Le();if(!a)throw new Error("Echo not initialized");a.channel(`driver-locations.${j}`).listen("DriverLocationUpdated",c=>{D("connected"),le(c)}),a.channel(`schedule-updates.${j}`).listen("ScheduleStatusUpdated",c=>{Ve(c.schedule)}),a.channel(`site-completion.${j}`).listen("SiteCompletionUpdated",c=>{Ne(c),ie()}),D("connected"),await Ae(),r()}catch(a){console.error("Realtime connection failed:",a),D("disconnected"),r()}},r=()=>{const a=setInterval(()=>{s()},1e4);return()=>clearInterval(a)},s=async()=>{try{if(T){const a=await I.get(`/schedule/${T}/driver-location`);a.data.success&&a.data.data&&le(a.data.data)}}catch(a){console.error("Error polling driver location:",a)}};return t(),()=>{const a=Le();a&&(a.leave(`driver-locations.${j}`),a.leave(`schedule-updates.${j}`),a.leave(`site-completion.${j}`))}},[j,T]);const ie=async(t=!0)=>{try{if(!S||!S.id){console.warn("No current schedule available to refresh sites");return}const r=await I.get(`/schedule/${S.id}/sites`);if(r.data.success){const s=r.data.data;if(q(s),s.filter(c=>c.type!=="station"&&c.status!=="finished"&&c.status!=="completed").length>0){const c=oe(s);c&&h&&setTimeout(()=>{Q(s,c,b&&g,!0)},200)}else console.log("‚ö†Ô∏è All sites finished - no route calculation needed")}}catch(r){console.error("Error refreshing sites from server:",r)}};u.useEffect(()=>{window.testSiteCompletion=t=>{Ne({site_id:t,completed_at:new Date().toISOString()})},window.refreshResidentMap=()=>{ie()}},[x,S]);const Ae=async()=>{try{me(!0),V("Loading collection sites...");const t=await I.get(`/barangay/${j}/current-schedule`);if(t.data.success){const r=t.data.data;if(de(r),r.id){const s=await I.get(`/schedule/${r.id}/sites`);if(s.data.success){const a=s.data.data;q(a);const c=oe(a);c&&_e(c)}}if(T){const s=await I.get(`/schedule/${T}/driver-location`);s.data.success&&s.data.data&&le(s.data.data)}}E(),pe(!1)}catch(t){console.error("Error loading initial data:",t),E(),pe(!1)}finally{me(!1)}},le=t=>{if(!t.longitude||!t.latitude){console.warn("Invalid location data received:",t);return}const r=[parseFloat(t.longitude),parseFloat(t.latitude)];Me(r),h&&d.current&&(ce(r,t),Oe()||d.current.flyTo({center:r,zoom:l?16:15,duration:2e3,essential:!0,offset:[0,l?-100:0]}),b&&ne())},Ne=t=>{q(r=>r.map(a=>a.id===t.site_id||a.id===t.siteId?{...a,status:"finished",collectionStatus:"finished",completed_at:t.completed_at||new Date().toISOString()}:a)),setTimeout(()=>{console.log("üîÑ Refreshing sites from server"),ie()},1e3)},ce=(t,r)=>{if(!d.current||!h)return;ue&&ue.remove();const s=l?"w-12 h-12":"w-10 h-10",a=l?"w-6 h-6":"w-5 h-5",c=document.createElement("div");c.className="driver-location-marker";const n=(r.timestamp?(new Date-new Date(r.timestamp))/1e3:0)<30;c.innerHTML=`
      <div class="relative">
        <div class="${s} bg-blue-600 border-3 border-white rounded-full shadow-lg flex items-center justify-center relative z-10">
          <svg class="${a} text-white" viewBox="0 0 24 24" fill="currentColor">
            <path d="M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z"/>
            <path d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0"/>
          </svg>
          ${n?"":`
            <div class="absolute -top-1 -right-1 w-3 h-3 bg-yellow-500 rounded-full border border-white"></div>
          `}
        </div>
        <div class="absolute inset-0 bg-blue-400 rounded-full animate-ping opacity-30"></div>
        ${r.accuracy?`
          <div class="absolute inset-0 border-2 border-blue-300 rounded-full opacity-50" 
               style="transform: scale(${Math.min(r.accuracy/10,3)})"></div>
        `:""}
      </div>
    `;try{const i=new C.Marker({element:c,draggable:!1}).setLngLat(t).addTo(d.current),m=new C.Popup({offset:25,closeButton:!1,className:`custom-popup ${l?"max-w-xs":"max-w-sm"}`}).setHTML(`
        <div class="text-sm ${l?"p-2":"p-3"}">
          <div class="font-semibold text-gray-900 ${l?"text-base":""}">üöó Driver Location</div>
          <div class="text-xs text-gray-500 mt-1">
            ${r.timestamp?`Updated: ${new Date(r.timestamp).toLocaleTimeString()}`:"Live"}
          </div>
          ${r.accuracy?`
            <div class="text-xs text-gray-500 mt-1">
              Accuracy: ¬±${Math.round(r.accuracy)} meters
            </div>
          `:""}
          ${n?"":`
            <div class="text-xs text-yellow-600 mt-1 font-medium">
              ‚ö†Ô∏è Location data may be delayed
            </div>
          `}
        </div>
      `);i.setPopup(m),Re(i)}catch(i){console.error("Error creating driver marker:",i)}},Ve=t=>{de(t)},$e=t=>{if(!d.current||!h)return;K.forEach(s=>{s&&s.remove&&s.remove()});const r=t.map((s,a)=>{if(!s.longitude||!s.latitude||s.type==="station")return null;try{const c=document.createElement("div");c.className="site-marker";const o=s.status==="completed"||s.status==="finished"||s.collectionStatus==="finished",n=s.status==="in_progress",i=s.type==="station",m=s.purok_name||s.site_name||"Site",v=b&&L&&L.id===s.id&&!o,$=()=>i?"#DC2626":o||v?"#10B981":"#6B7280",R=()=>i?`
              <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
              </svg>
            `:o?`
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
              </svg>
            `:`
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M3 6h18"/>
                <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
              </svg>
            `,Y=l?"w-14 h-14":"w-12 h-12",Qe=l?"w-7 h-7":"w-6 h-6",Ye=l?"w-8 h-8":"w-7 h-7",ke=k.findIndex(rt=>rt.id===s.id)+1,Ke=ke>0;c.innerHTML=`
          <div class="relative ${n||v?"animate-pulse":""}">
            ${Ke&&!i&&!o?`
              <div class="absolute -top-2 -right-2 bg-blue-500 text-white rounded-full ${l?"w-7 h-7 text-sm":"w-6 h-6 text-xs"} flex items-center justify-center font-bold shadow-lg border-2 border-white z-20">
                ${ke}
              </div>
            `:""}
            ${i?`
              <div class="${Y} rounded-full bg-white shadow-2xl border-4 border-red-600 flex items-center justify-center">
                <div class="${Ye} text-red-600">
                  ${R()}
                </div>
              </div>
            `:`
              <div class="${Y} rounded-full border-3 border-white flex items-center justify-center shadow-lg" 
                    style="background-color: ${$()}; ${o?"opacity: 0.7;":""}">
                <div class="${Qe} text-white">
                  ${R()}
                </div>
              </div>
            `}
            ${n?'<div class="absolute inset-0 rounded-full border-3 border-yellow-500 animate-ping"></div>':""}
            ${v&&!n?'<div class="absolute inset-0 rounded-full border-3 border-green-500 animate-ping"></div>':""}
          </div>
        `;const et=[parseFloat(s.longitude),parseFloat(s.latitude)],tt=new C.Popup({offset:25,closeButton:!1,className:`custom-popup ${l?"max-w-xs":"max-w-sm"}`}).setHTML(`
          <div class="text-sm ${l?"p-2":"p-3"}">
            <div class="font-semibold text-gray-900 ${l?"text-base":""}">${m}</div>
            <div class="text-xs text-gray-500 mt-1">
              ${i?"Collection Station":o?"Completed":n?"In Progress":"Pending"}
            </div>
            ${v&&b&&'<div class="text-xs text-green-600 mt-1 font-medium">üéØ Current Target</div>'}
            ${L&&L.id===s.id&&!v&&'<div class="text-xs text-green-600 mt-1 font-medium">üìç Nearest Site</div>'}
          </div>
        `);return new C.Marker({element:c,draggable:!1}).setLngLat(et).setPopup(tt).addTo(d.current)}catch(c){return console.error("Error creating marker:",c),null}}).filter(s=>s!==null);Te(r)},Ze=async()=>{x.length>0&&y&&(V("Refreshing route..."),await Q(x,y,b))},Ge=()=>{xe(!U)},Je=()=>p?"100%":we.width<640?"400px":we.width<768?"500px":"600px";return u.useEffect(()=>{console.log("Current state:",{cssLoaded:B,mapInitialized:h,containerReady:W,siteLocationsCount:x.length,siteMarkersCount:K.length,driverLocation:!!g})},[B,h,W,x,K,g]),e.jsxs("div",{className:`${p?"w-full h-full":"w-full"} bg-white ${p?"":"rounded-lg border border-gray-200"} overflow-hidden`,children:[e.jsx(lt,{isLoading:Ce,message:Fe,size:l?"medium":"large",variant:"default"}),X&&e.jsxs("div",{className:"absolute top-0 left-0 right-0 bg-yellow-500 text-black px-4 py-2 z-50 flex items-center justify-center gap-2 shadow-lg",children:[e.jsx(at,{className:"w-5 h-5"}),e.jsx("span",{className:"font-semibold text-sm",children:"Offline Mode - Using cached map data"})]}),e.jsxs("div",{className:`relative w-full ${p?"h-full":""}`,style:{height:p?"100%":Je()},children:[e.jsx("div",{ref:F,className:"w-full h-full absolute inset-0"}),h&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:`absolute ${l?"bottom-2 left-2":"bottom-4 left-4"} bg-white/95 backdrop-blur-sm rounded-lg shadow-lg border border-gray-200 ${l?"p-2":"p-3"} z-10 ${l?"min-w-40 max-w-48":p?"min-w-52":"min-w-48"}`,children:[e.jsxs("div",{className:`font-semibold ${l?"text-xs":"text-sm"} text-gray-900 ${l?"mb-2":"mb-3"} flex items-center justify-between`,children:[e.jsx("span",{children:"Legend"}),p&&!l&&e.jsx("span",{className:"text-xs font-normal text-gray-500",children:"Live Tracking"})]}),e.jsxs("div",{className:`space-y-1 ${l?"text-xs":"text-sm"}`,children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 bg-blue-600 rounded-full flex items-center justify-center flex-shrink-0 relative",children:e.jsx("div",{className:"absolute inset-0 bg-blue-400 rounded-full animate-ping opacity-30"})}),e.jsx("span",{className:"text-gray-700",children:"Driver"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 bg-red-600 rounded-full flex-shrink-0"}),e.jsx("span",{className:"text-gray-700",children:"Station"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 bg-gray-500 rounded-full flex-shrink-0"}),e.jsx("span",{className:"text-gray-700",children:"Pending"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 bg-green-600 rounded-full flex-shrink-0"}),e.jsx("span",{className:"text-gray-700",children:"Completed"})]}),b&&L&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 bg-green-500 rounded-full flex-shrink-0 relative",children:e.jsx("div",{className:"absolute inset-0 rounded-full border-2 border-white animate-ping"})}),e.jsx("span",{className:"text-gray-700",children:"Target Site"})]}),f&&e.jsxs("div",{className:"flex items-center gap-2 pt-1 border-t border-gray-200",children:[e.jsx("div",{className:"w-4 h-1 rounded-full flex-shrink-0",style:{backgroundColor:f.isRealTime?"#000000":"#6B7280"}}),e.jsx("span",{className:"text-gray-700",children:f.isRealTime?"Live Route":"Planned Route"})]})]})]}),e.jsxs("div",{className:`absolute ${l?"top-2 right-2":"top-4 right-4"} flex ${p&&!l?"flex-row gap-2":"flex-col gap-2"} z-10`,children:[e.jsx("button",{onClick:Ze,disabled:te,className:`${p?"bg-white/95 backdrop-blur-sm":"bg-white"} rounded-lg shadow-lg border border-gray-200 hover:bg-gray-50 transition-colors flex items-center justify-center ${l?"p-2":"p-3"} ${te?"opacity-50 cursor-not-allowed":""}`,title:"Refresh route",children:te?e.jsx("div",{className:`animate-spin rounded-full border-b-2 border-gray-700 ${l?"w-4 h-4":"w-5 h-5"}`}):e.jsx(nt,{className:`text-gray-700 ${l?"w-4 h-4":"w-5 h-5"}`})}),e.jsx("button",{onClick:Ge,className:`${p?"bg-white/95 backdrop-blur-sm":"bg-white"} rounded-lg shadow-lg border ${U?"border-blue-500 bg-blue-50":"border-gray-200"} hover:bg-gray-50 transition-colors flex items-center justify-center ${l?"p-2":"p-3"}`,title:U?"Hide route info":"Show route info",children:e.jsx(ot,{className:`${U?"text-blue-600":"text-gray-700"} ${l?"w-4 h-4":"w-5 h-5"}`})}),e.jsx("button",{onClick:Se,className:`${p?"bg-white/95 backdrop-blur-sm":"bg-white"} rounded-lg shadow-lg border border-gray-200 hover:bg-gray-50 transition-colors flex items-center justify-center ${l?"p-2":"p-3"}`,title:"Fit to route",children:e.jsx(it,{className:`text-gray-700 ${l?"w-4 h-4":"w-5 h-5"}`})})]}),e.jsx("div",{className:`absolute ${l?"top-2 left-2":"top-4 left-4"} bg-white/95 backdrop-blur-sm rounded-lg shadow-lg border border-gray-200 ${l?"px-2 py-1":"px-3 py-2"} z-10`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${H==="connected"?"bg-green-500":H==="connecting"?"bg-yellow-500":"bg-red-500"} ${H==="connected"?"animate-pulse":""}`}),e.jsx("span",{className:`font-medium text-gray-700 capitalize ${l?"text-xs":"text-sm"}`,children:H})]})}),f&&U&&e.jsxs("div",{className:`absolute ${l?"top-12 left-2 right-2":p?"top-4 left-1/2 transform -translate-x-1/2":"top-16 left-4"} bg-white/95 backdrop-blur-sm rounded-lg shadow-lg border border-gray-200 ${l?"p-3":"p-4"} z-10 ${l?"":p?"min-w-80 max-w-md":"min-w-64"}`,children:[e.jsxs("div",{className:`font-semibold text-gray-900 ${l?"text-sm mb-2":"text-base mb-3"} flex items-center justify-between`,children:[e.jsx("span",{children:f.isRealTime?"Live Route":"Planned Route"}),e.jsxs("div",{className:"flex gap-1",children:[f.isRealTime&&e.jsxs("span",{className:"text-xs bg-green-100 text-green-800 px-2 py-1 rounded flex items-center gap-1",children:[e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-pulse"}),"Live"]}),f.isFallback&&e.jsx("span",{className:"text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded",children:"Estimated"})]})]}),e.jsxs("div",{className:`space-y-2 ${l?"text-xs":"text-sm"} text-gray-600`,children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{children:"Estimated Time:"}),e.jsx("span",{className:"font-semibold text-blue-600",children:f.formattedDuration})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{children:"Distance:"}),e.jsxs("span",{className:"font-semibold",children:[f.distance," km"]})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{children:"Total Stops:"}),e.jsxs("span",{className:"font-semibold",children:[f.totalStops," sites"]})]}),f.targetSite&&e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{children:"Target Site:"}),e.jsx("span",{className:"font-semibold text-green-600",children:f.targetSite})]}),L&&!f.targetSite&&e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{children:"Nearest Site:"}),e.jsx("span",{className:"font-semibold text-green-600",children:L.site_name})]}),f.lastUpdated&&e.jsxs("div",{className:"flex justify-between items-center text-xs text-gray-500",children:[e.jsx("span",{children:"Last Updated:"}),e.jsx("span",{children:f.lastUpdated})]})]}),be&&e.jsx("div",{className:`mt-2 p-2 bg-red-50 border border-red-200 rounded ${l?"text-xs":"text-sm"} text-red-600`,children:be})]})]})]})]})};export{xt as default};
