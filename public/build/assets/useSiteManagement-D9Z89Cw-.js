import{r as p,a as f}from"./app-DomsZQZz.js";const X=({scheduleId:c,onTaskComplete:y,onTaskCancel:K,calculateDistance:F,showCompletionNotification:R,updateSiteMarkers:b,recalculateRouteFromCurrentPosition:I,currentLocation:$})=>{const[m,h]=p.useState([]),[U,z]=p.useState(null),[u,E]=p.useState(null),[B,k]=p.useState(null),[S,C]=p.useState([]),[L,w]=p.useState(new Set),[P,_]=p.useState(0),[W,A]=p.useState(!1),[Q,v]=p.useState(!1),N=(t,o)=>{if(!t||o.length===0)return null;let s=null,a=1/0;return o.forEach(e=>{if(e.longitude&&e.latitude){const n=F(parseFloat(t.latitude),parseFloat(t.longitude),parseFloat(e.latitude),parseFloat(e.longitude));n<a&&(a=n,s=e)}}),s},j=(t,o)=>{if(!t||o.length===0)return!1;const[s,a]=t;let e=!1;return o.forEach((n,r)=>{if(L.has(n.id))return;const d=parseFloat(n.longitude),l=parseFloat(n.latitude);F(a,s,l,d)<.05&&(T(n),e=!0)}),e},O=async()=>{var t;try{if(!m.length){console.log("No sites available to initialize collection queue");return}const o=m.map(a=>a.id);console.log("Initializing collection queue with sites:",o);const s=await f.post("/initialize",{schedule_id:c,site_id:o});s.data.success?console.log("Collection queue initialized with",s.data.total_sites,"sites"):console.error("Failed to initialize collection queue:",s.data.message)}catch(o){console.error("Error initializing collection queue:",o),console.error("Error details:",(t=o.response)==null?void 0:t.data)}},T=async(t,o)=>{var s;console.log(`Site reached: ${t.site_name}`);try{const a=await f.post("/mark-completed",{schedule_id:c,site_id:t.id});if(a.data.success){if(console.log("Site marked as completed in database:",t.site_name),w(e=>{const n=new Set(e);return n.add(t.id),console.log("Updated completed sites:",Array.from(n)),n}),h(e=>e.map(n=>n.id===t.id?{...n,collectionStatus:"finished",status:"finished",completed_at:new Date().toISOString()}:n)),a.data.all_completed?(console.log("ðŸŽ‰ All sites completed! Show completion report modal."),y&&y(t,!0)):console.log(`Progress: ${a.data.completed_sites}/${a.data.total_sites} sites completed`),S.length>0){const e=S.findIndex(n=>n.id===t.id);if(e!==-1&&e<S.length-1){const n=e+1;_(n);const r=S[n];console.log(`Moving to next site: ${r.site_name}`),$&&(console.log("Immediately recalculating route from current location to next site"),I($))}else e===S.length-1&&(console.log("ðŸ Last site reached!"),_(e))}b(),R(t.site_name)}}catch(a){console.error("Error marking site as completed:",a),console.error("Error details:",(s=a.response)==null?void 0:s.data)}},G=async()=>{if(!c){console.error("Cannot start task: missing schedule ID");return}try{const t=(u==null?void 0:u.barangay_id)||"unknown",o=await f.post("/schedule/start",{schedule_id:c,barangay_id:t});o.data.success&&(console.log("Task started and broadcasted to residents"),A(!0),m.length>0&&await O(),o.data.data&&E(s=>({...s,...o.data.data,status:"in_progress"})))}catch(t){console.error("Failed to start task:",t)}},H=async()=>{if(!c){console.error("Cannot complete task: missing schedule ID");return}try{(await f.post("/schedule/complete",{schedule_id:c})).data.success&&(console.log("Task completed and broadcasted to residents"),A(!1),y&&y())}catch(t){console.error("Failed to complete task:",t)}},J=()=>{w(new Set),_(0),b()},D=async()=>{if(!c){console.warn("No schedule ID provided");return}v(!0);try{let t=null;try{const o=await f.get(`/schedules/${c}`);o.data.success&&o.data.data?(t=o.data.data,E(t),console.log("Schedule data loaded:",t)):console.warn("No schedule data received from API")}catch(o){console.warn("Could not fetch schedule details:",o),t={id:c,barangay_id:"unknown",status:"pending"},E(t)}if(t!=null&&t.barangay_id&&t.barangay_id!=="unknown")try{const o=await f.get(`/barangay/${t.barangay_id}/sites?status=active`);if(o.data.success){const s=o.data.data;console.log("Sites loaded:",s.length);try{const a=await f.get(`/progress/${c}`);if(a.data.success){const e=a.data.progress,n=new Set(e.filter(i=>i.status==="finished").map(i=>i.site_id));console.log("Collection queue loaded, completed sites:",n.size),w(n);const r=s.map(i=>{var g;return{...i,collectionStatus:((g=e.find(x=>x.site_id===i.id))==null?void 0:g.status)||"unfinished"}}),d=r.find(i=>i.type==="station"),l=r.filter(i=>i.type!=="station");if(d&&(z({...d,coordinates:[parseFloat(d.longitude),parseFloat(d.latitude)]}),l.length>0)){const i=N(d,l);k(i),console.log("Nearest site to station found:",i==null?void 0:i.site_name);const g=q(d,l);C(g),_(0)}h(l)}}catch{console.warn("Could not fetch collection queue progress, using default statuses");const e=s.find(r=>r.type==="station"),n=s.filter(r=>r.type!=="station");if(e&&(z({...e,coordinates:[parseFloat(e.longitude),parseFloat(e.latitude)]}),n.length>0)){const r=N(e,n);k(r),console.log("Nearest site to station found:",r==null?void 0:r.site_name);const d=q(e,n);C(d),_(0)}h(n)}}}catch(o){console.error("Error fetching sites:",o)}else console.warn("No valid barangay_id available to fetch sites")}catch(t){console.error("Error in schedule and sites setup: ",t)}finally{v(!1)}},q=(t,o)=>{if(!t||o.length===0)return o;const s=[...o],a=[],e=s.map(l=>{const i=F(parseFloat(t.latitude),parseFloat(t.longitude),parseFloat(l.latitude),parseFloat(l.longitude));return{...l,distance:i,coordinates:[parseFloat(l.longitude),parseFloat(l.latitude)]}});e.sort((l,i)=>l.distance-i.distance);const n=e[0];a.push(n);const r=e.slice(1);let d=n;for(;r.length>0;){let l=-1,i=1/0;for(let g=0;g<r.length;g++){const x=F(parseFloat(d.latitude),parseFloat(d.longitude),parseFloat(r[g].latitude),parseFloat(r[g].longitude));x<i&&(i=x,l=g)}l!==-1&&(d=r[l],a.push(d),r.splice(l,1))}return a};return p.useEffect(()=>{D()},[c]),p.useEffect(()=>{m.length>0&&c&&(console.log("Sites loaded, initializing collection queue..."),O())},[m,c]),p.useEffect(()=>{if(!(u!=null&&u.barangay_id)||!c)return;console.log("Setting up site completion listener for barangay:",u.barangay_id);const t=`site-completion.${u.barangay_id}`,o=`site-completion-schedule.${c}`;return window.Echo.channel(t).listen("SiteCompletionUpdated",s=>{console.log("Site completion update received:",s),s.schedule_id===c&&(w(a=>{const e=new Set(a);return e.add(s.site_id),console.log("Site completion broadcast received, updated completed sites:",Array.from(e)),e}),h(a=>a.map(e=>e.id===s.site_id?{...e,collectionStatus:"finished",status:"finished",completed_at:s.completed_at}:e)),b())}),window.Echo.channel(o).listen("SiteCompletionUpdated",s=>{console.log("Schedule-specific site completion update:",s),w(a=>{const e=new Set(a);return e.add(s.site_id),e}),h(a=>a.map(e=>e.id===s.site_id?{...e,collectionStatus:"finished",status:"finished",completed_at:s.completed_at}:e)),b()}),()=>{window.Echo&&(window.Echo.leave(t),window.Echo.leave(o),console.log("Left site completion channels"))}},[u==null?void 0:u.barangay_id,c]),{siteLocations:m,stationLocation:U,activeSchedule:u,nearestSiteToStation:B,optimizedSiteOrder:S,completedSites:L,currentSiteIndex:P,isTaskActive:W,loading:Q,setSiteLocations:h,setStationLocation:z,setActiveSchedule:E,setNearestSiteToStation:k,setOptimizedSiteOrder:C,setCompletedSites:w,setCurrentSiteIndex:_,setIsTaskActive:A,setLoading:v,findNearestSiteToStation:N,checkSiteProximity:j,markSiteAsCompleted:T,startTaskAndBroadcast:G,completeTaskAndBroadcast:H,resetCompletedSites:J,fetchScheduleAndSites:D,optimizeSiteOrderFromStation:q}};export{X as useSiteManagement};
