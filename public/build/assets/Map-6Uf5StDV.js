import{r as u,c as h,j as g,a as H}from"./app-CaiA3wOq.js";import{a as p}from"./mapbox-gl-iqvqYPZ_.js";import{G as I}from"./index-Dfe5B_og.js";import{C as G}from"./index-DCoPM8i8.js";import{G as O}from"./index-BgchoCRf.js";import{c as q}from"./can-3MqaZyCZ.js";import"./iconBase-BdlJZVzg.js";function Z({mapboxKey:m,onLocationSelect:b,refreshTrigger:v,onEditSite:x,onDeleteSite:k}){const f=u.useRef(null),o=u.useRef(null),d=u.useRef(null),y=u.useRef([]),[E,w]=u.useState(!1),[F,_]=u.useState([]),[L,B]=u.useState(!1),M={type:"FeatureCollection",features:[{type:"Feature",properties:{id:1,barangay:"San Francisco"},geometry:{type:"Polygon",coordinates:[[[125.99912782475212,8.575510286263182],[126.00025443311193,8.571458743014418],[126.02485768210255,8.565939354188075],[126.04450490232114,8.466818846605392],[126.1103129490703,8.46664901562528],[126.06009804976281,8.415887696221361],[126.07054556119789,8.402939305491458],[126.02793797928399,8.40460170458961],[126.02527178904438,8.408548502194648],[126.02427353120135,8.409252626098564],[126.02385934340657,8.40926067897989],[126.0212174711134,8.407984558278983],[126.02055643141244,8.408178587487853],[126.01856794991,8.409294302964668],[126.01662892223891,8.4046902116812],[126.01474001557193,8.406036008364552],[126.01358506617925,8.404625448531675],[126.00952801076892,8.405454403475574],[126.00777831277611,8.404925515942836],[126.00658549599319,8.403966025428687],[126.00485033177199,8.403227717091895],[126.00509998136846,8.401577514556351],[126.00574801766186,8.400888351042127],[125.97641093552602,8.391757550629634],[125.97390880231916,8.39080800207968],[125.97081543981409,8.39161874461628],[125.96745822964954,8.39014796167777],[125.96303628490449,8.389036768089781],[125.95862571497344,8.38720153395198],[125.96318041276902,8.371729751905093],[125.95503341347933,8.369405592514127],[125.95860757814717,8.355388169154793],[125.92791631975041,8.347929528410077],[125.89113139787435,8.393374892862454],[125.88334005008488,8.417552308867386],[125.79651821810683,8.548921445742934],[125.93730538303595,8.548744057251142],[125.9349976967647,8.577733038602531],[125.99912782475212,8.575510286263182]]]}}]},C={Alegria:"#FF5733","Barangay 1":"#33FF57","Barangay 2":"#3357FF","Barangay 3":"#F033FF","Barangay 4":"#FF33F0","Barangay 5":"#33FFF0","Bayugan 2":"#8A2BE2","Bitan-agan":"#A52A2A",Borbon:"#DEB887",Buenasuerte:"#5F9EA0",Caimpugan:"#7FFF00","Das-agan":"#D2691E",Ebro:"#FF7F50",Hubang:"#6495ED",Karaus:"#DC143C",Ladgadan:"#00FFFF",Lapinigan:"#00008B",Lucac:"#008B8B",Mate:"#B8860B","New Visayas":"#006400",Ormaca:"#8B008B",Pasta:"#556B2F","Pisa-an":"#FF8C00",Rizal:"#9932CC","San Isidro":"#8FBC8F","Santa Ana":"#483D8B",Tagapua:"#2F4F4F","San Francisco":"#FFE659",_default:"#4F262A"};u.useEffect(()=>{const e=document.createElement("link");return e.href="https://api.mapbox.com/mapbox-gl-js/v3.0.0/mapbox-gl.css",e.rel="stylesheet",document.head.appendChild(e),w(!0),()=>{document.head.removeChild(e)}},[]),u.useEffect(()=>{(async()=>{try{const t=await H.get("/municipality/barangay/purok/sites");t.data.success&&_(t.data.data)}catch(t){console.error("Error fetching locations: ",t)}})()},[v]),u.useEffect(()=>{if(!(!E||!m||o.current||!f.current))return p.accessToken=m,o.current=new p.Map({container:f.current,style:"mapbox://styles/makisenpai/cm9mo7odu006c01qsc3931nj7",center:[125.94849837776422,8.483022468128098],attributionControl:!1,zoom:10.5}),o.current.on("load",()=>{B(!0),j(M)}),o.current.on("click",async e=>{var a;const{lng:t,lat:c}=e.lngLat;d.current&&(d.current.remove(),d.current=null);const n=document.createElement("div");n.className="custom-marker";const r=h.createRoot(n);r.render(g.jsx(G,{size:30,color:"#FC2622"})),d.current=new p.Marker({element:n,draggable:!1}).setLngLat([t,c]).addTo(o.current),d.current._root=r;try{const l=await(await fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${t},${c}.json?access_token=${m}&country=PH&types=region,district,locality,neighborhood,place`)).json(),i={coordinates:{lng:t,lat:c},full_address:((a=l.features[0])==null?void 0:a.place_name)||"",...T(l)};b&&b(i)}catch(s){console.error("Geocoding error:",s)}}),()=>{o.current&&(o.current.remove(),o.current=null),B(!1)}},[m,E,v]),u.useEffect(()=>{L&&F.length>0&&A()},[L,F]);const j=e=>{o.current&&(o.current.getLayer("polygons-fill")&&o.current.removeLayer("polygons-fill"),o.current.getLayer("polygons-outline")&&o.current.removeLayer("polygons-outline"),o.current.getSource("polygons")&&o.current.removeSource("polygons"),o.current.addSource("polygons",{type:"geojson",data:e}),o.current.addLayer({id:"polygons-fill",type:"fill",source:"polygons",paint:{"fill-color":["match",["get","barangay"],"San Francisco","#FFE659","#4F262A"],"fill-opacity":.5}}),o.current.addLayer({id:"polygons-outline",type:"line",source:"polygons",paint:{"line-color":"#000","line-width":2}}),o.current.on("mouseenter","polygons-fill",()=>{o.current.getCanvas().style.cursor="pointer"}),o.current.on("mouseleave","polygons-fill",()=>{o.current.getCanvas().style.cursor=""}))},A=()=>{P(),F.forEach(e=>{if(e.longitude&&e.latitude){const t=R([parseFloat(e.longitude),parseFloat(e.latitude)],"site",e.site_name,e);y.current.push(t)}})},P=()=>{y.current.forEach(e=>{e._root&&setTimeout(()=>e._root.unmount(),0),e.remove()}),y.current=[]},S=e=>{var c,n,r;const t=document.createElement("div");return t.className="p-3 min-w-[200px]",t.innerHTML=`
            <div class="text-center mb-3">
                <h3 class="font-bold text-lg text-gray-900">${e.site_name}</h3>
                <p class="text-sm text-gray-600">${((n=(c=e.purok)==null?void 0:c.baranggay)==null?void 0:n.baranggay_name)||"N/A"} - ${((r=e.purok)==null?void 0:r.purok_name)||"N/A"}</p>
            </div>
            <div class="flex gap-2 justify-center">
                <button id="edit-site-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded text-sm font-medium transition-colors flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                    </svg>
                    Edit
                </button>
                <button id="delete-site-btn" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded text-sm font-medium transition-colors flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                    Delete
                </button>
            </div>
        `,setTimeout(()=>{const a=t.querySelector("#edit-site-btn"),s=t.querySelector("#delete-site-btn");a&&a.addEventListener("click",l=>{l.stopPropagation(),x&&x(e)}),s&&s.addEventListener("click",l=>{l.stopPropagation(),k&&k(e)})},0),t},N=e=>{var r,a,s;const t=(a=(r=e==null?void 0:e.purok)==null?void 0:r.baranggay)==null?void 0:a.baranggay_name,c=C[t]||C._default,n=document.createElement("div");return n.className="custom-image-marker",n.innerHTML=`
            <div class="relative">
                <div class="w-10 h-10 rounded-full border-10 flex items-center justify-center overflow-hidden" 
                     style="border-color: ${c}; background-color: ${c}20;">
                    <img src="${q}" 
                         alt="${e.site_name}" 
                         class="w-8 h-8 object-cover rounded-full"
                         onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\\'w-8 h-8 rounded-full flex items-center justify-center text-white text-xs font-bold\\' style=\\'background-color: ${c}\\'>${((s=e.site_name)==null?void 0:s.charAt(0))||"S"}</div>'">
                </div>
            </div>
        `,n},$=()=>{const e=document.createElement("div");e.className="custom-marker";const t=h.createRoot(e);return t.render(g.jsx(O,{size:30,color:"#4F262A"})),{element:e,root:t}},R=(e,t="manual",c="",n=null)=>{let r,a=null;if(t==="manual")r=document.createElement("div"),r.className="custom-marker",a=h.createRoot(r),a.render(g.jsx(I,{size:15,color:"#FC2622"}));else if((n==null?void 0:n.type)==="station"){const l=$();r=l.element,a=l.root}else r=N(n);const s=new p.Marker({element:r,draggable:!1}).setLngLat(e).addTo(o.current);if(t==="site"&&c){const l=new p.Popup({offset:25,closeOnClick:!1,closeButton:!0,className:"site-popup"}).setDOMContent(S(n));s.setPopup(l),r.style.cursor="pointer",r.addEventListener("click",i=>{i.stopPropagation(),s.togglePopup()})}return t==="manual"&&(d.current=s),a&&(s._root=a),s},T=e=>{var s,l;const t=e.features;let c="",n="";const r=t.find(i=>i.place_type.includes("locality")||i.place_type.includes("place")||i.context&&i.context.some(z=>z.id.includes("locality")));r&&(c=r.text||((l=(s=r.context)==null?void 0:s.find(i=>i.id.includes("locality")))==null?void 0:l.text)||"");const a=t.find(i=>i.place_type.includes("neighborhood"));return a&&(n=a.text),{barangay:c||"Not specified",purok:n||"Not specified"}};return g.jsx("div",{ref:f,className:"w-full h-full rounded-lg"})}export{Z as default};
