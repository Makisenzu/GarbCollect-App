import{j as e,r as c,a as D,i as Ye,g as Ne}from"./app-kp99I6hj.js";import{a as T}from"./mapbox-gl-B45-CkQK.js";import{h as Ke,i as et,j as tt,g as at}from"./index-DehLUTJQ.js";import"./iconBase-CpeI5Jc8.js";const st=({isLoading:y=!1,size:$="medium",message:C="Collecting garbage..."})=>{if(!y)return null;const v={small:"w-16 h-16",medium:"w-24 h-24",large:"w-32 h-32",xlarge:"w-48 h-48"},z={small:"text-xs",medium:"text-sm",large:"text-base",xlarge:"text-lg"};return e.jsxs("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:[e.jsxs("div",{className:"bg-white rounded-2xl p-8 shadow-2xl flex flex-col items-center",children:[e.jsxs("div",{className:`relative ${v[$]} mb-4`,children:[e.jsx("div",{className:"absolute bottom-0 left-0 right-0 h-2 bg-gray-600 rounded-full"}),e.jsx("div",{className:"absolute bottom-3 left-4 w-3 h-4 bg-gray-400 rounded-sm",children:e.jsx("div",{className:"absolute -top-1 left-0.5 w-2 h-1 bg-gray-500 rounded-sm"})}),e.jsx("div",{className:"absolute bottom-3 left-8 w-3 h-5 bg-gray-400 rounded-sm",children:e.jsx("div",{className:"absolute -top-1 left-0.5 w-2 h-1 bg-gray-500 rounded-sm"})}),e.jsx("div",{className:"absolute bottom-3 left-12 w-3 h-4 bg-gray-400 rounded-sm",children:e.jsx("div",{className:"absolute -top-1 left-0.5 w-2 h-1 bg-gray-500 rounded-sm"})}),e.jsx("div",{className:"absolute bottom-2 left-0 animate-collect-garbage",children:e.jsxs("div",{className:"relative",children:[e.jsxs("div",{className:"w-6 h-4 bg-green-600 rounded-t-sm",children:[e.jsx("div",{className:"absolute top-0.5 left-1 w-3 h-1.5 bg-blue-300 rounded-sm"}),e.jsx("div",{className:"absolute bottom-0 left-1 w-1 h-0.5 bg-yellow-300 rounded-full"})]}),e.jsx("div",{className:"absolute left-6 top-1 w-8 h-3 bg-green-700 rounded-sm",children:e.jsx("div",{className:"absolute top-0.5 left-1 w-6 h-2 bg-gray-800 rounded",children:e.jsx("div",{className:"absolute -top-1 left-0 right-0 h-1 bg-gray-700 rounded-t animate-garbage-fill"})})}),e.jsx("div",{className:"absolute -bottom-1 left-1 w-2 h-2 bg-black rounded-full",children:e.jsx("div",{className:"absolute inset-0.5 w-1 h-1 bg-gray-600 rounded-full"})}),e.jsx("div",{className:"absolute -bottom-1 left-5 w-2 h-2 bg-black rounded-full",children:e.jsx("div",{className:"absolute inset-0.5 w-1 h-1 bg-gray-600 rounded-full"})}),e.jsx("div",{className:"absolute -bottom-1 left-11 w-2 h-2 bg-black rounded-full",children:e.jsx("div",{className:"absolute inset-0.5 w-1 h-1 bg-gray-600 rounded-full"})})]})}),e.jsx("div",{className:"absolute bottom-3 left-16 w-4 h-1 bg-gray-400 rounded-full animate-dust-cloud opacity-0"})]}),e.jsx("div",{className:`text-center ${z[$]} text-gray-700 font-semibold`,children:C}),e.jsxs("div",{className:"flex space-x-1 mt-2",children:[e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-bounce",style:{animationDelay:"0ms"}}),e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-bounce",style:{animationDelay:"150ms"}}),e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-bounce",style:{animationDelay:"300ms"}})]})]}),e.jsx("style",{jsx:!0,children:`
        @keyframes collect-garbage {
          0% {
            transform: translateX(-20px);
          }
          20% {
            transform: translateX(40px);
          }
          40% {
            transform: translateX(80px);
          }
          60% {
            transform: translateX(120px);
          }
          80% {
            transform: translateX(160px);
          }
          100% {
            transform: translateX(200px);
          }
        }
        
        @keyframes garbage-fill {
          0%, 20% {
            height: 0px;
            opacity: 0;
          }
          25% {
            height: 1px;
            opacity: 1;
          }
          40% {
            height: 2px;
            opacity: 1;
          }
          60% {
            height: 3px;
            opacity: 1;
          }
          80% {
            height: 4px;
            opacity: 1;
          }
          100% {
            height: 4px;
            opacity: 0;
          }
        }
        
        @keyframes dust-cloud {
          0%, 60% {
            opacity: 0;
            transform: scale(0.5);
          }
          70% {
            opacity: 0.8;
            transform: scale(1);
          }
          80% {
            opacity: 0.6;
            transform: scale(1.2);
          }
          90% {
            opacity: 0.4;
            transform: scale(1.4);
          }
          100% {
            opacity: 0;
            transform: scale(1.6);
          }
        }
        
        .animate-collect-garbage {
          animation: collect-garbage 4s ease-in-out infinite;
        }
        
        .animate-garbage-fill {
          animation: garbage-fill 4s ease-in-out infinite;
        }
        
        .animate-dust-cloud {
          animation: dust-cloud 4s ease-in-out infinite;
        }
      `})]})},K={Alegria:"#FF5733","Barangay 1":"#33FF57","Barangay 2":"#3357FF","Barangay 3":"#F033FF","Barangay 4":"#FF33F0","Barangay 5":"#33FFF0","Bayugan 2":"#8A2BE2","Bitan-agan":"#A52A2A",Borbon:"#DEB887",Buenasuerte:"#5F9EA0",Caimpugan:"#7FFF00","Das-agan":"#D2691E",Ebro:"#FF7F50",Hubang:"#6495ED",Karaus:"#DC143C",Ladgadan:"#00FFFF",Lapinigan:"#00008B",Lucac:"#008B8B",Mate:"#B8860B","New Visayas":"#006400",Ormaca:"#8B008B",Pasta:"#556B2F","Pisa-an":"#FF8C00",Rizal:"#9932CC","San Isidro":"#8FBC8F","Santa Ana":"#483D8B",Tagapua:"#2F4F4F","San Francisco":"#FFE659",_default:"#4F262A"},gt=({mapboxKey:y,barangayId:$,scheduleId:C,isFullscreen:v=!1})=>{const z=c.useRef(null),l=c.useRef(null),[A,H]=c.useState(!1),[h,I]=c.useState(!1),[w,me]=c.useState(null),[p,Fe]=c.useState(null),[ge,ke]=c.useState(null),[b,O]=c.useState([]),[ee,Me]=c.useState([]),[rt,ot]=c.useState(!0),[nt,fe]=c.useState(!0),[W,te]=c.useState("connecting"),[pe,V]=c.useState(null),[X,Le]=c.useState(!1),[Re,he]=c.useState(!1),[Ee,Te]=c.useState("Loading map data..."),G=(t="Loading map data...")=>{Te(t),he(!0)},_=()=>{he(!1)},[k,Z]=c.useState([]),[d,J]=c.useState(null),[M,Ce]=c.useState([]),[L,_e]=c.useState(null),[N,ze]=c.useState(null),[n,Be]=c.useState(!1),[P,xe]=c.useState(!0),[ae,be]=c.useState(!1),[ve,se]=c.useState(null),[S,it]=c.useState(!0),B=c.useRef(null),re=c.useRef(null),[De,Ie]=c.useState(Date.now()),Pe=()=>Date.now()-De<3e4,[we,Ue]=c.useState({width:typeof window<"u"?window.innerWidth:1200,height:typeof window<"u"?window.innerHeight:800});c.useEffect(()=>{if(!l.current)return;const t=["mousedown","touchstart","wheel","movestart","dragstart"],s=()=>{Ie(Date.now())};return t.forEach(a=>{l.current.on(a,s)}),()=>{t.forEach(a=>{l.current&&l.current.off(a,s)})}},[l.current]),c.useEffect(()=>{const t=()=>{const s=window.innerWidth<768;Be(s),Ue({width:window.innerWidth,height:window.innerHeight}),s&&xe(!1)};return t(),window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)},[]),c.useEffect(()=>{y&&(console.log("Setting Mapbox access token"),T.accessToken=y)},[y]),c.useEffect(()=>{const t=()=>{z.current?(console.log("Map container is ready in DOM"),Le(!0)):(console.log("Waiting for map container..."),setTimeout(t,100))};t()},[]),c.useEffect(()=>{if((()=>{const u=document.querySelector('link[href*="mapbox-gl.css"]');return u&&u.sheet?(console.log("Mapbox CSS already loaded"),H(!0),!0):!1})())return;const s=document.createElement("link");s.href="https://api.mapbox.com/mapbox-gl-js/v3.0.0/mapbox-gl.css",s.rel="stylesheet",s.type="text/css";let a;const r=()=>{clearTimeout(a),console.log("Mapbox CSS loaded successfully"),H(!0)},o=()=>{clearTimeout(a),console.warn("Mapbox CSS failed to load, continuing anyway"),H(!0)};s.onload=r,s.onerror=o,document.head.appendChild(s),a=setTimeout(()=>{console.warn("Mapbox CSS load timeout, continuing anyway"),H(!0)},5e3)},[]);const oe=t=>{if(t<60)return`${t} min`;{const s=Math.floor(t/60),a=t%60;return a===0?`${s}h`:`${s}h ${a}min`}},Q=(t,s,a,r)=>{const u=(a-t)*Math.PI/180,i=(r-s)*Math.PI/180,m=Math.sin(u/2)*Math.sin(u/2)+Math.cos(t*Math.PI/180)*Math.cos(a*Math.PI/180)*Math.sin(i/2)*Math.sin(i/2);return 6371*(2*Math.atan2(Math.sqrt(m),Math.sqrt(1-m)))},qe=(t,s)=>{if(!t||s.length===0)return s;const a=[...s],r=[],o=a.map(g=>{const x=Q(parseFloat(t.latitude),parseFloat(t.longitude),parseFloat(g.latitude),parseFloat(g.longitude));return{...g,distance:x,coordinates:[parseFloat(g.longitude),parseFloat(g.latitude)]}});o.sort((g,x)=>g.distance-x.distance);const u=o[0];r.push(u);const i=o.slice(1);let m=u;for(;i.length>0;){let g=-1,x=1/0;for(let F=0;F<i.length;F++){const f=Q(parseFloat(m.latitude),parseFloat(m.longitude),parseFloat(i[F].latitude),parseFloat(i[F].longitude));f<x&&(x=f,g=F)}g!==-1&&(m=i[g],r.push(m),i.splice(g,1))}return r},Y=async(t,s,a=!1,r=!1)=>{if(!(!y||t.length<1)){r||(be(!0),G("Calculating optimal route...")),se(null);try{const o=t.filter(f=>f.latitude&&f.longitude&&!isNaN(parseFloat(f.latitude))&&!isNaN(parseFloat(f.longitude)));if(o.length<1){console.warn("No valid sites with coordinates found"),se("No valid sites with coordinates found");return}const u=o.filter(f=>f.type==="station"||f.status!=="finished"&&f.status!=="completed"),i=s?qe(s,u.filter(f=>f.type!=="station")):u.filter(f=>f.type!=="station");if(Ce(i),i.length>0&&_e(i[0]),a&&p&&i.length>0){const f=[`${p[0].toFixed(6)},${p[1].toFixed(6)}`,...i.map(j=>`${parseFloat(j.longitude).toFixed(6)},${parseFloat(j.latitude).toFixed(6)}`)];try{const j=await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${f.join(";")}?access_token=${y}&geometries=geojson&overview=full&steps=true&alternatives=false&continue_straight=false&roundabout_exits=true`);if(j.ok){const E=await j.json();if(E.routes&&E.routes.length>0){const U=E.routes[0],q=Math.round(U.duration/60),ue=(U.distance/1e3).toFixed(1);Z(U.geometry.coordinates),J({duration:q,formattedDuration:oe(q),distance:ue,targetSite:i[0].site_name,isRealTime:!0,totalStops:i.length}),console.log(`Complete sequential route calculated from driver through ${i.length} sites`),l.current&&h&&R();return}}}catch(j){console.error("Error calculating driver sequential route:",j)}}let m=[];s?m=[`${parseFloat(s.longitude).toFixed(6)},${parseFloat(s.latitude).toFixed(6)}`,...i.map(f=>`${parseFloat(f.longitude).toFixed(6)},${parseFloat(f.latitude).toFixed(6)}`)]:m=i.map(f=>`${parseFloat(f.longitude).toFixed(6)},${parseFloat(f.latitude).toFixed(6)}`);const g=m.length>2,x=await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${m.join(";")}?access_token=${y}&geometries=geojson&overview=full&steps=true&alternatives=false&continue_straight=false`+(g?"&roundabout_exits=true":""));if(!x.ok)throw new Error(`HTTP error! status: ${x.status}`);const F=await x.json();if(F.routes&&F.routes.length>0){const f=F.routes[0];if(f.geometry&&f.geometry.coordinates){const j=Math.round(f.duration/60),E=(f.distance/1e3).toFixed(1);Z(f.geometry.coordinates),J({duration:j,formattedDuration:oe(j),distance:E,rawData:f,totalStops:i.length,isRealTime:!1}),console.log(`Station route calculated: ${j}min, ${E}km`),l.current&&h&&R()}else throw new Error("Invalid route geometry received")}else throw new Error(F.message||"No routes found")}catch(o){console.error("Error calculating route:",o),se(`Route calculation failed: ${o.message}`);const u=t.filter(i=>i.latitude&&i.longitude&&!isNaN(parseFloat(i.latitude))&&!isNaN(parseFloat(i.longitude)));if(u.length>0){const i=u.map(m=>[parseFloat(m.longitude),parseFloat(m.latitude)]);Z(i),J({duration:Math.round(ye(i)*2),formattedDuration:"Estimated",distance:ye(i).toFixed(1),isFallback:!0,totalStops:u.length,isRealTime:!1}),l.current&&h&&R()}}finally{r||(be(!1),_())}}},ye=t=>{let s=0;for(let a=1;a<t.length;a++){const[r,o]=t[a-1],[u,i]=t[a];s+=Q(o,r,i,u)}return s},ne=async()=>{if(!(!S||!p||!M.length)){if(re.current){const[t,s]=re.current,[a,r]=p;if(Q(s,t,r,a)*1e3<50)return}re.current=p,console.log("Updating complete sequential route from driver location through all sites");try{const t=[`${p[0].toFixed(6)},${p[1].toFixed(6)}`,...M.map(a=>`${parseFloat(a.longitude).toFixed(6)},${parseFloat(a.latitude).toFixed(6)}`)],s=await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${t.join(";")}?access_token=${y}&geometries=geojson&overview=full&steps=true&alternatives=false&continue_straight=false&roundabout_exits=true`);if(s.ok){const a=await s.json();if(a.routes&&a.routes.length>0){const r=a.routes[0],o=Math.round(r.duration/60),u=(r.distance/1e3).toFixed(1);Z(r.geometry.coordinates),J(i=>({...i,duration:o,formattedDuration:oe(o),distance:u,targetSite:M[0].site_name,isRealTime:!0,totalStops:M.length,lastUpdated:new Date().toLocaleTimeString()})),console.log(`Sequential route updated: Driver through ${M.length} sites (${u}km, ${o}min)`),l.current&&h&&R()}}}catch(t){console.error("Error updating real-time route:",t)}}},Ae=()=>{B.current&&clearInterval(B.current),B.current=setInterval(()=>{S&&p&&M.length>0&&ne()},2e3),console.log("Started real-time route updates")},He=()=>{B.current&&(clearInterval(B.current),B.current=null),console.log("Stopped real-time route updates")},R=()=>{if(!(!l.current||k.length===0)){if(!l.current.isStyleLoaded()){l.current.once("styledata",()=>{setTimeout(R,100)});return}["route","route-glow","route-direction","route-start","route-end","route-waypoints","driver-route","driver-route-glow"].forEach(t=>{l.current.getLayer(t)&&l.current.removeLayer(t)}),l.current.getSource("route")&&l.current.removeSource("route"),l.current.getSource("driver-route")&&l.current.removeSource("driver-route"),["route-start-marker","route-end-marker","route-waypoints-marker"].forEach(t=>{l.current.getSource(t)&&l.current.removeSource(t)});try{const t=d!=null&&d.isRealTime?"driver-route":"route",s=d!=null&&d.isRealTime?"driver-route":"route",a=d!=null&&d.isRealTime?"driver-route-glow":"route-glow";l.current.addSource(t,{type:"geojson",data:{type:"Feature",properties:{},geometry:{type:"LineString",coordinates:k}}});const r=(w==null?void 0:w.barangay_name)||"San Francisco",o=d!=null&&d.isRealTime?"#10B981":K[r]||K._default,u=n?6:5,i=n?14:12;l.current.addLayer({id:a,type:"line",source:t,layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":o,"line-width":i,"line-opacity":d!=null&&d.isRealTime?.4:.3,"line-blur":10}}),l.current.addLayer({id:s,type:"line",source:t,layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":o,"line-width":u,"line-opacity":.9,"line-dasharray":d!=null&&d.isRealTime?[2,1]:[1,0]}}),l.current.addLayer({id:"route-direction",type:"symbol",source:t,layout:{"symbol-placement":"line","text-field":"‚ñ∂","text-size":n?14:12,"symbol-spacing":100},paint:{"text-color":o}});const m=[];N&&N.latitude&&N.longitude&&!(d!=null&&d.isRealTime)&&m.push({coordinates:[parseFloat(N.longitude),parseFloat(N.latitude)],type:"station",sequence:0}),M.forEach((g,x)=>{g.latitude&&g.longitude&&m.push({coordinates:[parseFloat(g.longitude),parseFloat(g.latitude)],type:"site",sequence:x+1,isTarget:(d==null?void 0:d.isRealTime)&&x===0})}),m.length>0&&(l.current.addSource("route-waypoints-marker",{type:"geojson",data:{type:"FeatureCollection",features:m.map((g,x)=>({type:"Feature",geometry:{type:"Point",coordinates:g.coordinates},properties:{description:g.type==="station"?"Station":g.isTarget?`Target: ${g.sequence}`:`Site ${g.sequence}`,type:g.type,sequence:g.sequence,isTarget:g.isTarget}}))}}),l.current.addLayer({id:"route-waypoints",type:"circle",source:"route-waypoints-marker",paint:{"circle-radius":["case",["==",["get","type"],"station"],n?10:8,["==",["get","isTarget"],!0],n?12:10,n?8:6],"circle-color":["case",["==",["get","type"],"station"],"#dc2626",["==",["get","isTarget"],!0],"#10B981","#3b82f6"],"circle-stroke-width":2,"circle-stroke-color":"#ffffff"}})),!(d!=null&&d.isRealTime)&&k.length>=2&&(l.current.addSource("route-start-marker",{type:"geojson",data:{type:"Feature",geometry:{type:"Point",coordinates:k[0]},properties:{description:"Start"}}}),l.current.addSource("route-end-marker",{type:"geojson",data:{type:"Feature",geometry:{type:"Point",coordinates:k[k.length-1]},properties:{description:"End"}}}),l.current.addLayer({id:"route-start",type:"circle",source:"route-start-marker",paint:{"circle-radius":n?8:6,"circle-color":"#22c55e","circle-stroke-width":2,"circle-stroke-color":"#ffffff"}}),l.current.addLayer({id:"route-end",type:"circle",source:"route-end-marker",paint:{"circle-radius":n?8:6,"circle-color":"#ef4444","circle-stroke-width":2,"circle-stroke-color":"#ffffff"}})),setTimeout(()=>{Se()},200)}catch(t){console.error("Error adding route layer:",t),setTimeout(()=>{R()},500)}}},Se=()=>{if(!l.current||k.length===0||b.length===0)return;const t=new T.LngLatBounds;k.forEach(a=>{t.extend(a)}),N&&t.extend([parseFloat(N.longitude),parseFloat(N.latitude)]),b.forEach(a=>{a.longitude&&a.latitude&&t.extend([parseFloat(a.longitude),parseFloat(a.latitude)])}),p&&t.extend(p);const s=n?40:80;try{l.current.fitBounds(t,{padding:s,duration:1500,essential:!0,maxZoom:n?16:15,offset:[0,n?-50:0]})}catch(a){console.error("Error fitting map to bounds:",a)}},ie=t=>t.find(s=>s.type==="station")||null;c.useEffect(()=>(A&&y&&X&&(()=>{if(z.current&&!l.current){if(!y){V("Mapbox key is missing.");return}console.log("Starting map initialization..."),G("Initializing map...");try{T.accessToken=y,l.current=new T.Map({container:z.current,style:"mapbox://styles/mapbox/streets-v12",center:[125.94849837776422,8.483022468128098],zoom:n?11:10.5,attributionControl:!1,interactive:!0,scrollZoom:!0,dragPan:!0,dragRotate:!1,keyboard:!1,doubleClickZoom:!n,touchZoomRotate:!0,touchPitch:!1,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!0});const s=()=>{console.log("Map loaded successfully!"),I(!0),V(null),b.length>0&&$e(b),p&&de(p,{}),k.length>0&&setTimeout(()=>{R()},500),S&&Ae(),_()},a=o=>{var u;console.error("Map error:",o),V(`Map error: ${((u=o.error)==null?void 0:u.message)||"Unknown error"}`),I(!0),_()};l.current.once("load",s),l.current.on("error",a);const r=setTimeout(()=>{h||(console.warn("Map load timeout - continuing anyway"),I(!0),_())},1e4);return()=>clearTimeout(r)}catch(s){console.error("Error creating map:",s),V(`Failed to create map: ${s.message}`),I(!0),_()}}})(),()=>{He(),l.current&&(console.log("Cleaning up map"),l.current.remove(),l.current=null,I(!1))}),[A,y,X,n]),c.useEffect(()=>{b.length>0&&N&&y&&h&&(console.log("All data available, calculating optimal route..."),Y(b,N,S))},[b,N,y,h]),c.useEffect(()=>{if(S&&p&&M.length>0){const t=setTimeout(()=>{ne()},1e3);return()=>clearTimeout(t)}},[p,S]),c.useEffect(()=>{l.current&&k.length>0&&h&&R()},[k,h]),c.useEffect(()=>{h&&b.length>0&&(console.log("üîÑ Force updating site markers due to state change"),console.log("üìä Sites to render:",b.map(t=>({id:t.id,name:t.site_name,status:t.status}))),$e(b))},[h,b,n,S,L]),c.useEffect(()=>{if(!(w!=null&&w.id))return;console.log("‚è∞ Starting polling for site updates every 5 seconds");const t=setInterval(async()=>{try{const s=await D.get(`/schedule/${w.id}/sites`);if(s.data.success){const a=s.data.data;if(a.some((o,u)=>{const i=b.find(m=>m.id===o.id);return i&&i.status!==o.status})){console.log("üîÑ POLLING: Site status changed, updating silently"),O(a);const o=ie(a);o&&h&&setTimeout(()=>{Y(a,o,S&&p,!0)},200)}}}catch(s){console.error("Polling error:",s)}},5e3);return()=>{console.log("‚è∞ Stopping site polling"),clearInterval(t)}},[w==null?void 0:w.id,b]),c.useEffect(()=>{h&&p&&(console.log("Force updating driver marker"),de(p,{}))},[h,p,n]),c.useEffect(()=>{if(!$)return;const t=async()=>{try{console.log("Initializing Reverb connection for real-time location updates..."),Ye();const r=Ne();if(!r)throw new Error("Echo not initialized");r.channel(`driver-locations.${$}`).listen("DriverLocationUpdated",o=>{console.log("Real-time driver location update received:",o),te("connected"),ce(o)}),r.channel(`schedule-updates.${$}`).listen("ScheduleStatusUpdated",o=>{console.log("Schedule update received:",o),We(o.schedule)}),r.channel(`site-completion.${$}`).listen("SiteCompletionUpdated",o=>{console.log("üéØ REALTIME: Site completion event received:",{barangay_id:$,event_data:o,site_id:o.site_id||o.siteId,status:o.status,site_name:o.site_name||o.siteName,completed_sites:o.completed_sites,total_sites:o.total_sites}),je(o),le()}),te("connected"),await Oe(),s()}catch(r){console.error("Realtime connection failed:",r),te("disconnected"),s()}},s=()=>{const r=setInterval(()=>{a()},1e4);return()=>clearInterval(r)},a=async()=>{try{if(C){const r=await D.get(`/schedule/${C}/driver-location`);r.data.success&&r.data.data&&ce(r.data.data)}}catch(r){console.error("Error polling driver location:",r)}};return t(),()=>{const r=Ne();r&&(r.leave(`driver-locations.${$}`),r.leave(`schedule-updates.${$}`),r.leave(`site-completion.${$}`))}},[$,C]);const le=async(t=!0)=>{try{if(t||console.log("üîÑ Refreshing sites from server..."),!w||!w.id){console.warn("No current schedule available to refresh sites");return}const s=await D.get(`/schedule/${w.id}/sites`);if(s.data.success){const a=s.data.data;t||console.log("‚úÖ Sites refreshed from server:",a.map(o=>({id:o.id,name:o.site_name,status:o.status}))),O(a);const r=ie(a);r&&h&&setTimeout(()=>{Y(a,r,S&&p,!0)},200)}}catch(s){console.error("Error refreshing sites from server:",s)}};c.useEffect(()=>{window.testSiteCompletion=t=>{console.log("üß™ TEST: Manually triggering site completion for site ID:",t),je({site_id:t,status:"finished",completed_at:new Date().toISOString(),site_name:"Test Site"})},window.refreshResidentMap=()=>{console.log("üß™ TEST: Manually refreshing resident map"),le()}},[b,w]);const Oe=async()=>{try{fe(!0),G("Loading collection sites...");const t=await D.get(`/barangay/${$}/current-schedule`);if(t.data.success){const s=t.data.data;if(me(s),s.id){const a=await D.get(`/schedule/${s.id}/sites`);if(a.data.success){const r=a.data.data;O(r);const o=ie(r);o&&(ze(o),console.log("Station found:",o.site_name))}}if(C){const a=await D.get(`/schedule/${C}/driver-location`);a.data.success&&a.data.data&&ce(a.data.data)}}_()}catch(t){console.error("Error loading initial data:",t),_()}finally{fe(!1)}},ce=t=>{if(!t.longitude||!t.latitude){console.warn("Invalid location data received:",t);return}const s=[parseFloat(t.longitude),parseFloat(t.latitude)];console.log("Updating driver location on map:",s),Fe(s),h&&l.current&&(de(s,t),Pe()||l.current.flyTo({center:s,zoom:n?16:15,duration:2e3,essential:!0,offset:[0,n?-100:0]}),S&&ne())},je=t=>{console.log("üéØ PROCESSING site completion:",{received_data:t,site_id_variants:{site_id:t.site_id,siteId:t.siteId},current_sites_count:b.length}),O(s=>{console.log("üìã Current sites before update:",s.map(r=>({id:r.id,name:r.site_name,status:r.status})));const a=s.map(r=>r.id===t.site_id||r.id===t.siteId?(console.log(`‚úÖ MARKING site ${r.site_name} (ID: ${r.id}) as FINISHED`),{...r,status:"finished",collectionStatus:"finished",completed_at:t.completed_at||new Date().toISOString()}):r);return console.log("üìã Sites after update:",a.map(r=>({id:r.id,name:r.site_name,status:r.status}))),a}),setTimeout(()=>{console.log("üîÑ Refreshing sites from server"),le()},1e3)},de=(t,s)=>{if(!l.current||!h)return;ge&&ge.remove();const a=n?"w-12 h-12":"w-10 h-10",r=n?"w-6 h-6":"w-5 h-5",o=document.createElement("div");o.className="driver-location-marker";const i=(s.timestamp?(new Date-new Date(s.timestamp))/1e3:0)<30;o.innerHTML=`
      <div class="relative">
        <div class="${a} bg-blue-600 border-3 border-white rounded-full shadow-lg flex items-center justify-center relative z-10">
          <svg class="${r} text-white" viewBox="0 0 24 24" fill="currentColor">
            <path d="M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z"/>
            <path d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0"/>
          </svg>
          ${i?"":`
            <div class="absolute -top-1 -right-1 w-3 h-3 bg-yellow-500 rounded-full border border-white"></div>
          `}
        </div>
        <div class="absolute inset-0 bg-blue-400 rounded-full animate-ping opacity-30"></div>
        ${s.accuracy?`
          <div class="absolute inset-0 border-2 border-blue-300 rounded-full opacity-50" 
               style="transform: scale(${Math.min(s.accuracy/10,3)})"></div>
        `:""}
      </div>
    `;try{const m=new T.Marker({element:o,draggable:!1}).setLngLat(t).addTo(l.current),g=new T.Popup({offset:25,closeButton:!1,className:`custom-popup ${n?"max-w-xs":"max-w-sm"}`}).setHTML(`
        <div class="text-sm ${n?"p-2":"p-3"}">
          <div class="font-semibold text-gray-900 ${n?"text-base":""}">üöó Driver Location</div>
          <div class="text-xs text-gray-500 mt-1">
            ${s.timestamp?`Updated: ${new Date(s.timestamp).toLocaleTimeString()}`:"Live"}
          </div>
          ${s.accuracy?`
            <div class="text-xs text-gray-500 mt-1">
              Accuracy: ¬±${Math.round(s.accuracy)} meters
            </div>
          `:""}
          ${i?"":`
            <div class="text-xs text-yellow-600 mt-1 font-medium">
              ‚ö†Ô∏è Location data may be delayed
            </div>
          `}
        </div>
      `);m.setPopup(g),ke(m)}catch(m){console.error("Error creating driver marker:",m)}},We=t=>{me(t)},$e=t=>{if(!l.current||!h)return;ee.forEach(a=>{a&&a.remove&&a.remove()});const s=t.map((a,r)=>{if(!a.longitude||!a.latitude)return null;try{const o=document.createElement("div");o.className="site-marker";const u=a.status==="completed"||a.status==="finished"||a.collectionStatus==="finished",i=a.status==="in_progress",m=a.type==="station",g=a.purok_name||a.site_name||"Site",x=S&&L&&L.id===a.id&&!u;u&&console.log(`‚úì Rendering completed site: ${a.site_name} (ID: ${a.id})`);const F=()=>m?"#DC2626":u||x?"#10B981":"#6B7280",f=()=>m?`
              <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
              </svg>
            `:u?`
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
              </svg>
            `:`
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M3 6h18"/>
                <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
              </svg>
            `,j=n?"w-14 h-14":"w-12 h-12",E=n?"w-7 h-7":"w-6 h-6",U=n?"w-8 h-8":"w-7 h-7",q=M.findIndex(Qe=>Qe.id===a.id)+1,ue=q>0;o.innerHTML=`
          <div class="relative ${i||x?"animate-pulse":""}">
            ${ue&&!m&&!u?`
              <div class="absolute -top-2 -right-2 bg-blue-500 text-white rounded-full ${n?"w-7 h-7 text-sm":"w-6 h-6 text-xs"} flex items-center justify-center font-bold shadow-lg border-2 border-white z-20">
                ${q}
              </div>
            `:""}
            ${m?`
              <div class="${j} rounded-full bg-white shadow-2xl border-4 border-red-600 flex items-center justify-center">
                <div class="${U} text-red-600">
                  ${f()}
                </div>
              </div>
            `:`
              <div class="${j} rounded-full border-3 border-white flex items-center justify-center shadow-lg" 
                    style="background-color: ${F()}; ${u?"opacity: 0.7;":""}">
                <div class="${E} text-white">
                  ${f()}
                </div>
              </div>
            `}
            ${i?'<div class="absolute inset-0 rounded-full border-3 border-yellow-500 animate-ping"></div>':""}
            ${x&&!i?'<div class="absolute inset-0 rounded-full border-3 border-green-500 animate-ping"></div>':""}
          </div>
        `;const Ze=[parseFloat(a.longitude),parseFloat(a.latitude)],Je=new T.Popup({offset:25,closeButton:!1,className:`custom-popup ${n?"max-w-xs":"max-w-sm"}`}).setHTML(`
          <div class="text-sm ${n?"p-2":"p-3"}">
            <div class="font-semibold text-gray-900 ${n?"text-base":""}">${g}</div>
            <div class="text-xs text-gray-500 mt-1">
              ${m?"Collection Station":u?"Completed":i?"In Progress":"Pending"}
            </div>
            ${x&&S&&'<div class="text-xs text-green-600 mt-1 font-medium">üéØ Current Target</div>'}
            ${L&&L.id===a.id&&!x&&'<div class="text-xs text-green-600 mt-1 font-medium">üìç Nearest Site</div>'}
          </div>
        `);return new T.Marker({element:o,draggable:!1}).setLngLat(Ze).setPopup(Je).addTo(l.current)}catch(o){return console.error("Error creating marker:",o),null}}).filter(a=>a!==null);Me(s)},Ve=async()=>{b.length>0&&N&&(G("Refreshing route..."),await Y(b,N,S))},Xe=()=>{xe(!P)},Ge=()=>v?"100%":we.width<640?"400px":we.width<768?"500px":"600px";return c.useEffect(()=>{console.log("Current state:",{cssLoaded:A,mapInitialized:h,containerReady:X,siteLocationsCount:b.length,siteMarkersCount:ee.length,driverLocation:!!p})},[A,h,X,b,ee,p]),pe?e.jsx("div",{className:"w-full h-96 bg-gray-50 rounded-lg border border-gray-200 flex items-center justify-center",children:e.jsxs("div",{className:"text-center p-6",children:[e.jsx(Ke,{className:"w-12 h-12 text-red-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-base font-semibold text-gray-900 mb-2",children:"Map Loading Error"}),e.jsx("p",{className:"text-sm text-gray-600 mb-4",children:pe}),e.jsx("p",{className:"text-xs text-gray-500",children:"The interface will continue with limited functionality"})]})}):e.jsxs("div",{className:`${v?"w-full h-full":"w-full"} bg-white ${v?"":"rounded-lg border border-gray-200"} overflow-hidden`,children:[e.jsx(st,{isLoading:Re,message:Ee,size:n?"medium":"large",variant:"default"}),e.jsxs("div",{className:`relative w-full ${v?"h-full":""}`,style:{height:v?"100%":Ge()},children:[e.jsx("div",{ref:z,className:"w-full h-full absolute inset-0"}),h&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:`absolute ${n?"bottom-2 left-2":"bottom-4 left-4"} bg-white/95 backdrop-blur-sm rounded-lg shadow-lg border border-gray-200 ${n?"p-2":"p-3"} z-10 ${n?"min-w-40 max-w-48":v?"min-w-52":"min-w-48"}`,children:[e.jsxs("div",{className:`font-semibold ${n?"text-xs":"text-sm"} text-gray-900 ${n?"mb-2":"mb-3"} flex items-center justify-between`,children:[e.jsx("span",{children:"Legend"}),v&&!n&&e.jsx("span",{className:"text-xs font-normal text-gray-500",children:"Live Tracking"})]}),e.jsxs("div",{className:`space-y-1 ${n?"text-xs":"text-sm"}`,children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 bg-blue-600 rounded-full flex items-center justify-center flex-shrink-0 relative",children:e.jsx("div",{className:"absolute inset-0 bg-blue-400 rounded-full animate-ping opacity-30"})}),e.jsx("span",{className:"text-gray-700",children:"Driver"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 bg-red-600 rounded-full flex-shrink-0"}),e.jsx("span",{className:"text-gray-700",children:"Station"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 bg-gray-500 rounded-full flex-shrink-0"}),e.jsx("span",{className:"text-gray-700",children:"Pending"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 bg-green-600 rounded-full flex-shrink-0"}),e.jsx("span",{className:"text-gray-700",children:"Completed"})]}),S&&L&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 bg-green-500 rounded-full flex-shrink-0 relative",children:e.jsx("div",{className:"absolute inset-0 rounded-full border-2 border-white animate-ping"})}),e.jsx("span",{className:"text-gray-700",children:"Target Site"})]}),d&&e.jsxs("div",{className:"flex items-center gap-2 pt-1 border-t border-gray-200",children:[e.jsx("div",{className:"w-4 h-1 rounded-full flex-shrink-0",style:{backgroundColor:d.isRealTime?"#10B981":K[w==null?void 0:w.barangay_name]||K._default}}),e.jsx("span",{className:"text-gray-700",children:d.isRealTime?"Live Route":"Planned Route"})]})]})]}),e.jsxs("div",{className:`absolute ${n?"top-2 right-2":"top-4 right-4"} flex ${v&&!n?"flex-row gap-2":"flex-col gap-2"} z-10`,children:[e.jsx("button",{onClick:Ve,disabled:ae,className:`${v?"bg-white/95 backdrop-blur-sm":"bg-white"} rounded-lg shadow-lg border border-gray-200 hover:bg-gray-50 transition-colors flex items-center justify-center ${n?"p-2":"p-3"} ${ae?"opacity-50 cursor-not-allowed":""}`,title:"Refresh route",children:ae?e.jsx("div",{className:`animate-spin rounded-full border-b-2 border-gray-700 ${n?"w-4 h-4":"w-5 h-5"}`}):e.jsx(et,{className:`text-gray-700 ${n?"w-4 h-4":"w-5 h-5"}`})}),e.jsx("button",{onClick:Xe,className:`${v?"bg-white/95 backdrop-blur-sm":"bg-white"} rounded-lg shadow-lg border ${P?"border-blue-500 bg-blue-50":"border-gray-200"} hover:bg-gray-50 transition-colors flex items-center justify-center ${n?"p-2":"p-3"}`,title:P?"Hide route info":"Show route info",children:e.jsx(tt,{className:`${P?"text-blue-600":"text-gray-700"} ${n?"w-4 h-4":"w-5 h-5"}`})}),e.jsx("button",{onClick:Se,className:`${v?"bg-white/95 backdrop-blur-sm":"bg-white"} rounded-lg shadow-lg border border-gray-200 hover:bg-gray-50 transition-colors flex items-center justify-center ${n?"p-2":"p-3"}`,title:"Fit to route",children:e.jsx(at,{className:`text-gray-700 ${n?"w-4 h-4":"w-5 h-5"}`})})]}),e.jsx("div",{className:`absolute ${n?"top-2 left-2":"top-4 left-4"} bg-white/95 backdrop-blur-sm rounded-lg shadow-lg border border-gray-200 ${n?"px-2 py-1":"px-3 py-2"} z-10`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${W==="connected"?"bg-green-500":W==="connecting"?"bg-yellow-500":"bg-red-500"} ${W==="connected"?"animate-pulse":""}`}),e.jsx("span",{className:`font-medium text-gray-700 capitalize ${n?"text-xs":"text-sm"}`,children:W})]})}),d&&P&&e.jsxs("div",{className:`absolute ${n?"top-12 left-2 right-2":v?"top-4 left-1/2 transform -translate-x-1/2":"top-16 left-4"} bg-white/95 backdrop-blur-sm rounded-lg shadow-lg border border-gray-200 ${n?"p-3":"p-4"} z-10 ${n?"":v?"min-w-80 max-w-md":"min-w-64"}`,children:[e.jsxs("div",{className:`font-semibold text-gray-900 ${n?"text-sm mb-2":"text-base mb-3"} flex items-center justify-between`,children:[e.jsx("span",{children:d.isRealTime?"Live Route":"Planned Route"}),e.jsxs("div",{className:"flex gap-1",children:[d.isRealTime&&e.jsxs("span",{className:"text-xs bg-green-100 text-green-800 px-2 py-1 rounded flex items-center gap-1",children:[e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-pulse"}),"Live"]}),d.isFallback&&e.jsx("span",{className:"text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded",children:"Estimated"})]})]}),e.jsxs("div",{className:`space-y-2 ${n?"text-xs":"text-sm"} text-gray-600`,children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{children:"Estimated Time:"}),e.jsx("span",{className:"font-semibold text-blue-600",children:d.formattedDuration})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{children:"Distance:"}),e.jsxs("span",{className:"font-semibold",children:[d.distance," km"]})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{children:"Total Stops:"}),e.jsxs("span",{className:"font-semibold",children:[d.totalStops," sites"]})]}),d.targetSite&&e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{children:"Target Site:"}),e.jsx("span",{className:"font-semibold text-green-600",children:d.targetSite})]}),L&&!d.targetSite&&e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{children:"Nearest Site:"}),e.jsx("span",{className:"font-semibold text-green-600",children:L.site_name})]}),d.lastUpdated&&e.jsxs("div",{className:"flex justify-between items-center text-xs text-gray-500",children:[e.jsx("span",{children:"Last Updated:"}),e.jsx("span",{children:d.lastUpdated})]})]}),ve&&e.jsx("div",{className:`mt-2 p-2 bg-red-50 border border-red-200 rounded ${n?"text-xs":"text-sm"} text-red-600`,children:ve})]})]})]})]})};export{gt as default};
