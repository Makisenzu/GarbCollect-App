import{r as u,j as i,a as X}from"./app-C3ZLLJ3m.js";import{a as y}from"./mapbox-gl-aow2ddIA.js";/* empty css                  */import{S as me}from"./react-select.esm-Y31jT12t.js";import{c as pe}from"./can-3MqaZyCZ.js";import"./index-CnyDuYXe.js";import"./index-Co8R37hx.js";const $={Alegria:"#FF5733","Barangay 1":"#33FF57","Barangay 2":"#3357FF","Barangay 3":"#F033FF","Barangay 4":"#FF33F0","Barangay 5":"#33FFF0","Bayugan 2":"#8A2BE2","Bitan-agan":"#A52A2A",Borbon:"#DEB887",Buenasuerte:"#5F9EA0",Caimpugan:"#7FFF00","Das-agan":"#D2691E",Ebro:"#FF7F50",Hubang:"#6495ED",Karaus:"#DC143C",Ladgadan:"#00FFFF",Lapinigan:"#00008B",Lucac:"#008B8B",Mate:"#B8860B","New Visayas":"#006400",Ormaca:"#8B008B",Pasta:"#556B2F","Pisa-an":"#FF8C00",Rizal:"#9932CC","San Isidro":"#8FBC8F","Santa Ana":"#483D8B",Tagapua:"#2F4F4F","San Francisco":"#FFE659",_default:"#4F262A"},Ne=w=>{const C=u.useRef(null),n=u.useRef(null),[Y,O]=u.useState(!1),[ee,B]=u.useState(!0),[te,z]=u.useState(null),[m,re]=u.useState(!1),[E,ae]=u.useState(""),[x,N]=u.useState([]),[_,q]=u.useState(!1),j=u.useRef([]),[f,F]=u.useState([]),[L,v]=u.useState(null),[H,W]=u.useState([]),[k,oe]=u.useState(null),[h,ne]=u.useState(null),[R,se]=u.useState([]),[D,Z]=u.useState(!1),A=R.map(e=>({value:e.id,label:e.baranggay_name})),V=e=>{if(e<60)return`${e} min`;{const t=Math.floor(e/60),r=e%60;return r===0?`${t}h`:`${t}h ${r}min`}},P=(e,t,r,c)=>{const o=(r-e)*Math.PI/180,s=(c-t)*Math.PI/180,g=Math.sin(o/2)*Math.sin(o/2)+Math.cos(e*Math.PI/180)*Math.cos(r*Math.PI/180)*Math.sin(s/2)*Math.sin(s/2);return 6371*(2*Math.atan2(Math.sqrt(g),Math.sqrt(1-g)))},K=(e,t)=>{if(!e||t.length===0)return t;const r=[...t],c=[],a=r.map(d=>{const l=P(parseFloat(e.latitude),parseFloat(e.longitude),parseFloat(d.latitude),parseFloat(d.longitude));return{...d,distance:l,coordinates:[parseFloat(d.longitude),parseFloat(d.latitude)]}});a.sort((d,l)=>d.distance-l.distance);const o=a[0];c.push(o);const s=a.slice(1);let g=o;for(;s.length>0;){let d=-1,l=1/0;for(let p=0;p<s.length;p++){const b=P(parseFloat(g.latitude),parseFloat(g.longitude),parseFloat(s[p].latitude),parseFloat(s[p].longitude));b<l&&(l=b,d=p)}d!==-1&&(g=s[d],c.push(g),s.splice(d,1))}return c},ie=async(e,t,r)=>{if(!(!w||e.length<1))try{const c=e.filter(l=>l.latitude&&l.longitude&&!isNaN(parseFloat(l.latitude))&&!isNaN(parseFloat(l.longitude)));if(c.length<1){console.warn("No valid sites with coordinates found");return}const a=r?K(r,c.filter(l=>l.type!=="station")):c;W(a),a.length>0&&oe(a[0]);let o=[];r?o=[`${parseFloat(r.longitude).toFixed(6)},${parseFloat(r.latitude).toFixed(6)}`,...a.map(l=>`${parseFloat(l.longitude).toFixed(6)},${parseFloat(l.latitude).toFixed(6)}`)]:o=a.map(l=>`${parseFloat(l.longitude).toFixed(6)},${parseFloat(l.latitude).toFixed(6)}`);const s=o.length>2,g=await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${o.join(";")}?access_token=${w}&geometries=geojson&overview=full&steps=true&alternatives=false&continue_straight=false`+(s?"&roundabout_exits=true":""));if(!g.ok)throw new Error(`HTTP error! status: ${g.status}`);const d=await g.json();if(d.routes&&d.routes.length>0){const l=d.routes[0];if(l.geometry&&l.geometry.coordinates){const p=Math.round(l.duration/60),b=(l.distance/1e3).toFixed(1);F(l.geometry.coordinates),v({duration:p,formattedDuration:V(p),distance:b,rawData:l}),console.log(`Route calculated: ${p}min, ${b}km, ${l.geometry.coordinates.length} points`)}else throw new Error("Invalid route geometry received")}else throw new Error(d.message||"No routes found")}catch(c){console.error("Error calculating route:",c);const a=e.filter(o=>o.latitude&&o.longitude&&!isNaN(parseFloat(o.latitude))&&!isNaN(parseFloat(o.longitude)));if(a.length>0){const o=a.map(s=>[parseFloat(s.longitude),parseFloat(s.latitude)]);F(o),v({duration:Math.round(G(o)*2),formattedDuration:"Estimated",distance:G(o).toFixed(1),isFallback:!0})}}},G=e=>{let t=0;for(let r=1;r<e.length;r++){const[c,a]=e[r-1],[o,s]=e[r];t+=P(a,c,s,o)}return t},I=()=>{var e;if(!(!n.current||f.length===0)){if(!n.current.isStyleLoaded()){n.current.once("styledata",()=>{setTimeout(I,100)});return}["route","route-glow","route-direction","route-start","route-end","route-waypoints"].forEach(t=>{n.current.getLayer(t)&&n.current.removeLayer(t)}),n.current.getSource("route")&&n.current.removeSource("route"),["route-start-marker","route-end-marker","route-waypoints-marker"].forEach(t=>{n.current.getSource(t)&&n.current.removeSource(t)});try{n.current.addSource("route",{type:"geojson",data:{type:"Feature",properties:{},geometry:{type:"LineString",coordinates:f}}});const t=E&&((e=R.find(s=>s.id===E))==null?void 0:e.baranggay_name)||"San Francisco",r=$[t]||$._default,c=m?6:5,a=m?14:12;n.current.addLayer({id:"route-glow",type:"line",source:"route",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":r,"line-width":a,"line-opacity":.3,"line-blur":10}}),n.current.addLayer({id:"route",type:"line",source:"route",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":r,"line-width":c,"line-opacity":.9}}),n.current.addLayer({id:"route-direction",type:"symbol",source:"route",layout:{"symbol-placement":"line","text-field":"‚ñ∂","text-size":m?14:12,"symbol-spacing":100},paint:{"text-color":r}});const o=[];h&&h.latitude&&h.longitude&&o.push({coordinates:[parseFloat(h.longitude),parseFloat(h.latitude)],type:"station",sequence:0}),H.forEach((s,g)=>{s.latitude&&s.longitude&&o.push({coordinates:[parseFloat(s.longitude),parseFloat(s.latitude)],type:"site",sequence:g+1})}),o.length>0&&(n.current.addSource("route-waypoints-marker",{type:"geojson",data:{type:"FeatureCollection",features:o.map((s,g)=>({type:"Feature",geometry:{type:"Point",coordinates:s.coordinates},properties:{description:s.type==="station"?"Station":`Site ${s.sequence}`,type:s.type,sequence:s.sequence}}))}}),n.current.addLayer({id:"route-waypoints",type:"circle",source:"route-waypoints-marker",paint:{"circle-radius":["case",["==",["get","type"],"station"],m?10:8,m?8:6],"circle-color":["case",["==",["get","type"],"station"],"#dc2626","#3b82f6"],"circle-stroke-width":2,"circle-stroke-color":"#ffffff"}})),f.length>=2&&(n.current.addSource("route-start-marker",{type:"geojson",data:{type:"Feature",geometry:{type:"Point",coordinates:f[0]},properties:{description:"Start"}}}),n.current.addSource("route-end-marker",{type:"geojson",data:{type:"Feature",geometry:{type:"Point",coordinates:f[f.length-1]},properties:{description:"End"}}}),n.current.addLayer({id:"route-start",type:"circle",source:"route-start-marker",paint:{"circle-radius":m?8:6,"circle-color":"#22c55e","circle-stroke-width":2,"circle-stroke-color":"#ffffff"}}),n.current.addLayer({id:"route-end",type:"circle",source:"route-end-marker",paint:{"circle-radius":m?8:6,"circle-color":"#ef4444","circle-stroke-width":2,"circle-stroke-color":"#ffffff"}})),setTimeout(()=>{le()},200)}catch(t){console.error("Error adding route layer:",t),setTimeout(()=>{I()},500)}}},le=()=>{if(!n.current||f.length===0||x.length===0)return;const e=new y.LngLatBounds;f.forEach(r=>{e.extend(r)}),h&&e.extend([parseFloat(h.longitude),parseFloat(h.latitude)]),x.forEach(r=>{r.longitude&&r.latitude&&e.extend([parseFloat(r.longitude),parseFloat(r.latitude)])});const t=m?40:80;try{n.current.fitBounds(e,{padding:t,duration:1500,essential:!0,maxZoom:m?16:15,offset:[0,m?-50:0]})}catch(r){console.error("Error fitting map to bounds:",r)}};u.useEffect(()=>{const e=()=>{const t=window.innerWidth<768;re(t)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),u.useEffect(()=>{(async()=>{Z(!0);try{const t=await X.get("/getBarangay");se(t.data.barangay_data||[])}catch(t){console.error("Error fetching barangays:",t)}finally{Z(!1)}})()},[]);const S=()=>{j.current.forEach(e=>e.remove()),j.current=[]},ce=e=>{if(!n.current||!e.length)return;S();const t=e.find(a=>a.type==="station"),r=e.filter(a=>a.type!=="station"),c=t?K(t,r):r;if(W(c),t&&t.latitude&&t.longitude){const a=document.createElement("div");a.className="custom-marker animate-pulse",a.innerHTML=`
        <div class="hover:scale-110 transition-transform duration-200 cursor-pointer relative">
          <div class="bg-white rounded-full p-2 shadow-lg border-2 border-red-500">
            <div class="w-6 h-6 bg-red-500 rounded-full flex items-center justify-center">
              <span class="text-white text-xs font-bold">üè†</span>
            </div>
          </div>
        </div>
      `;const o=new y.Marker({element:a,anchor:"bottom"}).setLngLat([parseFloat(t.longitude),parseFloat(t.latitude)]).addTo(n.current);j.current.push(o),a.addEventListener("click",()=>{o.togglePopup()})}if(c.forEach((a,o)=>{var s,g,d;if(a.latitude&&a.longitude){const l=o+1,p=k&&k.id===a.id,b=(g=(s=a.purok)==null?void 0:s.baranggay)==null?void 0:g.baranggay_name,T=$[b]||$._default,ue=m?"w-7 h-7 text-xs":"w-6 h-6 text-xs",ge=m?"w-12 h-12":"w-10 h-10",J=m?"w-10 h-10":"w-8 h-8",M=document.createElement("div");M.className="custom-marker animate-pulse",M.innerHTML=`
          <div class="hover:scale-110 transition-transform duration-200 cursor-pointer relative">
            <div class="${ge} rounded-full border-3 flex items-center justify-center overflow-hidden shadow-lg bg-white relative ${p?"ring-4 ring-green-500 ring-opacity-70":""}" style="border-color: ${T};">
              ${p?`
                <div class="absolute -inset-3 rounded-full border-4 border-green-500 border-opacity-70 animate-pulse pointer-events-none z-10"></div>
              `:""}
              <img src="${pe}" 
                   alt="${a.site_name}" 
                   class="${J} object-cover rounded-full z-0"
                   onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\\'${J} rounded-full flex items-center justify-center text-white text-xs font-bold bg-white\\' style=\\'border: 2px solid ${T}; color: ${T}\\'>${((d=a.site_name)==null?void 0:d.charAt(0))||"S"}</div>'">
            </div>
            <div class="absolute -top-2 -right-2 bg-blue-500 text-white rounded-full ${ue} flex items-center justify-center font-bold shadow-lg border-2 border-white">
              ${l}
            </div>
          </div>
        `;const Q=new y.Marker({element:M,anchor:"bottom"}).setLngLat([parseFloat(a.longitude),parseFloat(a.latitude)]).addTo(n.current);j.current.push(Q),M.addEventListener("click",()=>{Q.togglePopup()})}}),e.length>0&&e.some(a=>a.latitude&&a.longitude)){const a=new y.LngLatBounds;e.forEach(o=>{o.latitude&&o.longitude&&a.extend([parseFloat(o.longitude),parseFloat(o.latitude)])}),n.current.fitBounds(a,{padding:50,maxZoom:15,duration:1e3})}},U=async e=>{if(!e){N([]),S(),F([]),v(null);return}q(!0);try{const t=await X.get(`/barangay/getSites/${e}`);if(t.data.success){const r=t.data.data||[];N(r),console.log("Active sites:",r);const c=r.find(a=>a.type==="station");c&&ne(c),ce(r),r.length>=1&&await ie(r,e,c)}else console.error("Failed to fetch sites:",t.data.message),N([]),S(),F([]),v(null)}catch(t){console.error("Error fetching active sites:",t),N([]),S(),F([]),v(null)}finally{q(!1)}};u.useEffect(()=>{n.current&&f.length>0&&I()},[f]),u.useEffect(()=>{if(!w){z("Mapbox API key is missing"),B(!1);return}if(C.current){try{y.accessToken=w,n.current=new y.Map({container:C.current,style:"mapbox://styles/mapbox/streets-v12",center:[125.94849837776422,8.483022468128098],zoom:11,attributionControl:!1,interactive:!0,scrollZoom:!0,dragPan:!0,dragRotate:!1,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1}),n.current.addControl(new y.NavigationControl,"top-right"),n.current.addControl(new y.FullscreenControl,"top-right"),n.current.on("load",()=>{console.log("Map loaded successfully"),O(!0),B(!1)}),n.current.on("error",e=>{var t;console.error("Map error:",e),z("Failed to load map: "+((t=e.error)==null?void 0:t.message)),B(!1)})}catch(e){console.error("Error creating map:",e),z("Failed to initialize map: "+e.message),B(!1)}return()=>{S(),n.current&&(n.current.remove(),n.current=null)}}},[w]);const de=async e=>{const t=(e==null?void 0:e.value)||"",r=(e==null?void 0:e.label)||"None";console.log("Selected Barangay ID:",t),console.log("Selected Barangay Name:",r),ae(t),t?await U(t):(N([]),S(),F([]),v(null))};return{mapContainer:C,map:n,mapLoaded:Y,loading:ee,error:te,barangays:R,loadingBarangays:D,activeSites:x,loadingSites:_,selectedBarangay:E,options:A,renderBarangaySelect:(e,t)=>i.jsx(me,{id:"barangay_id",name:"barangay_id",value:A.find(r=>r.value===e.barangay_id)||null,onChange:r=>{const c=(r==null?void 0:r.value)||"";de(r),t("barangay_id",c)},options:A,placeholder:D?"Loading barangays...":"Select Barangay",isDisabled:D,required:!0,maxMenuHeight:150,className:"text-sm",styles:{control:r=>({...r,borderColor:"#d1d5db",minHeight:"42px",fontSize:"14px","&:hover":{borderColor:"#d1d5db"},"&:focus":{borderColor:"#6366f1",boxShadow:"0 0 0 1px #6366f1"}})}}),renderSitesInfo:()=>E?i.jsx("div",{className:`
        absolute z-40 bg-white rounded-lg shadow-xl border border-gray-200
        max-h-64 overflow-y-auto
        ${m?"bottom-4 left-4 right-4":"top-20 right-4 w-80"}
      `,children:i.jsxs("div",{className:"p-4",children:[i.jsxs("div",{className:"flex items-center justify-between mb-3",children:[i.jsxs("h3",{className:"text-lg font-semibold text-gray-800",children:["Active Sites ",x.length>0&&`(${x.length})`]}),_&&i.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"})]}),L&&i.jsx("div",{className:"mb-3 p-2 bg-blue-50 rounded border border-blue-200",children:i.jsxs("div",{className:"text-xs text-blue-800",children:[i.jsxs("div",{children:[i.jsx("strong",{children:"Route:"})," ",L.formattedDuration," ‚Ä¢ ",L.distance," km"]}),k&&i.jsxs("div",{children:[i.jsx("strong",{children:"Nearest:"})," ",k.site_name]}),L.isFallback&&i.jsxs("div",{className:"text-orange-600 mt-1",children:[i.jsx("strong",{children:"Note:"})," Using estimated route"]})]})}),_?i.jsxs("div",{className:"text-center py-4",children:[i.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mx-auto mb-2"}),i.jsx("p",{className:"text-sm text-gray-600",children:"Loading sites..."})]}):x.length>0?i.jsx("div",{className:"space-y-2",children:x.map(e=>{var t,r,c;return i.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg border border-gray-200 hover:bg-blue-50 transition-colors cursor-pointer",onClick:()=>{if(e.latitude&&e.longitude){n.current.flyTo({center:[parseFloat(e.longitude),parseFloat(e.latitude)],zoom:15,essential:!0});const a=j.current.find(o=>o.getLngLat().lng===parseFloat(e.longitude)&&o.getLngLat().lat===parseFloat(e.latitude));a&&a.togglePopup()}},children:[i.jsxs("div",{className:"flex justify-between items-start",children:[i.jsxs("div",{className:"flex-1",children:[i.jsx("h4",{className:"font-medium text-gray-900 text-sm",children:e.site_name}),i.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["Barangay: ",((r=(t=e.purok)==null?void 0:t.baranggay)==null?void 0:r.baranggay_name)||"N/A"]}),i.jsxs("div",{className:"text-xs text-gray-600",children:["Purok: ",((c=e.purok)==null?void 0:c.purok_name)||"N/A"]}),i.jsxs("div",{className:"text-xs text-gray-600",children:["Type: ",i.jsx("span",{className:"capitalize",children:e.type})]})]}),i.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800",children:"Active"})]}),e.latitude&&e.longitude&&i.jsxs("div",{className:"text-xs text-gray-500 mt-2",children:["üìç ",e.latitude,", ",e.longitude]})]},e.id)})}):i.jsxs("div",{className:"text-center py-6",children:[i.jsx("div",{className:"text-gray-400 text-4xl mb-2",children:"üè¢"}),i.jsx("p",{className:"text-gray-500 text-sm",children:"No active sites found"}),i.jsx("p",{className:"text-gray-400 text-xs mt-1",children:"for this barangay"})]})]})}):null,fetchActiveSites:U,routeCoordinates:f,routeInfo:L,optimizedSiteOrder:H,nearestSite:k,stationLocation:h,formatDuration:V}};export{Ne as default};
