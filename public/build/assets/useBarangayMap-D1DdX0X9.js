import{r as u,j as i,a as te}from"./app-BOwIOK84.js";import{a as y}from"./mapbox-gl-CcLdEyCe.js";/* empty css                  */import{S as me}from"./react-select.esm-lWWW0zGc.js";import{c as pe}from"./can-3MqaZyCZ.js";import"./index-CnyDuYXe.js";import"./index-BY4an93v.js";const R={Alegria:"#FF5733","Barangay 1":"#33FF57","Barangay 2":"#3357FF","Barangay 3":"#F033FF","Barangay 4":"#FF33F0","Barangay 5":"#33FFF0","Bayugan 2":"#8A2BE2","Bitan-agan":"#A52A2A",Borbon:"#DEB887",Buenasuerte:"#5F9EA0",Caimpugan:"#7FFF00","Das-agan":"#D2691E",Ebro:"#FF7F50",Hubang:"#6495ED",Karaus:"#DC143C",Ladgadan:"#00FFFF",Lapinigan:"#00008B",Lucac:"#008B8B",Mate:"#B8860B","New Visayas":"#006400",Ormaca:"#8B008B",Pasta:"#556B2F","Pisa-an":"#FF8C00",Rizal:"#9932CC","San Isidro":"#8FBC8F","Santa Ana":"#483D8B",Tagapua:"#2F4F4F","San Francisco":"#FFE659",_default:"#4F262A"},je=b=>{const D=u.useRef(null),o=u.useRef(null),[V,re]=u.useState(!1),[ae,B]=u.useState(!0),[oe,A]=u.useState(null),[f,ne]=u.useState(!1),[E,se]=u.useState(""),[h,k]=u.useState([]),[P,K]=u.useState(!1),M=u.useRef([]),[m,F]=u.useState([]),[v,S]=u.useState(null),[G,w]=u.useState([]),[N,$]=u.useState(null),[C,z]=u.useState(null),[I,ie]=u.useState([]),[T,U]=u.useState(!1),q=I.map(e=>({value:e.id,label:e.baranggay_name})),J=e=>{if(e<60)return`${e} min`;{const r=Math.floor(e/60),t=e%60;return t===0?`${r}h`:`${r}h ${t}min`}},H=(e,r,t,c)=>{const n=(t-e)*Math.PI/180,s=(c-r)*Math.PI/180,g=Math.sin(n/2)*Math.sin(n/2)+Math.cos(e*Math.PI/180)*Math.cos(t*Math.PI/180)*Math.sin(s/2)*Math.sin(s/2);return 6371*(2*Math.atan2(Math.sqrt(g),Math.sqrt(1-g)))},Q=(e,r)=>{if(!e||r.length===0)return r;const t=[...r],c=[],a=t.map(d=>{const l=H(parseFloat(e.latitude),parseFloat(e.longitude),parseFloat(d.latitude),parseFloat(d.longitude));return{...d,distance:l,coordinates:[parseFloat(d.longitude),parseFloat(d.latitude)]}});a.sort((d,l)=>d.distance-l.distance);const n=a[0];c.push(n);const s=a.slice(1);let g=n;for(;s.length>0;){let d=-1,l=1/0;for(let p=0;p<s.length;p++){const x=H(parseFloat(g.latitude),parseFloat(g.longitude),parseFloat(s[p].latitude),parseFloat(s[p].longitude));x<l&&(l=x,d=p)}d!==-1&&(g=s[d],c.push(g),s.splice(d,1))}return c},le=async(e,r,t)=>{if(!(!b||e.length<1))try{const c=e.filter(l=>l.latitude&&l.longitude&&!isNaN(parseFloat(l.latitude))&&!isNaN(parseFloat(l.longitude)));if(c.length<1){console.warn("No valid sites with coordinates found");return}const a=t?Q(t,c.filter(l=>l.type!=="station")):c;w(a),a.length>0&&$(a[0]);let n=[];t?n=[`${parseFloat(t.longitude).toFixed(6)},${parseFloat(t.latitude).toFixed(6)}`,...a.map(l=>`${parseFloat(l.longitude).toFixed(6)},${parseFloat(l.latitude).toFixed(6)}`)]:n=a.map(l=>`${parseFloat(l.longitude).toFixed(6)},${parseFloat(l.latitude).toFixed(6)}`);const s=n.length>2,g=await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${n.join(";")}?access_token=${b}&geometries=geojson&overview=full&steps=true&alternatives=false&continue_straight=false`+(s?"&roundabout_exits=true":""));if(!g.ok)throw new Error(`HTTP error! status: ${g.status}`);const d=await g.json();if(d.routes&&d.routes.length>0){const l=d.routes[0];if(l.geometry&&l.geometry.coordinates){const p=Math.round(l.duration/60),x=(l.distance/1e3).toFixed(1);F(l.geometry.coordinates),S({duration:p,formattedDuration:J(p),distance:x,rawData:l})}else throw new Error("Invalid route geometry received")}else throw new Error(d.message||"No routes found")}catch(c){console.error("Error calculating route:",c);const a=e.filter(n=>n.latitude&&n.longitude&&!isNaN(parseFloat(n.latitude))&&!isNaN(parseFloat(n.longitude)));if(a.length>0){const n=a.map(s=>[parseFloat(s.longitude),parseFloat(s.latitude)]);F(n),S({duration:Math.round(X(n)*2),formattedDuration:"Estimated",distance:X(n).toFixed(1),isFallback:!0})}}},X=e=>{let r=0;for(let t=1;t<e.length;t++){const[c,a]=e[t-1],[n,s]=e[t];r+=H(a,c,s,n)}return r},W=()=>{var e;if(!(!o.current||m.length===0)){if(!o.current.isStyleLoaded()){o.current.once("styledata",()=>{setTimeout(W,100)});return}L();try{o.current.addSource("route",{type:"geojson",data:{type:"Feature",properties:{},geometry:{type:"LineString",coordinates:m}}});const r=E&&((e=I.find(s=>s.id===E))==null?void 0:e.baranggay_name)||"San Francisco",t=R[r]||R._default,c=f?6:5,a=f?14:12;o.current.addLayer({id:"route-glow",type:"line",source:"route",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":t,"line-width":a,"line-opacity":.3,"line-blur":10}}),o.current.addLayer({id:"route",type:"line",source:"route",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":t,"line-width":c,"line-opacity":.9}}),o.current.addLayer({id:"route-direction",type:"symbol",source:"route",layout:{"symbol-placement":"line","text-field":"‚ñ∂","text-size":f?14:12,"symbol-spacing":100},paint:{"text-color":t}});const n=[];G.forEach((s,g)=>{s.latitude&&s.longitude&&n.push({coordinates:[parseFloat(s.longitude),parseFloat(s.latitude)],type:"site",sequence:g+1})}),n.length>0&&(o.current.addSource("route-waypoints-marker",{type:"geojson",data:{type:"FeatureCollection",features:n.map((s,g)=>({type:"Feature",geometry:{type:"Point",coordinates:s.coordinates},properties:{description:`Site ${s.sequence}`,type:s.type,sequence:s.sequence}}))}}),o.current.addLayer({id:"route-waypoints",type:"circle",source:"route-waypoints-marker",paint:{"circle-radius":f?8:6,"circle-color":"#3b82f6","circle-stroke-width":2,"circle-stroke-color":"#ffffff"}})),m.length>=2&&(o.current.addSource("route-start-marker",{type:"geojson",data:{type:"Feature",geometry:{type:"Point",coordinates:m[0]},properties:{description:"Start"}}}),o.current.addSource("route-end-marker",{type:"geojson",data:{type:"Feature",geometry:{type:"Point",coordinates:m[m.length-1]},properties:{description:"End"}}}),o.current.addLayer({id:"route-start",type:"circle",source:"route-start-marker",paint:{"circle-radius":f?8:6,"circle-color":"#22c55e","circle-stroke-width":2,"circle-stroke-color":"#ffffff"}}),o.current.addLayer({id:"route-end",type:"circle",source:"route-end-marker",paint:{"circle-radius":f?8:6,"circle-color":"#ef4444","circle-stroke-width":2,"circle-stroke-color":"#ffffff"}})),setTimeout(()=>{ce()},200)}catch(r){console.error("Error adding route layer:",r),setTimeout(()=>{W()},500)}}},ce=()=>{if(!o.current||m.length===0||h.length===0)return;const e=new y.LngLatBounds;m.forEach(t=>{e.extend(t)}),C&&e.extend([parseFloat(C.longitude),parseFloat(C.latitude)]),h.forEach(t=>{t.longitude&&t.latitude&&e.extend([parseFloat(t.longitude),parseFloat(t.latitude)])});const r=f?40:80;try{o.current.fitBounds(e,{padding:r,duration:1500,essential:!0,maxZoom:f?16:15,offset:[0,f?-50:0]})}catch(t){console.error("Error fitting map to bounds:",t)}};u.useEffect(()=>{const e=()=>{const r=window.innerWidth<768;ne(r)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),u.useEffect(()=>{(async()=>{U(!0);try{const r=await te.get("/getBarangay");ie(r.data.barangay_data||[])}catch(r){console.error("Error fetching barangays:",r)}finally{U(!1)}})()},[]);const j=()=>{M.current.forEach(e=>e.remove()),M.current=[]},L=()=>{if(o.current){if(!o.current.isStyleLoaded()){setTimeout(L,100);return}try{["route","route-glow","route-direction","route-start","route-end","route-waypoints"].forEach(e=>{o.current.getLayer(e)&&o.current.removeLayer(e)}),o.current.getSource("route")&&o.current.removeSource("route"),["route-start-marker","route-end-marker","route-waypoints-marker"].forEach(e=>{o.current.getSource(e)&&o.current.removeSource(e)})}catch(e){console.error("Error clearing route layers:",e)}}},de=e=>{if(!o.current||!e.length)return;j();const r=e.find(a=>a.type==="station"),t=e.filter(a=>a.type!=="station"),c=r?Q(r,t):t;if(w(c),c.forEach((a,n)=>{var s,g,d;if(a.latitude&&a.longitude){const l=n+1,p=N&&N.id===a.id,x=(g=(s=a.purok)==null?void 0:s.baranggay)==null?void 0:g.baranggay_name,Z=R[x]||R._default,ge=f?"w-7 h-7 text-xs":"w-6 h-6 text-xs",fe=f?"w-12 h-12":"w-10 h-10",O=f?"w-10 h-10":"w-8 h-8",_=document.createElement("div");_.className="custom-marker animate-pulse",_.innerHTML=`
          <div class="hover:scale-110 transition-transform duration-200 cursor-pointer relative">
            <div class="${fe} rounded-full border-3 flex items-center justify-center overflow-hidden shadow-lg bg-white relative ${p?"ring-4 ring-green-500 ring-opacity-70":""}" style="border-color: ${Z};">
              ${p?`
                <div class="absolute -inset-3 rounded-full border-4 border-green-500 border-opacity-70 animate-pulse pointer-events-none z-10"></div>
              `:""}
              <img src="${pe}" 
                   alt="${a.site_name}" 
                   class="${O} object-cover rounded-full z-0"
                   onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\\'${O} rounded-full flex items-center justify-center text-white text-xs font-bold bg-white\\' style=\\'border: 2px solid ${Z}; color: ${Z}\\'>${((d=a.site_name)==null?void 0:d.charAt(0))||"S"}</div>'">
            </div>
            <div class="absolute -top-2 -right-2 bg-blue-500 text-white rounded-full ${ge} flex items-center justify-center font-bold shadow-lg border-2 border-white">
              ${l}
            </div>
          </div>
        `;const ee=new y.Marker({element:_,anchor:"bottom"}).setLngLat([parseFloat(a.longitude),parseFloat(a.latitude)]).addTo(o.current);M.current.push(ee),_.addEventListener("click",()=>{ee.togglePopup()})}}),e.length>0&&e.some(a=>a.latitude&&a.longitude)){const a=new y.LngLatBounds;e.forEach(n=>{n.latitude&&n.longitude&&a.extend([parseFloat(n.longitude),parseFloat(n.latitude)])}),o.current.fitBounds(a,{padding:50,maxZoom:15,duration:1e3})}},Y=async e=>{if(!e){j(),L(),k([]),F([]),S(null),w([]),$(null),z(null);return}j(),L(),k([]),F([]),S(null),w([]),$(null),z(null),K(!0);try{const r=await te.get(`/barangay/getSites/${e}`);if(r.data.success){const t=r.data.data||[],c=t.find(a=>a.type==="station");c&&z(c),k(t),t.length>0&&(de(t),t.length>=1&&await le(t,e,c))}else console.error("Failed to fetch sites:",r.data.message)}catch(r){console.error("Error fetching active sites:",r)}finally{K(!1)}};u.useEffect(()=>{o.current&&o.current.isStyleLoaded()&&m.length>0&&W()},[m,V]),u.useEffect(()=>{if(!b){A("Mapbox API key is missing"),B(!1);return}if(D.current){try{y.accessToken=b,o.current=new y.Map({container:D.current,style:"mapbox://styles/mapbox/streets-v12",center:[125.94849837776422,8.483022468128098],zoom:11,attributionControl:!1,interactive:!0,scrollZoom:!0,dragPan:!0,dragRotate:!1,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1}),o.current.addControl(new y.NavigationControl,"top-right"),o.current.addControl(new y.FullscreenControl,"top-right"),o.current.on("load",()=>{re(!0),B(!1)}),o.current.on("error",e=>{var r;console.error("Map error:",e),A("Failed to load map: "+((r=e.error)==null?void 0:r.message)),B(!1)})}catch(e){console.error("Error creating map:",e),A("Failed to initialize map: "+e.message),B(!1)}return()=>{j(),o.current&&(o.current.remove(),o.current=null)}}},[b]);const ue=async e=>{const r=(e==null?void 0:e.value)||"";e!=null&&e.label,se(r),r?await Y(r):(j(),L(),k([]),F([]),S(null),w([]),$(null),z(null))};return{mapContainer:D,map:o,mapLoaded:V,loading:ae,error:oe,barangays:I,loadingBarangays:T,activeSites:h,loadingSites:P,selectedBarangay:E,options:q,renderBarangaySelect:(e,r)=>i.jsx(me,{id:"barangay_id",name:"barangay_id",value:q.find(t=>t.value===e.barangay_id)||null,onChange:t=>{const c=(t==null?void 0:t.value)||"";ue(t),r("barangay_id",c)},options:q,placeholder:T?"Loading barangays...":"Select Barangay",isDisabled:T,required:!0,maxMenuHeight:150,className:"text-sm",styles:{control:t=>({...t,borderColor:"#d1d5db",minHeight:"42px",fontSize:"14px","&:hover":{borderColor:"#d1d5db"},"&:focus":{borderColor:"#6366f1",boxShadow:"0 0 0 1px #6366f1"}})}}),renderSitesInfo:()=>E?i.jsx("div",{className:`
        absolute z-40 bg-white rounded-lg shadow-xl border border-gray-200
        max-h-64 overflow-y-auto
        ${f?"bottom-4 left-4 right-4":"top-20 right-4 w-80"}
      `,children:i.jsxs("div",{className:"p-4",children:[i.jsxs("div",{className:"flex items-center justify-between mb-3",children:[i.jsxs("h3",{className:"text-lg font-semibold text-gray-800",children:["Active Sites ",h.filter(e=>e.type!=="station").length>0&&`(${h.filter(e=>e.type!=="station").length})`]}),P&&i.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"})]}),v&&i.jsx("div",{className:"mb-3 p-2 bg-blue-50 rounded border border-blue-200",children:i.jsxs("div",{className:"text-xs text-blue-800",children:[i.jsxs("div",{children:[i.jsx("strong",{children:"Route:"})," ",v.formattedDuration," ‚Ä¢ ",v.distance," km"]}),N&&i.jsxs("div",{children:[i.jsx("strong",{children:"Nearest:"})," ",N.site_name]}),v.isFallback&&i.jsxs("div",{className:"text-orange-600 mt-1",children:[i.jsx("strong",{children:"Note:"})," Using estimated route"]})]})}),P?i.jsxs("div",{className:"text-center py-4",children:[i.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mx-auto mb-2"}),i.jsx("p",{className:"text-sm text-gray-600",children:"Loading sites..."})]}):h.filter(e=>e.type!=="station").length>0?i.jsx("div",{className:"space-y-2",children:h.filter(e=>e.type!=="station").map(e=>{var r,t,c;return i.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg border border-gray-200 hover:bg-blue-50 transition-colors cursor-pointer",onClick:()=>{if(e.latitude&&e.longitude){o.current.flyTo({center:[parseFloat(e.longitude),parseFloat(e.latitude)],zoom:15,essential:!0});const a=M.current.find(n=>n.getLngLat().lng===parseFloat(e.longitude)&&n.getLngLat().lat===parseFloat(e.latitude));a&&a.togglePopup()}},children:[i.jsxs("div",{className:"flex justify-between items-start",children:[i.jsxs("div",{className:"flex-1",children:[i.jsx("h4",{className:"font-medium text-gray-900 text-sm",children:e.site_name}),i.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["Barangay: ",((t=(r=e.purok)==null?void 0:r.baranggay)==null?void 0:t.baranggay_name)||"N/A"]}),i.jsxs("div",{className:"text-xs text-gray-600",children:["Purok: ",((c=e.purok)==null?void 0:c.purok_name)||"N/A"]})]}),i.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800",children:"Active"})]}),e.latitude&&e.longitude&&i.jsxs("div",{className:"text-xs text-gray-500 mt-2",children:["üìç ",e.latitude,", ",e.longitude]})]},e.id)})}):i.jsxs("div",{className:"text-center py-6",children:[i.jsx("div",{className:"text-gray-400 text-4xl mb-2",children:"üè¢"}),i.jsx("p",{className:"text-gray-500 text-sm",children:"No active sites found"}),i.jsx("p",{className:"text-gray-400 text-xs mt-1",children:"for this barangay"})]})]})}):null,fetchActiveSites:Y,routeCoordinates:m,routeInfo:v,optimizedSiteOrder:G,nearestSite:N,stationLocation:C,formatDuration:J}};export{je as default};
