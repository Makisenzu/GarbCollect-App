import{r as a}from"./app-nYSkDZzl.js";const oe=(T=[])=>{const[j,N]=a.useState(T),[E,B]=a.useState([]),[d,O]=a.useState([]),[H,x]=a.useState(!0),[M,D]=a.useState(!1),[$,f]=a.useState(null),[q,o]=a.useState(null),[c,w]=a.useState(1),[m,J]=a.useState(3),[r,h]=a.useState({rate:0,fullname:"",category_id:"",barangay:"",purok:"",review_content:"",additional_comments:""}),[u,p]=a.useState(1),[U,K]=a.useState(0),[S,L]=a.useState("all"),[l,V]=a.useState("newest"),[X,F]=a.useState([]),z=async()=>{try{const e=await fetch("/categoryFetch");if(!e.ok)throw new Error("Failed to fetch categories");const t=await e.json();if(t.success)B(t.categories||[]);else throw new Error(t.message||"Failed to fetch categories")}catch(e){console.error("Error fetching categories:",e),f(t=>t||`Categories: ${e.message}`)}},G=async()=>{try{const e=await fetch("/barangayFetch");if(!e.ok)throw new Error("Failed to fetch barangay data");const t=await e.json();if(t.success){const v=t.barangays.map(i=>({id:i.id,name:i.baranggay_name,puroks:i.puroks?i.puroks.map(n=>({id:n.id,name:n.purok_name})):[]}));O(v)}else throw new Error(t.message||"Failed to fetch barangay data")}catch(e){console.error("Error fetching barangay data:",e),f(t=>t||`Barangays: ${e.message}`)}};a.useEffect(()=>{(async()=>{try{x(!0),f(null),await Promise.all([z(),G()])}catch(t){console.error("Error fetching data:",t),f(t.message)}finally{x(!1)}})()},[]),a.useEffect(()=>{if(r.barangay){const e=d.find(t=>t.name===r.barangay);F((e==null?void 0:e.puroks)||[]),h(t=>({...t,purok:""}))}else F([])},[r.barangay,d]);const C=[{number:1,title:"Rating",description:"How was your experience?"},{number:2,title:"Personal Info",description:"Tell us about yourself"},{number:3,title:"Service Details",description:"Service type and location"},{number:4,title:"Review Content",description:"Share your experience"}],Q=async e=>{var i;if(e.preventDefault(),r.rate===0||!r.review_content.trim()||!r.category_id){o({success:!1,message:"Please fill in all required fields: rating, service type, and review content."});return}const t=d.find(n=>n.name===r.barangay),v=t==null?void 0:t.puroks.find(n=>n.name===r.purok);if(!v){o({success:!1,message:"Please select a valid barangay and purok."});return}try{D(!0),o(null);const n={fullname:r.fullname||"Anonymous User",purok_id:v.id,category_id:parseInt(r.category_id),review_content:r.review_content,suggestion_content:r.additional_comments||"",rate:parseInt(r.rate)};console.log("Submitting review:",n);const g=await fetch("/reviews",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":((i=document.querySelector('meta[name="csrf-token"]'))==null?void 0:i.getAttribute("content"))||"",Accept:"application/json"},body:JSON.stringify(n)}),A=g.headers.get("content-type");if(!A||!A.includes("application/json")){const y=await g.text();throw console.error("Non-JSON response:",y.substring(0,200)),new Error("Server returned an invalid response. Please try again.")}const s=await g.json();if(!g.ok)throw new Error(s.message||`Server error: ${g.status}`);if(s.success){const y={id:s.review.id,fullname:s.review.fullname,category_id:s.review.category_id,review_content:s.review.review_content,additional_comments:s.review.suggestion_content,rate:s.review.rate,barangay:r.barangay,purok:r.purok,created_at:s.review.created_at,category:E.find(R=>R.id===s.review.category_id)||{id:s.review.category_id,category_name:"Unknown Category"},replies:null,status:s.review.status};s.status==="approved"&&N(R=>[y,...R]),h({rate:0,fullname:"",category_id:"",barangay:"",purok:"",review_content:"",additional_comments:""}),p(1),w(1),o({success:!0,message:s.message,status:s.status,review:y}),setTimeout(()=>{o(null)},5e3)}else throw new Error(s.message||"Failed to submit review")}catch(n){console.error("Error submitting review:",n),o({success:!1,message:n.message||"An error occurred while submitting your review. Please try again."})}finally{D(!1)}},W=()=>{u<C.length&&p(u+1)},Y=()=>{u>1&&p(u-1)},Z=e=>{console.log("Marked review as helpful:",e)},_=j.filter(e=>e.status&&e.status!=="approved"?!1:S==="all"?!0:e.rate===parseInt(S)).sort((e,t)=>l==="newest"?new Date(t.created_at)-new Date(e.created_at):l==="oldest"?new Date(e.created_at)-new Date(t.created_at):l==="highest"?t.rate-e.rate:l==="lowest"?e.rate-t.rate:0),b=_.length,k=Math.ceil(b/m),P=(c-1)*m,I=P+m,ee=_.slice(P,I),te=e=>{e>=1&&e<=k&&w(e)},re=()=>{c<k&&w(c+1)},ae=()=>{c>1&&w(c-1)},se=()=>{switch(u){case 1:return r.rate>0;case 2:return!0;case 3:return r.category_id&&r.barangay&&r.purok;case 4:return r.review_content.trim().length>0;default:return!1}};return{reviews:ee,allReviews:_,categories:E,barangays:d,newReview:r,currentStep:u,hoverRating:U,activeFilter:S,sortBy:l,availablePuroks:X,loading:H,submitting:M,error:$,submitResult:q,pagination:{currentPage:c,totalPages:k,totalReviews:b,itemsPerPage:m,startIndex:P+1,endIndex:Math.min(I,b)},steps:C,setNewReview:h,setCurrentStep:p,setHoverRating:K,setActiveFilter:L,setSortBy:V,handleSubmitReview:Q,nextStep:W,prevStep:Y,handleHelpful:Z,isStepValid:se,goToPage:te,nextPage:re,prevPage:ae,setItemsPerPage:J,clearSubmitResult:()=>o(null)}};export{oe as useReview};
